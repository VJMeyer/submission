<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
    <meta charset="utf-8">
    <meta name="generator" content="quarto-1.7.29">

    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


    <title>amtair_prototype_example_carlsmithipynb</title>
    <style>
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      div.columns{display: flex; gap: min(4vw, 1.5em);}
      div.column{flex: auto; overflow-x: auto;}
      div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
      ul.task-list{list-style: none;}
      ul.task-list li input[type="checkbox"] {
        width: 0.8em;
        margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
        vertical-align: middle;
      }
      /* CSS for syntax highlighting */
      html { -webkit-text-size-adjust: 100%; }
      pre > code.sourceCode { white-space: pre; position: relative; }
      pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
      pre > code.sourceCode > span:empty { height: 1.2em; }
      .sourceCode { overflow: visible; }
      code.sourceCode > span { color: inherit; text-decoration: inherit; }
      div.sourceCode { margin: 1em 0; }
      pre.sourceCode { margin: 0; }
      @media screen {
      div.sourceCode { overflow: auto; }
      }
      @media print {
      pre > code.sourceCode { white-space: pre-wrap; }
      pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
      }
      pre.numberSource code
        { counter-reset: source-line 0; }
      pre.numberSource code > span
        { position: relative; left: -4em; counter-increment: source-line; }
      pre.numberSource code > span > a:first-child::before
        { content: counter(source-line);
          position: relative; left: -1em; text-align: right; vertical-align: baseline;
          border: none; display: inline-block;
          -webkit-touch-callout: none; -webkit-user-select: none;
          -khtml-user-select: none; -moz-user-select: none;
          -ms-user-select: none; user-select: none;
          padding: 0 4px; width: 4em;
        }
      pre.numberSource { margin-left: 3em;  padding-left: 4px; }
      div.sourceCode
        {   }
      @media screen {
      pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
      }
    </style>

    <style>
      body.hypothesis-enabled #quarto-embed-header {
        padding-right: 36px;
      }

      #quarto-embed-header {
        height: 3em;
        width: 100%;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: solid 1px;
      }

      #quarto-embed-header h6 {
        font-size: 1.1em;
        padding-top: 0.6em;
        margin-left: 1em;
        margin-right: 1em;
        font-weight: 400;
      }

      #quarto-embed-header a.quarto-back-link,
      #quarto-embed-header a.quarto-download-embed {
        font-size: 0.8em;
        margin-top: 1em;
        margin-bottom: 1em;
        margin-left: 1em;
        margin-right: 1em;
      }

      .quarto-back-container {
        padding-left: 0.5em;
        display: flex;
      }

      .headroom {
          will-change: transform;
          transition: transform 200ms linear;
      }

      .headroom--pinned {
          transform: translateY(0%);
      }

      .headroom--unpinned {
          transform: translateY(-100%);
      }      
    </style>

    <script>
    window.document.addEventListener("DOMContentLoaded", function () {

      var header = window.document.querySelector("#quarto-embed-header");
      const titleBannerEl = window.document.querySelector("body > #title-block-header");
      if (titleBannerEl) {
        titleBannerEl.style.paddingTop = header.clientHeight + "px";
      }
      const contentEl = window.document.getElementById('quarto-content');
      for (const child of contentEl.children) {
        child.style.paddingTop = header.clientHeight + "px";
        child.style.marginTop = "1em";
      }

      // Use the article root if the `back` call doesn't work. This isn't perfect
      // but should typically work
      window.quartoBackToArticle = () => {
        var currentUrl = window.location.href;
        window.history.back();
        setTimeout(() => {
            // if location was not changed in 100 ms, then there is no history back
            if(currentUrl === window.location.href){              
                // redirect to site root
                window.location.href = "../index.html";
            }
        }, 100);
      }

      const headroom = new window.Headroom(header, {
        tolerance: 5,
        onPin: function () {
        },
        onUnpin: function () {
        },
      });
      headroom.init();
    });
    </script>

    
<script src="../site_libs/manuscript-notebook/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-0815c480559380816a4d1ea211a47e91.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-8a894fcc3cb5e37eb5bf30def131be2f.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
     <script async="" src="https://hypothes.is/embed.js"></script>
<script>
  window.document.addEventListener("DOMContentLoaded", function (_event) {
    document.body.classList.add('hypothesis-enabled');
  });
</script>  
      </head>

  <body class="quarto-notebook quarto-light">
    <div id="quarto-embed-header" class="headroom fixed-top bg-primary">
      
      <a onclick="window.quartoBackToArticle(); return false;" class="btn btn-primary quarto-back-link" href=""><i class="bi bi-caret-left"></i> Back to Article</a>
      <h6><i class="bi bi-journal-code"></i> <a href="https://colab.research.google.com/github/SingularitySmith/AMTAIR_Prototype/blob/main/version_history/AMTAIR_Prototype_0_1.3.ipynb#scrollTo=lt8-AnebGUXr">AMTAIR Prototype Demonstration (Public Colab Notebook)</a></h6>

            <a href="../notebooks/AMTAIR_Prototype_example_carlsmithIPYNB.md" class="btn btn-primary quarto-download-embed" download="AMTAIR_Prototype_example_carlsmithIPYNB.md">Download Notebook</a>
          </div>

     <div id="quarto-content" class="page-columns page-rows-contents page-layout-article toc-left">
<div id="quarto-sidebar-toc-left" class="sidebar toc-left">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#amtair-prototype-demonstration-public-colab-notebook" id="toc-amtair-prototype-demonstration-public-colab-notebook" class="nav-link active" data-scroll-target="#amtair-prototype-demonstration-public-colab-notebook">AMTAIR Prototype Demonstration (Public Colab Notebook)</a></li>
  <li><a href="#amtair-prototype-automating-transformative-ai-risk-modeling" id="toc-amtair-prototype-automating-transformative-ai-risk-modeling" class="nav-link" data-scroll-target="#amtair-prototype-automating-transformative-ai-risk-modeling">AMTAIR Prototype: Automating Transformative AI Risk Modeling</a>
  <ul class="collapse">
  <li><a href="#executive-summary" id="toc-executive-summary" class="nav-link" data-scroll-target="#executive-summary">Executive Summary</a>
  <ul class="collapse">
  <li><a href="#purpose-within-the-masters-thesis" id="toc-purpose-within-the-masters-thesis" class="nav-link" data-scroll-target="#purpose-within-the-masters-thesis">Purpose Within the Master’s Thesis</a></li>
  <li><a href="#relevance-to-ai-governance" id="toc-relevance-to-ai-governance" class="nav-link" data-scroll-target="#relevance-to-ai-governance">Relevance to AI Governance</a></li>
  </ul></li>
  <li><a href="#notebook-structure-and-workflow" id="toc-notebook-structure-and-workflow" class="nav-link" data-scroll-target="#notebook-structure-and-workflow">Notebook Structure and Workflow</a></li>
  <li><a href="#project-context-and-purpose" id="toc-project-context-and-purpose" class="nav-link" data-scroll-target="#project-context-and-purpose">Project Context and Purpose</a></li>
  <li><a href="#notebook-overview-and-pipeline" id="toc-notebook-overview-and-pipeline" class="nav-link" data-scroll-target="#notebook-overview-and-pipeline">Notebook Overview and Pipeline</a></li>
  <li><a href="#connection-to-masters-thesis" id="toc-connection-to-masters-thesis" class="nav-link" data-scroll-target="#connection-to-masters-thesis">Connection to Master’s Thesis</a></li>
  <li><a href="#instructions-how-to-use-this-notebook" id="toc-instructions-how-to-use-this-notebook" class="nav-link" data-scroll-target="#instructions-how-to-use-this-notebook">Instructions — How to use this notebook:</a></li>
  <li><a href="#key-concepts" id="toc-key-concepts" class="nav-link" data-scroll-target="#key-concepts">Key Concepts:</a></li>
  <li><a href="#example-workflow" id="toc-example-workflow" class="nav-link" data-scroll-target="#example-workflow">Example Workflow:</a></li>
  <li><a href="#troubleshooting" id="toc-troubleshooting" class="nav-link" data-scroll-target="#troubleshooting">Troubleshooting:</a></li>
  </ul></li>
  <li><a href="#environment-setup-and-data-access" id="toc-environment-setup-and-data-access" class="nav-link" data-scroll-target="#environment-setup-and-data-access">0. Environment Setup and Data Access</a></li>
  <li><a href="#prepare-colabpython-environment-import-libraries-packages" id="toc-prepare-colabpython-environment-import-libraries-packages" class="nav-link" data-scroll-target="#prepare-colabpython-environment-import-libraries-packages">0.1 Prepare Colab/Python Environment — Import Libraries &amp; Packages</a>
  <ul class="collapse">
  <li><a href="#connect-to-github-repository" id="toc-connect-to-github-repository" class="nav-link" data-scroll-target="#connect-to-github-repository">0.2 Connect to GitHub Repository</a></li>
  <li><a href="#file-import" id="toc-file-import" class="nav-link" data-scroll-target="#file-import">0.3 File Import</a></li>
  </ul></li>
  <li><a href="#sources-pdfs-of-papers-to-argdown-.md-file" id="toc-sources-pdfs-of-papers-to-argdown-.md-file" class="nav-link" data-scroll-target="#sources-pdfs-of-papers-to-argdown-.md-file">1.0 Sources (PDF’s of Papers) to ArgDown (.md file)</a></li>
  <li><a href="#sources-to-argdown-structured-argument-extraction" id="toc-sources-to-argdown-structured-argument-extraction" class="nav-link" data-scroll-target="#sources-to-argdown-structured-argument-extraction">1. Sources to ArgDown: Structured Argument Extraction</a>
  <ul class="collapse">
  <li><a href="#process-overview" id="toc-process-overview" class="nav-link" data-scroll-target="#process-overview">Process Overview</a></li>
  <li><a href="#what-is-argdown" id="toc-what-is-argdown" class="nav-link" data-scroll-target="#what-is-argdown">What is ArgDown?</a></li>
  <li><a href="#specify-source-document-e.g.-pdf" id="toc-specify-source-document-e.g.-pdf" class="nav-link" data-scroll-target="#specify-source-document-e.g.-pdf">1.1 Specify Source Document (e.g.&nbsp;PDF)</a></li>
  <li><a href="#generate-argdown-extraction-prompt" id="toc-generate-argdown-extraction-prompt" class="nav-link" data-scroll-target="#generate-argdown-extraction-prompt">1.2 Generate ArgDown Extraction Prompt</a></li>
  <li><a href="#prepare-llm-api-call" id="toc-prepare-llm-api-call" class="nav-link" data-scroll-target="#prepare-llm-api-call">1.3 Prepare LLM API Call</a></li>
  <li><a href="#make-argdown-extraction-llm-api-call" id="toc-make-argdown-extraction-llm-api-call" class="nav-link" data-scroll-target="#make-argdown-extraction-llm-api-call">1.4 Make ArgDown Extraction LLM API Call</a></li>
  <li><a href="#save-argdown-extraction-response" id="toc-save-argdown-extraction-response" class="nav-link" data-scroll-target="#save-argdown-extraction-response">1.5 Save ArgDown Extraction Response</a></li>
  <li><a href="#review-and-check-argdown.md-file" id="toc-review-and-check-argdown.md-file" class="nav-link" data-scroll-target="#review-and-check-argdown.md-file">1.6 Review and Check ArgDown.md File</a></li>
  <li><a href="#check-the-graph-structure-with-the-argdown-sandbox-online" id="toc-check-the-graph-structure-with-the-argdown-sandbox-online" class="nav-link" data-scroll-target="#check-the-graph-structure-with-the-argdown-sandbox-online">1.6.2 Check the Graph Structure with the ArgDown Sandbox Online</a></li>
  <li><a href="#extract-argdown-graph-information-as-dataframe" id="toc-extract-argdown-graph-information-as-dataframe" class="nav-link" data-scroll-target="#extract-argdown-graph-information-as-dataframe">1.7 Extract ArgDown Graph Information as DataFrame</a></li>
  <li><a href="#store-argdown-information-as-argdown.csv-file" id="toc-store-argdown-information-as-argdown.csv-file" class="nav-link" data-scroll-target="#store-argdown-information-as-argdown.csv-file">1.8 Store ArgDown Information as ‘ArgDown.csv’ file</a></li>
  </ul></li>
  <li><a href="#probability-extractions-argdown-.csv-to-bayesdown-.md-plugin-json-syntax" id="toc-probability-extractions-argdown-.csv-to-bayesdown-.md-plugin-json-syntax" class="nav-link" data-scroll-target="#probability-extractions-argdown-.csv-to-bayesdown-.md-plugin-json-syntax">2.0 Probability Extractions: ArgDown (.csv) to BayesDown (.md + plugin JSON syntax)</a></li>
  <li><a href="#argdown-to-bayesdown-adding-probability-information" id="toc-argdown-to-bayesdown-adding-probability-information" class="nav-link" data-scroll-target="#argdown-to-bayesdown-adding-probability-information">2. ArgDown to BayesDown: Adding Probability Information</a>
  <ul class="collapse">
  <li><a href="#process-overview-1" id="toc-process-overview-1" class="nav-link" data-scroll-target="#process-overview-1">Process Overview</a></li>
  <li><a href="#what-is-bayesdown" id="toc-what-is-bayesdown" class="nav-link" data-scroll-target="#what-is-bayesdown">What is BayesDown?</a></li>
  <li><a href="#probability-extraction-questions-argdown.csv-to-argdown_withquestions.csv" id="toc-probability-extraction-questions-argdown.csv-to-argdown_withquestions.csv" class="nav-link" data-scroll-target="#probability-extraction-questions-argdown.csv-to-argdown_withquestions.csv">2.1 Probability Extraction Questions — ‘ArgDown.csv’ to ‘ArgDown_WithQuestions.csv’</a></li>
  <li><a href="#argdown_withquestions.csv-to-bayesdownquestions.md" id="toc-argdown_withquestions.csv-to-bayesdownquestions.md" class="nav-link" data-scroll-target="#argdown_withquestions.csv-to-bayesdownquestions.md">2.2 ‘ArgDown_WithQuestions.csv’ to ‘BayesDownQuestions.md’</a></li>
  <li><a href="#generate-bayesdown-probability-extraction-prompt" id="toc-generate-bayesdown-probability-extraction-prompt" class="nav-link" data-scroll-target="#generate-bayesdown-probability-extraction-prompt">2.3 Generate BayesDown Probability Extraction Prompt</a></li>
  <li><a href="#bayesdown-format-specification" id="toc-bayesdown-format-specification" class="nav-link" data-scroll-target="#bayesdown-format-specification">2.3.1 BayesDown Format Specification</a>
  <ul class="collapse">
  <li><a href="#core-structure" id="toc-core-structure" class="nav-link" data-scroll-target="#core-structure">Core Structure</a></li>
  </ul></li>
  <li><a href="#test-bayesdown-extraction" id="toc-test-bayesdown-extraction" class="nav-link" data-scroll-target="#test-bayesdown-extraction">3.1.2 Test BayesDown Extraction</a></li>
  <li><a href="#check-the-graph-structure-with-the-argdown-sandbox-online-1" id="toc-check-the-graph-structure-with-the-argdown-sandbox-online-1" class="nav-link" data-scroll-target="#check-the-graph-structure-with-the-argdown-sandbox-online-1">3.1.2.2 Check the Graph Structure with the ArgDown Sandbox Online</a></li>
  <li><a href="#extraction" id="toc-extraction" class="nav-link" data-scroll-target="#extraction">3.3 Extraction</a>
  <ul class="collapse">
  <li><a href="#data-post-processing" id="toc-data-post-processing" class="nav-link" data-scroll-target="#data-post-processing">3.3 Data-Post-Processing</a></li>
  <li><a href="#download-and-save-finished-data-frame-as-.csv-file" id="toc-download-and-save-finished-data-frame-as-.csv-file" class="nav-link" data-scroll-target="#download-and-save-finished-data-frame-as-.csv-file">3.4 Download and save finished data frame as .csv file</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#analysis-inference-bayesian-network-visualization" id="toc-analysis-inference-bayesian-network-visualization" class="nav-link" data-scroll-target="#analysis-inference-bayesian-network-visualization">4. Analysis &amp; Inference: Bayesian Network Visualization</a>
  <ul class="collapse">
  <li><a href="#bayesian-network-visualization-approach" id="toc-bayesian-network-visualization-approach" class="nav-link" data-scroll-target="#bayesian-network-visualization-approach">Bayesian Network Visualization Approach</a>
  <ul class="collapse">
  <li><a href="#visualization-philosophy" id="toc-visualization-philosophy" class="nav-link" data-scroll-target="#visualization-philosophy">Visualization Philosophy</a></li>
  <li><a href="#connection-to-amtair-goals" id="toc-connection-to-amtair-goals" class="nav-link" data-scroll-target="#connection-to-amtair-goals">Connection to AMTAIR Goals</a></li>
  <li><a href="#implementation-structure" id="toc-implementation-structure" class="nav-link" data-scroll-target="#implementation-structure">Implementation Structure</a></li>
  </ul></li>
  <li><a href="#phase-1-dependenciesfunctions" id="toc-phase-1-dependenciesfunctions" class="nav-link" data-scroll-target="#phase-1-dependenciesfunctions">Phase 1: Dependencies/Functions</a></li>
  <li><a href="#phase-2-node-classification-and-styling-module" id="toc-phase-2-node-classification-and-styling-module" class="nav-link" data-scroll-target="#phase-2-node-classification-and-styling-module">Phase 2: Node Classification and Styling Module</a></li>
  <li><a href="#phase-3-html-content-generation-module" id="toc-phase-3-html-content-generation-module" class="nav-link" data-scroll-target="#phase-3-html-content-generation-module">Phase 3: HTML Content Generation Module</a></li>
  <li><a href="#phase-4-main-visualization-function" id="toc-phase-4-main-visualization-function" class="nav-link" data-scroll-target="#phase-4-main-visualization-function">Phase 4: Main Visualization Function</a></li>
  </ul></li>
  <li><a href="#quickly-check-html-outputs" id="toc-quickly-check-html-outputs" class="nav-link" data-scroll-target="#quickly-check-html-outputs">Quickly check HTML Outputs</a></li>
  <li><a href="#conclusion-from-prototype-to-production" id="toc-conclusion-from-prototype-to-production" class="nav-link" data-scroll-target="#conclusion-from-prototype-to-production">Conclusion: From Prototype to Production</a>
  <ul class="collapse">
  <li><a href="#summary-of-achievements" id="toc-summary-of-achievements" class="nav-link" data-scroll-target="#summary-of-achievements">Summary of Achievements</a></li>
  <li><a href="#limitations-and-future-work" id="toc-limitations-and-future-work" class="nav-link" data-scroll-target="#limitations-and-future-work">Limitations and Future Work</a></li>
  <li><a href="#connection-to-amtair-project" id="toc-connection-to-amtair-project" class="nav-link" data-scroll-target="#connection-to-amtair-project">Connection to AMTAIR Project</a></li>
  </ul></li>
  <li><a href="#save-outputs" id="toc-save-outputs" class="nav-link" data-scroll-target="#save-outputs">6.0 Save Outputs</a></li>
  <li><a href="#saving-and-exporting-results" id="toc-saving-and-exporting-results" class="nav-link" data-scroll-target="#saving-and-exporting-results">6. Saving and Exporting Results</a>
  <ul class="collapse">
  <li><a href="#convert-.ipynb-notebook-to-markdown" id="toc-convert-.ipynb-notebook-to-markdown" class="nav-link" data-scroll-target="#convert-.ipynb-notebook-to-markdown">Convert .ipynb Notebook to MarkDown</a></li>
  </ul></li>
  </ul>
</nav>
</div>
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
</div>
<main class="content" id="quarto-document-content">      <section id="amtair-prototype-demonstration-public-colab-notebook" class="level1">
<h1><a href="https://colab.research.google.com/github/SingularitySmith/AMTAIR_Prototype/blob/main/version_history/AMTAIR_Prototype_0_1.3.ipynb#scrollTo=lt8-AnebGUXr">AMTAIR Prototype Demonstration (Public Colab Notebook)</a></h1>
</section>
<section id="amtair-prototype-automating-transformative-ai-risk-modeling" class="level1">
<h1>AMTAIR Prototype: Automating Transformative AI Risk Modeling</h1>
<section id="executive-summary" class="level2">
<h2 class="anchored" data-anchor-id="executive-summary">Executive Summary</h2>
<p>This notebook implements a prototype of the AMTAIR (Automating Transformative AI Risk Modeling) project, which addresses the critical coordination failure in AI governance by developing computational tools that automate the extraction of probabilistic world models from AI safety literature.</p>
<p>The prototype demonstrates the transformation pipeline from structured argument representations (ArgDown) to probabilistic Bayesian networks (BayesDown), enabling the visualization and analysis of causal relationships and probability distributions that underlie AI risk assessments and policy evaluations.</p>
<section id="purpose-within-the-masters-thesis" class="level3">
<h3 class="anchored" data-anchor-id="purpose-within-the-masters-thesis">Purpose Within the Master’s Thesis</h3>
<p>This notebook serves as the technical implementation component of the Master’s thesis “Automating Transformative AI Risk Modeling: A Computational Approach to Policy Impact Evaluation.” It demonstrates the feasibility of automating the extraction and formalization of world models, focusing on the core extraction pipeline and visualization capabilities that form the foundation for more sophisticated analysis.</p>
</section>
<section id="relevance-to-ai-governance" class="level3">
<h3 class="anchored" data-anchor-id="relevance-to-ai-governance">Relevance to AI Governance</h3>
<p>The coordination crisis in AI governance stems from different stakeholders working with incompatible assumptions, terminologies, and priorities. By making implicit models explicit through automated extraction and formalization, this work helps bridge communication gaps between technical researchers, policy specialists, and other stakeholders, contributing to more effective coordination in addressing existential risks from advanced AI.</p>
</section>
</section>
<section id="notebook-structure-and-workflow" class="level2">
<h2 class="anchored" data-anchor-id="notebook-structure-and-workflow">Notebook Structure and Workflow</h2>
<p>This notebook implements a multi-stage pipeline for transforming argument structures into interactive Bayesian network visualizations:</p>
<ol type="1">
<li><p><strong>Environment Setup</strong> (Sections 0.1-0.3): Establishes the technical environment with necessary libraries and data connections</p></li>
<li><p><strong>Argument Extraction</strong> (Sections 1.0-1.8): Processes source documents into structured ArgDown representations</p></li>
<li><p><strong>Probability Integration</strong> (Sections 2.0-2.8): Enhances ArgDown with probability information to create BayesDown</p></li>
<li><p><strong>Data Transformation</strong> (Section 3.0): Converts BayesDown into structured DataFrame format</p></li>
<li><p><strong>Visualization and Analysis</strong> (Section 4.0): Creates interactive Bayesian network visualizations</p></li>
<li><p><strong>Archiving and Export</strong> (Sections 5.0-6.0): Provides utilities for saving and sharing results</p></li>
</ol>
<p>Throughout this notebook, we use the classic rain-sprinkler-lawn example as a canonical test case, demonstrating how a simple causal scenario (rain and sprinkler use affecting wet grass) can be represented, processed, and visualized using our automated pipeline.</p>
</section>
<section id="project-context-and-purpose" class="level2">
<h2 class="anchored" data-anchor-id="project-context-and-purpose">Project Context and Purpose</h2>
<p>This notebook implements a prototype of the Automating Transformative AI Risk Modeling (AMTAIR) project, which addresses a critical coordination failure in AI governance by developing computational tools to automate the extraction of probabilistic world models from AI safety literature.</p>
<p>The coordination crisis in AI governance stems from different stakeholders (technical researchers, policy specialists, ethicists) operating with different terminologies, priorities, and implicit theories of change. This fragmentation systematically increases existential risk through safety gaps, resource misallocation, and capability-governance mismatches.</p>
<p>The AMTAIR project aims to bridge these divides by: 1. Making implicit models explicit through automated extraction and formalization 2. Enabling comparison across different worldviews 3. Providing a common language for discussing probabilistic relationships 4. Supporting policy evaluation across diverse scenarios</p>
</section>
<section id="notebook-overview-and-pipeline" class="level2">
<h2 class="anchored" data-anchor-id="notebook-overview-and-pipeline">Notebook Overview and Pipeline</h2>
<p>This notebook demonstrates the core extraction pipeline from structured argument representations (ArgDown) to probabilistic Bayesian networks (BayesDown), using the classic rain-sprinkler-lawn example as a canonical test case.</p>
<p>The pipeline consists of five main stages: 1. <strong>Environment Setup</strong>: Libraries, GitHub repository access, and data loading 2. <strong>Argument Extraction</strong>: Processing source documents into structured ArgDown format 3. <strong>Probability Integration</strong>: Enhancing ArgDown with probabilistic information to create BayesDown 4. <strong>Data Transformation</strong>: Converting BayesDown into structured DataFrame format 5. <strong>Visualization &amp; Analysis</strong>: Creating interactive Bayesian network visualizations</p>
</section>
<section id="connection-to-masters-thesis" class="level2">
<h2 class="anchored" data-anchor-id="connection-to-masters-thesis">Connection to Master’s Thesis</h2>
<p>This notebook serves as the technical implementation component of the Master’s thesis “Automating Transformative AI Risk Modeling: A Computational Approach to Policy Impact Evaluation” (see PY_Thesis_OutlineNDraft), demonstrating the feasibility of automating the process of extracting and formalizing world models from AI safety literature.</p>
<p>The thesis positions this work as a solution to the coordination crisis in AI governance, where the AMTAIR tools provide a crucial bridge between different stakeholder communities by creating formal representations that can be analyzed, compared, and used for policy evaluation.</p>
<p>For broader context on the project’s motivation and placement within AI governance efforts, see PY_Post0.0 (“The Missing Piece: Why We Need a Grand Strategy for AI”) and PY_AMTAIRDescription, which explain how this technical work contributes to the development of a comprehensive AI safety grand strategy.</p>
</section>
<section id="instructions-how-to-use-this-notebook" class="level2">
<h2 class="anchored" data-anchor-id="instructions-how-to-use-this-notebook">Instructions — How to use this notebook:</h2>
<ol type="1">
<li><p><strong>Import Libraries &amp; Install Packages</strong>: Run Section 0.1 to set up the necessary dependencies for data processing and visualization.</p></li>
<li><p><strong>Connect to GitHub Repository &amp; Load Data files</strong>: Run Section 0.2 to establish connections to the data repository and load example datasets. This step retrieves sample ArgDown files and extracted data for demonstration.</p></li>
<li><p><strong>Process Source Documents to ArgDown</strong>: Sections 1.0-1.8 demonstrate the extraction of argument structures from source documents (such as PDFs) into ArgDown format, a markdown-like notation for structured arguments.</p></li>
<li><p><strong>Convert ArgDown to BayesDown</strong>: Sections 2.0-2.3 handle the transformation of ArgDown files into BayesDown format, which incorporates probabilistic information into the argument structure.</p></li>
<li><p><strong>Extract Data into Structured Format</strong>: Section 3.0 processes BayesDown format into structured database entries (CSV) that can be used for analysis.</p></li>
<li><p><strong>Create and Analyze Bayesian Networks</strong>: Section 4.0 demonstrates how to build Bayesian networks from the extracted data and provides tools for analyzing risk pathways.</p></li>
<li><p><strong>Save and Export Results</strong>: Sections 5.0-6.0 provide methods for archiving results and exporting visualizations.</p></li>
</ol>
<blockquote class="blockquote">
<p><a href="#scrollTo=lt8-AnebGUXr">AMTAIR Prototype Demonstration (Public Colab Notebook)</a></p>
</blockquote>
<blockquote class="blockquote">
<p><a href="#scrollTo=iDy_leH6DJH_">AMTAIR Prototype: Automating Transformative AI Risk Modeling</a></p>
</blockquote>
<blockquote class="blockquote">
<blockquote class="blockquote">
<p><a href="#scrollTo=iDy_leH6DJH_">Executive Summary</a></p>
</blockquote>
</blockquote>
<blockquote class="blockquote">
<blockquote class="blockquote">
<blockquote class="blockquote">
<p><a href="#scrollTo=iDy_leH6DJH_">Purpose Within the Master’s Thesis</a></p>
</blockquote>
</blockquote>
</blockquote>
<blockquote class="blockquote">
<blockquote class="blockquote">
<blockquote class="blockquote">
<p><a href="#scrollTo=iDy_leH6DJH_">Relevance to AI Governance</a></p>
</blockquote>
</blockquote>
</blockquote>
<blockquote class="blockquote">
<blockquote class="blockquote">
<p><a href="#scrollTo=iDy_leH6DJH_">Notebook Structure and Workflow</a></p>
</blockquote>
</blockquote>
<blockquote class="blockquote">
<blockquote class="blockquote">
<p><a href="#scrollTo=Cm1JQGDYNJjf">Project Context and Purpose</a></p>
</blockquote>
</blockquote>
<blockquote class="blockquote">
<blockquote class="blockquote">
<p><a href="#scrollTo=Cm1JQGDYNJjf">Notebook Overview and Pipeline</a></p>
</blockquote>
</blockquote>
<blockquote class="blockquote">
<blockquote class="blockquote">
<p><a href="#scrollTo=Cm1JQGDYNJjf">Connection to Master’s Thesis</a></p>
</blockquote>
</blockquote>
<blockquote class="blockquote">
<blockquote class="blockquote">
<p><a href="#scrollTo=22NBzTxxsnfQ">Instructions — How to use this notebook:</a></p>
</blockquote>
</blockquote>
<blockquote class="blockquote">
<blockquote class="blockquote">
<p><a href="#scrollTo=NovjnOw6bzLi">Key Concepts:</a></p>
</blockquote>
</blockquote>
<blockquote class="blockquote">
<blockquote class="blockquote">
<p><a href="#scrollTo=NovjnOw6bzLi">Example Workflow:</a></p>
</blockquote>
</blockquote>
<blockquote class="blockquote">
<blockquote class="blockquote">
<p><a href="#scrollTo=NovjnOw6bzLi">Troubleshooting:</a></p>
</blockquote>
</blockquote>
<blockquote class="blockquote">
<p><a href="#scrollTo=neYYoWhbNRIJ">Environment Setup and Data Access</a></p>
</blockquote>
<blockquote class="blockquote">
<p><a href="#scrollTo=GtVFO-s74vI_">0.1 Prepare Colab/Python Environment — Import Libraries &amp; Packages</a></p>
</blockquote>
<blockquote class="blockquote">
<blockquote class="blockquote">
<p><a href="#scrollTo=2a3VR0fLhJow">0.2 Connect to GitHub Repository</a></p>
</blockquote>
</blockquote>
<blockquote class="blockquote">
<blockquote class="blockquote">
<p><a href="#scrollTo=y-ix4Rp5fE9m">0.3 File Import</a></p>
</blockquote>
</blockquote>
<blockquote class="blockquote">
<p><a href="#scrollTo=52XyPlte5HrU">1.0 Sources (PDF’s of Papers) to ArgDown (.md file)</a></p>
</blockquote>
<blockquote class="blockquote">
<p><a href="#scrollTo=1-7O4KHfNU-e">Sources to ArgDown: Structured Argument Extraction</a></p>
</blockquote>
<blockquote class="blockquote">
<blockquote class="blockquote">
<p><a href="#scrollTo=1-7O4KHfNU-e">Process Overview</a></p>
</blockquote>
</blockquote>
<blockquote class="blockquote">
<blockquote class="blockquote">
<p><a href="#scrollTo=1-7O4KHfNU-e">What is ArgDown?</a></p>
</blockquote>
</blockquote>
<blockquote class="blockquote">
<blockquote class="blockquote">
<p><a href="#scrollTo=ESKnZ_4f_a6y">1.1 Specify Source Document (e.g.&nbsp;PDF)</a></p>
</blockquote>
</blockquote>
<blockquote class="blockquote">
<blockquote class="blockquote">
<p><a href="#scrollTo=6ToQFra3_nl9">1.2 Generate ArgDown Extraction Prompt</a></p>
</blockquote>
</blockquote>
<blockquote class="blockquote">
<blockquote class="blockquote">
<p><a href="#scrollTo=pGv2KcZU_9Bn">1.3 Prepare LLM API Call</a></p>
</blockquote>
</blockquote>
<blockquote class="blockquote">
<blockquote class="blockquote">
<p><a href="#scrollTo=i5xsDYnsAWC4">1.4 Make ArgDown Extraction LLM API Call</a></p>
</blockquote>
</blockquote>
<blockquote class="blockquote">
<blockquote class="blockquote">
<p><a href="#scrollTo=Lc2nMp8nAfeU">1.5 Save ArgDown Extraction Response</a></p>
</blockquote>
</blockquote>
<blockquote class="blockquote">
<blockquote class="blockquote">
<p><a href="#scrollTo=5HcCfqE4A0ht">1.6 Review and Check ArgDown.md File</a></p>
</blockquote>
</blockquote>
<blockquote class="blockquote">
<blockquote class="blockquote">
<p><a href="#scrollTo=gSpkvLbCC_PI">1.6.2 Check the Graph Structure with the ArgDown Sandbox Online</a></p>
</blockquote>
</blockquote>
<blockquote class="blockquote">
<blockquote class="blockquote">
<p><a href="#scrollTo=MAm0UKpeBvyr">1.7 Extract ArgDown Graph Information as DataFrame</a></p>
</blockquote>
</blockquote>
<blockquote class="blockquote">
<blockquote class="blockquote">
<p><a href="#scrollTo=iFC6oiyICREn">1.8 Store ArgDown Information as ‘ArgDown.csv’ file</a></p>
</blockquote>
</blockquote>
<blockquote class="blockquote">
<p><a href="#scrollTo=7SGB0XMp5VFq">2.0 Probability Extractions: ArgDown (.csv) to BayesDown (.md + plugin JSON syntax)</a></p>
</blockquote>
<blockquote class="blockquote">
<p><a href="#scrollTo=hWkmySZYNtzS">ArgDown to BayesDown: Adding Probability Information</a></p>
</blockquote>
<blockquote class="blockquote">
<blockquote class="blockquote">
<p><a href="#scrollTo=hWkmySZYNtzS">Process Overview</a></p>
</blockquote>
</blockquote>
<blockquote class="blockquote">
<blockquote class="blockquote">
<p><a href="#scrollTo=hWkmySZYNtzS">What is BayesDown?</a></p>
</blockquote>
</blockquote>
<blockquote class="blockquote">
<blockquote class="blockquote">
<p><a href="#scrollTo=WcF2nHXBZru4">2.1 Probability Extraction Questions — ‘ArgDown.csv’ to ‘ArgDown_WithQuestions.csv’</a></p>
</blockquote>
</blockquote>
<blockquote class="blockquote">
<blockquote class="blockquote">
<p><a href="#scrollTo=-q9UOQ8yaBZn">2.2 ‘ArgDown_WithQuestions.csv’ to ‘BayesDownQuestions.md’</a></p>
</blockquote>
</blockquote>
<blockquote class="blockquote">
<blockquote class="blockquote">
<p><a href="#scrollTo=Ux4OUCPue6Bu">2.3 Generate BayesDown Probability Extraction Prompt</a></p>
</blockquote>
</blockquote>
<blockquote class="blockquote">
<blockquote class="blockquote">
<p><a href="#scrollTo=ivcnd2ml41Nv">2.3.1 BayesDown Format Specification</a></p>
</blockquote>
</blockquote>
<blockquote class="blockquote">
<blockquote class="blockquote">
<blockquote class="blockquote">
<p><a href="#scrollTo=ivcnd2ml41Nv">Core Structure</a></p>
</blockquote>
</blockquote>
</blockquote>
<blockquote class="blockquote">
<blockquote class="blockquote">
<blockquote class="blockquote">
<blockquote class="blockquote">
<blockquote class="blockquote">
<p><a href="#scrollTo=Fn72WmgVEOH0">Rain-Sprinkler-Lawn Example</a></p>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
<blockquote class="blockquote">
<blockquote class="blockquote">
<p><a href="#scrollTo=d4tB9WD-fIWZ">2.4 Prepare 2nd API call</a></p>
</blockquote>
</blockquote>
<blockquote class="blockquote">
<blockquote class="blockquote">
<p><a href="#scrollTo=oPWto83lfN9Q">2.5 Make BayesDown Probability Extraction API Call</a></p>
</blockquote>
</blockquote>
<blockquote class="blockquote">
<blockquote class="blockquote">
<p><a href="#scrollTo=L8NWpz8MfZ9_">2.6 Save BayesDown with Probability Estimates (.csv)</a></p>
</blockquote>
</blockquote>
<blockquote class="blockquote">
<blockquote class="blockquote">
<p><a href="#scrollTo=Q3PTtYgRfsLa">2.7 Review &amp; Verify BayesDown Probability Estimates</a></p>
</blockquote>
</blockquote>
<blockquote class="blockquote">
<blockquote class="blockquote">
<p><a href="#scrollTo=VwoAgBsafonh">2.7.2 Check the Graph Structure with the ArgDown Sandbox Online</a></p>
</blockquote>
</blockquote>
<blockquote class="blockquote">
<blockquote class="blockquote">
<p><a href="#scrollTo=19KDn2mKf309">2.8 Extract BayesDown with Probability Estimates as Dataframe</a></p>
</blockquote>
</blockquote>
<blockquote class="blockquote">
<p><a href="#scrollTo=vUSS00TCEpeW">3.0 Data Extraction: BayesDown (.md) to Database (.csv)</a></p>
</blockquote>
<blockquote class="blockquote">
<p><a href="#scrollTo=vUSS00TCEpeW">BayesDown to Structured Data: Network Construction</a></p>
</blockquote>
<blockquote class="blockquote">
<blockquote class="blockquote">
<p><a href="#scrollTo=vUSS00TCEpeW">Extraction Pipeline Overview</a></p>
</blockquote>
</blockquote>
<blockquote class="blockquote">
<blockquote class="blockquote">
<blockquote class="blockquote">
<p><a href="#scrollTo=vUSS00TCEpeW">Theoretical Foundation</a></p>
</blockquote>
</blockquote>
</blockquote>
<blockquote class="blockquote">
<blockquote class="blockquote">
<blockquote class="blockquote">
<p><a href="#scrollTo=vUSS00TCEpeW">Role in Thesis Research</a></p>
</blockquote>
</blockquote>
</blockquote>
<blockquote class="blockquote">
<blockquote class="blockquote">
<blockquote class="blockquote">
<p><a href="#scrollTo=AFnu_1Ludahi">3.1 ExtractBayesDown-Data_v1</a></p>
</blockquote>
</blockquote>
</blockquote>
<blockquote class="blockquote">
<blockquote class="blockquote">
<p><a href="#scrollTo=eUBJh8Qp4yd4">3.1.2 Test BayesDown Extraction</a></p>
</blockquote>
</blockquote>
<blockquote class="blockquote">
<blockquote class="blockquote">
<p><a href="#scrollTo=z4Hgs0ICDQyW">3.1.2.2 Check the Graph Structure with the ArgDown Sandbox Online</a></p>
</blockquote>
</blockquote>
<blockquote class="blockquote">
<blockquote class="blockquote">
<p><a href="#scrollTo=mv8f4c4D3yJj">3.3 Extraction</a></p>
</blockquote>
</blockquote>
<blockquote class="blockquote">
<blockquote class="blockquote">
<blockquote class="blockquote">
<p><a href="#scrollTo=UcXf3fZ8dahj">3.3 Data-Post-Processing</a></p>
</blockquote>
</blockquote>
</blockquote>
<blockquote class="blockquote">
<blockquote class="blockquote">
<blockquote class="blockquote">
<p><a href="#scrollTo=xTwPO_J-dahj">3.4 Download and save finished data frame as .csv file</a></p>
</blockquote>
</blockquote>
</blockquote>
<blockquote class="blockquote">
<p><a href="#scrollTo=t3zl7vKMECMg">Analysis &amp; Inference: Bayesian Network Visualization</a></p>
</blockquote>
<blockquote class="blockquote">
<blockquote class="blockquote">
<p><a href="#scrollTo=t3zl7vKMECMg">Bayesian Network Visualization Approach</a></p>
</blockquote>
</blockquote>
<blockquote class="blockquote">
<blockquote class="blockquote">
<blockquote class="blockquote">
<p><a href="#scrollTo=t3zl7vKMECMg">Visualization Philosophy</a></p>
</blockquote>
</blockquote>
</blockquote>
<blockquote class="blockquote">
<blockquote class="blockquote">
<blockquote class="blockquote">
<p><a href="#scrollTo=t3zl7vKMECMg">Connection to AMTAIR Goals</a></p>
</blockquote>
</blockquote>
</blockquote>
<blockquote class="blockquote">
<blockquote class="blockquote">
<blockquote class="blockquote">
<p><a href="#scrollTo=t3zl7vKMECMg">Implementation Structure</a></p>
</blockquote>
</blockquote>
</blockquote>
<blockquote class="blockquote">
<blockquote class="blockquote">
<p><a href="#scrollTo=LSeSAPvtgIgU">Phase 1: Dependencies/Functions</a></p>
</blockquote>
</blockquote>
<blockquote class="blockquote">
<blockquote class="blockquote">
<p><a href="#scrollTo=byAExfek5yFU">Phase 2: Node Classification and Styling Module</a></p>
</blockquote>
</blockquote>
<blockquote class="blockquote">
<blockquote class="blockquote">
<p><a href="#scrollTo=gnS3jFGU52OZ">Phase 3: HTML Content Generation Module</a></p>
</blockquote>
</blockquote>
<blockquote class="blockquote">
<blockquote class="blockquote">
<p><a href="#scrollTo=d2uyG0Pi571f">Phase 4: Main Visualization Function</a></p>
</blockquote>
</blockquote>
<blockquote class="blockquote">
<p><a href="#scrollTo=bFtxTKmLElSF">Quickly check HTML Outputs</a></p>
</blockquote>
<blockquote class="blockquote">
<p><a href="#scrollTo=oatKYlKrOSiN">Conclusion: From Prototype to Production</a></p>
</blockquote>
<blockquote class="blockquote">
<blockquote class="blockquote">
<p><a href="#scrollTo=oatKYlKrOSiN">Summary of Achievements</a></p>
</blockquote>
</blockquote>
<blockquote class="blockquote">
<blockquote class="blockquote">
<p><a href="#scrollTo=oatKYlKrOSiN">Limitations and Future Work</a></p>
</blockquote>
</blockquote>
<blockquote class="blockquote">
<blockquote class="blockquote">
<p><a href="#scrollTo=oatKYlKrOSiN">Connection to AMTAIR Project</a></p>
</blockquote>
</blockquote>
<blockquote class="blockquote">
<p><a href="#scrollTo=kjbIj19epbrF">6.0 Save Outputs</a></p>
</blockquote>
<blockquote class="blockquote">
<p><a href="#scrollTo=0QqlN6dYpm4s">Saving and Exporting Results</a></p>
</blockquote>
<blockquote class="blockquote">
<blockquote class="blockquote">
<p><a href="#scrollTo=pS6AhdiSCLw4">Convert .ipynb Notebook to MarkDown</a></p>
</blockquote>
</blockquote>
</section>
<section id="key-concepts" class="level2">
<h2 class="anchored" data-anchor-id="key-concepts">Key Concepts:</h2>
<ul>
<li><strong>ArgDown</strong>: A structured format for representing arguments, with hierarchical relationships between statements.</li>
<li><strong>BayesDown</strong>: An extension of ArgDown that incorporates probabilistic information, allowing for Bayesian network construction.</li>
<li><strong>Extraction Pipeline</strong>: The process of converting unstructured text to structured argument representations.</li>
<li><strong>Bayesian Networks</strong>: Probabilistic graphical models that represent variables and their conditional dependencies.</li>
</ul>
</section>
<section id="example-workflow" class="level2">
<h2 class="anchored" data-anchor-id="example-workflow">Example Workflow:</h2>
<ol type="1">
<li>Load a sample ArgDown file from the repository</li>
<li>Extract the hierarchical structure and relationships</li>
<li>Add probabilistic information to create a BayesDown representation</li>
<li>Generate a Bayesian network visualization</li>
<li>Analyze conditional probabilities and risk pathways</li>
</ol>
</section>
<section id="troubleshooting" class="level2">
<h2 class="anchored" data-anchor-id="troubleshooting">Troubleshooting:</h2>
<ul>
<li>If connectivity issues occur, ensure you have access to the GitHub repository</li>
<li>For visualization errors, check that all required libraries are properly installed</li>
<li>When processing custom files, ensure they follow the expected format conventions</li>
</ul>
</section>
</section>
<section id="environment-setup-and-data-access" class="level1">
<h1>0. Environment Setup and Data Access</h1>
<p>This section establishes the technical foundation for the AMTAIR prototype by: 1. Installing and importing necessary libraries 2. Setting up access to the GitHub repository 3. Loading example data files</p>
<p>The environment setup is designed to be run once per session, with flags to prevent redundant installations and imports. This section forms the basis for the subsequent extraction and analysis steps in the pipeline.</p>
<p>The key goal is to create a reproducible environment where the Bayesian network extraction and visualization can be performed consistently, with appropriate error handling and resource management.</p>
</section>
<section id="prepare-colabpython-environment-import-libraries-packages" class="level1">
<h1>0.1 Prepare Colab/Python Environment — Import Libraries &amp; Packages</h1>
<div class="sourceCode" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># @title 0.1 --- Install &amp; Import Libraries &amp; Packages (One-Time Setup) ---</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co">BLOCK PURPOSE: Establishes the core technical environment for the AMTAIR prototype.</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co">Sets up all required libraries for Bayesian network processing, visualization, and data manipulation.</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="co">Uses a flag-based approach to ensure setup only runs once per session, enhancing efficiency.</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="co">The setup follows a three-stage process:</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="co">1. Install required packages not available in Colab by default</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="co">2. Import all necessary libraries with error handling</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="co">3. Set a global flag to prevent redundant execution</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="co">DEPENDENCIES: Requires internet connection for package installation</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="co">OUTPUTS: Global variable _setup_imports_done and loaded Python libraries</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="co">#  Check if setup has already been completed in this session using environment flag</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If this variable exists, setup was already done successfully</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>    _setup_imports_done</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"✅ Libraries already installed and imported in this session. Skipping setup."</span>)</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">NameError</span>:</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"⏳ Performing one-time library installation and imports..."</span>)</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --- STAGE 1: Install required packages ---</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Install visualization and network analysis libraries</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>    <span class="op">!</span>pip install <span class="op">-</span>q pyvis  <span class="co"># Network visualization library</span></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>    <span class="op">!</span>apt<span class="op">-</span>get install pandoc <span class="op">-</span>y  <span class="co"># Document conversion utility</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Install Google API and data processing packages</span></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>    <span class="op">!</span>pip install <span class="op">-</span>q <span class="op">--</span>upgrade gspread pandas google<span class="op">-</span>auth google<span class="op">-</span>colab  <span class="co"># Data manipulation and Google integration</span></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Install Bayesian network and probabilistic modeling tools</span></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>    <span class="op">!</span>pip install <span class="op">-</span>q pgmpy  <span class="co"># Probabilistic graphical models library</span></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Install notebook conversion tools</span></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>    <span class="op">!</span>pip install <span class="op">-</span>q nbconvert  <span class="co"># Often pre-installed, but ensures availability</span></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"   --&gt; Installations complete."</span>)</span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --- STAGE 2: Import libraries with error handling ---</span></span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Network and HTTP libraries</span></span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>        <span class="im">import</span> requests      <span class="co"># For making HTTP requests to APIs and GitHub</span></span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>        <span class="im">import</span> io            <span class="co"># For handling in-memory file-like objects</span></span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Data processing libraries</span></span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>        <span class="im">import</span> pandas <span class="im">as</span> pd  <span class="co"># For structured data manipulation</span></span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a>        <span class="im">import</span> numpy <span class="im">as</span> np   <span class="co"># For numerical operations</span></span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a>        <span class="im">import</span> json          <span class="co"># For JSON parsing and serialization</span></span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a>        <span class="im">import</span> re            <span class="co"># For regular expression pattern matching</span></span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Visualization libraries</span></span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a>        <span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt  <span class="co"># For creating plots and charts</span></span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a>        <span class="im">from</span> IPython.display <span class="im">import</span> HTML, display, Markdown  <span class="co"># For rich output in notebook</span></span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a>        <span class="co"># --- Specialized libraries requiring installation ---</span></span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Network analysis library</span></span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a>        <span class="im">import</span> networkx <span class="im">as</span> nx  <span class="co"># For graph representation and analysis</span></span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Probabilistic modeling libraries</span></span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a>        <span class="im">from</span> pgmpy.models <span class="im">import</span> BayesianNetwork  <span class="co"># For Bayesian network structure</span></span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a>        <span class="im">from</span> pgmpy.factors.discrete <span class="im">import</span> TabularCPD  <span class="co"># For conditional probability tables</span></span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a>        <span class="im">from</span> pgmpy.inference <span class="im">import</span> VariableElimination  <span class="co"># For probabilistic inference</span></span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Interactive network visualization</span></span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a>        <span class="im">from</span> pyvis.network <span class="im">import</span> Network  <span class="co"># For interactive network visualization</span></span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Output version information for key libraries</span></span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"      pandas version: </span><span class="sc">{</span>pd<span class="sc">.</span>__version__<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-72"><a href="#cb1-72" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"      networkx version: </span><span class="sc">{</span>nx<span class="sc">.</span>__version__<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-73"><a href="#cb1-73" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add others if specific versions are critical</span></span>
<span id="cb1-74"><a href="#cb1-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-75"><a href="#cb1-75" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"   --&gt; Imports complete."</span>)</span>
<span id="cb1-76"><a href="#cb1-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-77"><a href="#cb1-77" aria-hidden="true" tabindex="-1"></a>        <span class="co"># --- STAGE 3: Set flag to indicate successful setup ---</span></span>
<span id="cb1-78"><a href="#cb1-78" aria-hidden="true" tabindex="-1"></a>        _setup_imports_done <span class="op">=</span> <span class="va">True</span></span>
<span id="cb1-79"><a href="#cb1-79" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"✅ One-time setup finished successfully."</span>)</span>
<span id="cb1-80"><a href="#cb1-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-81"><a href="#cb1-81" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">ImportError</span> <span class="im">as</span> e:</span>
<span id="cb1-82"><a href="#cb1-82" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Handle specific import failures</span></span>
<span id="cb1-83"><a href="#cb1-83" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"❌ ERROR during import: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-84"><a href="#cb1-84" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"   --&gt; Setup did not complete successfully. Please check installations."</span>)</span>
<span id="cb1-85"><a href="#cb1-85" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb1-86"><a href="#cb1-86" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Handle unexpected errors</span></span>
<span id="cb1-87"><a href="#cb1-87" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"❌ UNEXPECTED ERROR during setup: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-88"><a href="#cb1-88" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"   --&gt; Setup did not complete successfully."</span>)</span>
<span id="cb1-89"><a href="#cb1-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-90"><a href="#cb1-90" aria-hidden="true" tabindex="-1"></a><span class="co"># Environment is now ready for AMTAIR processing</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<section id="connect-to-github-repository" class="level2">
<h2 class="anchored" data-anchor-id="connect-to-github-repository">0.2 Connect to GitHub Repository</h2>
<p>The Public GitHub Repo Url in use:</p>
<p>https://raw.githubusercontent.com/SingularitySmith/AMTAIR_Prototype/main/</p>
<p>Note: When encountering errors, accessing the data, try using “RAW” Urls.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># @title 0.2 --- Connect to GitHub Repository --- Load Files</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co">BLOCK PURPOSE: Establishes connection to the AMTAIR GitHub repository and provides</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co">functions to load example data files for processing.</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="co">This block creates a reusable function for accessing files from the project's</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="co">GitHub repository, enabling access to example files like the rain-sprinkler-lawn</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="co">Bayesian network that serves as our canonical test case.</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="co">DEPENDENCIES: requests library, io library</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="co">OUTPUTS: load_file_from_repo function and test file loads</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> requests.exceptions <span class="im">import</span> HTTPError</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Specify the base repository URL for the AMTAIR project</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>repo_url <span class="op">=</span> <span class="st">"https://raw.githubusercontent.com/SingularitySmith/AMTAIR_Prototype/main/data/example_carlsmith/"</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Connecting to repository: </span><span class="sc">{</span>repo_url<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> load_file_from_repo(relative_path):</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a><span class="co">    Loads a file from the specified GitHub repository using a relative path.</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a><span class="co">        relative_path (str): Path to the file relative to the repo_url</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a><span class="co">        For CSV/JSON: pandas DataFrame</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a><span class="co">        For MD: string containing file contents</span></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a><span class="co">    Raises:</span></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a><span class="co">        HTTPError: If file not found or other HTTP error occurs</span></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a><span class="co">        ValueError: If unsupported file type is requested</span></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>    file_url <span class="op">=</span> repo_url <span class="op">+</span> relative_path</span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Attempting to load: </span><span class="sc">{</span>file_url<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fetch the file content from GitHub</span></span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> requests.get(file_url)</span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check for bad status codes with enhanced error messages</span></span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> response.status_code <span class="op">==</span> <span class="dv">404</span>:</span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> HTTPError(<span class="ss">f"File not found at URL: </span><span class="sc">{</span>file_url<span class="sc">}</span><span class="ss">. Check the file path/name and ensure the file is publicly accessible."</span>, response<span class="op">=</span>response)</span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>        response.raise_for_status()  <span class="co"># Raise for other error codes</span></span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert response to file-like object</span></span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a>    file_object <span class="op">=</span> io.StringIO(response.text)</span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Process different file types appropriately</span></span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> relative_path.endswith(<span class="st">".csv"</span>):</span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.read_csv(file_object)  <span class="co"># Return DataFrame for CSV</span></span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> relative_path.endswith(<span class="st">".json"</span>):</span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.read_json(file_object)  <span class="co"># Return DataFrame for JSON</span></span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> relative_path.endswith(<span class="st">".md"</span>):</span>
<span id="cb2-57"><a href="#cb2-57" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> file_object.read()  <span class="co"># Return raw content for MD files</span></span>
<span id="cb2-58"><a href="#cb2-58" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb2-59"><a href="#cb2-59" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"Unsupported file type: </span><span class="sc">{</span>relative_path<span class="sc">.</span>split(<span class="st">'.'</span>)[<span class="op">-</span><span class="dv">1</span>]<span class="sc">}</span><span class="ss">. Add support in the GitHub Connection section of this notebook."</span>)</span>
<span id="cb2-60"><a href="#cb2-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-61"><a href="#cb2-61" aria-hidden="true" tabindex="-1"></a><span class="co"># Load example files to test connection</span></span>
<span id="cb2-62"><a href="#cb2-62" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb2-63"><a href="#cb2-63" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load the extracted data CSV file</span></span>
<span id="cb2-64"><a href="#cb2-64" aria-hidden="true" tabindex="-1"></a><span class="co">#    df = load_file_from_repo("extracted_data.csv")</span></span>
<span id="cb2-65"><a href="#cb2-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-66"><a href="#cb2-66" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load the ArgDown test text</span></span>
<span id="cb2-67"><a href="#cb2-67" aria-hidden="true" tabindex="-1"></a>    md_content <span class="op">=</span> load_file_from_repo(<span class="st">"ArgDown.md"</span>)</span>
<span id="cb2-68"><a href="#cb2-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-69"><a href="#cb2-69" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"✅ Successfully connected to repository and loaded test files."</span>)</span>
<span id="cb2-70"><a href="#cb2-70" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb2-71"><a href="#cb2-71" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"❌ Error loading files: </span><span class="sc">{</span><span class="bu">str</span>(e)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb2-72"><a href="#cb2-72" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Please check your internet connection and the repository URL."</span>)</span>
<span id="cb2-73"><a href="#cb2-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-74"><a href="#cb2-74" aria-hidden="true" tabindex="-1"></a><span class="co"># Display preview of loaded content (commented out to avoid cluttering output)</span></span>
<span id="cb2-75"><a href="#cb2-75" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(md_content)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="file-import" class="level2">
<h2 class="anchored" data-anchor-id="file-import">0.3 File Import</h2>
<div class="sourceCode" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># @title</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>md_content</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="sources-pdfs-of-papers-to-argdown-.md-file" class="level1">
<h1>1.0 Sources (PDF’s of Papers) to ArgDown (.md file)</h1>
</section>
<section id="sources-to-argdown-structured-argument-extraction" class="level1">
<h1>1. Sources to ArgDown: Structured Argument Extraction</h1>
<section id="process-overview" class="level2">
<h2 class="anchored" data-anchor-id="process-overview">Process Overview</h2>
<p>This section implements the first major stage of the AMTAIR pipeline: transforming source documents (such as research papers, blog posts, or expert analyses) into structured argument representations using the ArgDown format.</p>
<p>ArgDown is a markdown-like notation for representing arguments in a hierarchical structure. In the context of AMTAIR, it serves as the first step toward creating formal Bayesian networks by: 1. Identifying key variables/statements in the text 2. Capturing their hierarchical relationships 3. Preserving their descriptive content 4. Defining their possible states (instantiations)</p>
<p>The extraction process uses Large Language Models (LLMs) to identify the structure and relationships in the text, though in this notebook we focus on processing pre-formatted examples rather than performing the full extraction from raw text.</p>
</section>
<section id="what-is-argdown" class="level2">
<h2 class="anchored" data-anchor-id="what-is-argdown">What is ArgDown?</h2>
<p>ArgDown uses a simple syntax where: - Statements are represented as <code>[Statement]: Description</code> - Relationships are indicated with <code>+</code> symbols and indentation - Metadata is added in JSON format, including possible states of each variable</p>
<p>For example:</p>
<pre><code>[MainClaim]: Description of the main claim. {"instantiations": ["claim_TRUE", "claim_FALSE"]}

 + [SupportingEvidence]: Description of evidence. {"instantiations": ["evidence_TRUE", "evidence_FALSE"]}</code></pre>
<p>This structure will later be enhanced with probability information to create BayesDown, which can be transformed into a Bayesian network for analysis and visualization.</p>
</section>
<section id="specify-source-document-e.g.-pdf" class="level2">
<h2 class="anchored" data-anchor-id="specify-source-document-e.g.-pdf">1.1 Specify Source Document (e.g.&nbsp;PDF)</h2>
<p>Review the source document, ensure it is suitable for API call and upload to / store it in the correct location.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># @title 1.1.a) --- MTAIR Online Model (Analytica) ---</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> IPython.display <span class="im">import</span> IFrame</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>IFrame(src<span class="op">=</span><span class="st">"https://acp.analytica.com/view0?invite=4560&amp;code=3000289064591444815"</span>, width<span class="op">=</span><span class="st">"100%"</span>, height<span class="op">=</span><span class="st">"900px"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="generate-argdown-extraction-prompt" class="level2">
<h2 class="anchored" data-anchor-id="generate-argdown-extraction-prompt">1.2 Generate ArgDown Extraction Prompt</h2>
<p>Generate Extraction Prompt</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># @title 1.2.0 --- Prompt Template Function Definitions ---</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="co">BLOCK PURPOSE: Defines a flexible template system for LLM prompts used in the extraction pipeline.</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="co">This block implements two key classes:</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="co">1. PromptTemplate: A simple template class supporting variable substitution for dynamic prompts</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="co">2. PromptLibrary: A collection of pre-defined prompt templates for different extraction tasks</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="co">These templates are used in the ArgDown extraction and BayesDown probability extraction</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="co">stages of the pipeline, providing consistent and well-structured prompts to the LLMs.</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="co">DEPENDENCIES: string.Template for variable substitution</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a><span class="co">OUTPUTS: PromptTemplate and PromptLibrary classes</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> string <span class="im">import</span> Template</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Dict, Optional, Union, List</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> PromptTemplate:</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Template system for LLM prompts with variable substitution"""</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, template: <span class="bu">str</span>):</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Initialize with template string using $variable format"""</span></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.template <span class="op">=</span> Template(template)</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="bu">format</span>(<span class="va">self</span>, <span class="op">**</span>kwargs) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Substitute variables in the template"""</span></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.template.safe_substitute(<span class="op">**</span>kwargs)</span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">@classmethod</span></span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> from_file(cls, filepath: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="st">'PromptTemplate'</span>:</span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Load template from a file"""</span></span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> <span class="bu">open</span>(filepath, <span class="st">'r'</span>) <span class="im">as</span> f:</span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>            template <span class="op">=</span> f.read()</span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> cls(template)</span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> PromptLibrary:</span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Collection of prompt templates for different extraction tasks"""</span></span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ArgDown extraction prompt - transforms source text into structured argument map</span></span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a>    ARGDOWN_EXTRACTION <span class="op">=</span> PromptTemplate(<span class="st">"""</span></span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a><span class="st">You are participating in the AMTAIR (Automating Transformative AI Risk Modeling) project and you are tasked with converting natural language arguments into ArgDown syntax by extracting and formalizing causal world models from unstructured text.</span></span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a><span class="st">Your specific task is to extract the implicit causal model from the provided document in structured ArgDown format.</span></span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a><span class="st">## Epistemic Foundation &amp; Purpose</span></span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a><span class="st">This extraction represents one possible interpretation of the implicit causal model in the document. Multiple extractions from the same text help reveal patterns of convergence (where the model is clearly articulated) and divergence (where the model contains ambiguities). This approach acknowledges that expert texts often contain implicit rather than explicit causal models.</span></span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-50"><a href="#cb6-50" aria-hidden="true" tabindex="-1"></a><span class="st">Your role is to reveal the causal structure already present in the author's thinking, maintaining epistemic humility about your interpretation while adhering strictly to the required format.</span></span>
<span id="cb6-51"><a href="#cb6-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-52"><a href="#cb6-52" aria-hidden="true" tabindex="-1"></a><span class="st">## ArgDown Format Specification</span></span>
<span id="cb6-53"><a href="#cb6-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-54"><a href="#cb6-54" aria-hidden="true" tabindex="-1"></a><span class="st">### Core Syntax</span></span>
<span id="cb6-55"><a href="#cb6-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-56"><a href="#cb6-56" aria-hidden="true" tabindex="-1"></a><span class="st">ArgDown represents causal relationships using a hierarchical structure:</span></span>
<span id="cb6-57"><a href="#cb6-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-58"><a href="#cb6-58" aria-hidden="true" tabindex="-1"></a><span class="st">1. Variables appear in square brackets with descriptive text:</span></span>
<span id="cb6-59"><a href="#cb6-59" aria-hidden="true" tabindex="-1"></a><span class="st">   `[Variable_Name]: Description of the variable.`</span></span>
<span id="cb6-60"><a href="#cb6-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-61"><a href="#cb6-61" aria-hidden="true" tabindex="-1"></a><span class="st">2. Causal relationships use indentation (2 spaces per level) and '+' symbols:</span></span>
<span id="cb6-62"><a href="#cb6-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-63"><a href="#cb6-63" aria-hidden="true" tabindex="-1"></a><span class="st">[Effect]: Description of effect. + [Cause]: Description of cause. + [Deeper_Cause]: Description of deeper cause.</span></span>
<span id="cb6-64"><a href="#cb6-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-65"><a href="#cb6-65" aria-hidden="true" tabindex="-1"></a><span class="st">3. Causality flows from bottom (more indented) to top (less indented):</span></span>
<span id="cb6-66"><a href="#cb6-66" aria-hidden="true" tabindex="-1"></a><span class="st">- More indented variables (causes) influence less indented variables (effects)</span></span>
<span id="cb6-67"><a href="#cb6-67" aria-hidden="true" tabindex="-1"></a><span class="st">- The top-level variable is the ultimate effect or outcome</span></span>
<span id="cb6-68"><a href="#cb6-68" aria-hidden="true" tabindex="-1"></a><span class="st">- Deeper indentation levels represent root causes or earlier factors</span></span>
<span id="cb6-69"><a href="#cb6-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-70"><a href="#cb6-70" aria-hidden="true" tabindex="-1"></a><span class="st">4. Each variable must include JSON metadata with possible states (instantiations):</span></span>
<span id="cb6-71"><a href="#cb6-71" aria-hidden="true" tabindex="-1"></a><span class="st">`[Variable]: Description. {"instantiations": ["variable_STATE1", "variable_STATE2"]}`</span></span>
<span id="cb6-72"><a href="#cb6-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-73"><a href="#cb6-73" aria-hidden="true" tabindex="-1"></a><span class="st">### JSON Metadata Format</span></span>
<span id="cb6-74"><a href="#cb6-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-75"><a href="#cb6-75" aria-hidden="true" tabindex="-1"></a><span class="st">The JSON metadata must follow this exact structure:</span></span>
<span id="cb6-76"><a href="#cb6-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-77"><a href="#cb6-77" aria-hidden="true" tabindex="-1"></a><span class="st">```json</span></span>
<span id="cb6-78"><a href="#cb6-78" aria-hidden="true" tabindex="-1"></a><span class="st">{"instantiations": ["variable_STATE1", "variable_STATE2"]}</span></span>
<span id="cb6-79"><a href="#cb6-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-80"><a href="#cb6-80" aria-hidden="true" tabindex="-1"></a><span class="st">Requirements:</span></span>
<span id="cb6-81"><a href="#cb6-81" aria-hidden="true" tabindex="-1"></a><span class="st">* Double quotes (not single) around field names and string values</span></span>
<span id="cb6-82"><a href="#cb6-82" aria-hidden="true" tabindex="-1"></a><span class="st">* Square brackets enclosing the instantiations array</span></span>
<span id="cb6-83"><a href="#cb6-83" aria-hidden="true" tabindex="-1"></a><span class="st">* Comma separation between array elements</span></span>
<span id="cb6-84"><a href="#cb6-84" aria-hidden="true" tabindex="-1"></a><span class="st">* No trailing comma after the last element</span></span>
<span id="cb6-85"><a href="#cb6-85" aria-hidden="true" tabindex="-1"></a><span class="st">* Must be valid JSON syntax that can be parsed by standard JSON parsers</span></span>
<span id="cb6-86"><a href="#cb6-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-87"><a href="#cb6-87" aria-hidden="true" tabindex="-1"></a><span class="st">For binary variables (most common case):</span></span>
<span id="cb6-88"><a href="#cb6-88" aria-hidden="true" tabindex="-1"></a><span class="st">{"instantiations": ["variable_TRUE", "variable_FALSE"]}</span></span>
<span id="cb6-89"><a href="#cb6-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-90"><a href="#cb6-90" aria-hidden="true" tabindex="-1"></a><span class="st">For multi-state variables (when clearly specified in the text):</span></span>
<span id="cb6-91"><a href="#cb6-91" aria-hidden="true" tabindex="-1"></a><span class="st">{"instantiations": ["variable_HIGH", "variable_MEDIUM", "variable_LOW"]}</span></span>
<span id="cb6-92"><a href="#cb6-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-93"><a href="#cb6-93" aria-hidden="true" tabindex="-1"></a><span class="st">The metadata must appear on the same line as the variable definition, after the description.</span></span>
<span id="cb6-94"><a href="#cb6-94" aria-hidden="true" tabindex="-1"></a><span class="st">## Complex Structural Patterns</span></span>
<span id="cb6-95"><a href="#cb6-95" aria-hidden="true" tabindex="-1"></a><span class="st">### Variables Influencing Multiple Effects</span></span>
<span id="cb6-96"><a href="#cb6-96" aria-hidden="true" tabindex="-1"></a><span class="st">The same variable can appear multiple times in different places in the hierarchy if it influences multiple effects:</span></span>
<span id="cb6-97"><a href="#cb6-97" aria-hidden="true" tabindex="-1"></a><span class="st">[Effect1]: First effect description. {"instantiations": ["effect1_TRUE", "effect1_FALSE"]}</span></span>
<span id="cb6-98"><a href="#cb6-98" aria-hidden="true" tabindex="-1"></a><span class="st">  + [Cause_A]: Description of cause A. {"instantiations": ["cause_a_TRUE", "cause_a_FALSE"]}</span></span>
<span id="cb6-99"><a href="#cb6-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-100"><a href="#cb6-100" aria-hidden="true" tabindex="-1"></a><span class="st">[Effect2]: Second effect description. {"instantiations": ["effect2_TRUE", "effect2_FALSE"]}</span></span>
<span id="cb6-101"><a href="#cb6-101" aria-hidden="true" tabindex="-1"></a><span class="st">  + [Cause_A]</span></span>
<span id="cb6-102"><a href="#cb6-102" aria-hidden="true" tabindex="-1"></a><span class="st">  + [Cause_B]: Description of cause B. {"instantiations": ["cause_b_TRUE", "cause_b_FALSE"]}</span></span>
<span id="cb6-103"><a href="#cb6-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-104"><a href="#cb6-104" aria-hidden="true" tabindex="-1"></a><span class="st">### Multiple Causes of the Same Effect</span></span>
<span id="cb6-105"><a href="#cb6-105" aria-hidden="true" tabindex="-1"></a><span class="st">Multiple causes can influence the same effect by being listed at the same indentation level:</span></span>
<span id="cb6-106"><a href="#cb6-106" aria-hidden="true" tabindex="-1"></a><span class="st">[Effect]: Description of effect. {"instantiations": ["effect_TRUE", "effect_FALSE"]}</span></span>
<span id="cb6-107"><a href="#cb6-107" aria-hidden="true" tabindex="-1"></a><span class="st">  + [Cause1]: Description of first cause. {"instantiations": ["cause1_TRUE", "cause1_FALSE"]}</span></span>
<span id="cb6-108"><a href="#cb6-108" aria-hidden="true" tabindex="-1"></a><span class="st">  + [Cause2]: Description of second cause. {"instantiations": ["cause2_TRUE", "cause2_FALSE"]}</span></span>
<span id="cb6-109"><a href="#cb6-109" aria-hidden="true" tabindex="-1"></a><span class="st">    + [Deeper_Cause]: A cause that influences Cause2. {"instantiations": ["deeper_cause_TRUE", "deeper_cause_FALSE"]}</span></span>
<span id="cb6-110"><a href="#cb6-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-111"><a href="#cb6-111" aria-hidden="true" tabindex="-1"></a><span class="st">### Causal Chains</span></span>
<span id="cb6-112"><a href="#cb6-112" aria-hidden="true" tabindex="-1"></a><span class="st">Causal chains are represented through multiple levels of indentation:</span></span>
<span id="cb6-113"><a href="#cb6-113" aria-hidden="true" tabindex="-1"></a><span class="st">[Ultimate_Effect]: The final outcome. {"instantiations": ["ultimate_effect_TRUE", "ultimate_effect_FALSE"]}</span></span>
<span id="cb6-114"><a href="#cb6-114" aria-hidden="true" tabindex="-1"></a><span class="st">  + [Intermediate_Effect]: A mediating variable. {"instantiations": ["intermediate_effect_TRUE", "intermediate_effect_FALSE"]}</span></span>
<span id="cb6-115"><a href="#cb6-115" aria-hidden="true" tabindex="-1"></a><span class="st">    + [Root_Cause]: The initial cause. {"instantiations": ["root_cause_TRUE", "root_cause_FALSE"]}</span></span>
<span id="cb6-116"><a href="#cb6-116" aria-hidden="true" tabindex="-1"></a><span class="st">  + [2nd_Intermediate_Effect]: A mediating variable. {"instantiations": ["intermediate_effect_TRUE", "intermediate_effect_FALSE"]}</span></span>
<span id="cb6-117"><a href="#cb6-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-118"><a href="#cb6-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-119"><a href="#cb6-119" aria-hidden="true" tabindex="-1"></a><span class="st">### Common Cause of Multiple Variables</span></span>
<span id="cb6-120"><a href="#cb6-120" aria-hidden="true" tabindex="-1"></a><span class="st">A common cause affecting multiple variables is represented by referencing the same variable in multiple places:</span></span>
<span id="cb6-121"><a href="#cb6-121" aria-hidden="true" tabindex="-1"></a><span class="st">[Effect1]: First effect description. {"instantiations": ["effect1_TRUE", "effect1_FALSE"]}</span></span>
<span id="cb6-122"><a href="#cb6-122" aria-hidden="true" tabindex="-1"></a><span class="st">  + [Common_Cause]: Description of common cause. {"instantiations": ["common_cause_TRUE", "common_cause_FALSE"]}</span></span>
<span id="cb6-123"><a href="#cb6-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-124"><a href="#cb6-124" aria-hidden="true" tabindex="-1"></a><span class="st">[Effect2]: Second effect description. {"instantiations": ["effect2_TRUE", "effect2_FALSE"]}</span></span>
<span id="cb6-125"><a href="#cb6-125" aria-hidden="true" tabindex="-1"></a><span class="st">  + [Common_Cause]</span></span>
<span id="cb6-126"><a href="#cb6-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-127"><a href="#cb6-127" aria-hidden="true" tabindex="-1"></a><span class="st">## Detailed Extraction Workflow</span></span>
<span id="cb6-128"><a href="#cb6-128" aria-hidden="true" tabindex="-1"></a><span class="st">Please follow this step-by-step process, documenting your reasoning in XML tags:</span></span>
<span id="cb6-129"><a href="#cb6-129" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;analysis&gt;</span></span>
<span id="cb6-130"><a href="#cb6-130" aria-hidden="true" tabindex="-1"></a><span class="st">First, conduct a holistic analysis of the document:</span></span>
<span id="cb6-131"><a href="#cb6-131" aria-hidden="true" tabindex="-1"></a><span class="st">1. Identify the main subject matter or domain</span></span>
<span id="cb6-132"><a href="#cb6-132" aria-hidden="true" tabindex="-1"></a><span class="st">2. Note key concepts, variables, and factors discussed</span></span>
<span id="cb6-133"><a href="#cb6-133" aria-hidden="true" tabindex="-1"></a><span class="st">3. Pay attention to language indicating causal relationships (causes, affects, influences, depends on, etc.)</span></span>
<span id="cb6-134"><a href="#cb6-134" aria-hidden="true" tabindex="-1"></a><span class="st">4. Look for the ultimate outcomes or effects that are the focus of the document</span></span>
<span id="cb6-135"><a href="#cb6-135" aria-hidden="true" tabindex="-1"></a><span class="st">5. Record your general understanding of the document's implicit causal structure</span></span>
<span id="cb6-136"><a href="#cb6-136" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/analysis&gt;</span></span>
<span id="cb6-137"><a href="#cb6-137" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;variable_identification&gt;</span></span>
<span id="cb6-138"><a href="#cb6-138" aria-hidden="true" tabindex="-1"></a><span class="st">Next, identify and list the key variables in the causal model:</span></span>
<span id="cb6-139"><a href="#cb6-139" aria-hidden="true" tabindex="-1"></a><span class="st">* Focus on factors that are discussed as having an influence or being influenced</span></span>
<span id="cb6-140"><a href="#cb6-140" aria-hidden="true" tabindex="-1"></a><span class="st">* For each variable:</span></span>
<span id="cb6-141"><a href="#cb6-141" aria-hidden="true" tabindex="-1"></a><span class="st">  * Create a descriptive name in [square_brackets]</span></span>
<span id="cb6-142"><a href="#cb6-142" aria-hidden="true" tabindex="-1"></a><span class="st">  * Write a concise description based directly on the text</span></span>
<span id="cb6-143"><a href="#cb6-143" aria-hidden="true" tabindex="-1"></a><span class="st">  * Determine possible states (usually binary TRUE/FALSE unless clearly specified)</span></span>
<span id="cb6-144"><a href="#cb6-144" aria-hidden="true" tabindex="-1"></a><span class="st">* Distinguish between:</span></span>
<span id="cb6-145"><a href="#cb6-145" aria-hidden="true" tabindex="-1"></a><span class="st">  * Outcome variables (effects the author is concerned with)</span></span>
<span id="cb6-146"><a href="#cb6-146" aria-hidden="true" tabindex="-1"></a><span class="st">  * Intermediate variables (both causes and effects in chains)</span></span>
<span id="cb6-147"><a href="#cb6-147" aria-hidden="true" tabindex="-1"></a><span class="st">  * Root cause variables (exogenous factors in the model)</span></span>
<span id="cb6-148"><a href="#cb6-148" aria-hidden="true" tabindex="-1"></a><span class="st">* List all identified variables with their descriptions and possible states</span></span>
<span id="cb6-149"><a href="#cb6-149" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/variable_identification&gt;</span></span>
<span id="cb6-150"><a href="#cb6-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-151"><a href="#cb6-151" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;causal_structure&gt;</span></span>
<span id="cb6-152"><a href="#cb6-152" aria-hidden="true" tabindex="-1"></a><span class="st">Then, determine the causal relationships between variables:</span></span>
<span id="cb6-153"><a href="#cb6-153" aria-hidden="true" tabindex="-1"></a><span class="st">* For each variable, identify what factors influence it</span></span>
<span id="cb6-154"><a href="#cb6-154" aria-hidden="true" tabindex="-1"></a><span class="st">* Note the direction of causality (what causes what)</span></span>
<span id="cb6-155"><a href="#cb6-155" aria-hidden="true" tabindex="-1"></a><span class="st">* Look for mediating variables in causal chains</span></span>
<span id="cb6-156"><a href="#cb6-156" aria-hidden="true" tabindex="-1"></a><span class="st">* Identify common causes of multiple effects</span></span>
<span id="cb6-157"><a href="#cb6-157" aria-hidden="true" tabindex="-1"></a><span class="st">* Capture feedback loops if present (though they must be represented as DAGs)</span></span>
<span id="cb6-158"><a href="#cb6-158" aria-hidden="true" tabindex="-1"></a><span class="st">* Map out the hierarchical structure of the causal model</span></span>
<span id="cb6-159"><a href="#cb6-159" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/causal_structure&gt;</span></span>
<span id="cb6-160"><a href="#cb6-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-161"><a href="#cb6-161" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;format_conversion&gt;</span></span>
<span id="cb6-162"><a href="#cb6-162" aria-hidden="true" tabindex="-1"></a><span class="st">Now, convert your analysis into proper ArgDown format:</span></span>
<span id="cb6-163"><a href="#cb6-163" aria-hidden="true" tabindex="-1"></a><span class="st">* Start with the ultimate outcome variables at the top level</span></span>
<span id="cb6-164"><a href="#cb6-164" aria-hidden="true" tabindex="-1"></a><span class="st">* Place direct causes indented below with </span><span class="er">\</span><span class="st">+ symbols</span></span>
<span id="cb6-165"><a href="#cb6-165" aria-hidden="true" tabindex="-1"></a><span class="st">* Continue with deeper causes at further indentation levels</span></span>
<span id="cb6-166"><a href="#cb6-166" aria-hidden="true" tabindex="-1"></a><span class="st">* Add variable descriptions and instantiations metadata</span></span>
<span id="cb6-167"><a href="#cb6-167" aria-hidden="true" tabindex="-1"></a><span class="st">* Ensure variables appearing in multiple places have consistent names</span></span>
<span id="cb6-168"><a href="#cb6-168" aria-hidden="true" tabindex="-1"></a><span class="st">* Check that the entire structure forms a valid directed acyclic graph</span></span>
<span id="cb6-169"><a href="#cb6-169" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/format_conversion&gt;</span></span>
<span id="cb6-170"><a href="#cb6-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-171"><a href="#cb6-171" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;validation&gt;</span></span>
<span id="cb6-172"><a href="#cb6-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-173"><a href="#cb6-173" aria-hidden="true" tabindex="-1"></a><span class="st">Finally, review your extraction for quality and format correctness:</span></span>
<span id="cb6-174"><a href="#cb6-174" aria-hidden="true" tabindex="-1"></a><span class="st">1. Verify all variables have properly formatted metadata</span></span>
<span id="cb6-175"><a href="#cb6-175" aria-hidden="true" tabindex="-1"></a><span class="st">2. Check that indentation properly represents causal direction</span></span>
<span id="cb6-176"><a href="#cb6-176" aria-hidden="true" tabindex="-1"></a><span class="st">3. Confirm the extraction accurately reflects the document's implicit model</span></span>
<span id="cb6-177"><a href="#cb6-177" aria-hidden="true" tabindex="-1"></a><span class="st">4. Ensure no cycles exist in the causal structure</span></span>
<span id="cb6-178"><a href="#cb6-178" aria-hidden="true" tabindex="-1"></a><span class="st">5. Verify that variables referenced multiple times are consistent</span></span>
<span id="cb6-179"><a href="#cb6-179" aria-hidden="true" tabindex="-1"></a><span class="st">6. Check that the extraction would be useful for subsequent analysis</span></span>
<span id="cb6-180"><a href="#cb6-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-181"><a href="#cb6-181" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/validation&gt;</span></span>
<span id="cb6-182"><a href="#cb6-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-183"><a href="#cb6-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-184"><a href="#cb6-184" aria-hidden="true" tabindex="-1"></a><span class="st">## Source Document Analysis Guidance</span></span>
<span id="cb6-185"><a href="#cb6-185" aria-hidden="true" tabindex="-1"></a><span class="st">When analyzing the source document:</span></span>
<span id="cb6-186"><a href="#cb6-186" aria-hidden="true" tabindex="-1"></a><span class="st">* Focus on revealing the author's own causal model, not imposing an external framework</span></span>
<span id="cb6-187"><a href="#cb6-187" aria-hidden="true" tabindex="-1"></a><span class="st">* Maintain the author's terminology where possible</span></span>
<span id="cb6-188"><a href="#cb6-188" aria-hidden="true" tabindex="-1"></a><span class="st">* Look for both explicit statements of causality and implicit assumptions</span></span>
<span id="cb6-189"><a href="#cb6-189" aria-hidden="true" tabindex="-1"></a><span class="st">* Pay attention to the relative importance the author assigns to different factors</span></span>
<span id="cb6-190"><a href="#cb6-190" aria-hidden="true" tabindex="-1"></a><span class="st">* Notice where the author expresses certainty versus uncertainty</span></span>
<span id="cb6-191"><a href="#cb6-191" aria-hidden="true" tabindex="-1"></a><span class="st">* Consider the level of granularity appropriate to the document's own analysis</span></span>
<span id="cb6-192"><a href="#cb6-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-193"><a href="#cb6-193" aria-hidden="true" tabindex="-1"></a><span class="st">Remember that your goal is to make the implicit model explicit, not to evaluate or improve it.</span></span>
<span id="cb6-194"><a href="#cb6-194" aria-hidden="true" tabindex="-1"></a><span class="st">The value lies in accurately representing the author's perspective, even if you might personally disagree or see limitations in their model.</span></span>
<span id="cb6-195"><a href="#cb6-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-196"><a href="#cb6-196" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span>)</span>
<span id="cb6-197"><a href="#cb6-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-198"><a href="#cb6-198" aria-hidden="true" tabindex="-1"></a>    <span class="co"># BayesDown probability extraction prompt - enhances ArgDown with probability information</span></span>
<span id="cb6-199"><a href="#cb6-199" aria-hidden="true" tabindex="-1"></a>    BAYESDOWN_EXTRACTION <span class="op">=</span> PromptTemplate(<span class="st">"""</span></span>
<span id="cb6-200"><a href="#cb6-200" aria-hidden="true" tabindex="-1"></a><span class="st">You are an expert in probabilistic reasoning and Bayesian networks. Your task is to extend the provided ArgDown structure with probability information, creating a BayesDown representation.</span></span>
<span id="cb6-201"><a href="#cb6-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-202"><a href="#cb6-202" aria-hidden="true" tabindex="-1"></a><span class="st">For each statement in the ArgDown structure, you need to:</span></span>
<span id="cb6-203"><a href="#cb6-203" aria-hidden="true" tabindex="-1"></a><span class="st">1. Estimate prior probabilities for each possible state</span></span>
<span id="cb6-204"><a href="#cb6-204" aria-hidden="true" tabindex="-1"></a><span class="st">2. Estimate conditional probabilities given parent states</span></span>
<span id="cb6-205"><a href="#cb6-205" aria-hidden="true" tabindex="-1"></a><span class="st">3. Maintain the original structure and relationships</span></span>
<span id="cb6-206"><a href="#cb6-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-207"><a href="#cb6-207" aria-hidden="true" tabindex="-1"></a><span class="st">Here is the format to follow:</span></span>
<span id="cb6-208"><a href="#cb6-208" aria-hidden="true" tabindex="-1"></a><span class="st">[Node]: Description. { "instantiations": ["node_TRUE", "node_FALSE"], "priors": { "p(node_TRUE)": "0.7", "p(node_FALSE)": "0.3" }, "posteriors": { "p(node_TRUE|parent_TRUE)": "0.9", "p(node_TRUE|parent_FALSE)": "0.4", "p(node_FALSE|parent_TRUE)": "0.1", "p(node_FALSE|parent_FALSE)": "0.6" } }</span></span>
<span id="cb6-209"><a href="#cb6-209" aria-hidden="true" tabindex="-1"></a><span class="st"> [Parent]: Parent description. {...}</span></span>
<span id="cb6-210"><a href="#cb6-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-211"><a href="#cb6-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-212"><a href="#cb6-212" aria-hidden="true" tabindex="-1"></a><span class="st">Here are the specific probability questions to answer:</span></span>
<span id="cb6-213"><a href="#cb6-213" aria-hidden="true" tabindex="-1"></a><span class="st">$questions</span></span>
<span id="cb6-214"><a href="#cb6-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-215"><a href="#cb6-215" aria-hidden="true" tabindex="-1"></a><span class="st">ArgDown structure to enhance:</span></span>
<span id="cb6-216"><a href="#cb6-216" aria-hidden="true" tabindex="-1"></a><span class="st">$argdown</span></span>
<span id="cb6-217"><a href="#cb6-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-218"><a href="#cb6-218" aria-hidden="true" tabindex="-1"></a><span class="st">Provide the complete BayesDown representation with probabilities:</span></span>
<span id="cb6-219"><a href="#cb6-219" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span>)</span>
<span id="cb6-220"><a href="#cb6-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-221"><a href="#cb6-221" aria-hidden="true" tabindex="-1"></a>    <span class="at">@classmethod</span></span>
<span id="cb6-222"><a href="#cb6-222" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get_template(cls, template_name: <span class="bu">str</span>) <span class="op">-&gt;</span> PromptTemplate:</span>
<span id="cb6-223"><a href="#cb6-223" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Get a prompt template by name"""</span></span>
<span id="cb6-224"><a href="#cb6-224" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">hasattr</span>(cls, template_name):</span>
<span id="cb6-225"><a href="#cb6-225" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="bu">getattr</span>(cls, template_name)</span>
<span id="cb6-226"><a href="#cb6-226" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb6-227"><a href="#cb6-227" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"Template not found: </span><span class="sc">{</span>template_name<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="prepare-llm-api-call" class="level2">
<h2 class="anchored" data-anchor-id="prepare-llm-api-call">1.3 Prepare LLM API Call</h2>
<p>Combine Systemprompt + API Specifications + ArgDown Instructions + Prompt + Source PDF for API Call</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># @title 1.3.0 --- Provider-Agnostic LLM API Interface ---</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="co">BLOCK PURPOSE: Provides a unified interface for interacting with different LLM providers.</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="co">This block implements a flexible, provider-agnostic system for making LLM API calls:</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="co">1. Base abstract class (LLMProvider) defining the common interface</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="co">2. Implementation classes for specific providers (OpenAI and Anthropic)</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="co">3. Factory class for creating appropriate provider instances</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="co">This abstraction allows the extraction pipeline to work with different LLM providers</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="co">without changing the core code, supporting both current and future LLM backends.</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a><span class="co">DEPENDENCIES: requests for API calls, os for environment variables, abstract base classes</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a><span class="co">OUTPUTS: LLMProvider abstract class and concrete implementations for OpenAI and Anthropic</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> requests</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> abc <span class="im">import</span> ABC, abstractmethod</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Dict, List, Optional, Union, Any</span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dataclasses <span class="im">import</span> dataclass</span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a><span class="at">@dataclass</span></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> LLMResponse:</span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Standard response object for LLM completions"""</span></span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>    content: <span class="bu">str</span>            <span class="co"># The generated text response</span></span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>    model: <span class="bu">str</span>              <span class="co"># The model used for generation</span></span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>    usage: Dict[<span class="bu">str</span>, <span class="bu">int</span>]   <span class="co"># Token usage statistics</span></span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>    raw_response: Dict[<span class="bu">str</span>, Any]  <span class="co"># Complete provider-specific response</span></span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>    created_at: <span class="bu">float</span> <span class="op">=</span> time.time()  <span class="co"># Timestamp of response creation</span></span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> LLMProvider(ABC):</span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Abstract base class for LLM providers"""</span></span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">@abstractmethod</span></span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> complete(<span class="va">self</span>,</span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a>                prompt: <span class="bu">str</span>,</span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a>                system_prompt: Optional[<span class="bu">str</span>] <span class="op">=</span> <span class="va">None</span>,</span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a>                temperature: <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.7</span>,</span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a>                max_tokens: <span class="bu">int</span> <span class="op">=</span> <span class="dv">4000</span>) <span class="op">-&gt;</span> LLMResponse:</span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Generate a completion from the LLM"""</span></span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">pass</span></span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-47"><a href="#cb7-47" aria-hidden="true" tabindex="-1"></a>    <span class="at">@abstractmethod</span></span>
<span id="cb7-48"><a href="#cb7-48" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get_available_models(<span class="va">self</span>) <span class="op">-&gt;</span> List[<span class="bu">str</span>]:</span>
<span id="cb7-49"><a href="#cb7-49" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Return a list of available models from this provider"""</span></span>
<span id="cb7-50"><a href="#cb7-50" aria-hidden="true" tabindex="-1"></a>        <span class="cf">pass</span></span>
<span id="cb7-51"><a href="#cb7-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-52"><a href="#cb7-52" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> OpenAIProvider(LLMProvider):</span>
<span id="cb7-53"><a href="#cb7-53" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""OpenAI API implementation"""</span></span>
<span id="cb7-54"><a href="#cb7-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-55"><a href="#cb7-55" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, api_key: Optional[<span class="bu">str</span>] <span class="op">=</span> <span class="va">None</span>, organization: Optional[<span class="bu">str</span>] <span class="op">=</span> <span class="va">None</span>):</span>
<span id="cb7-56"><a href="#cb7-56" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Initialize with API key from args or environment"""</span></span>
<span id="cb7-57"><a href="#cb7-57" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.api_key <span class="op">=</span> api_key <span class="kw">or</span> os.environ.get(<span class="st">"OPENAI_API_KEY"</span>)</span>
<span id="cb7-58"><a href="#cb7-58" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> <span class="va">self</span>.api_key:</span>
<span id="cb7-59"><a href="#cb7-59" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"OpenAI API key is required. Provide as argument or set OPENAI_API_KEY environment variable."</span>)</span>
<span id="cb7-60"><a href="#cb7-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-61"><a href="#cb7-61" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.organization <span class="op">=</span> organization <span class="kw">or</span> os.environ.get(<span class="st">"OPENAI_ORGANIZATION"</span>)</span>
<span id="cb7-62"><a href="#cb7-62" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.api_base <span class="op">=</span> <span class="st">"https://api.openai.com/v1"</span></span>
<span id="cb7-63"><a href="#cb7-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-64"><a href="#cb7-64" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> complete(<span class="va">self</span>,</span>
<span id="cb7-65"><a href="#cb7-65" aria-hidden="true" tabindex="-1"></a>                prompt: <span class="bu">str</span>,</span>
<span id="cb7-66"><a href="#cb7-66" aria-hidden="true" tabindex="-1"></a>                system_prompt: Optional[<span class="bu">str</span>] <span class="op">=</span> <span class="va">None</span>,</span>
<span id="cb7-67"><a href="#cb7-67" aria-hidden="true" tabindex="-1"></a>                model: <span class="bu">str</span> <span class="op">=</span> <span class="st">"gpt-4-turbo"</span>,</span>
<span id="cb7-68"><a href="#cb7-68" aria-hidden="true" tabindex="-1"></a>                temperature: <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.7</span>,</span>
<span id="cb7-69"><a href="#cb7-69" aria-hidden="true" tabindex="-1"></a>                max_tokens: <span class="bu">int</span> <span class="op">=</span> <span class="dv">4000</span>) <span class="op">-&gt;</span> LLMResponse:</span>
<span id="cb7-70"><a href="#cb7-70" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Generate a completion using OpenAI's API"""</span></span>
<span id="cb7-71"><a href="#cb7-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-72"><a href="#cb7-72" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Prepare request headers</span></span>
<span id="cb7-73"><a href="#cb7-73" aria-hidden="true" tabindex="-1"></a>        headers <span class="op">=</span> {</span>
<span id="cb7-74"><a href="#cb7-74" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Content-Type"</span>: <span class="st">"application/json"</span>,</span>
<span id="cb7-75"><a href="#cb7-75" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Authorization"</span>: <span class="ss">f"Bearer </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>api_key<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb7-76"><a href="#cb7-76" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb7-77"><a href="#cb7-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-78"><a href="#cb7-78" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.organization:</span>
<span id="cb7-79"><a href="#cb7-79" aria-hidden="true" tabindex="-1"></a>            headers[<span class="st">"OpenAI-Organization"</span>] <span class="op">=</span> <span class="va">self</span>.organization</span>
<span id="cb7-80"><a href="#cb7-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-81"><a href="#cb7-81" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create message structure</span></span>
<span id="cb7-82"><a href="#cb7-82" aria-hidden="true" tabindex="-1"></a>        messages <span class="op">=</span> []</span>
<span id="cb7-83"><a href="#cb7-83" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> system_prompt:</span>
<span id="cb7-84"><a href="#cb7-84" aria-hidden="true" tabindex="-1"></a>            messages.append({<span class="st">"role"</span>: <span class="st">"system"</span>, <span class="st">"content"</span>: system_prompt})</span>
<span id="cb7-85"><a href="#cb7-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-86"><a href="#cb7-86" aria-hidden="true" tabindex="-1"></a>        messages.append({<span class="st">"role"</span>: <span class="st">"user"</span>, <span class="st">"content"</span>: prompt})</span>
<span id="cb7-87"><a href="#cb7-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-88"><a href="#cb7-88" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Prepare request data</span></span>
<span id="cb7-89"><a href="#cb7-89" aria-hidden="true" tabindex="-1"></a>        data <span class="op">=</span> {</span>
<span id="cb7-90"><a href="#cb7-90" aria-hidden="true" tabindex="-1"></a>            <span class="st">"model"</span>: model,</span>
<span id="cb7-91"><a href="#cb7-91" aria-hidden="true" tabindex="-1"></a>            <span class="st">"messages"</span>: messages,</span>
<span id="cb7-92"><a href="#cb7-92" aria-hidden="true" tabindex="-1"></a>            <span class="st">"temperature"</span>: temperature,</span>
<span id="cb7-93"><a href="#cb7-93" aria-hidden="true" tabindex="-1"></a>            <span class="st">"max_tokens"</span>: max_tokens</span>
<span id="cb7-94"><a href="#cb7-94" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb7-95"><a href="#cb7-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-96"><a href="#cb7-96" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Make API call</span></span>
<span id="cb7-97"><a href="#cb7-97" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> requests.post(</span>
<span id="cb7-98"><a href="#cb7-98" aria-hidden="true" tabindex="-1"></a>            <span class="ss">f"</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>api_base<span class="sc">}</span><span class="ss">/chat/completions"</span>,</span>
<span id="cb7-99"><a href="#cb7-99" aria-hidden="true" tabindex="-1"></a>            headers<span class="op">=</span>headers,</span>
<span id="cb7-100"><a href="#cb7-100" aria-hidden="true" tabindex="-1"></a>            json<span class="op">=</span>data</span>
<span id="cb7-101"><a href="#cb7-101" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb7-102"><a href="#cb7-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-103"><a href="#cb7-103" aria-hidden="true" tabindex="-1"></a>        response.raise_for_status()</span>
<span id="cb7-104"><a href="#cb7-104" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> response.json()</span>
<span id="cb7-105"><a href="#cb7-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-106"><a href="#cb7-106" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Transform into standardized response format</span></span>
<span id="cb7-107"><a href="#cb7-107" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> LLMResponse(</span>
<span id="cb7-108"><a href="#cb7-108" aria-hidden="true" tabindex="-1"></a>            content<span class="op">=</span>result[<span class="st">"choices"</span>][<span class="dv">0</span>][<span class="st">"message"</span>][<span class="st">"content"</span>],</span>
<span id="cb7-109"><a href="#cb7-109" aria-hidden="true" tabindex="-1"></a>            model<span class="op">=</span>result[<span class="st">"model"</span>],</span>
<span id="cb7-110"><a href="#cb7-110" aria-hidden="true" tabindex="-1"></a>            usage<span class="op">=</span>result[<span class="st">"usage"</span>],</span>
<span id="cb7-111"><a href="#cb7-111" aria-hidden="true" tabindex="-1"></a>            raw_response<span class="op">=</span>result</span>
<span id="cb7-112"><a href="#cb7-112" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb7-113"><a href="#cb7-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-114"><a href="#cb7-114" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get_available_models(<span class="va">self</span>) <span class="op">-&gt;</span> List[<span class="bu">str</span>]:</span>
<span id="cb7-115"><a href="#cb7-115" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Return a list of available OpenAI models"""</span></span>
<span id="cb7-116"><a href="#cb7-116" aria-hidden="true" tabindex="-1"></a>        headers <span class="op">=</span> {</span>
<span id="cb7-117"><a href="#cb7-117" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Authorization"</span>: <span class="ss">f"Bearer </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>api_key<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb7-118"><a href="#cb7-118" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb7-119"><a href="#cb7-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-120"><a href="#cb7-120" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.organization:</span>
<span id="cb7-121"><a href="#cb7-121" aria-hidden="true" tabindex="-1"></a>            headers[<span class="st">"OpenAI-Organization"</span>] <span class="op">=</span> <span class="va">self</span>.organization</span>
<span id="cb7-122"><a href="#cb7-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-123"><a href="#cb7-123" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> requests.get(</span>
<span id="cb7-124"><a href="#cb7-124" aria-hidden="true" tabindex="-1"></a>            <span class="ss">f"</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>api_base<span class="sc">}</span><span class="ss">/models"</span>,</span>
<span id="cb7-125"><a href="#cb7-125" aria-hidden="true" tabindex="-1"></a>            headers<span class="op">=</span>headers</span>
<span id="cb7-126"><a href="#cb7-126" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb7-127"><a href="#cb7-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-128"><a href="#cb7-128" aria-hidden="true" tabindex="-1"></a>        response.raise_for_status()</span>
<span id="cb7-129"><a href="#cb7-129" aria-hidden="true" tabindex="-1"></a>        models <span class="op">=</span> response.json()[<span class="st">"data"</span>]</span>
<span id="cb7-130"><a href="#cb7-130" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> [model[<span class="st">"id"</span>] <span class="cf">for</span> model <span class="kw">in</span> models]</span>
<span id="cb7-131"><a href="#cb7-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-132"><a href="#cb7-132" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> AnthropicProvider(LLMProvider):</span>
<span id="cb7-133"><a href="#cb7-133" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Anthropic Claude API implementation"""</span></span>
<span id="cb7-134"><a href="#cb7-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-135"><a href="#cb7-135" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, api_key: Optional[<span class="bu">str</span>] <span class="op">=</span> <span class="va">None</span>):</span>
<span id="cb7-136"><a href="#cb7-136" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Initialize with API key from args or environment"""</span></span>
<span id="cb7-137"><a href="#cb7-137" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.api_key <span class="op">=</span> api_key <span class="kw">or</span> os.environ.get(<span class="st">"ANTHROPIC_API_KEY"</span>)</span>
<span id="cb7-138"><a href="#cb7-138" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> <span class="va">self</span>.api_key:</span>
<span id="cb7-139"><a href="#cb7-139" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"Anthropic API key is required. Provide as argument or set ANTHROPIC_API_KEY environment variable."</span>)</span>
<span id="cb7-140"><a href="#cb7-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-141"><a href="#cb7-141" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.api_base <span class="op">=</span> <span class="st">"https://api.anthropic.com/v1"</span></span>
<span id="cb7-142"><a href="#cb7-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-143"><a href="#cb7-143" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> complete(<span class="va">self</span>,</span>
<span id="cb7-144"><a href="#cb7-144" aria-hidden="true" tabindex="-1"></a>                prompt: <span class="bu">str</span>,</span>
<span id="cb7-145"><a href="#cb7-145" aria-hidden="true" tabindex="-1"></a>                system_prompt: Optional[<span class="bu">str</span>] <span class="op">=</span> <span class="va">None</span>,</span>
<span id="cb7-146"><a href="#cb7-146" aria-hidden="true" tabindex="-1"></a>                model: <span class="bu">str</span> <span class="op">=</span> <span class="st">"claude-3-opus-20240229"</span>,</span>
<span id="cb7-147"><a href="#cb7-147" aria-hidden="true" tabindex="-1"></a>                temperature: <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.7</span>,</span>
<span id="cb7-148"><a href="#cb7-148" aria-hidden="true" tabindex="-1"></a>                max_tokens: <span class="bu">int</span> <span class="op">=</span> <span class="dv">4000</span>) <span class="op">-&gt;</span> LLMResponse:</span>
<span id="cb7-149"><a href="#cb7-149" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Generate a completion using Anthropic's API"""</span></span>
<span id="cb7-150"><a href="#cb7-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-151"><a href="#cb7-151" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Prepare request headers</span></span>
<span id="cb7-152"><a href="#cb7-152" aria-hidden="true" tabindex="-1"></a>        headers <span class="op">=</span> {</span>
<span id="cb7-153"><a href="#cb7-153" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Content-Type"</span>: <span class="st">"application/json"</span>,</span>
<span id="cb7-154"><a href="#cb7-154" aria-hidden="true" tabindex="-1"></a>            <span class="st">"X-API-Key"</span>: <span class="va">self</span>.api_key,</span>
<span id="cb7-155"><a href="#cb7-155" aria-hidden="true" tabindex="-1"></a>            <span class="st">"anthropic-version"</span>: <span class="st">"2023-06-01"</span></span>
<span id="cb7-156"><a href="#cb7-156" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb7-157"><a href="#cb7-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-158"><a href="#cb7-158" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Prepare request data in Anthropic-specific format</span></span>
<span id="cb7-159"><a href="#cb7-159" aria-hidden="true" tabindex="-1"></a>        data <span class="op">=</span> {</span>
<span id="cb7-160"><a href="#cb7-160" aria-hidden="true" tabindex="-1"></a>            <span class="st">"model"</span>: model,</span>
<span id="cb7-161"><a href="#cb7-161" aria-hidden="true" tabindex="-1"></a>            <span class="st">"messages"</span>: [{<span class="st">"role"</span>: <span class="st">"user"</span>, <span class="st">"content"</span>: prompt}],</span>
<span id="cb7-162"><a href="#cb7-162" aria-hidden="true" tabindex="-1"></a>            <span class="st">"temperature"</span>: temperature,</span>
<span id="cb7-163"><a href="#cb7-163" aria-hidden="true" tabindex="-1"></a>            <span class="st">"max_tokens"</span>: max_tokens</span>
<span id="cb7-164"><a href="#cb7-164" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb7-165"><a href="#cb7-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-166"><a href="#cb7-166" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add system prompt if provided (Anthropic uses a different format)</span></span>
<span id="cb7-167"><a href="#cb7-167" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> system_prompt:</span>
<span id="cb7-168"><a href="#cb7-168" aria-hidden="true" tabindex="-1"></a>            data[<span class="st">"system"</span>] <span class="op">=</span> system_prompt</span>
<span id="cb7-169"><a href="#cb7-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-170"><a href="#cb7-170" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Make API call</span></span>
<span id="cb7-171"><a href="#cb7-171" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> requests.post(</span>
<span id="cb7-172"><a href="#cb7-172" aria-hidden="true" tabindex="-1"></a>            <span class="ss">f"</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>api_base<span class="sc">}</span><span class="ss">/messages"</span>,</span>
<span id="cb7-173"><a href="#cb7-173" aria-hidden="true" tabindex="-1"></a>            headers<span class="op">=</span>headers,</span>
<span id="cb7-174"><a href="#cb7-174" aria-hidden="true" tabindex="-1"></a>            json<span class="op">=</span>data</span>
<span id="cb7-175"><a href="#cb7-175" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb7-176"><a href="#cb7-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-177"><a href="#cb7-177" aria-hidden="true" tabindex="-1"></a>        response.raise_for_status()</span>
<span id="cb7-178"><a href="#cb7-178" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> response.json()</span>
<span id="cb7-179"><a href="#cb7-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-180"><a href="#cb7-180" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Transform into standardized response format</span></span>
<span id="cb7-181"><a href="#cb7-181" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> LLMResponse(</span>
<span id="cb7-182"><a href="#cb7-182" aria-hidden="true" tabindex="-1"></a>            content<span class="op">=</span>result[<span class="st">"content"</span>][<span class="dv">0</span>][<span class="st">"text"</span>],</span>
<span id="cb7-183"><a href="#cb7-183" aria-hidden="true" tabindex="-1"></a>            model<span class="op">=</span>result[<span class="st">"model"</span>],</span>
<span id="cb7-184"><a href="#cb7-184" aria-hidden="true" tabindex="-1"></a>            usage<span class="op">=</span>{<span class="st">"prompt_tokens"</span>: result.get(<span class="st">"usage"</span>, {}).get(<span class="st">"input_tokens"</span>, <span class="dv">0</span>),</span>
<span id="cb7-185"><a href="#cb7-185" aria-hidden="true" tabindex="-1"></a>                   <span class="st">"completion_tokens"</span>: result.get(<span class="st">"usage"</span>, {}).get(<span class="st">"output_tokens"</span>, <span class="dv">0</span>)},</span>
<span id="cb7-186"><a href="#cb7-186" aria-hidden="true" tabindex="-1"></a>            raw_response<span class="op">=</span>result</span>
<span id="cb7-187"><a href="#cb7-187" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb7-188"><a href="#cb7-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-189"><a href="#cb7-189" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get_available_models(<span class="va">self</span>) <span class="op">-&gt;</span> List[<span class="bu">str</span>]:</span>
<span id="cb7-190"><a href="#cb7-190" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Return a list of available Anthropic models"""</span></span>
<span id="cb7-191"><a href="#cb7-191" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Anthropic doesn't have a models endpoint, so we return a static list</span></span>
<span id="cb7-192"><a href="#cb7-192" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> [</span>
<span id="cb7-193"><a href="#cb7-193" aria-hidden="true" tabindex="-1"></a>            <span class="st">"claude-3-opus-20240229"</span>,</span>
<span id="cb7-194"><a href="#cb7-194" aria-hidden="true" tabindex="-1"></a>            <span class="st">"claude-3-sonnet-20240229"</span>,</span>
<span id="cb7-195"><a href="#cb7-195" aria-hidden="true" tabindex="-1"></a>            <span class="st">"claude-3-haiku-20240307"</span></span>
<span id="cb7-196"><a href="#cb7-196" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb7-197"><a href="#cb7-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-198"><a href="#cb7-198" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> LLMFactory:</span>
<span id="cb7-199"><a href="#cb7-199" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Factory for creating LLM providers"""</span></span>
<span id="cb7-200"><a href="#cb7-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-201"><a href="#cb7-201" aria-hidden="true" tabindex="-1"></a>    <span class="at">@staticmethod</span></span>
<span id="cb7-202"><a href="#cb7-202" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> create_provider(provider_name: <span class="bu">str</span>, <span class="op">**</span>kwargs) <span class="op">-&gt;</span> LLMProvider:</span>
<span id="cb7-203"><a href="#cb7-203" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Create and return an LLM provider instance"""</span></span>
<span id="cb7-204"><a href="#cb7-204" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> provider_name.lower() <span class="op">==</span> <span class="st">"openai"</span>:</span>
<span id="cb7-205"><a href="#cb7-205" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> OpenAIProvider(<span class="op">**</span>kwargs)</span>
<span id="cb7-206"><a href="#cb7-206" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> provider_name.lower() <span class="op">==</span> <span class="st">"anthropic"</span>:</span>
<span id="cb7-207"><a href="#cb7-207" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> AnthropicProvider(<span class="op">**</span>kwargs)</span>
<span id="cb7-208"><a href="#cb7-208" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb7-209"><a href="#cb7-209" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"Unsupported provider: </span><span class="sc">{</span>provider_name<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># @title 1.3.0 --- API Call Function Definitions ---</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="co">BLOCK PURPOSE: Provides core functions for extracting ArgDown representations from text using LLMs.</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="co">This block implements the main extraction functionality:</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="co">1. extract_argdown_from_text: Sends text to LLM to extract structured ArgDown representation</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="co">2. validate_argdown: Verifies the extracted ArgDown for correctness and completeness</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="co">3. process_source_document: Handles source files (PDF, TXT, MD) and manages extraction</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="co">4. save_argdown_extraction: Saves extraction results with metadata for further processing</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="co">These functions form the first stage of the AMTAIR pipeline, transforming</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a><span class="co">unstructured text into structured argument representations.</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a><span class="co">DEPENDENCIES: LLMFactory from previous cell, re for pattern matching</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a><span class="co">OUTPUTS: Functions for ArgDown extraction, validation, and storage</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> extract_argdown_from_text(text: <span class="bu">str</span>, provider_name: <span class="bu">str</span> <span class="op">=</span> <span class="st">"openai"</span>, model: <span class="bu">str</span> <span class="op">=</span> <span class="va">None</span>) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a><span class="co">    Extract ArgDown representation from text using LLM</span></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a><span class="co">        text: The source text to extract arguments from</span></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a><span class="co">        provider_name: The LLM provider to use (openai or anthropic)</span></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a><span class="co">        model: Specific model to use, or None for default</span></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a><span class="co">        Extracted ArgDown representation</span></span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create LLM provider</span></span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>    provider <span class="op">=</span> LLMFactory.create_provider(provider_name)</span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get extraction prompt</span></span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>    prompt_template <span class="op">=</span> PromptLibrary.get_template(<span class="st">"ARGDOWN_EXTRACTION"</span>)</span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>    prompt <span class="op">=</span> prompt_template.<span class="bu">format</span>(text<span class="op">=</span>text)</span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Set model-specific parameters</span></span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> provider_name.lower() <span class="op">==</span> <span class="st">"openai"</span>:</span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a>        model <span class="op">=</span> model <span class="kw">or</span> <span class="st">"gpt-4-turbo"</span></span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a>        temperature <span class="op">=</span> <span class="fl">0.3</span>  <span class="co"># Lower temperature for more deterministic extraction</span></span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a>        max_tokens <span class="op">=</span> <span class="dv">4000</span></span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> provider_name.lower() <span class="op">==</span> <span class="st">"anthropic"</span>:</span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a>        model <span class="op">=</span> model <span class="kw">or</span> <span class="st">"claude-3-opus-20240229"</span></span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a>        temperature <span class="op">=</span> <span class="fl">0.2</span></span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a>        max_tokens <span class="op">=</span> <span class="dv">4000</span></span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Call the LLM</span></span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a>    system_prompt <span class="op">=</span> <span class="st">"You are an expert in argument mapping and causal reasoning."</span></span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> provider.complete(</span>
<span id="cb8-51"><a href="#cb8-51" aria-hidden="true" tabindex="-1"></a>        prompt<span class="op">=</span>prompt,</span>
<span id="cb8-52"><a href="#cb8-52" aria-hidden="true" tabindex="-1"></a>        system_prompt<span class="op">=</span>system_prompt,</span>
<span id="cb8-53"><a href="#cb8-53" aria-hidden="true" tabindex="-1"></a>        model<span class="op">=</span>model,</span>
<span id="cb8-54"><a href="#cb8-54" aria-hidden="true" tabindex="-1"></a>        temperature<span class="op">=</span>temperature,</span>
<span id="cb8-55"><a href="#cb8-55" aria-hidden="true" tabindex="-1"></a>        max_tokens<span class="op">=</span>max_tokens</span>
<span id="cb8-56"><a href="#cb8-56" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb8-57"><a href="#cb8-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-58"><a href="#cb8-58" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract the ArgDown content (remove any markdown code blocks if present)</span></span>
<span id="cb8-59"><a href="#cb8-59" aria-hidden="true" tabindex="-1"></a>    argdown_content <span class="op">=</span> response.content</span>
<span id="cb8-60"><a href="#cb8-60" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">"```"</span> <span class="kw">in</span> argdown_content:</span>
<span id="cb8-61"><a href="#cb8-61" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Extract content between code blocks if present</span></span>
<span id="cb8-62"><a href="#cb8-62" aria-hidden="true" tabindex="-1"></a>        <span class="im">import</span> re</span>
<span id="cb8-63"><a href="#cb8-63" aria-hidden="true" tabindex="-1"></a>        matches <span class="op">=</span> re.findall(<span class="vs">r"```</span>(?:<span class="vs">argdown</span>)<span class="op">?</span><span class="ch">\n</span><span class="kw">(</span><span class="pp">[</span><span class="dv">\s\S</span><span class="pp">]</span><span class="op">*?</span><span class="kw">)</span><span class="ch">\n</span><span class="vs">```"</span>, argdown_content)</span>
<span id="cb8-64"><a href="#cb8-64" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> matches:</span>
<span id="cb8-65"><a href="#cb8-65" aria-hidden="true" tabindex="-1"></a>            argdown_content <span class="op">=</span> matches[<span class="dv">0</span>]</span>
<span id="cb8-66"><a href="#cb8-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-67"><a href="#cb8-67" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> argdown_content</span>
<span id="cb8-68"><a href="#cb8-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-69"><a href="#cb8-69" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> validate_argdown(argdown_text: <span class="bu">str</span>) <span class="op">-&gt;</span> Dict[<span class="bu">str</span>, Any]:</span>
<span id="cb8-70"><a href="#cb8-70" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb8-71"><a href="#cb8-71" aria-hidden="true" tabindex="-1"></a><span class="co">    Validate ArgDown representation to ensure it's well-formed</span></span>
<span id="cb8-72"><a href="#cb8-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-73"><a href="#cb8-73" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb8-74"><a href="#cb8-74" aria-hidden="true" tabindex="-1"></a><span class="co">        argdown_text: ArgDown representation to validate</span></span>
<span id="cb8-75"><a href="#cb8-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-76"><a href="#cb8-76" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb8-77"><a href="#cb8-77" aria-hidden="true" tabindex="-1"></a><span class="co">        Dictionary with validation results</span></span>
<span id="cb8-78"><a href="#cb8-78" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb8-79"><a href="#cb8-79" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Initialize validation results</span></span>
<span id="cb8-80"><a href="#cb8-80" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> {</span>
<span id="cb8-81"><a href="#cb8-81" aria-hidden="true" tabindex="-1"></a>        <span class="st">"is_valid"</span>: <span class="va">True</span>,</span>
<span id="cb8-82"><a href="#cb8-82" aria-hidden="true" tabindex="-1"></a>        <span class="st">"errors"</span>: [],</span>
<span id="cb8-83"><a href="#cb8-83" aria-hidden="true" tabindex="-1"></a>        <span class="st">"warnings"</span>: [],</span>
<span id="cb8-84"><a href="#cb8-84" aria-hidden="true" tabindex="-1"></a>        <span class="st">"stats"</span>: {</span>
<span id="cb8-85"><a href="#cb8-85" aria-hidden="true" tabindex="-1"></a>            <span class="st">"node_count"</span>: <span class="dv">0</span>,</span>
<span id="cb8-86"><a href="#cb8-86" aria-hidden="true" tabindex="-1"></a>            <span class="st">"relationship_count"</span>: <span class="dv">0</span>,</span>
<span id="cb8-87"><a href="#cb8-87" aria-hidden="true" tabindex="-1"></a>            <span class="st">"max_depth"</span>: <span class="dv">0</span></span>
<span id="cb8-88"><a href="#cb8-88" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb8-89"><a href="#cb8-89" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb8-90"><a href="#cb8-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-91"><a href="#cb8-91" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Basic syntax checks</span></span>
<span id="cb8-92"><a href="#cb8-92" aria-hidden="true" tabindex="-1"></a>    lines <span class="op">=</span> argdown_text.split(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb8-93"><a href="#cb8-93" aria-hidden="true" tabindex="-1"></a>    node_pattern <span class="op">=</span> <span class="vs">r'</span><span class="ch">\[</span><span class="kw">(</span><span class="dv">.</span><span class="op">*?</span><span class="kw">)</span><span class="ch">\]</span><span class="vs">:'</span></span>
<span id="cb8-94"><a href="#cb8-94" aria-hidden="true" tabindex="-1"></a>    instantiation_pattern <span class="op">=</span> <span class="vs">r'{"instantiations":'</span></span>
<span id="cb8-95"><a href="#cb8-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-96"><a href="#cb8-96" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Track nodes and relationships</span></span>
<span id="cb8-97"><a href="#cb8-97" aria-hidden="true" tabindex="-1"></a>    nodes <span class="op">=</span> <span class="bu">set</span>()</span>
<span id="cb8-98"><a href="#cb8-98" aria-hidden="true" tabindex="-1"></a>    relationships <span class="op">=</span> []</span>
<span id="cb8-99"><a href="#cb8-99" aria-hidden="true" tabindex="-1"></a>    current_depth <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb8-100"><a href="#cb8-100" aria-hidden="true" tabindex="-1"></a>    max_depth <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb8-101"><a href="#cb8-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-102"><a href="#cb8-102" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, line <span class="kw">in</span> <span class="bu">enumerate</span>(lines):</span>
<span id="cb8-103"><a href="#cb8-103" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Skip empty lines</span></span>
<span id="cb8-104"><a href="#cb8-104" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> line.strip():</span>
<span id="cb8-105"><a href="#cb8-105" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb8-106"><a href="#cb8-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-107"><a href="#cb8-107" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate indentation depth</span></span>
<span id="cb8-108"><a href="#cb8-108" aria-hidden="true" tabindex="-1"></a>        indent <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb8-109"><a href="#cb8-109" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">'+'</span> <span class="kw">in</span> line:</span>
<span id="cb8-110"><a href="#cb8-110" aria-hidden="true" tabindex="-1"></a>            indent <span class="op">=</span> line.find(<span class="st">'+'</span>) <span class="op">//</span> <span class="dv">2</span></span>
<span id="cb8-111"><a href="#cb8-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-112"><a href="#cb8-112" aria-hidden="true" tabindex="-1"></a>        current_depth <span class="op">=</span> indent</span>
<span id="cb8-113"><a href="#cb8-113" aria-hidden="true" tabindex="-1"></a>        max_depth <span class="op">=</span> <span class="bu">max</span>(max_depth, current_depth)</span>
<span id="cb8-114"><a href="#cb8-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-115"><a href="#cb8-115" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check for node definitions</span></span>
<span id="cb8-116"><a href="#cb8-116" aria-hidden="true" tabindex="-1"></a>        <span class="im">import</span> re</span>
<span id="cb8-117"><a href="#cb8-117" aria-hidden="true" tabindex="-1"></a>        node_matches <span class="op">=</span> re.findall(node_pattern, line)</span>
<span id="cb8-118"><a href="#cb8-118" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> node_matches:</span>
<span id="cb8-119"><a href="#cb8-119" aria-hidden="true" tabindex="-1"></a>            node <span class="op">=</span> node_matches[<span class="dv">0</span>]</span>
<span id="cb8-120"><a href="#cb8-120" aria-hidden="true" tabindex="-1"></a>            nodes.add(node)</span>
<span id="cb8-121"><a href="#cb8-121" aria-hidden="true" tabindex="-1"></a>            results[<span class="st">"stats"</span>][<span class="st">"node_count"</span>] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb8-122"><a href="#cb8-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-123"><a href="#cb8-123" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Check for instantiations</span></span>
<span id="cb8-124"><a href="#cb8-124" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> instantiation_pattern <span class="kw">not</span> <span class="kw">in</span> line:</span>
<span id="cb8-125"><a href="#cb8-125" aria-hidden="true" tabindex="-1"></a>                results[<span class="st">"warnings"</span>].append(<span class="ss">f"Line </span><span class="sc">{</span>i<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">: Node '</span><span class="sc">{</span>node<span class="sc">}</span><span class="ss">' is missing instantiations metadata"</span>)</span>
<span id="cb8-126"><a href="#cb8-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-127"><a href="#cb8-127" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check parent-child relationships</span></span>
<span id="cb8-128"><a href="#cb8-128" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> indent <span class="op">&gt;</span> <span class="dv">0</span> <span class="kw">and</span> <span class="st">'+'</span> <span class="kw">in</span> line <span class="kw">and</span> node_matches:</span>
<span id="cb8-129"><a href="#cb8-129" aria-hidden="true" tabindex="-1"></a>            <span class="co"># This is a child node; find its parent</span></span>
<span id="cb8-130"><a href="#cb8-130" aria-hidden="true" tabindex="-1"></a>            parent_indent <span class="op">=</span> indent <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb8-131"><a href="#cb8-131" aria-hidden="true" tabindex="-1"></a>            j <span class="op">=</span> i <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb8-132"><a href="#cb8-132" aria-hidden="true" tabindex="-1"></a>            <span class="cf">while</span> j <span class="op">&gt;=</span> <span class="dv">0</span>:</span>
<span id="cb8-133"><a href="#cb8-133" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="st">'+'</span> <span class="kw">in</span> lines[j] <span class="kw">and</span> lines[j].find(<span class="st">'+'</span>) <span class="op">//</span> <span class="dv">2</span> <span class="op">==</span> parent_indent:</span>
<span id="cb8-134"><a href="#cb8-134" aria-hidden="true" tabindex="-1"></a>                    parent_matches <span class="op">=</span> re.findall(node_pattern, lines[j])</span>
<span id="cb8-135"><a href="#cb8-135" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> parent_matches:</span>
<span id="cb8-136"><a href="#cb8-136" aria-hidden="true" tabindex="-1"></a>                        parent <span class="op">=</span> parent_matches[<span class="dv">0</span>]</span>
<span id="cb8-137"><a href="#cb8-137" aria-hidden="true" tabindex="-1"></a>                        relationships.append((parent, node))</span>
<span id="cb8-138"><a href="#cb8-138" aria-hidden="true" tabindex="-1"></a>                        results[<span class="st">"stats"</span>][<span class="st">"relationship_count"</span>] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb8-139"><a href="#cb8-139" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">break</span></span>
<span id="cb8-140"><a href="#cb8-140" aria-hidden="true" tabindex="-1"></a>                j <span class="op">-=</span> <span class="dv">1</span></span>
<span id="cb8-141"><a href="#cb8-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-142"><a href="#cb8-142" aria-hidden="true" tabindex="-1"></a>    results[<span class="st">"stats"</span>][<span class="st">"max_depth"</span>] <span class="op">=</span> max_depth</span>
<span id="cb8-143"><a href="#cb8-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-144"><a href="#cb8-144" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If we didn't find any nodes, that's a problem</span></span>
<span id="cb8-145"><a href="#cb8-145" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> results[<span class="st">"stats"</span>][<span class="st">"node_count"</span>] <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb8-146"><a href="#cb8-146" aria-hidden="true" tabindex="-1"></a>        results[<span class="st">"is_valid"</span>] <span class="op">=</span> <span class="va">False</span></span>
<span id="cb8-147"><a href="#cb8-147" aria-hidden="true" tabindex="-1"></a>        results[<span class="st">"errors"</span>].append(<span class="st">"No valid nodes found in ArgDown representation"</span>)</span>
<span id="cb8-148"><a href="#cb8-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-149"><a href="#cb8-149" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> results</span>
<span id="cb8-150"><a href="#cb8-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-151"><a href="#cb8-151" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> process_source_document(file_path: <span class="bu">str</span>, provider_name: <span class="bu">str</span> <span class="op">=</span> <span class="st">"openai"</span>) <span class="op">-&gt;</span> Dict[<span class="bu">str</span>, Any]:</span>
<span id="cb8-152"><a href="#cb8-152" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb8-153"><a href="#cb8-153" aria-hidden="true" tabindex="-1"></a><span class="co">    Process a source document to extract ArgDown representation</span></span>
<span id="cb8-154"><a href="#cb8-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-155"><a href="#cb8-155" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb8-156"><a href="#cb8-156" aria-hidden="true" tabindex="-1"></a><span class="co">        file_path: Path to the source document</span></span>
<span id="cb8-157"><a href="#cb8-157" aria-hidden="true" tabindex="-1"></a><span class="co">        provider_name: The LLM provider to use</span></span>
<span id="cb8-158"><a href="#cb8-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-159"><a href="#cb8-159" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb8-160"><a href="#cb8-160" aria-hidden="true" tabindex="-1"></a><span class="co">        Dictionary with extraction results</span></span>
<span id="cb8-161"><a href="#cb8-161" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb8-162"><a href="#cb8-162" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load the source document</span></span>
<span id="cb8-163"><a href="#cb8-163" aria-hidden="true" tabindex="-1"></a>    text <span class="op">=</span> <span class="st">""</span></span>
<span id="cb8-164"><a href="#cb8-164" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> file_path.endswith(<span class="st">".pdf"</span>):</span>
<span id="cb8-165"><a href="#cb8-165" aria-hidden="true" tabindex="-1"></a>        <span class="co"># PDF handling requires additional libraries</span></span>
<span id="cb8-166"><a href="#cb8-166" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb8-167"><a href="#cb8-167" aria-hidden="true" tabindex="-1"></a>            <span class="im">import</span> PyPDF2</span>
<span id="cb8-168"><a href="#cb8-168" aria-hidden="true" tabindex="-1"></a>            <span class="cf">with</span> <span class="bu">open</span>(file_path, <span class="st">'rb'</span>) <span class="im">as</span> <span class="bu">file</span>:</span>
<span id="cb8-169"><a href="#cb8-169" aria-hidden="true" tabindex="-1"></a>                reader <span class="op">=</span> PyPDF2.PdfReader(<span class="bu">file</span>)</span>
<span id="cb8-170"><a href="#cb8-170" aria-hidden="true" tabindex="-1"></a>                text <span class="op">=</span> <span class="st">""</span></span>
<span id="cb8-171"><a href="#cb8-171" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> page <span class="kw">in</span> reader.pages:</span>
<span id="cb8-172"><a href="#cb8-172" aria-hidden="true" tabindex="-1"></a>                    text <span class="op">+=</span> page.extract_text() <span class="op">+</span> <span class="st">"</span><span class="ch">\n</span><span class="st">"</span></span>
<span id="cb8-173"><a href="#cb8-173" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">ImportError</span>:</span>
<span id="cb8-174"><a href="#cb8-174" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">ImportError</span>(<span class="st">"PyPDF2 is required for PDF processing. Install it with: pip install PyPDF2"</span>)</span>
<span id="cb8-175"><a href="#cb8-175" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> file_path.endswith(<span class="st">".txt"</span>):</span>
<span id="cb8-176"><a href="#cb8-176" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> <span class="bu">open</span>(file_path, <span class="st">'r'</span>) <span class="im">as</span> <span class="bu">file</span>:</span>
<span id="cb8-177"><a href="#cb8-177" aria-hidden="true" tabindex="-1"></a>            text <span class="op">=</span> <span class="bu">file</span>.read()</span>
<span id="cb8-178"><a href="#cb8-178" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> file_path.endswith(<span class="st">".md"</span>):</span>
<span id="cb8-179"><a href="#cb8-179" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> <span class="bu">open</span>(file_path, <span class="st">'r'</span>) <span class="im">as</span> <span class="bu">file</span>:</span>
<span id="cb8-180"><a href="#cb8-180" aria-hidden="true" tabindex="-1"></a>            text <span class="op">=</span> <span class="bu">file</span>.read()</span>
<span id="cb8-181"><a href="#cb8-181" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb8-182"><a href="#cb8-182" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"Unsupported file format: </span><span class="sc">{</span>file_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb8-183"><a href="#cb8-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-184"><a href="#cb8-184" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract ArgDown</span></span>
<span id="cb8-185"><a href="#cb8-185" aria-hidden="true" tabindex="-1"></a>    argdown_content <span class="op">=</span> extract_argdown_from_text(text, provider_name)</span>
<span id="cb8-186"><a href="#cb8-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-187"><a href="#cb8-187" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Validate the extraction</span></span>
<span id="cb8-188"><a href="#cb8-188" aria-hidden="true" tabindex="-1"></a>    validation_results <span class="op">=</span> validate_argdown(argdown_content)</span>
<span id="cb8-189"><a href="#cb8-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-190"><a href="#cb8-190" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Prepare results</span></span>
<span id="cb8-191"><a href="#cb8-191" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> {</span>
<span id="cb8-192"><a href="#cb8-192" aria-hidden="true" tabindex="-1"></a>        <span class="st">"source_path"</span>: file_path,</span>
<span id="cb8-193"><a href="#cb8-193" aria-hidden="true" tabindex="-1"></a>        <span class="st">"extraction_timestamp"</span>: time.time(),</span>
<span id="cb8-194"><a href="#cb8-194" aria-hidden="true" tabindex="-1"></a>        <span class="st">"argdown_content"</span>: argdown_content,</span>
<span id="cb8-195"><a href="#cb8-195" aria-hidden="true" tabindex="-1"></a>        <span class="st">"validation"</span>: validation_results,</span>
<span id="cb8-196"><a href="#cb8-196" aria-hidden="true" tabindex="-1"></a>        <span class="st">"provider"</span>: provider_name</span>
<span id="cb8-197"><a href="#cb8-197" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb8-198"><a href="#cb8-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-199"><a href="#cb8-199" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> results</span>
<span id="cb8-200"><a href="#cb8-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-201"><a href="#cb8-201" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> save_argdown_extraction(results: Dict[<span class="bu">str</span>, Any], output_path: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb8-202"><a href="#cb8-202" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb8-203"><a href="#cb8-203" aria-hidden="true" tabindex="-1"></a><span class="co">    Save ArgDown extraction results</span></span>
<span id="cb8-204"><a href="#cb8-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-205"><a href="#cb8-205" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb8-206"><a href="#cb8-206" aria-hidden="true" tabindex="-1"></a><span class="co">        results: Extraction results dictionary</span></span>
<span id="cb8-207"><a href="#cb8-207" aria-hidden="true" tabindex="-1"></a><span class="co">        output_path: Path to save the results</span></span>
<span id="cb8-208"><a href="#cb8-208" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb8-209"><a href="#cb8-209" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Save the ArgDown content</span></span>
<span id="cb8-210"><a href="#cb8-210" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(output_path, <span class="st">'w'</span>) <span class="im">as</span> <span class="bu">file</span>:</span>
<span id="cb8-211"><a href="#cb8-211" aria-hidden="true" tabindex="-1"></a>        <span class="bu">file</span>.write(results[<span class="st">"argdown_content"</span>])</span>
<span id="cb8-212"><a href="#cb8-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-213"><a href="#cb8-213" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Save metadata alongside</span></span>
<span id="cb8-214"><a href="#cb8-214" aria-hidden="true" tabindex="-1"></a>    metadata_path <span class="op">=</span> output_path.replace(<span class="st">'.md'</span>, <span class="st">'_metadata.json'</span>)</span>
<span id="cb8-215"><a href="#cb8-215" aria-hidden="true" tabindex="-1"></a>    metadata <span class="op">=</span> {</span>
<span id="cb8-216"><a href="#cb8-216" aria-hidden="true" tabindex="-1"></a>        <span class="st">"source_path"</span>: results[<span class="st">"source_path"</span>],</span>
<span id="cb8-217"><a href="#cb8-217" aria-hidden="true" tabindex="-1"></a>        <span class="st">"extraction_timestamp"</span>: results[<span class="st">"extraction_timestamp"</span>],</span>
<span id="cb8-218"><a href="#cb8-218" aria-hidden="true" tabindex="-1"></a>        <span class="st">"validation"</span>: results[<span class="st">"validation"</span>],</span>
<span id="cb8-219"><a href="#cb8-219" aria-hidden="true" tabindex="-1"></a>        <span class="st">"provider"</span>: results[<span class="st">"provider"</span>]</span>
<span id="cb8-220"><a href="#cb8-220" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb8-221"><a href="#cb8-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-222"><a href="#cb8-222" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(metadata_path, <span class="st">'w'</span>) <span class="im">as</span> <span class="bu">file</span>:</span>
<span id="cb8-223"><a href="#cb8-223" aria-hidden="true" tabindex="-1"></a>        json.dump(metadata, <span class="bu">file</span>, indent<span class="op">=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># @title 1.3 --- Prepare LLM API Call ---</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="co">BLOCK PURPOSE: Prepares parameters for LLM API calls used in ArgDown extraction.</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="co">This function handles the configuration for LLM API calls, including:</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="co">1. Source document path validation</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="co">2. LLM provider selection and validation</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="co">3. Model selection with appropriate defaults</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a><span class="co">The function returns a configuration dictionary that can be passed to the</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a><span class="co">extraction function in the next step of the pipeline.</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a><span class="co">DEPENDENCIES: None (uses standard Python functionality)</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a><span class="co">OUTPUTS: Dictionary with extraction configuration parameters</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> prepare_extraction_call(source_path, provider_name<span class="op">=</span><span class="st">"openai"</span>, model<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a><span class="co">    Prepare the LLM API call for ArgDown extraction</span></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a><span class="co">        source_path (str): Path to the source document to extract from</span></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a><span class="co">        provider_name (str): LLM provider to use ('openai' or 'anthropic')</span></span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a><span class="co">        model (str, optional): Specific model to use. Defaults to None (uses provider's default).</span></span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a><span class="co">        dict: Configuration parameters for extraction</span></span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a><span class="co">    Raises:</span></span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a><span class="co">        ValueError: If an unsupported provider is specified</span></span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load the source document</span></span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Processing source document: </span><span class="sc">{</span>source_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Determine provider and model</span></span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a>    provider <span class="op">=</span> provider_name.lower()</span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> provider <span class="kw">not</span> <span class="kw">in</span> [<span class="st">"openai"</span>, <span class="st">"anthropic"</span>]:</span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"Unsupported provider: </span><span class="sc">{</span>provider<span class="sc">}</span><span class="ss">. Use 'openai' or 'anthropic'."</span>)</span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Set default model if none provided</span></span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> model <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> provider <span class="op">==</span> <span class="st">"openai"</span>:</span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a>            model <span class="op">=</span> <span class="st">"gpt-4-turbo"</span></span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> provider <span class="op">==</span> <span class="st">"anthropic"</span>:</span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a>            model <span class="op">=</span> <span class="st">"claude-3-opus-20240229"</span></span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Print configuration</span></span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Using provider: </span><span class="sc">{</span>provider<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb9-50"><a href="#cb9-50" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Selected model: </span><span class="sc">{</span>model<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb9-51"><a href="#cb9-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-52"><a href="#cb9-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb9-53"><a href="#cb9-53" aria-hidden="true" tabindex="-1"></a>        <span class="st">"source_path"</span>: source_path,</span>
<span id="cb9-54"><a href="#cb9-54" aria-hidden="true" tabindex="-1"></a>        <span class="st">"provider"</span>: provider,</span>
<span id="cb9-55"><a href="#cb9-55" aria-hidden="true" tabindex="-1"></a>        <span class="st">"model"</span>: model</span>
<span id="cb9-56"><a href="#cb9-56" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb9-57"><a href="#cb9-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-58"><a href="#cb9-58" aria-hidden="true" tabindex="-1"></a><span class="co"># Usage example:</span></span>
<span id="cb9-59"><a href="#cb9-59" aria-hidden="true" tabindex="-1"></a>source_path <span class="op">=</span> <span class="st">"example_document.pdf"</span>  <span class="co"># Replace with actual document path</span></span>
<span id="cb9-60"><a href="#cb9-60" aria-hidden="true" tabindex="-1"></a>extraction_config <span class="op">=</span> prepare_extraction_call(source_path, provider_name<span class="op">=</span><span class="st">"openai"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="make-argdown-extraction-llm-api-call" class="level2">
<h2 class="anchored" data-anchor-id="make-argdown-extraction-llm-api-call">1.4 Make ArgDown Extraction LLM API Call</h2>
<div class="sourceCode" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># @title 1.4 --- Make ArgDown Extraction LLM API Call ---</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="co">BLOCK PURPOSE: Executes the ArgDown extraction process using the LLM API.</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="co">This function performs the actual extraction of ArgDown representations from source documents:</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="co">1. Takes the configuration parameters prepared in the previous step</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="co">2. Processes the document using the LLM API</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="co">3. Validates the extraction results</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="co">4. Provides timing and statistics about the extraction</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a><span class="co">The extraction process transforms unstructured text into a structured argument</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a><span class="co">representation following the ArgDown syntax defined in the AMTAIR project.</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a><span class="co">DEPENDENCIES: process_source_document function from previous cells</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a><span class="co">OUTPUTS: Dictionary with extraction results including ArgDown content and validation info</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> execute_extraction(extraction_config):</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a><span class="co">    Execute the ArgDown extraction using the LLM API</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a><span class="co">        extraction_config (dict): Configuration parameters for extraction</span></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a><span class="co">        dict: Extraction results including ArgDown content and validation info</span></span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a><span class="co">    Raises:</span></span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a><span class="co">        Exception: For any errors during extraction</span></span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Starting extraction from </span><span class="sc">{</span>extraction_config[<span class="st">'source_path'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>    start_time <span class="op">=</span> time.time()</span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Process the document</span></span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>        results <span class="op">=</span> process_source_document(</span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>            extraction_config[<span class="st">"source_path"</span>],</span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>            provider_name<span class="op">=</span>extraction_config[<span class="st">"provider"</span>]</span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Print success message</span></span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a>        elapsed_time <span class="op">=</span> time.time() <span class="op">-</span> start_time</span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Extraction completed in </span><span class="sc">{</span>elapsed_time<span class="sc">:.2f}</span><span class="ss"> seconds"</span>)</span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Extracted </span><span class="sc">{</span>results[<span class="st">'validation'</span>][<span class="st">'stats'</span>][<span class="st">'node_count'</span>]<span class="sc">}</span><span class="ss"> nodes with "</span></span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a>              <span class="ss">f"</span><span class="sc">{</span>results[<span class="st">'validation'</span>][<span class="st">'stats'</span>][<span class="st">'relationship_count'</span>]<span class="sc">}</span><span class="ss"> relationships"</span>)</span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Print any warnings</span></span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> results[<span class="st">'validation'</span>][<span class="st">'warnings'</span>]:</span>
<span id="cb10-50"><a href="#cb10-50" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Warnings:"</span>)</span>
<span id="cb10-51"><a href="#cb10-51" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> warning <span class="kw">in</span> results[<span class="st">'validation'</span>][<span class="st">'warnings'</span>]:</span>
<span id="cb10-52"><a href="#cb10-52" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"- </span><span class="sc">{</span>warning<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb10-53"><a href="#cb10-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-54"><a href="#cb10-54" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> results</span>
<span id="cb10-55"><a href="#cb10-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-56"><a href="#cb10-56" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb10-57"><a href="#cb10-57" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Error during extraction: </span><span class="sc">{</span><span class="bu">str</span>(e)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb10-58"><a href="#cb10-58" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span></span>
<span id="cb10-59"><a href="#cb10-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-60"><a href="#cb10-60" aria-hidden="true" tabindex="-1"></a><span class="co"># Usage example:</span></span>
<span id="cb10-61"><a href="#cb10-61" aria-hidden="true" tabindex="-1"></a>extraction_results <span class="op">=</span> execute_extraction(extraction_config)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="save-argdown-extraction-response" class="level2">
<h2 class="anchored" data-anchor-id="save-argdown-extraction-response">1.5 Save ArgDown Extraction Response</h2>
<ol type="1">
<li><p>Save and log API return</p></li>
<li><p>Save ArgDown.md file for further Proecessing</p></li>
</ol>
<div class="sourceCode" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># @title 1.5 --- Save ArgDown Extraction Response ---</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="co">BLOCK PURPOSE: Saves the extracted ArgDown content to files for further processing.</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="co">This function handles saving the extraction results:</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="co">1. Creates an output directory if it doesn't exist</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="co">2. Saves the extracted ArgDown content with a timestamp in the filename</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="co">3. Saves accompanying metadata in a JSON file</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a><span class="co">4. Saves a copy at a standard location for the next steps in the pipeline</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a><span class="co">5. Provides a preview of the extracted content</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a><span class="co">The saved files serve as inputs for the next stage of the pipeline where</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a><span class="co">probability information will be added to create BayesDown.</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a><span class="co">DEPENDENCIES: os module for directory operations</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a><span class="co">OUTPUTS: Saved ArgDown files and preview of extracted content</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> save_extraction_results(results, output_directory<span class="op">=</span><span class="st">"./outputs"</span>):</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a><span class="co">    Save the extraction results to file</span></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a><span class="co">        results (dict): Extraction results from execute_extraction</span></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a><span class="co">        output_directory (str): Directory to save results</span></span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a><span class="co">        str: Path to the saved ArgDown file</span></span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ensure output directory exists</span></span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> os</span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>    os.makedirs(output_directory, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create base filename from source</span></span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> os.path</span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>    base_name <span class="op">=</span> os.path.basename(results[<span class="st">"source_path"</span>]).split(<span class="st">'.'</span>)[<span class="dv">0</span>]</span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>    timestamp <span class="op">=</span> time.strftime(<span class="st">"%Y%m</span><span class="sc">%d</span><span class="st">-%H%M%S"</span>)</span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>    output_filename <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>base_name<span class="sc">}</span><span class="ss">_argdown_</span><span class="sc">{</span>timestamp<span class="sc">}</span><span class="ss">.md"</span></span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a>    output_path <span class="op">=</span> os.path.join(output_directory, output_filename)</span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Save the results</span></span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a>    save_argdown_extraction(results, output_path)</span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Saved ArgDown extraction to: </span><span class="sc">{</span>output_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Metadata saved to: </span><span class="sc">{</span>output_path<span class="sc">.</span>replace(<span class="st">'.md'</span>, <span class="st">'_metadata.json'</span>)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Also save to standard location for further processing</span></span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a>    standard_path <span class="op">=</span> os.path.join(output_directory, <span class="st">"ArgDown.md"</span>)</span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(standard_path, <span class="st">'w'</span>) <span class="im">as</span> f:</span>
<span id="cb11-51"><a href="#cb11-51" aria-hidden="true" tabindex="-1"></a>        f.write(results[<span class="st">"argdown_content"</span>])</span>
<span id="cb11-52"><a href="#cb11-52" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Also saved to standard location: </span><span class="sc">{</span>standard_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb11-53"><a href="#cb11-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-54"><a href="#cb11-54" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> output_path</span>
<span id="cb11-55"><a href="#cb11-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-56"><a href="#cb11-56" aria-hidden="true" tabindex="-1"></a><span class="co"># Usage example:</span></span>
<span id="cb11-57"><a href="#cb11-57" aria-hidden="true" tabindex="-1"></a>output_path <span class="op">=</span> save_extraction_results(extraction_results)</span>
<span id="cb11-58"><a href="#cb11-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-59"><a href="#cb11-59" aria-hidden="true" tabindex="-1"></a><span class="co"># Preview the extracted ArgDown</span></span>
<span id="cb11-60"><a href="#cb11-60" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> IPython.display <span class="im">import</span> Markdown, display</span>
<span id="cb11-61"><a href="#cb11-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-62"><a href="#cb11-62" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the first 500 characters of the extracted ArgDown</span></span>
<span id="cb11-63"><a href="#cb11-63" aria-hidden="true" tabindex="-1"></a>preview <span class="op">=</span> extraction_results[<span class="st">"argdown_content"</span>][:<span class="dv">500</span>] <span class="op">+</span> <span class="st">"..."</span> <span class="cf">if</span> <span class="bu">len</span>(extraction_results[<span class="st">"argdown_content"</span>]) <span class="op">&gt;</span> <span class="dv">500</span> <span class="cf">else</span> extraction_results[<span class="st">"argdown_content"</span>]</span>
<span id="cb11-64"><a href="#cb11-64" aria-hidden="true" tabindex="-1"></a>display(Markdown(<span class="ss">f"## Extracted ArgDown Preview</span><span class="ch">\n\n</span><span class="ss">```</span><span class="ch">\n</span><span class="sc">{</span>preview<span class="sc">}</span><span class="ch">\n</span><span class="ss">```"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="review-and-check-argdown.md-file" class="level2">
<h2 class="anchored" data-anchor-id="review-and-check-argdown.md-file">1.6 Review and Check ArgDown.md File</h2>
<div class="sourceCode" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>display(Markdown(md_content))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="check-the-graph-structure-with-the-argdown-sandbox-online" class="level2">
<h2 class="anchored" data-anchor-id="check-the-graph-structure-with-the-argdown-sandbox-online">1.6.2 Check the Graph Structure with the ArgDown Sandbox Online</h2>
<p>Copy and paste the BayesDown formatted … in the ArgDown Sandbox below to quickly verify that the network renders correctly.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># @title 1.6.2 --- ArgDown Online Sandbox ---</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> IPython.display <span class="im">import</span> IFrame</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>IFrame(src<span class="op">=</span><span class="st">"https://argdown.org/sandbox/map/"</span>, width<span class="op">=</span><span class="st">"100%"</span>, height<span class="op">=</span><span class="st">"600px"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="extract-argdown-graph-information-as-dataframe" class="level2">
<h2 class="anchored" data-anchor-id="extract-argdown-graph-information-as-dataframe">1.7 Extract ArgDown Graph Information as DataFrame</h2>
<p>Extract:</p>
<ul>
<li>Nodes (Variable_Title)</li>
<li>Edges (Parents)</li>
<li>Instantiations</li>
<li>Description</li>
</ul>
<p>Implementation nodes: - One function for ArgDown and BayesDown extraction, but: - IF YOU ONLY WANT ARGDOWN EXTRACTION: USE ARGUMENT IN FUNCTION CALL “parse_markdown_hierarchy(markdown_text, ArgDown = True)” - so if you set ArgDown = True, it gives you only instantiations, no probabilities.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># @title 1.7 --- Parsing ArgDown &amp; BayesDown (.md to .csv) ---</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="co">BLOCK PURPOSE: Provides the core parsing functionality for transforming ArgDown and BayesDown</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="co">text representations into structured DataFrame format for further processing.</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="co">This block implements the critical extraction pipeline described in the AMTAIR project</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="co">(see PY_TechnicalImplementation) that converts argument structures into Bayesian networks.</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="co">The function can handle both basic ArgDown (structure-only) and BayesDown (with probabilities).</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="co">Key steps in the parsing process:</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a><span class="co">1. Remove comments from the markdown text</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a><span class="co">2. Extract titles, descriptions, and indentation levels</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a><span class="co">3. Establish parent-child relationships based on indentation</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a><span class="co">4. Convert the structured information into a DataFrame</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a><span class="co">5. Add derived columns for network analysis</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a><span class="co">DEPENDENCIES: pandas, re, json libraries</span></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a><span class="co">INPUTS: Markdown text in ArgDown/BayesDown format</span></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a><span class="co">OUTPUTS: Structured DataFrame with node information, relationships, and properties</span></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> parse_markdown_hierarchy_fixed(markdown_text, ArgDown<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a><span class="co">    Parse ArgDown or BayesDown format into a structured DataFrame with parent-child relationships.</span></span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a><span class="co">        markdown_text (str): Text in ArgDown or BayesDown format</span></span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a><span class="co">        ArgDown (bool): If True, extracts only structure without probabilities</span></span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a><span class="co">                        If False, extracts both structure and probability information</span></span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a><span class="co">        pandas.DataFrame: Structured data with node information, relationships, and attributes</span></span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a>    <span class="co"># PHASE 1: Clean and prepare the text</span></span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a>    clean_text <span class="op">=</span> remove_comments(markdown_text)</span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># PHASE 2: Extract basic information about nodes</span></span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a>    titles_info <span class="op">=</span> extract_titles_info(clean_text)</span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># PHASE 3: Determine the hierarchical relationships</span></span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a>    titles_with_relations <span class="op">=</span> establish_relationships_fixed(titles_info, clean_text)</span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a>    <span class="co"># PHASE 4: Convert to structured DataFrame format</span></span>
<span id="cb14-45"><a href="#cb14-45" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> convert_to_dataframe(titles_with_relations, ArgDown)</span>
<span id="cb14-46"><a href="#cb14-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-47"><a href="#cb14-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># PHASE 5: Add derived columns for analysis</span></span>
<span id="cb14-48"><a href="#cb14-48" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> add_no_parent_no_child_columns_to_df(df)</span>
<span id="cb14-49"><a href="#cb14-49" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> add_parents_instantiation_columns_to_df(df)</span>
<span id="cb14-50"><a href="#cb14-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-51"><a href="#cb14-51" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb14-52"><a href="#cb14-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-53"><a href="#cb14-53" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> remove_comments(markdown_text):</span>
<span id="cb14-54"><a href="#cb14-54" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb14-55"><a href="#cb14-55" aria-hidden="true" tabindex="-1"></a><span class="co">    Remove comment blocks from markdown text using regex pattern matching.</span></span>
<span id="cb14-56"><a href="#cb14-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-57"><a href="#cb14-57" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb14-58"><a href="#cb14-58" aria-hidden="true" tabindex="-1"></a><span class="co">        markdown_text (str): Text containing potential comment blocks</span></span>
<span id="cb14-59"><a href="#cb14-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-60"><a href="#cb14-60" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb14-61"><a href="#cb14-61" aria-hidden="true" tabindex="-1"></a><span class="co">        str: Text with comment blocks removed</span></span>
<span id="cb14-62"><a href="#cb14-62" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb14-63"><a href="#cb14-63" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Remove anything between /* and */ using regex</span></span>
<span id="cb14-64"><a href="#cb14-64" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> re.sub(<span class="vs">r'/</span><span class="ch">\*</span><span class="dv">.</span><span class="op">*?</span><span class="ch">\*</span><span class="vs">/'</span>, <span class="st">''</span>, markdown_text, flags<span class="op">=</span>re.DOTALL)</span>
<span id="cb14-65"><a href="#cb14-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-66"><a href="#cb14-66" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> extract_titles_info(text):</span>
<span id="cb14-67"><a href="#cb14-67" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb14-68"><a href="#cb14-68" aria-hidden="true" tabindex="-1"></a><span class="co">    Extract titles with their descriptions and indentation levels from markdown text.</span></span>
<span id="cb14-69"><a href="#cb14-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-70"><a href="#cb14-70" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb14-71"><a href="#cb14-71" aria-hidden="true" tabindex="-1"></a><span class="co">        text (str): Cleaned markdown text</span></span>
<span id="cb14-72"><a href="#cb14-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-73"><a href="#cb14-73" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb14-74"><a href="#cb14-74" aria-hidden="true" tabindex="-1"></a><span class="co">        dict: Dictionary with titles as keys and dictionaries of attributes as values</span></span>
<span id="cb14-75"><a href="#cb14-75" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb14-76"><a href="#cb14-76" aria-hidden="true" tabindex="-1"></a>    lines <span class="op">=</span> text.split(<span class="st">'</span><span class="ch">\n</span><span class="st">'</span>)</span>
<span id="cb14-77"><a href="#cb14-77" aria-hidden="true" tabindex="-1"></a>    titles_info <span class="op">=</span> {}</span>
<span id="cb14-78"><a href="#cb14-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-79"><a href="#cb14-79" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> line <span class="kw">in</span> lines:</span>
<span id="cb14-80"><a href="#cb14-80" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Skip empty lines</span></span>
<span id="cb14-81"><a href="#cb14-81" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> line.strip():</span>
<span id="cb14-82"><a href="#cb14-82" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb14-83"><a href="#cb14-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-84"><a href="#cb14-84" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Extract title within square or angle brackets</span></span>
<span id="cb14-85"><a href="#cb14-85" aria-hidden="true" tabindex="-1"></a>        title_match <span class="op">=</span> re.search(<span class="vs">r'</span><span class="pp">[&lt;</span><span class="ch">\[</span><span class="pp">]</span><span class="kw">(</span><span class="dv">.</span><span class="op">+?</span><span class="kw">)</span><span class="pp">[&gt;</span><span class="ch">\]</span><span class="pp">]</span><span class="vs">'</span>, line)</span>
<span id="cb14-86"><a href="#cb14-86" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> title_match:</span>
<span id="cb14-87"><a href="#cb14-87" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb14-88"><a href="#cb14-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-89"><a href="#cb14-89" aria-hidden="true" tabindex="-1"></a>        title <span class="op">=</span> title_match.group(<span class="dv">1</span>)</span>
<span id="cb14-90"><a href="#cb14-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-91"><a href="#cb14-91" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Extract description and metadata</span></span>
<span id="cb14-92"><a href="#cb14-92" aria-hidden="true" tabindex="-1"></a>        title_pattern_in_line <span class="op">=</span> <span class="vs">r'</span><span class="pp">[&lt;</span><span class="ch">\[</span><span class="pp">]</span><span class="vs">'</span> <span class="op">+</span> re.escape(title) <span class="op">+</span> <span class="vs">r'</span><span class="pp">[&gt;</span><span class="ch">\]</span><span class="pp">]</span><span class="vs">:'</span></span>
<span id="cb14-93"><a href="#cb14-93" aria-hidden="true" tabindex="-1"></a>        description_match <span class="op">=</span> re.search(title_pattern_in_line <span class="op">+</span> <span class="vs">r'</span><span class="dv">\s</span><span class="op">*</span><span class="kw">(</span><span class="dv">.</span><span class="op">*</span><span class="kw">)</span><span class="vs">'</span>, line)</span>
<span id="cb14-94"><a href="#cb14-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-95"><a href="#cb14-95" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> description_match:</span>
<span id="cb14-96"><a href="#cb14-96" aria-hidden="true" tabindex="-1"></a>            full_text <span class="op">=</span> description_match.group(<span class="dv">1</span>).strip()</span>
<span id="cb14-97"><a href="#cb14-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-98"><a href="#cb14-98" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Split description and metadata at the first "{"</span></span>
<span id="cb14-99"><a href="#cb14-99" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="st">"{"</span> <span class="kw">in</span> full_text:</span>
<span id="cb14-100"><a href="#cb14-100" aria-hidden="true" tabindex="-1"></a>                split_index <span class="op">=</span> full_text.find(<span class="st">"{"</span>)</span>
<span id="cb14-101"><a href="#cb14-101" aria-hidden="true" tabindex="-1"></a>                description <span class="op">=</span> full_text[:split_index].strip()</span>
<span id="cb14-102"><a href="#cb14-102" aria-hidden="true" tabindex="-1"></a>                metadata <span class="op">=</span> full_text[split_index:].strip()</span>
<span id="cb14-103"><a href="#cb14-103" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb14-104"><a href="#cb14-104" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Keep the entire description and no metadata</span></span>
<span id="cb14-105"><a href="#cb14-105" aria-hidden="true" tabindex="-1"></a>                description <span class="op">=</span> full_text</span>
<span id="cb14-106"><a href="#cb14-106" aria-hidden="true" tabindex="-1"></a>                metadata <span class="op">=</span> <span class="st">''</span>  <span class="co"># Initialize as empty string</span></span>
<span id="cb14-107"><a href="#cb14-107" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb14-108"><a href="#cb14-108" aria-hidden="true" tabindex="-1"></a>            description <span class="op">=</span> <span class="st">''</span></span>
<span id="cb14-109"><a href="#cb14-109" aria-hidden="true" tabindex="-1"></a>            metadata <span class="op">=</span> <span class="st">''</span>  <span class="co"># Ensure metadata is initialized</span></span>
<span id="cb14-110"><a href="#cb14-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-111"><a href="#cb14-111" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate indentation level based on spaces before + or - symbol</span></span>
<span id="cb14-112"><a href="#cb14-112" aria-hidden="true" tabindex="-1"></a>        indentation <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb14-113"><a href="#cb14-113" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">'+'</span> <span class="kw">in</span> line:</span>
<span id="cb14-114"><a href="#cb14-114" aria-hidden="true" tabindex="-1"></a>            symbol_index <span class="op">=</span> line.find(<span class="st">'+'</span>)</span>
<span id="cb14-115"><a href="#cb14-115" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Count spaces before the '+' symbol</span></span>
<span id="cb14-116"><a href="#cb14-116" aria-hidden="true" tabindex="-1"></a>            i <span class="op">=</span> symbol_index <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb14-117"><a href="#cb14-117" aria-hidden="true" tabindex="-1"></a>            <span class="cf">while</span> i <span class="op">&gt;=</span> <span class="dv">0</span> <span class="kw">and</span> line[i] <span class="op">==</span> <span class="st">' '</span>:</span>
<span id="cb14-118"><a href="#cb14-118" aria-hidden="true" tabindex="-1"></a>                indentation <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb14-119"><a href="#cb14-119" aria-hidden="true" tabindex="-1"></a>                i <span class="op">-=</span> <span class="dv">1</span></span>
<span id="cb14-120"><a href="#cb14-120" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> <span class="st">'-'</span> <span class="kw">in</span> line:</span>
<span id="cb14-121"><a href="#cb14-121" aria-hidden="true" tabindex="-1"></a>            symbol_index <span class="op">=</span> line.find(<span class="st">'-'</span>)</span>
<span id="cb14-122"><a href="#cb14-122" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Count spaces before the '-' symbol</span></span>
<span id="cb14-123"><a href="#cb14-123" aria-hidden="true" tabindex="-1"></a>            i <span class="op">=</span> symbol_index <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb14-124"><a href="#cb14-124" aria-hidden="true" tabindex="-1"></a>            <span class="cf">while</span> i <span class="op">&gt;=</span> <span class="dv">0</span> <span class="kw">and</span> line[i] <span class="op">==</span> <span class="st">' '</span>:</span>
<span id="cb14-125"><a href="#cb14-125" aria-hidden="true" tabindex="-1"></a>                indentation <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb14-126"><a href="#cb14-126" aria-hidden="true" tabindex="-1"></a>                i <span class="op">-=</span> <span class="dv">1</span></span>
<span id="cb14-127"><a href="#cb14-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-128"><a href="#cb14-128" aria-hidden="true" tabindex="-1"></a>        <span class="co"># If neither symbol exists, indentation remains 0</span></span>
<span id="cb14-129"><a href="#cb14-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-130"><a href="#cb14-130" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> title <span class="kw">in</span> titles_info:</span>
<span id="cb14-131"><a href="#cb14-131" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Only update description if it's currently empty and we found a new one</span></span>
<span id="cb14-132"><a href="#cb14-132" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">not</span> titles_info[title][<span class="st">'description'</span>] <span class="kw">and</span> description:</span>
<span id="cb14-133"><a href="#cb14-133" aria-hidden="true" tabindex="-1"></a>                titles_info[title][<span class="st">'description'</span>] <span class="op">=</span> description</span>
<span id="cb14-134"><a href="#cb14-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-135"><a href="#cb14-135" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Store all indentation levels for this title</span></span>
<span id="cb14-136"><a href="#cb14-136" aria-hidden="true" tabindex="-1"></a>            titles_info[title][<span class="st">'indentation_levels'</span>].append(indentation)</span>
<span id="cb14-137"><a href="#cb14-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-138"><a href="#cb14-138" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Keep max indentation for backward compatibility</span></span>
<span id="cb14-139"><a href="#cb14-139" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> indentation <span class="op">&gt;</span> titles_info[title][<span class="st">'indentation'</span>]:</span>
<span id="cb14-140"><a href="#cb14-140" aria-hidden="true" tabindex="-1"></a>                titles_info[title][<span class="st">'indentation'</span>] <span class="op">=</span> indentation</span>
<span id="cb14-141"><a href="#cb14-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-142"><a href="#cb14-142" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Do NOT update metadata here - keep the original metadata</span></span>
<span id="cb14-143"><a href="#cb14-143" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb14-144"><a href="#cb14-144" aria-hidden="true" tabindex="-1"></a>            <span class="co"># First time seeing this title, create a new entry</span></span>
<span id="cb14-145"><a href="#cb14-145" aria-hidden="true" tabindex="-1"></a>            titles_info[title] <span class="op">=</span> {</span>
<span id="cb14-146"><a href="#cb14-146" aria-hidden="true" tabindex="-1"></a>                <span class="st">'description'</span>: description,</span>
<span id="cb14-147"><a href="#cb14-147" aria-hidden="true" tabindex="-1"></a>                <span class="st">'indentation'</span>: indentation,</span>
<span id="cb14-148"><a href="#cb14-148" aria-hidden="true" tabindex="-1"></a>                <span class="st">'indentation_levels'</span>: [indentation],  <span class="co"># Initialize with first indentation level</span></span>
<span id="cb14-149"><a href="#cb14-149" aria-hidden="true" tabindex="-1"></a>                <span class="st">'parents'</span>: [],</span>
<span id="cb14-150"><a href="#cb14-150" aria-hidden="true" tabindex="-1"></a>                <span class="st">'children'</span>: [],</span>
<span id="cb14-151"><a href="#cb14-151" aria-hidden="true" tabindex="-1"></a>                <span class="st">'line'</span>: <span class="va">None</span>,</span>
<span id="cb14-152"><a href="#cb14-152" aria-hidden="true" tabindex="-1"></a>                <span class="st">'line_numbers'</span>: [],  <span class="co"># Initialize an empty list for all occurrences</span></span>
<span id="cb14-153"><a href="#cb14-153" aria-hidden="true" tabindex="-1"></a>                <span class="st">'metadata'</span>: metadata  <span class="co"># Set metadata explicitly from what we found</span></span>
<span id="cb14-154"><a href="#cb14-154" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb14-155"><a href="#cb14-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-156"><a href="#cb14-156" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> titles_info</span>
<span id="cb14-157"><a href="#cb14-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-158"><a href="#cb14-158" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> establish_relationships_fixed(titles_info, text):</span>
<span id="cb14-159"><a href="#cb14-159" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb14-160"><a href="#cb14-160" aria-hidden="true" tabindex="-1"></a><span class="co">    Establish parent-child relationships between titles using BayesDown indentation rules.</span></span>
<span id="cb14-161"><a href="#cb14-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-162"><a href="#cb14-162" aria-hidden="true" tabindex="-1"></a><span class="co">    In BayesDown syntax:</span></span>
<span id="cb14-163"><a href="#cb14-163" aria-hidden="true" tabindex="-1"></a><span class="co">    - More indented nodes (with + symbol) are PARENTS of less indented nodes</span></span>
<span id="cb14-164"><a href="#cb14-164" aria-hidden="true" tabindex="-1"></a><span class="co">    - The relationship reads as "Effect is caused by Cause" (Effect + Cause)</span></span>
<span id="cb14-165"><a href="#cb14-165" aria-hidden="true" tabindex="-1"></a><span class="co">    - This aligns with how Bayesian networks represent causality</span></span>
<span id="cb14-166"><a href="#cb14-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-167"><a href="#cb14-167" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb14-168"><a href="#cb14-168" aria-hidden="true" tabindex="-1"></a><span class="co">        titles_info (dict): Dictionary with information about titles</span></span>
<span id="cb14-169"><a href="#cb14-169" aria-hidden="true" tabindex="-1"></a><span class="co">        text (str): Original markdown text (for identifying line numbers)</span></span>
<span id="cb14-170"><a href="#cb14-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-171"><a href="#cb14-171" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb14-172"><a href="#cb14-172" aria-hidden="true" tabindex="-1"></a><span class="co">        dict: Updated dictionary with parent-child relationships</span></span>
<span id="cb14-173"><a href="#cb14-173" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb14-174"><a href="#cb14-174" aria-hidden="true" tabindex="-1"></a>    lines <span class="op">=</span> text.split(<span class="st">'</span><span class="ch">\n</span><span class="st">'</span>)</span>
<span id="cb14-175"><a href="#cb14-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-176"><a href="#cb14-176" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Dictionary to store line numbers for each title occurrence</span></span>
<span id="cb14-177"><a href="#cb14-177" aria-hidden="true" tabindex="-1"></a>    title_occurrences <span class="op">=</span> {}</span>
<span id="cb14-178"><a href="#cb14-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-179"><a href="#cb14-179" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Record line number for each title (including multiple occurrences)</span></span>
<span id="cb14-180"><a href="#cb14-180" aria-hidden="true" tabindex="-1"></a>    line_number <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb14-181"><a href="#cb14-181" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> line <span class="kw">in</span> lines:</span>
<span id="cb14-182"><a href="#cb14-182" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> line.strip():</span>
<span id="cb14-183"><a href="#cb14-183" aria-hidden="true" tabindex="-1"></a>            line_number <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb14-184"><a href="#cb14-184" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb14-185"><a href="#cb14-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-186"><a href="#cb14-186" aria-hidden="true" tabindex="-1"></a>        title_match <span class="op">=</span> re.search(<span class="vs">r'</span><span class="pp">[&lt;</span><span class="ch">\[</span><span class="pp">]</span><span class="kw">(</span><span class="dv">.</span><span class="op">+?</span><span class="kw">)</span><span class="pp">[&gt;</span><span class="ch">\]</span><span class="pp">]</span><span class="vs">'</span>, line)</span>
<span id="cb14-187"><a href="#cb14-187" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> title_match:</span>
<span id="cb14-188"><a href="#cb14-188" aria-hidden="true" tabindex="-1"></a>            line_number <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb14-189"><a href="#cb14-189" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb14-190"><a href="#cb14-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-191"><a href="#cb14-191" aria-hidden="true" tabindex="-1"></a>        title <span class="op">=</span> title_match.group(<span class="dv">1</span>)</span>
<span id="cb14-192"><a href="#cb14-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-193"><a href="#cb14-193" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Store all occurrences of each title with their line numbers</span></span>
<span id="cb14-194"><a href="#cb14-194" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> title <span class="kw">not</span> <span class="kw">in</span> title_occurrences:</span>
<span id="cb14-195"><a href="#cb14-195" aria-hidden="true" tabindex="-1"></a>            title_occurrences[title] <span class="op">=</span> []</span>
<span id="cb14-196"><a href="#cb14-196" aria-hidden="true" tabindex="-1"></a>        title_occurrences[title].append(line_number)</span>
<span id="cb14-197"><a href="#cb14-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-198"><a href="#cb14-198" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Store all line numbers where this title appears</span></span>
<span id="cb14-199"><a href="#cb14-199" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">'line_numbers'</span> <span class="kw">not</span> <span class="kw">in</span> titles_info[title]:</span>
<span id="cb14-200"><a href="#cb14-200" aria-hidden="true" tabindex="-1"></a>            titles_info[title][<span class="st">'line_numbers'</span>] <span class="op">=</span> []</span>
<span id="cb14-201"><a href="#cb14-201" aria-hidden="true" tabindex="-1"></a>        titles_info[title][<span class="st">'line_numbers'</span>].append(line_number)</span>
<span id="cb14-202"><a href="#cb14-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-203"><a href="#cb14-203" aria-hidden="true" tabindex="-1"></a>        <span class="co"># For backward compatibility, keep the first occurrence in 'line'</span></span>
<span id="cb14-204"><a href="#cb14-204" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> titles_info[title][<span class="st">'line'</span>] <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb14-205"><a href="#cb14-205" aria-hidden="true" tabindex="-1"></a>            titles_info[title][<span class="st">'line'</span>] <span class="op">=</span> line_number</span>
<span id="cb14-206"><a href="#cb14-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-207"><a href="#cb14-207" aria-hidden="true" tabindex="-1"></a>        line_number <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb14-208"><a href="#cb14-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-209"><a href="#cb14-209" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create an ordered list of all title occurrences with their line numbers</span></span>
<span id="cb14-210"><a href="#cb14-210" aria-hidden="true" tabindex="-1"></a>    all_occurrences <span class="op">=</span> []</span>
<span id="cb14-211"><a href="#cb14-211" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> title, occurrences <span class="kw">in</span> title_occurrences.items():</span>
<span id="cb14-212"><a href="#cb14-212" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> line_num <span class="kw">in</span> occurrences:</span>
<span id="cb14-213"><a href="#cb14-213" aria-hidden="true" tabindex="-1"></a>            all_occurrences.append((title, line_num))</span>
<span id="cb14-214"><a href="#cb14-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-215"><a href="#cb14-215" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sort occurrences by line number</span></span>
<span id="cb14-216"><a href="#cb14-216" aria-hidden="true" tabindex="-1"></a>    all_occurrences.sort(key<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="dv">1</span>])</span>
<span id="cb14-217"><a href="#cb14-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-218"><a href="#cb14-218" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get indentation for each occurrence</span></span>
<span id="cb14-219"><a href="#cb14-219" aria-hidden="true" tabindex="-1"></a>    occurrence_indents <span class="op">=</span> {}</span>
<span id="cb14-220"><a href="#cb14-220" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> title, line_num <span class="kw">in</span> all_occurrences:</span>
<span id="cb14-221"><a href="#cb14-221" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> line <span class="kw">in</span> lines[line_num:line_num<span class="op">+</span><span class="dv">1</span>]:  <span class="co"># Only check the current line</span></span>
<span id="cb14-222"><a href="#cb14-222" aria-hidden="true" tabindex="-1"></a>            indent <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb14-223"><a href="#cb14-223" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="st">'+'</span> <span class="kw">in</span> line:</span>
<span id="cb14-224"><a href="#cb14-224" aria-hidden="true" tabindex="-1"></a>                symbol_index <span class="op">=</span> line.find(<span class="st">'+'</span>)</span>
<span id="cb14-225"><a href="#cb14-225" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Count spaces before the '+' symbol</span></span>
<span id="cb14-226"><a href="#cb14-226" aria-hidden="true" tabindex="-1"></a>                j <span class="op">=</span> symbol_index <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb14-227"><a href="#cb14-227" aria-hidden="true" tabindex="-1"></a>                <span class="cf">while</span> j <span class="op">&gt;=</span> <span class="dv">0</span> <span class="kw">and</span> line[j] <span class="op">==</span> <span class="st">' '</span>:</span>
<span id="cb14-228"><a href="#cb14-228" aria-hidden="true" tabindex="-1"></a>                    indent <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb14-229"><a href="#cb14-229" aria-hidden="true" tabindex="-1"></a>                    j <span class="op">-=</span> <span class="dv">1</span></span>
<span id="cb14-230"><a href="#cb14-230" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> <span class="st">'-'</span> <span class="kw">in</span> line:</span>
<span id="cb14-231"><a href="#cb14-231" aria-hidden="true" tabindex="-1"></a>                symbol_index <span class="op">=</span> line.find(<span class="st">'-'</span>)</span>
<span id="cb14-232"><a href="#cb14-232" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Count spaces before the '-' symbol</span></span>
<span id="cb14-233"><a href="#cb14-233" aria-hidden="true" tabindex="-1"></a>                j <span class="op">=</span> symbol_index <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb14-234"><a href="#cb14-234" aria-hidden="true" tabindex="-1"></a>                <span class="cf">while</span> j <span class="op">&gt;=</span> <span class="dv">0</span> <span class="kw">and</span> line[j] <span class="op">==</span> <span class="st">' '</span>:</span>
<span id="cb14-235"><a href="#cb14-235" aria-hidden="true" tabindex="-1"></a>                    indent <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb14-236"><a href="#cb14-236" aria-hidden="true" tabindex="-1"></a>                    j <span class="op">-=</span> <span class="dv">1</span></span>
<span id="cb14-237"><a href="#cb14-237" aria-hidden="true" tabindex="-1"></a>            occurrence_indents[(title, line_num)] <span class="op">=</span> indent</span>
<span id="cb14-238"><a href="#cb14-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-239"><a href="#cb14-239" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Enhanced backward pass for correct parent-child relationships</span></span>
<span id="cb14-240"><a href="#cb14-240" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, (title, line_num) <span class="kw">in</span> <span class="bu">enumerate</span>(all_occurrences):</span>
<span id="cb14-241"><a href="#cb14-241" aria-hidden="true" tabindex="-1"></a>        current_indent <span class="op">=</span> occurrence_indents[(title, line_num)]</span>
<span id="cb14-242"><a href="#cb14-242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-243"><a href="#cb14-243" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Skip root nodes (indentation 0) for processing</span></span>
<span id="cb14-244"><a href="#cb14-244" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> current_indent <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb14-245"><a href="#cb14-245" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb14-246"><a href="#cb14-246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-247"><a href="#cb14-247" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Look for the immediately preceding node with lower indentation</span></span>
<span id="cb14-248"><a href="#cb14-248" aria-hidden="true" tabindex="-1"></a>        j <span class="op">=</span> i <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb14-249"><a href="#cb14-249" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span> j <span class="op">&gt;=</span> <span class="dv">0</span>:</span>
<span id="cb14-250"><a href="#cb14-250" aria-hidden="true" tabindex="-1"></a>            prev_title, prev_line <span class="op">=</span> all_occurrences[j]</span>
<span id="cb14-251"><a href="#cb14-251" aria-hidden="true" tabindex="-1"></a>            prev_indent <span class="op">=</span> occurrence_indents[(prev_title, prev_line)]</span>
<span id="cb14-252"><a href="#cb14-252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-253"><a href="#cb14-253" aria-hidden="true" tabindex="-1"></a>            <span class="co"># If we find a node with less indentation, it's a child of current node</span></span>
<span id="cb14-254"><a href="#cb14-254" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> prev_indent <span class="op">&lt;</span> current_indent:</span>
<span id="cb14-255"><a href="#cb14-255" aria-hidden="true" tabindex="-1"></a>                <span class="co"># In BayesDown: More indented node is a parent (cause) of less indented node (effect)</span></span>
<span id="cb14-256"><a href="#cb14-256" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> title <span class="kw">not</span> <span class="kw">in</span> titles_info[prev_title][<span class="st">'parents'</span>]:</span>
<span id="cb14-257"><a href="#cb14-257" aria-hidden="true" tabindex="-1"></a>                    titles_info[prev_title][<span class="st">'parents'</span>].append(title)</span>
<span id="cb14-258"><a href="#cb14-258" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> prev_title <span class="kw">not</span> <span class="kw">in</span> titles_info[title][<span class="st">'children'</span>]:</span>
<span id="cb14-259"><a href="#cb14-259" aria-hidden="true" tabindex="-1"></a>                    titles_info[title][<span class="st">'children'</span>].append(prev_title)</span>
<span id="cb14-260"><a href="#cb14-260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-261"><a href="#cb14-261" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Only need to find the immediate child (closest preceding node with lower indentation)</span></span>
<span id="cb14-262"><a href="#cb14-262" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb14-263"><a href="#cb14-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-264"><a href="#cb14-264" aria-hidden="true" tabindex="-1"></a>            j <span class="op">-=</span> <span class="dv">1</span></span>
<span id="cb14-265"><a href="#cb14-265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-266"><a href="#cb14-266" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> titles_info</span>
<span id="cb14-267"><a href="#cb14-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-268"><a href="#cb14-268" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> convert_to_dataframe(titles_info, ArgDown):</span>
<span id="cb14-269"><a href="#cb14-269" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb14-270"><a href="#cb14-270" aria-hidden="true" tabindex="-1"></a><span class="co">    Convert the titles information dictionary to a pandas DataFrame.</span></span>
<span id="cb14-271"><a href="#cb14-271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-272"><a href="#cb14-272" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb14-273"><a href="#cb14-273" aria-hidden="true" tabindex="-1"></a><span class="co">        titles_info (dict): Dictionary with information about titles</span></span>
<span id="cb14-274"><a href="#cb14-274" aria-hidden="true" tabindex="-1"></a><span class="co">        ArgDown (bool): If True, extract only structural information without probabilities</span></span>
<span id="cb14-275"><a href="#cb14-275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-276"><a href="#cb14-276" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb14-277"><a href="#cb14-277" aria-hidden="true" tabindex="-1"></a><span class="co">        pandas.DataFrame: Structured data with node information and relationships</span></span>
<span id="cb14-278"><a href="#cb14-278" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb14-279"><a href="#cb14-279" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> ArgDown <span class="op">==</span> <span class="va">True</span>:</span>
<span id="cb14-280"><a href="#cb14-280" aria-hidden="true" tabindex="-1"></a>        <span class="co"># For ArgDown, exclude probability columns</span></span>
<span id="cb14-281"><a href="#cb14-281" aria-hidden="true" tabindex="-1"></a>        df <span class="op">=</span> pd.DataFrame(columns<span class="op">=</span>[<span class="st">'Title'</span>, <span class="st">'Description'</span>, <span class="st">'line'</span>, <span class="st">'line_numbers'</span>, <span class="st">'indentation'</span>,</span>
<span id="cb14-282"><a href="#cb14-282" aria-hidden="true" tabindex="-1"></a>                               <span class="st">'indentation_levels'</span>, <span class="st">'Parents'</span>, <span class="st">'Children'</span>, <span class="st">'instantiations'</span>])</span>
<span id="cb14-283"><a href="#cb14-283" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb14-284"><a href="#cb14-284" aria-hidden="true" tabindex="-1"></a>        <span class="co"># For BayesDown, include probability columns</span></span>
<span id="cb14-285"><a href="#cb14-285" aria-hidden="true" tabindex="-1"></a>        df <span class="op">=</span> pd.DataFrame(columns<span class="op">=</span>[<span class="st">'Title'</span>, <span class="st">'Description'</span>, <span class="st">'line'</span>, <span class="st">'line_numbers'</span>, <span class="st">'indentation'</span>,</span>
<span id="cb14-286"><a href="#cb14-286" aria-hidden="true" tabindex="-1"></a>                               <span class="st">'indentation_levels'</span>, <span class="st">'Parents'</span>, <span class="st">'Children'</span>, <span class="st">'instantiations'</span>,</span>
<span id="cb14-287"><a href="#cb14-287" aria-hidden="true" tabindex="-1"></a>                               <span class="st">'priors'</span>, <span class="st">'posteriors'</span>])</span>
<span id="cb14-288"><a href="#cb14-288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-289"><a href="#cb14-289" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> title, info <span class="kw">in</span> titles_info.items():</span>
<span id="cb14-290"><a href="#cb14-290" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Parse the metadata JSON string into a Python dictionary</span></span>
<span id="cb14-291"><a href="#cb14-291" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">'metadata'</span> <span class="kw">in</span> info <span class="kw">and</span> info[<span class="st">'metadata'</span>]:</span>
<span id="cb14-292"><a href="#cb14-292" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb14-293"><a href="#cb14-293" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Only try to parse if metadata is not empty</span></span>
<span id="cb14-294"><a href="#cb14-294" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> info[<span class="st">'metadata'</span>].strip():</span>
<span id="cb14-295"><a href="#cb14-295" aria-hidden="true" tabindex="-1"></a>                    jsonMetadata <span class="op">=</span> json.loads(info[<span class="st">'metadata'</span>])</span>
<span id="cb14-296"><a href="#cb14-296" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> ArgDown <span class="op">==</span> <span class="va">True</span>:</span>
<span id="cb14-297"><a href="#cb14-297" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># Create the row dictionary with instantiations as metadata only, no probabilities yet</span></span>
<span id="cb14-298"><a href="#cb14-298" aria-hidden="true" tabindex="-1"></a>                        row <span class="op">=</span> {</span>
<span id="cb14-299"><a href="#cb14-299" aria-hidden="true" tabindex="-1"></a>                            <span class="st">'Title'</span>: title,</span>
<span id="cb14-300"><a href="#cb14-300" aria-hidden="true" tabindex="-1"></a>                            <span class="st">'Description'</span>: info.get(<span class="st">'description'</span>, <span class="st">''</span>),</span>
<span id="cb14-301"><a href="#cb14-301" aria-hidden="true" tabindex="-1"></a>                            <span class="st">'line'</span>: info.get(<span class="st">'line'</span>,<span class="st">''</span>),</span>
<span id="cb14-302"><a href="#cb14-302" aria-hidden="true" tabindex="-1"></a>                            <span class="st">'line_numbers'</span>: info.get(<span class="st">'line_numbers'</span>, []),</span>
<span id="cb14-303"><a href="#cb14-303" aria-hidden="true" tabindex="-1"></a>                            <span class="st">'indentation'</span>: info.get(<span class="st">'indentation'</span>,<span class="st">''</span>),</span>
<span id="cb14-304"><a href="#cb14-304" aria-hidden="true" tabindex="-1"></a>                            <span class="st">'indentation_levels'</span>: info.get(<span class="st">'indentation_levels'</span>, []),</span>
<span id="cb14-305"><a href="#cb14-305" aria-hidden="true" tabindex="-1"></a>                            <span class="st">'Parents'</span>: info.get(<span class="st">'parents'</span>, []),</span>
<span id="cb14-306"><a href="#cb14-306" aria-hidden="true" tabindex="-1"></a>                            <span class="st">'Children'</span>: info.get(<span class="st">'children'</span>, []),</span>
<span id="cb14-307"><a href="#cb14-307" aria-hidden="true" tabindex="-1"></a>                            <span class="co"># Extract specific metadata fields, defaulting to empty if not present</span></span>
<span id="cb14-308"><a href="#cb14-308" aria-hidden="true" tabindex="-1"></a>                            <span class="st">'instantiations'</span>: jsonMetadata.get(<span class="st">'instantiations'</span>, []),</span>
<span id="cb14-309"><a href="#cb14-309" aria-hidden="true" tabindex="-1"></a>                        }</span>
<span id="cb14-310"><a href="#cb14-310" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">else</span>:</span>
<span id="cb14-311"><a href="#cb14-311" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># Create dict with probabilities for BayesDown</span></span>
<span id="cb14-312"><a href="#cb14-312" aria-hidden="true" tabindex="-1"></a>                        row <span class="op">=</span> {</span>
<span id="cb14-313"><a href="#cb14-313" aria-hidden="true" tabindex="-1"></a>                            <span class="st">'Title'</span>: title,</span>
<span id="cb14-314"><a href="#cb14-314" aria-hidden="true" tabindex="-1"></a>                            <span class="st">'Description'</span>: info.get(<span class="st">'description'</span>, <span class="st">''</span>),</span>
<span id="cb14-315"><a href="#cb14-315" aria-hidden="true" tabindex="-1"></a>                            <span class="st">'line'</span>: info.get(<span class="st">'line'</span>,<span class="st">''</span>),</span>
<span id="cb14-316"><a href="#cb14-316" aria-hidden="true" tabindex="-1"></a>                            <span class="st">'line_numbers'</span>: info.get(<span class="st">'line_numbers'</span>, []),</span>
<span id="cb14-317"><a href="#cb14-317" aria-hidden="true" tabindex="-1"></a>                            <span class="st">'indentation'</span>: info.get(<span class="st">'indentation'</span>,<span class="st">''</span>),</span>
<span id="cb14-318"><a href="#cb14-318" aria-hidden="true" tabindex="-1"></a>                            <span class="st">'indentation_levels'</span>: info.get(<span class="st">'indentation_levels'</span>, []),</span>
<span id="cb14-319"><a href="#cb14-319" aria-hidden="true" tabindex="-1"></a>                            <span class="st">'Parents'</span>: info.get(<span class="st">'parents'</span>, []),</span>
<span id="cb14-320"><a href="#cb14-320" aria-hidden="true" tabindex="-1"></a>                            <span class="st">'Children'</span>: info.get(<span class="st">'children'</span>, []),</span>
<span id="cb14-321"><a href="#cb14-321" aria-hidden="true" tabindex="-1"></a>                            <span class="co"># Extract specific metadata fields, defaulting to empty if not present</span></span>
<span id="cb14-322"><a href="#cb14-322" aria-hidden="true" tabindex="-1"></a>                            <span class="st">'instantiations'</span>: jsonMetadata.get(<span class="st">'instantiations'</span>, []),</span>
<span id="cb14-323"><a href="#cb14-323" aria-hidden="true" tabindex="-1"></a>                            <span class="st">'priors'</span>: jsonMetadata.get(<span class="st">'priors'</span>, {}),</span>
<span id="cb14-324"><a href="#cb14-324" aria-hidden="true" tabindex="-1"></a>                            <span class="st">'posteriors'</span>: jsonMetadata.get(<span class="st">'posteriors'</span>, {})</span>
<span id="cb14-325"><a href="#cb14-325" aria-hidden="true" tabindex="-1"></a>                        }</span>
<span id="cb14-326"><a href="#cb14-326" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb14-327"><a href="#cb14-327" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Empty metadata case</span></span>
<span id="cb14-328"><a href="#cb14-328" aria-hidden="true" tabindex="-1"></a>                    row <span class="op">=</span> {</span>
<span id="cb14-329"><a href="#cb14-329" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'Title'</span>: title,</span>
<span id="cb14-330"><a href="#cb14-330" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'Description'</span>: info.get(<span class="st">'description'</span>, <span class="st">''</span>),</span>
<span id="cb14-331"><a href="#cb14-331" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'line'</span>: info.get(<span class="st">'line'</span>,<span class="st">''</span>),</span>
<span id="cb14-332"><a href="#cb14-332" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'line_numbers'</span>: info.get(<span class="st">'line_numbers'</span>, []),</span>
<span id="cb14-333"><a href="#cb14-333" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'indentation'</span>: info.get(<span class="st">'indentation'</span>,<span class="st">''</span>),</span>
<span id="cb14-334"><a href="#cb14-334" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'indentation_levels'</span>: info.get(<span class="st">'indentation_levels'</span>, []),</span>
<span id="cb14-335"><a href="#cb14-335" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'Parents'</span>: info.get(<span class="st">'parents'</span>, []),</span>
<span id="cb14-336"><a href="#cb14-336" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'Children'</span>: info.get(<span class="st">'children'</span>, []),</span>
<span id="cb14-337"><a href="#cb14-337" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'instantiations'</span>: [],</span>
<span id="cb14-338"><a href="#cb14-338" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'priors'</span>: {},</span>
<span id="cb14-339"><a href="#cb14-339" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'posteriors'</span>: {}</span>
<span id="cb14-340"><a href="#cb14-340" aria-hidden="true" tabindex="-1"></a>                    }</span>
<span id="cb14-341"><a href="#cb14-341" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span> json.JSONDecodeError:</span>
<span id="cb14-342"><a href="#cb14-342" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Handle case where metadata isn't valid JSON</span></span>
<span id="cb14-343"><a href="#cb14-343" aria-hidden="true" tabindex="-1"></a>                row <span class="op">=</span> {</span>
<span id="cb14-344"><a href="#cb14-344" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'Title'</span>: title,</span>
<span id="cb14-345"><a href="#cb14-345" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'Description'</span>: info.get(<span class="st">'description'</span>, <span class="st">''</span>),</span>
<span id="cb14-346"><a href="#cb14-346" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'line'</span>: info.get(<span class="st">'line'</span>,<span class="st">''</span>),</span>
<span id="cb14-347"><a href="#cb14-347" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'line_numbers'</span>: info.get(<span class="st">'line_numbers'</span>, []),</span>
<span id="cb14-348"><a href="#cb14-348" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'indentation'</span>: info.get(<span class="st">'indentation'</span>,<span class="st">''</span>),</span>
<span id="cb14-349"><a href="#cb14-349" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'indentation_levels'</span>: info.get(<span class="st">'indentation_levels'</span>, []),</span>
<span id="cb14-350"><a href="#cb14-350" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'Parents'</span>: info.get(<span class="st">'parents'</span>, []),</span>
<span id="cb14-351"><a href="#cb14-351" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'Children'</span>: info.get(<span class="st">'children'</span>, []),</span>
<span id="cb14-352"><a href="#cb14-352" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'instantiations'</span>: [],</span>
<span id="cb14-353"><a href="#cb14-353" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'priors'</span>: {},</span>
<span id="cb14-354"><a href="#cb14-354" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'posteriors'</span>: {}</span>
<span id="cb14-355"><a href="#cb14-355" aria-hidden="true" tabindex="-1"></a>                }</span>
<span id="cb14-356"><a href="#cb14-356" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb14-357"><a href="#cb14-357" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Handle case where metadata field doesn't exist or is empty</span></span>
<span id="cb14-358"><a href="#cb14-358" aria-hidden="true" tabindex="-1"></a>            row <span class="op">=</span> {</span>
<span id="cb14-359"><a href="#cb14-359" aria-hidden="true" tabindex="-1"></a>                <span class="st">'Title'</span>: title,</span>
<span id="cb14-360"><a href="#cb14-360" aria-hidden="true" tabindex="-1"></a>                <span class="st">'Description'</span>: info.get(<span class="st">'description'</span>, <span class="st">''</span>),</span>
<span id="cb14-361"><a href="#cb14-361" aria-hidden="true" tabindex="-1"></a>                <span class="st">'line'</span>: info.get(<span class="st">'line'</span>,<span class="st">''</span>),</span>
<span id="cb14-362"><a href="#cb14-362" aria-hidden="true" tabindex="-1"></a>                <span class="st">'line_numbers'</span>: info.get(<span class="st">'line_numbers'</span>, []),</span>
<span id="cb14-363"><a href="#cb14-363" aria-hidden="true" tabindex="-1"></a>                <span class="st">'indentation'</span>: info.get(<span class="st">'indentation'</span>,<span class="st">''</span>),</span>
<span id="cb14-364"><a href="#cb14-364" aria-hidden="true" tabindex="-1"></a>                <span class="st">'indentation_levels'</span>: info.get(<span class="st">'indentation_levels'</span>, []),</span>
<span id="cb14-365"><a href="#cb14-365" aria-hidden="true" tabindex="-1"></a>                <span class="st">'Parents'</span>: info.get(<span class="st">'parents'</span>, []),</span>
<span id="cb14-366"><a href="#cb14-366" aria-hidden="true" tabindex="-1"></a>                <span class="st">'Children'</span>: info.get(<span class="st">'children'</span>, []),</span>
<span id="cb14-367"><a href="#cb14-367" aria-hidden="true" tabindex="-1"></a>                <span class="st">'instantiations'</span>: [],</span>
<span id="cb14-368"><a href="#cb14-368" aria-hidden="true" tabindex="-1"></a>                <span class="st">'priors'</span>: {},</span>
<span id="cb14-369"><a href="#cb14-369" aria-hidden="true" tabindex="-1"></a>                <span class="st">'posteriors'</span>: {}</span>
<span id="cb14-370"><a href="#cb14-370" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb14-371"><a href="#cb14-371" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-372"><a href="#cb14-372" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add the row to the DataFrame</span></span>
<span id="cb14-373"><a href="#cb14-373" aria-hidden="true" tabindex="-1"></a>        df.loc[<span class="bu">len</span>(df)] <span class="op">=</span> row</span>
<span id="cb14-374"><a href="#cb14-374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-375"><a href="#cb14-375" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb14-376"><a href="#cb14-376" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-377"><a href="#cb14-377" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> add_no_parent_no_child_columns_to_df(dataframe):</span>
<span id="cb14-378"><a href="#cb14-378" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb14-379"><a href="#cb14-379" aria-hidden="true" tabindex="-1"></a><span class="co">    Add No_Parent and No_Children boolean columns to the DataFrame to identify root and leaf nodes.</span></span>
<span id="cb14-380"><a href="#cb14-380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-381"><a href="#cb14-381" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb14-382"><a href="#cb14-382" aria-hidden="true" tabindex="-1"></a><span class="co">        dataframe (pandas.DataFrame): The DataFrame to enhance</span></span>
<span id="cb14-383"><a href="#cb14-383" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-384"><a href="#cb14-384" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb14-385"><a href="#cb14-385" aria-hidden="true" tabindex="-1"></a><span class="co">        pandas.DataFrame: Enhanced DataFrame with additional boolean columns</span></span>
<span id="cb14-386"><a href="#cb14-386" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb14-387"><a href="#cb14-387" aria-hidden="true" tabindex="-1"></a>    no_parent <span class="op">=</span> []</span>
<span id="cb14-388"><a href="#cb14-388" aria-hidden="true" tabindex="-1"></a>    no_children <span class="op">=</span> []</span>
<span id="cb14-389"><a href="#cb14-389" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-390"><a href="#cb14-390" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _, row <span class="kw">in</span> dataframe.iterrows():</span>
<span id="cb14-391"><a href="#cb14-391" aria-hidden="true" tabindex="-1"></a>        no_parent.append(<span class="kw">not</span> row[<span class="st">'Parents'</span>])  <span class="co"># True if Parents list is empty</span></span>
<span id="cb14-392"><a href="#cb14-392" aria-hidden="true" tabindex="-1"></a>        no_children.append(<span class="kw">not</span> row[<span class="st">'Children'</span>])  <span class="co"># True if Children list is empty</span></span>
<span id="cb14-393"><a href="#cb14-393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-394"><a href="#cb14-394" aria-hidden="true" tabindex="-1"></a>    dataframe[<span class="st">'No_Parent'</span>] <span class="op">=</span> no_parent</span>
<span id="cb14-395"><a href="#cb14-395" aria-hidden="true" tabindex="-1"></a>    dataframe[<span class="st">'No_Children'</span>] <span class="op">=</span> no_children</span>
<span id="cb14-396"><a href="#cb14-396" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-397"><a href="#cb14-397" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> dataframe</span>
<span id="cb14-398"><a href="#cb14-398" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-399"><a href="#cb14-399" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> add_parents_instantiation_columns_to_df(dataframe):</span>
<span id="cb14-400"><a href="#cb14-400" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb14-401"><a href="#cb14-401" aria-hidden="true" tabindex="-1"></a><span class="co">    Add all possible instantiations of parents as a list of lists column to the DataFrame.</span></span>
<span id="cb14-402"><a href="#cb14-402" aria-hidden="true" tabindex="-1"></a><span class="co">    This is crucial for generating conditional probability tables.</span></span>
<span id="cb14-403"><a href="#cb14-403" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-404"><a href="#cb14-404" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb14-405"><a href="#cb14-405" aria-hidden="true" tabindex="-1"></a><span class="co">        dataframe (pandas.DataFrame): The DataFrame to enhance</span></span>
<span id="cb14-406"><a href="#cb14-406" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-407"><a href="#cb14-407" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb14-408"><a href="#cb14-408" aria-hidden="true" tabindex="-1"></a><span class="co">        pandas.DataFrame: Enhanced DataFrame with parent_instantiations column</span></span>
<span id="cb14-409"><a href="#cb14-409" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb14-410"><a href="#cb14-410" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create a new column to store parent instantiations</span></span>
<span id="cb14-411"><a href="#cb14-411" aria-hidden="true" tabindex="-1"></a>    parent_instantiations <span class="op">=</span> []</span>
<span id="cb14-412"><a href="#cb14-412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-413"><a href="#cb14-413" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Iterate through each row in the dataframe</span></span>
<span id="cb14-414"><a href="#cb14-414" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _, row <span class="kw">in</span> dataframe.iterrows():</span>
<span id="cb14-415"><a href="#cb14-415" aria-hidden="true" tabindex="-1"></a>        parents <span class="op">=</span> row[<span class="st">'Parents'</span>]</span>
<span id="cb14-416"><a href="#cb14-416" aria-hidden="true" tabindex="-1"></a>        parent_insts <span class="op">=</span> []</span>
<span id="cb14-417"><a href="#cb14-417" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-418"><a href="#cb14-418" aria-hidden="true" tabindex="-1"></a>        <span class="co"># For each parent, find its instantiations and add to the list</span></span>
<span id="cb14-419"><a href="#cb14-419" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> parent <span class="kw">in</span> parents:</span>
<span id="cb14-420"><a href="#cb14-420" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Find the row where Title matches the parent</span></span>
<span id="cb14-421"><a href="#cb14-421" aria-hidden="true" tabindex="-1"></a>            parent_row <span class="op">=</span> dataframe[dataframe[<span class="st">'Title'</span>] <span class="op">==</span> parent]</span>
<span id="cb14-422"><a href="#cb14-422" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-423"><a href="#cb14-423" aria-hidden="true" tabindex="-1"></a>            <span class="co"># If parent found in the dataframe</span></span>
<span id="cb14-424"><a href="#cb14-424" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">not</span> parent_row.empty:</span>
<span id="cb14-425"><a href="#cb14-425" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Get the instantiations of this parent</span></span>
<span id="cb14-426"><a href="#cb14-426" aria-hidden="true" tabindex="-1"></a>                parent_instantiation <span class="op">=</span> parent_row[<span class="st">'instantiations'</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb14-427"><a href="#cb14-427" aria-hidden="true" tabindex="-1"></a>                parent_insts.append(parent_instantiation)</span>
<span id="cb14-428"><a href="#cb14-428" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-429"><a href="#cb14-429" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add the list of parent instantiations to our new column</span></span>
<span id="cb14-430"><a href="#cb14-430" aria-hidden="true" tabindex="-1"></a>        parent_instantiations.append(parent_insts)</span>
<span id="cb14-431"><a href="#cb14-431" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-432"><a href="#cb14-432" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add the new column to the dataframe</span></span>
<span id="cb14-433"><a href="#cb14-433" aria-hidden="true" tabindex="-1"></a>    dataframe[<span class="st">'parent_instantiations'</span>] <span class="op">=</span> parent_instantiations</span>
<span id="cb14-434"><a href="#cb14-434" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-435"><a href="#cb14-435" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> dataframe</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># example use case:</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>ex_csv <span class="op">=</span> parse_markdown_hierarchy_fixed(md_content, ArgDown <span class="op">=</span> <span class="va">True</span>)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>ex_csv</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="store-argdown-information-as-argdown.csv-file" class="level2">
<h2 class="anchored" data-anchor-id="store-argdown-information-as-argdown.csv-file">1.8 Store ArgDown Information as ‘ArgDown.csv’ file</h2>
<div class="sourceCode" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Assuming 'md_content' holds the markdown text</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Store the results of running the function parse_markdown_hierarchy(md_content, ArgDown = True) as the file 'ArgDown.csv'</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>result_df <span class="op">=</span> parse_markdown_hierarchy_fixed(md_content, ArgDown <span class="op">=</span> <span class="va">True</span>)</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Save to CSV</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>result_df.to_csv(<span class="st">'ArgDown.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Test if 'ArgDown.csv' has been saved correctly with the correct information</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the data from the CSV file</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>argdown_df <span class="op">=</span> pd.read_csv(<span class="st">'ArgDown.csv'</span>)</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the DataFrame</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(argdown_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="probability-extractions-argdown-.csv-to-bayesdown-.md-plugin-json-syntax" class="level1">
<h1>2.0 Probability Extractions: ArgDown (.csv) to BayesDown (.md + plugin JSON syntax)</h1>
</section>
<section id="argdown-to-bayesdown-adding-probability-information" class="level1">
<h1>2. ArgDown to BayesDown: Adding Probability Information</h1>
<section id="process-overview-1" class="level2">
<h2 class="anchored" data-anchor-id="process-overview-1">Process Overview</h2>
<p>This section implements the second major stage of the AMTAIR pipeline: enhancing the structured argument representation (ArgDown) with probability information to create BayesDown.</p>
<p>BayesDown extends ArgDown by adding: 1. Prior probabilities for each variable (unconditional beliefs) 2. Conditional probabilities representing the relationships between variables 3. The full parameter specification needed for a Bayesian network</p>
<p>The process follows these steps: 1. Generate probability questions for each node and its relationships 2. Create a BayesDown template with placeholders for these probabilities 3. Answer the probability questions (manually or via LLM) 4. Substitute the answers into the BayesDown representation</p>
<p>This enhanced representation contains all the information needed to construct a formal Bayesian network, enabling probabilistic reasoning and policy evaluation.</p>
</section>
<section id="what-is-bayesdown" class="level2">
<h2 class="anchored" data-anchor-id="what-is-bayesdown">What is BayesDown?</h2>
<p>BayesDown maintains the ArgDown structure but adds probability metadata:</p>
<pre><code>[Node]: Description. {
"instantiations": ["node_TRUE", "node_FALSE"],
"priors": { "p(node_TRUE)": "0.7", "p(node_FALSE)": "0.3" },
"posteriors": { "p(node_TRUE|parent_TRUE)": "0.9", "p(node_TRUE|parent_FALSE)": "0.4" }
}</code></pre>
<p>The result is a hybrid representation that preserves the narrative structure of arguments while adding the mathematical precision of Bayesian networks.</p>
</section>
<section id="probability-extraction-questions-argdown.csv-to-argdown_withquestions.csv" class="level2">
<h2 class="anchored" data-anchor-id="probability-extraction-questions-argdown.csv-to-argdown_withquestions.csv">2.1 Probability Extraction Questions — ‘ArgDown.csv’ to ‘ArgDown_WithQuestions.csv’</h2>
<div class="sourceCode" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># @title 2.1 --- Probability Extraction Questions Generation ---</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="co">BLOCK PURPOSE: Generates probability questions for ArgDown nodes to prepare for BayesDown conversion.</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="co">This block implements a key step in the pipeline where structure (from ArgDown) is prepared</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="co">for probability integration (to create BayesDown). It:</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a><span class="co">1. Processes a CSV file containing ArgDown structure</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a><span class="co">2. For each node, generates appropriate probability questions:</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a><span class="co">   - Prior probability questions for all nodes</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a><span class="co">   - Conditional probability questions for nodes with parents</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a><span class="co">3. Creates a new CSV file with these questions ready for the next stage</span></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a><span class="co">The generated questions serve as placeholders that will be answered in the</span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a><span class="co">probability extraction phase to complete the Bayesian network.</span></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a><span class="co">DEPENDENCIES: pandas, json, itertools libraries</span></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a><span class="co">INPUTS: ArgDown CSV file</span></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a><span class="co">OUTPUTS: Enhanced CSV with probability questions for each node</span></span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> itertools</span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> IPython.display <span class="im">import</span> Markdown, display</span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> parse_instantiations(instantiations_str):</span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a><span class="co">    Parse instantiations from string or list format.</span></span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a><span class="co">    Handles various input formats flexibly.</span></span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a><span class="co">        instantiations_str: Instantiations in string or list format</span></span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a><span class="co">        list: Parsed instantiations as a list</span></span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> pd.isna(instantiations_str) <span class="kw">or</span> instantiations_str <span class="op">==</span> <span class="st">''</span>:</span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> []</span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-44"><a href="#cb19-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(instantiations_str, <span class="bu">list</span>):</span>
<span id="cb19-45"><a href="#cb19-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> instantiations_str</span>
<span id="cb19-46"><a href="#cb19-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-47"><a href="#cb19-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb19-48"><a href="#cb19-48" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Try to parse as JSON</span></span>
<span id="cb19-49"><a href="#cb19-49" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> json.loads(instantiations_str)</span>
<span id="cb19-50"><a href="#cb19-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span>:</span>
<span id="cb19-51"><a href="#cb19-51" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Try to parse as string list</span></span>
<span id="cb19-52"><a href="#cb19-52" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">isinstance</span>(instantiations_str, <span class="bu">str</span>):</span>
<span id="cb19-53"><a href="#cb19-53" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Remove brackets and split by comma</span></span>
<span id="cb19-54"><a href="#cb19-54" aria-hidden="true" tabindex="-1"></a>            clean_str <span class="op">=</span> instantiations_str.strip(<span class="st">'[]"</span><span class="ch">\'</span><span class="st">'</span>)</span>
<span id="cb19-55"><a href="#cb19-55" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">not</span> clean_str:</span>
<span id="cb19-56"><a href="#cb19-56" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> []</span>
<span id="cb19-57"><a href="#cb19-57" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> [s.strip(<span class="st">' "</span><span class="ch">\'</span><span class="st">'</span>) <span class="cf">for</span> s <span class="kw">in</span> clean_str.split(<span class="st">','</span>) <span class="cf">if</span> s.strip()]</span>
<span id="cb19-58"><a href="#cb19-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-59"><a href="#cb19-59" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> []</span>
<span id="cb19-60"><a href="#cb19-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-61"><a href="#cb19-61" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> parse_parents(parents_str):</span>
<span id="cb19-62"><a href="#cb19-62" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb19-63"><a href="#cb19-63" aria-hidden="true" tabindex="-1"></a><span class="co">    Parse parents from string or list format.</span></span>
<span id="cb19-64"><a href="#cb19-64" aria-hidden="true" tabindex="-1"></a><span class="co">    Handles various input formats flexibly.</span></span>
<span id="cb19-65"><a href="#cb19-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-66"><a href="#cb19-66" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb19-67"><a href="#cb19-67" aria-hidden="true" tabindex="-1"></a><span class="co">        parents_str: Parents in string or list format</span></span>
<span id="cb19-68"><a href="#cb19-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-69"><a href="#cb19-69" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb19-70"><a href="#cb19-70" aria-hidden="true" tabindex="-1"></a><span class="co">        list: Parsed parents as a list</span></span>
<span id="cb19-71"><a href="#cb19-71" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb19-72"><a href="#cb19-72" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> pd.isna(parents_str) <span class="kw">or</span> parents_str <span class="op">==</span> <span class="st">''</span>:</span>
<span id="cb19-73"><a href="#cb19-73" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> []</span>
<span id="cb19-74"><a href="#cb19-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-75"><a href="#cb19-75" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(parents_str, <span class="bu">list</span>):</span>
<span id="cb19-76"><a href="#cb19-76" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> parents_str</span>
<span id="cb19-77"><a href="#cb19-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-78"><a href="#cb19-78" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb19-79"><a href="#cb19-79" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Try to parse as JSON</span></span>
<span id="cb19-80"><a href="#cb19-80" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> json.loads(parents_str)</span>
<span id="cb19-81"><a href="#cb19-81" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span>:</span>
<span id="cb19-82"><a href="#cb19-82" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Try to parse as string list</span></span>
<span id="cb19-83"><a href="#cb19-83" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">isinstance</span>(parents_str, <span class="bu">str</span>):</span>
<span id="cb19-84"><a href="#cb19-84" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Remove brackets and split by comma</span></span>
<span id="cb19-85"><a href="#cb19-85" aria-hidden="true" tabindex="-1"></a>            clean_str <span class="op">=</span> parents_str.strip(<span class="st">'[]"</span><span class="ch">\'</span><span class="st">'</span>)</span>
<span id="cb19-86"><a href="#cb19-86" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">not</span> clean_str:</span>
<span id="cb19-87"><a href="#cb19-87" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> []</span>
<span id="cb19-88"><a href="#cb19-88" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> [s.strip(<span class="st">' "</span><span class="ch">\'</span><span class="st">'</span>) <span class="cf">for</span> s <span class="kw">in</span> clean_str.split(<span class="st">','</span>) <span class="cf">if</span> s.strip()]</span>
<span id="cb19-89"><a href="#cb19-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-90"><a href="#cb19-90" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> []</span>
<span id="cb19-91"><a href="#cb19-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-92"><a href="#cb19-92" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_parent_instantiations(parent, df):</span>
<span id="cb19-93"><a href="#cb19-93" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb19-94"><a href="#cb19-94" aria-hidden="true" tabindex="-1"></a><span class="co">    Get the instantiations for a parent node from the DataFrame.</span></span>
<span id="cb19-95"><a href="#cb19-95" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns default instantiations if not found.</span></span>
<span id="cb19-96"><a href="#cb19-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-97"><a href="#cb19-97" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb19-98"><a href="#cb19-98" aria-hidden="true" tabindex="-1"></a><span class="co">        parent (str): Parent node name</span></span>
<span id="cb19-99"><a href="#cb19-99" aria-hidden="true" tabindex="-1"></a><span class="co">        df (DataFrame): DataFrame containing node information</span></span>
<span id="cb19-100"><a href="#cb19-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-101"><a href="#cb19-101" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb19-102"><a href="#cb19-102" aria-hidden="true" tabindex="-1"></a><span class="co">        list: Instantiations for the parent node</span></span>
<span id="cb19-103"><a href="#cb19-103" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb19-104"><a href="#cb19-104" aria-hidden="true" tabindex="-1"></a>    parent_row <span class="op">=</span> df[df[<span class="st">'Title'</span>] <span class="op">==</span> parent]</span>
<span id="cb19-105"><a href="#cb19-105" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> parent_row.empty:</span>
<span id="cb19-106"><a href="#cb19-106" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> [<span class="ss">f"</span><span class="sc">{</span>parent<span class="sc">}</span><span class="ss">_TRUE"</span>, <span class="ss">f"</span><span class="sc">{</span>parent<span class="sc">}</span><span class="ss">_FALSE"</span>]</span>
<span id="cb19-107"><a href="#cb19-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-108"><a href="#cb19-108" aria-hidden="true" tabindex="-1"></a>    instantiations <span class="op">=</span> parse_instantiations(parent_row.iloc[<span class="dv">0</span>][<span class="st">'instantiations'</span>])</span>
<span id="cb19-109"><a href="#cb19-109" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> instantiations:</span>
<span id="cb19-110"><a href="#cb19-110" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> [<span class="ss">f"</span><span class="sc">{</span>parent<span class="sc">}</span><span class="ss">_TRUE"</span>, <span class="ss">f"</span><span class="sc">{</span>parent<span class="sc">}</span><span class="ss">_FALSE"</span>]</span>
<span id="cb19-111"><a href="#cb19-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-112"><a href="#cb19-112" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> instantiations</span>
<span id="cb19-113"><a href="#cb19-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-114"><a href="#cb19-114" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> generate_instantiation_questions(title, instantiation, parents, df):</span>
<span id="cb19-115"><a href="#cb19-115" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb19-116"><a href="#cb19-116" aria-hidden="true" tabindex="-1"></a><span class="co">    Generate questions for a specific instantiation of a node.</span></span>
<span id="cb19-117"><a href="#cb19-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-118"><a href="#cb19-118" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb19-119"><a href="#cb19-119" aria-hidden="true" tabindex="-1"></a><span class="co">        title (str): The title of the node</span></span>
<span id="cb19-120"><a href="#cb19-120" aria-hidden="true" tabindex="-1"></a><span class="co">        instantiation (str): The specific instantiation (e.g., "title_TRUE")</span></span>
<span id="cb19-121"><a href="#cb19-121" aria-hidden="true" tabindex="-1"></a><span class="co">        parents (list): List of parent nodes</span></span>
<span id="cb19-122"><a href="#cb19-122" aria-hidden="true" tabindex="-1"></a><span class="co">        df (DataFrame): The full DataFrame for looking up parent instantiations</span></span>
<span id="cb19-123"><a href="#cb19-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-124"><a href="#cb19-124" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb19-125"><a href="#cb19-125" aria-hidden="true" tabindex="-1"></a><span class="co">        dict: Dictionary mapping questions to estimate keys</span></span>
<span id="cb19-126"><a href="#cb19-126" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb19-127"><a href="#cb19-127" aria-hidden="true" tabindex="-1"></a>    questions <span class="op">=</span> {}</span>
<span id="cb19-128"><a href="#cb19-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-129"><a href="#cb19-129" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Always generate a prior probability question, regardless of parents</span></span>
<span id="cb19-130"><a href="#cb19-130" aria-hidden="true" tabindex="-1"></a>    prior_question <span class="op">=</span> <span class="ss">f"What is the probability for </span><span class="sc">{</span>title<span class="sc">}</span><span class="ss">=</span><span class="sc">{</span>instantiation<span class="sc">}</span><span class="ss">?"</span></span>
<span id="cb19-131"><a href="#cb19-131" aria-hidden="true" tabindex="-1"></a>    questions[prior_question] <span class="op">=</span> <span class="st">'prior'</span>  <span class="co"># Question is the key, 'prior' is the value</span></span>
<span id="cb19-132"><a href="#cb19-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-133"><a href="#cb19-133" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If no parents, return only the prior question</span></span>
<span id="cb19-134"><a href="#cb19-134" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> parents:</span>
<span id="cb19-135"><a href="#cb19-135" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> questions</span>
<span id="cb19-136"><a href="#cb19-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-137"><a href="#cb19-137" aria-hidden="true" tabindex="-1"></a>    <span class="co"># For nodes with parents, generate conditional probability questions</span></span>
<span id="cb19-138"><a href="#cb19-138" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get all combinations of parent instantiations</span></span>
<span id="cb19-139"><a href="#cb19-139" aria-hidden="true" tabindex="-1"></a>    parent_instantiations <span class="op">=</span> []</span>
<span id="cb19-140"><a href="#cb19-140" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> parent <span class="kw">in</span> parents:</span>
<span id="cb19-141"><a href="#cb19-141" aria-hidden="true" tabindex="-1"></a>        parent_insts <span class="op">=</span> get_parent_instantiations(parent, df)</span>
<span id="cb19-142"><a href="#cb19-142" aria-hidden="true" tabindex="-1"></a>        parent_instantiations.append([(parent, inst) <span class="cf">for</span> inst <span class="kw">in</span> parent_insts])</span>
<span id="cb19-143"><a href="#cb19-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-144"><a href="#cb19-144" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Generate all combinations</span></span>
<span id="cb19-145"><a href="#cb19-145" aria-hidden="true" tabindex="-1"></a>    all_combinations <span class="op">=</span> <span class="bu">list</span>(itertools.product(<span class="op">*</span>parent_instantiations))</span>
<span id="cb19-146"><a href="#cb19-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-147"><a href="#cb19-147" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create conditional probability questions for each combination</span></span>
<span id="cb19-148"><a href="#cb19-148" aria-hidden="true" tabindex="-1"></a>    <span class="co"># and use questions as keys, estimate_i as values</span></span>
<span id="cb19-149"><a href="#cb19-149" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, combination <span class="kw">in</span> <span class="bu">enumerate</span>(all_combinations):</span>
<span id="cb19-150"><a href="#cb19-150" aria-hidden="true" tabindex="-1"></a>        condition_str <span class="op">=</span> <span class="st">", "</span>.join([<span class="ss">f"</span><span class="sc">{</span>parent<span class="sc">}</span><span class="ss">=</span><span class="sc">{</span>inst<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> parent, inst <span class="kw">in</span> combination])</span>
<span id="cb19-151"><a href="#cb19-151" aria-hidden="true" tabindex="-1"></a>        question <span class="op">=</span> <span class="ss">f"What is the probability for </span><span class="sc">{</span>title<span class="sc">}</span><span class="ss">=</span><span class="sc">{</span>instantiation<span class="sc">}</span><span class="ss"> if </span><span class="sc">{</span>condition_str<span class="sc">}</span><span class="ss">?"</span></span>
<span id="cb19-152"><a href="#cb19-152" aria-hidden="true" tabindex="-1"></a>        questions[question] <span class="op">=</span> <span class="ss">f'estimate_</span><span class="sc">{</span>i <span class="op">+</span> <span class="dv">1</span><span class="sc">}</span><span class="ss">'</span>  <span class="co"># Question is the key, estimate_i is the value</span></span>
<span id="cb19-153"><a href="#cb19-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-154"><a href="#cb19-154" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> questions</span>
<span id="cb19-155"><a href="#cb19-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-156"><a href="#cb19-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-157"><a href="#cb19-157" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> generate_argdown_with_questions(argdown_csv_path, output_csv_path):</span>
<span id="cb19-158"><a href="#cb19-158" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb19-159"><a href="#cb19-159" aria-hidden="true" tabindex="-1"></a><span class="co">    Generate probability questions based on the ArgDown CSV file and save to a new CSV file.</span></span>
<span id="cb19-160"><a href="#cb19-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-161"><a href="#cb19-161" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb19-162"><a href="#cb19-162" aria-hidden="true" tabindex="-1"></a><span class="co">        argdown_csv_path (str): Path to the input ArgDown CSV file</span></span>
<span id="cb19-163"><a href="#cb19-163" aria-hidden="true" tabindex="-1"></a><span class="co">        output_csv_path (str): Path to save the output CSV file with questions</span></span>
<span id="cb19-164"><a href="#cb19-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-165"><a href="#cb19-165" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb19-166"><a href="#cb19-166" aria-hidden="true" tabindex="-1"></a><span class="co">        DataFrame: Enhanced DataFrame with probability questions</span></span>
<span id="cb19-167"><a href="#cb19-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-168"><a href="#cb19-168" aria-hidden="true" tabindex="-1"></a><span class="co">    Raises:</span></span>
<span id="cb19-169"><a href="#cb19-169" aria-hidden="true" tabindex="-1"></a><span class="co">        Exception: If CSV loading fails or required columns are missing</span></span>
<span id="cb19-170"><a href="#cb19-170" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb19-171"><a href="#cb19-171" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Loading ArgDown CSV from </span><span class="sc">{</span>argdown_csv_path<span class="sc">}</span><span class="ss">..."</span>)</span>
<span id="cb19-172"><a href="#cb19-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-173"><a href="#cb19-173" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load the ArgDown CSV file</span></span>
<span id="cb19-174"><a href="#cb19-174" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb19-175"><a href="#cb19-175" aria-hidden="true" tabindex="-1"></a>        df <span class="op">=</span> pd.read_csv(argdown_csv_path)</span>
<span id="cb19-176"><a href="#cb19-176" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Successfully loaded CSV with </span><span class="sc">{</span><span class="bu">len</span>(df)<span class="sc">}</span><span class="ss"> rows."</span>)</span>
<span id="cb19-177"><a href="#cb19-177" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb19-178"><a href="#cb19-178" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">Exception</span>(<span class="ss">f"Error loading ArgDown CSV: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb19-179"><a href="#cb19-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-180"><a href="#cb19-180" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Validate required columns</span></span>
<span id="cb19-181"><a href="#cb19-181" aria-hidden="true" tabindex="-1"></a>    required_columns <span class="op">=</span> [<span class="st">'Title'</span>, <span class="st">'Parents'</span>, <span class="st">'instantiations'</span>]</span>
<span id="cb19-182"><a href="#cb19-182" aria-hidden="true" tabindex="-1"></a>    missing_columns <span class="op">=</span> [col <span class="cf">for</span> col <span class="kw">in</span> required_columns <span class="cf">if</span> col <span class="kw">not</span> <span class="kw">in</span> df.columns]</span>
<span id="cb19-183"><a href="#cb19-183" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> missing_columns:</span>
<span id="cb19-184"><a href="#cb19-184" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">Exception</span>(<span class="ss">f"Missing required columns: </span><span class="sc">{</span><span class="st">', '</span><span class="sc">.</span>join(missing_columns)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb19-185"><a href="#cb19-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-186"><a href="#cb19-186" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Initialize columns for questions</span></span>
<span id="cb19-187"><a href="#cb19-187" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'Generate_Positive_Instantiation_Questions'</span>] <span class="op">=</span> <span class="va">None</span></span>
<span id="cb19-188"><a href="#cb19-188" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'Generate_Negative_Instantiation_Questions'</span>] <span class="op">=</span> <span class="va">None</span></span>
<span id="cb19-189"><a href="#cb19-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-190"><a href="#cb19-190" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Generating probability questions for each node..."</span>)</span>
<span id="cb19-191"><a href="#cb19-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-192"><a href="#cb19-192" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Process each row to generate questions</span></span>
<span id="cb19-193"><a href="#cb19-193" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> idx, row <span class="kw">in</span> df.iterrows():</span>
<span id="cb19-194"><a href="#cb19-194" aria-hidden="true" tabindex="-1"></a>        title <span class="op">=</span> row[<span class="st">'Title'</span>]</span>
<span id="cb19-195"><a href="#cb19-195" aria-hidden="true" tabindex="-1"></a>        instantiations <span class="op">=</span> parse_instantiations(row[<span class="st">'instantiations'</span>])</span>
<span id="cb19-196"><a href="#cb19-196" aria-hidden="true" tabindex="-1"></a>        parents <span class="op">=</span> parse_parents(row[<span class="st">'Parents'</span>])</span>
<span id="cb19-197"><a href="#cb19-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-198"><a href="#cb19-198" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(instantiations) <span class="op">&lt;</span> <span class="dv">2</span>:</span>
<span id="cb19-199"><a href="#cb19-199" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Default instantiations if not provided</span></span>
<span id="cb19-200"><a href="#cb19-200" aria-hidden="true" tabindex="-1"></a>            instantiations <span class="op">=</span> [<span class="ss">f"</span><span class="sc">{</span>title<span class="sc">}</span><span class="ss">_TRUE"</span>, <span class="ss">f"</span><span class="sc">{</span>title<span class="sc">}</span><span class="ss">_FALSE"</span>]</span>
<span id="cb19-201"><a href="#cb19-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-202"><a href="#cb19-202" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Generate positive instantiation questions</span></span>
<span id="cb19-203"><a href="#cb19-203" aria-hidden="true" tabindex="-1"></a>        positive_questions <span class="op">=</span> generate_instantiation_questions(title, instantiations[<span class="dv">0</span>], parents, df)</span>
<span id="cb19-204"><a href="#cb19-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-205"><a href="#cb19-205" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Generate negative instantiation questions</span></span>
<span id="cb19-206"><a href="#cb19-206" aria-hidden="true" tabindex="-1"></a>        negative_questions <span class="op">=</span> generate_instantiation_questions(title, instantiations[<span class="dv">1</span>], parents, df)</span>
<span id="cb19-207"><a href="#cb19-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-208"><a href="#cb19-208" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Update the DataFrame</span></span>
<span id="cb19-209"><a href="#cb19-209" aria-hidden="true" tabindex="-1"></a>        df.at[idx, <span class="st">'Generate_Positive_Instantiation_Questions'</span>] <span class="op">=</span> json.dumps(positive_questions)</span>
<span id="cb19-210"><a href="#cb19-210" aria-hidden="true" tabindex="-1"></a>        df.at[idx, <span class="st">'Generate_Negative_Instantiation_Questions'</span>] <span class="op">=</span> json.dumps(negative_questions)</span>
<span id="cb19-211"><a href="#cb19-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-212"><a href="#cb19-212" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Save the enhanced DataFrame</span></span>
<span id="cb19-213"><a href="#cb19-213" aria-hidden="true" tabindex="-1"></a>    df.to_csv(output_csv_path, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb19-214"><a href="#cb19-214" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Generated questions saved to </span><span class="sc">{</span>output_csv_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb19-215"><a href="#cb19-215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-216"><a href="#cb19-216" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb19-217"><a href="#cb19-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-218"><a href="#cb19-218" aria-hidden="true" tabindex="-1"></a><span class="co"># Example usage:</span></span>
<span id="cb19-219"><a href="#cb19-219" aria-hidden="true" tabindex="-1"></a>df_with_questions <span class="op">=</span> generate_argdown_with_questions(<span class="st">"ArgDown.csv"</span>, <span class="st">"ArgDown_WithQuestions.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the data from the ArgDown_WithQuestions CSV file</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>argdown_with_questions_df <span class="op">=</span> pd.read_csv(<span class="st">'ArgDown_WithQuestions.csv'</span>)</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the DataFrame</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(argdown_with_questions_df)</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>argdown_with_questions_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="argdown_withquestions.csv-to-bayesdownquestions.md" class="level2">
<h2 class="anchored" data-anchor-id="argdown_withquestions.csv-to-bayesdownquestions.md">2.2 ‘ArgDown_WithQuestions.csv’ to ‘BayesDownQuestions.md’</h2>
<p>2.2 Save BayesDown Extraction Questions as ‘BayesDownQuestions.md’</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># @title 2.2 --- BayesDown Questions Generation ---</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="co">BLOCK PURPOSE: Transforms the ArgDown with questions into a BayesDown template with placeholders.</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="co">This function creates a BayesDown representation with probability placeholders based on the questions generated in the previous step. It:</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="co">1. Loads the CSV file with probability questions</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a><span class="co">2. Constructs a directed graph to represent the causal structure</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a><span class="co">3. Processes each node to create BayesDown syntax with probability placeholders</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a><span class="co">4. Optionally includes comments with the specific questions to be answered</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a><span class="co">5. Saves the result as a markdown file for the next stage of the pipeline</span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a><span class="co">The output is a BayesDown template that can be used in the probability extraction phase, where the placeholders will be replaced with actual probability values.</span></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a><span class="co">DEPENDENCIES: networkx, pandas, json libraries</span></span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a><span class="co">INPUTS: CSV file with ArgDown structure and probability questions</span></span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a><span class="co">OUTPUTS: BayesDown markdown file with probability placeholders</span></span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> extract_bayesdown_questions_fixed(argdown_with_questions_path, output_md_path, include_questions_as_comments<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>  <span class="co">"""</span></span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a><span class="co">  Generate BayesDown syntax from the ArgDown_WithQuestions CSV file with correct parent-child relationships.</span></span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a><span class="co">  Args:</span></span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a><span class="co">      argdown_with_questions_path (str): Path to the CSV file with probability questions</span></span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a><span class="co">      output_md_path (str): Path to save the output BayesDown file</span></span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a><span class="co">      include_questions_as_comments (bool, optional): Whether to include the original</span></span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a><span class="co">                                                    questions as comments. Defaults to True.</span></span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a><span class="co">  Returns:</span></span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a><span class="co">      str: The generated BayesDown content</span></span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a><span class="co">  Raises:</span></span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a><span class="co">      Exception: If CSV loading fails or required columns are missing</span></span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a><span class="co">  """</span></span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a>  <span class="bu">print</span>(<span class="ss">f"Loading CSV from </span><span class="sc">{</span>argdown_with_questions_path<span class="sc">}</span><span class="ss">..."</span>)</span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-39"><a href="#cb21-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Load the CSV file</span></span>
<span id="cb21-40"><a href="#cb21-40" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span>:</span>
<span id="cb21-41"><a href="#cb21-41" aria-hidden="true" tabindex="-1"></a>      df <span class="op">=</span> pd.read_csv(argdown_with_questions_path)</span>
<span id="cb21-42"><a href="#cb21-42" aria-hidden="true" tabindex="-1"></a>      <span class="bu">print</span>(<span class="ss">f"Successfully loaded CSV with </span><span class="sc">{</span><span class="bu">len</span>(df)<span class="sc">}</span><span class="ss"> rows."</span>)</span>
<span id="cb21-43"><a href="#cb21-43" aria-hidden="true" tabindex="-1"></a>  <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb21-44"><a href="#cb21-44" aria-hidden="true" tabindex="-1"></a>      <span class="cf">raise</span> <span class="pp">Exception</span>(<span class="ss">f"Error loading CSV: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb21-45"><a href="#cb21-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-46"><a href="#cb21-46" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Validate required columns</span></span>
<span id="cb21-47"><a href="#cb21-47" aria-hidden="true" tabindex="-1"></a>  required_columns <span class="op">=</span> [<span class="st">'Title'</span>, <span class="st">'Description'</span>, <span class="st">'Parents'</span>, <span class="st">'Children'</span>, <span class="st">'instantiations'</span>]</span>
<span id="cb21-48"><a href="#cb21-48" aria-hidden="true" tabindex="-1"></a>  missing_columns <span class="op">=</span> [col <span class="cf">for</span> col <span class="kw">in</span> required_columns <span class="cf">if</span> col <span class="kw">not</span> <span class="kw">in</span> df.columns]</span>
<span id="cb21-49"><a href="#cb21-49" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> missing_columns:</span>
<span id="cb21-50"><a href="#cb21-50" aria-hidden="true" tabindex="-1"></a>      <span class="cf">raise</span> <span class="pp">Exception</span>(<span class="ss">f"Missing required columns: </span><span class="sc">{</span><span class="st">', '</span><span class="sc">.</span>join(missing_columns)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb21-51"><a href="#cb21-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-52"><a href="#cb21-52" aria-hidden="true" tabindex="-1"></a>  <span class="bu">print</span>(<span class="st">"Generating BayesDown syntax with placeholder probabilities..."</span>)</span>
<span id="cb21-53"><a href="#cb21-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-54"><a href="#cb21-54" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Build a directed graph of nodes</span></span>
<span id="cb21-55"><a href="#cb21-55" aria-hidden="true" tabindex="-1"></a>  G <span class="op">=</span> nx.DiGraph()</span>
<span id="cb21-56"><a href="#cb21-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-57"><a href="#cb21-57" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add nodes to the graph</span></span>
<span id="cb21-58"><a href="#cb21-58" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> idx, row <span class="kw">in</span> df.iterrows():</span>
<span id="cb21-59"><a href="#cb21-59" aria-hidden="true" tabindex="-1"></a>      G.add_node(row[<span class="st">'Title'</span>], data<span class="op">=</span>row)</span>
<span id="cb21-60"><a href="#cb21-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-61"><a href="#cb21-61" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add edges to the graph based on parent-child relationships - CORRECTLY</span></span>
<span id="cb21-62"><a href="#cb21-62" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> idx, row <span class="kw">in</span> df.iterrows():</span>
<span id="cb21-63"><a href="#cb21-63" aria-hidden="true" tabindex="-1"></a>      child <span class="op">=</span> row[<span class="st">'Title'</span>]</span>
<span id="cb21-64"><a href="#cb21-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-65"><a href="#cb21-65" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Parse parents and add edges</span></span>
<span id="cb21-66"><a href="#cb21-66" aria-hidden="true" tabindex="-1"></a>      parents <span class="op">=</span> row[<span class="st">'Parents'</span>]</span>
<span id="cb21-67"><a href="#cb21-67" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> <span class="bu">isinstance</span>(parents, <span class="bu">str</span>):</span>
<span id="cb21-68"><a href="#cb21-68" aria-hidden="true" tabindex="-1"></a>          <span class="co"># Handle string representation of list</span></span>
<span id="cb21-69"><a href="#cb21-69" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> parents.startswith(<span class="st">'['</span>) <span class="kw">and</span> parents.endswith(<span class="st">']'</span>):</span>
<span id="cb21-70"><a href="#cb21-70" aria-hidden="true" tabindex="-1"></a>              parents <span class="op">=</span> parents.strip(<span class="st">'[]'</span>)</span>
<span id="cb21-71"><a href="#cb21-71" aria-hidden="true" tabindex="-1"></a>              <span class="cf">if</span> parents:  <span class="co"># Check if not empty</span></span>
<span id="cb21-72"><a href="#cb21-72" aria-hidden="true" tabindex="-1"></a>                  parent_list <span class="op">=</span> [p.strip().strip(<span class="st">'</span><span class="ch">\'</span><span class="st">"'</span>) <span class="cf">for</span> p <span class="kw">in</span> parents.split(<span class="st">','</span>)]</span>
<span id="cb21-73"><a href="#cb21-73" aria-hidden="true" tabindex="-1"></a>                  <span class="cf">for</span> parent <span class="kw">in</span> parent_list:</span>
<span id="cb21-74"><a href="#cb21-74" aria-hidden="true" tabindex="-1"></a>                      <span class="cf">if</span> parent <span class="kw">in</span> G.nodes():</span>
<span id="cb21-75"><a href="#cb21-75" aria-hidden="true" tabindex="-1"></a>                          <span class="co"># In BayesDown: Parent (cause) -&gt; Child (effect)</span></span>
<span id="cb21-76"><a href="#cb21-76" aria-hidden="true" tabindex="-1"></a>                          G.add_edge(parent, child)</span>
<span id="cb21-77"><a href="#cb21-77" aria-hidden="true" tabindex="-1"></a>      <span class="cf">elif</span> <span class="bu">isinstance</span>(parents, <span class="bu">list</span>):</span>
<span id="cb21-78"><a href="#cb21-78" aria-hidden="true" tabindex="-1"></a>          <span class="co"># Handle actual list</span></span>
<span id="cb21-79"><a href="#cb21-79" aria-hidden="true" tabindex="-1"></a>          <span class="cf">for</span> parent <span class="kw">in</span> parents:</span>
<span id="cb21-80"><a href="#cb21-80" aria-hidden="true" tabindex="-1"></a>              <span class="cf">if</span> parent <span class="kw">in</span> G.nodes():</span>
<span id="cb21-81"><a href="#cb21-81" aria-hidden="true" tabindex="-1"></a>                  G.add_edge(parent, child)</span>
<span id="cb21-82"><a href="#cb21-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-83"><a href="#cb21-83" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Function to safely parse JSON strings</span></span>
<span id="cb21-84"><a href="#cb21-84" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> safe_parse_json(json_str):</span>
<span id="cb21-85"><a href="#cb21-85" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> pd.isna(json_str):</span>
<span id="cb21-86"><a href="#cb21-86" aria-hidden="true" tabindex="-1"></a>          <span class="cf">return</span> {}</span>
<span id="cb21-87"><a href="#cb21-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-88"><a href="#cb21-88" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> <span class="bu">isinstance</span>(json_str, <span class="bu">dict</span>):</span>
<span id="cb21-89"><a href="#cb21-89" aria-hidden="true" tabindex="-1"></a>          <span class="cf">return</span> json_str</span>
<span id="cb21-90"><a href="#cb21-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-91"><a href="#cb21-91" aria-hidden="true" tabindex="-1"></a>      <span class="cf">try</span>:</span>
<span id="cb21-92"><a href="#cb21-92" aria-hidden="true" tabindex="-1"></a>          <span class="cf">return</span> json.loads(json_str)</span>
<span id="cb21-93"><a href="#cb21-93" aria-hidden="true" tabindex="-1"></a>      <span class="cf">except</span>:</span>
<span id="cb21-94"><a href="#cb21-94" aria-hidden="true" tabindex="-1"></a>          <span class="cf">return</span> {}</span>
<span id="cb21-95"><a href="#cb21-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-96"><a href="#cb21-96" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Start building the BayesDown content</span></span>
<span id="cb21-97"><a href="#cb21-97" aria-hidden="true" tabindex="-1"></a>  bayesdown_content <span class="op">=</span> <span class="st">""</span>  <span class="co"># Initialize as empty</span></span>
<span id="cb21-98"><a href="#cb21-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-99"><a href="#cb21-99" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> include_questions_as_comments:</span>
<span id="cb21-100"><a href="#cb21-100" aria-hidden="true" tabindex="-1"></a>    bayesdown_content <span class="op">=</span> <span class="st">"# BayesDown Representation with Placeholder Probabilities</span><span class="ch">\n\n</span><span class="st">"</span></span>
<span id="cb21-101"><a href="#cb21-101" aria-hidden="true" tabindex="-1"></a>    bayesdown_content <span class="op">+=</span> <span class="st">"/* This file contains BayesDown syntax with placeholder probabilities.</span><span class="ch">\n</span><span class="st">"</span></span>
<span id="cb21-102"><a href="#cb21-102" aria-hidden="true" tabindex="-1"></a>    bayesdown_content <span class="op">+=</span> <span class="st">"   Replace the placeholders with actual probability values based on the </span><span class="ch">\n</span><span class="st">"</span></span>
<span id="cb21-103"><a href="#cb21-103" aria-hidden="true" tabindex="-1"></a>    bayesdown_content <span class="op">+=</span> <span class="st">"   questions in the comments. */</span><span class="ch">\n\n</span><span class="st">"</span></span>
<span id="cb21-104"><a href="#cb21-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-105"><a href="#cb21-105" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get leaf nodes (nodes with no outgoing edges) - these are effects without children</span></span>
<span id="cb21-106"><a href="#cb21-106" aria-hidden="true" tabindex="-1"></a>  leaf_nodes <span class="op">=</span> [n <span class="cf">for</span> n <span class="kw">in</span> G.nodes() <span class="cf">if</span> G.out_degree(n) <span class="op">==</span> <span class="dv">0</span>]</span>
<span id="cb21-107"><a href="#cb21-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-108"><a href="#cb21-108" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Helper function to process a node and its parents recursively</span></span>
<span id="cb21-109"><a href="#cb21-109" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> process_node(node, indent_level<span class="op">=</span><span class="dv">0</span>, processed_nodes<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb21-110"><a href="#cb21-110" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> processed_nodes <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb21-111"><a href="#cb21-111" aria-hidden="true" tabindex="-1"></a>          processed_nodes <span class="op">=</span> <span class="bu">set</span>()</span>
<span id="cb21-112"><a href="#cb21-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-113"><a href="#cb21-113" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Create the indentation string</span></span>
<span id="cb21-114"><a href="#cb21-114" aria-hidden="true" tabindex="-1"></a>      indent <span class="op">=</span> <span class="st">' '</span> <span class="op">*</span> (indent_level <span class="op">*</span> <span class="dv">2</span>)</span>
<span id="cb21-115"><a href="#cb21-115" aria-hidden="true" tabindex="-1"></a>      prefix <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>indent<span class="sc">}</span><span class="ss">+ "</span> <span class="cf">if</span> indent_level <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="st">""</span></span>
<span id="cb21-116"><a href="#cb21-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-117"><a href="#cb21-117" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Get node data</span></span>
<span id="cb21-118"><a href="#cb21-118" aria-hidden="true" tabindex="-1"></a>      node_data <span class="op">=</span> G.nodes[node][<span class="st">'data'</span>]</span>
<span id="cb21-119"><a href="#cb21-119" aria-hidden="true" tabindex="-1"></a>      title <span class="op">=</span> node_data[<span class="st">'Title'</span>]</span>
<span id="cb21-120"><a href="#cb21-120" aria-hidden="true" tabindex="-1"></a>      description <span class="op">=</span> node_data[<span class="st">'Description'</span>] <span class="cf">if</span> <span class="kw">not</span> pd.isna(node_data[<span class="st">'Description'</span>]) <span class="cf">else</span> <span class="st">""</span></span>
<span id="cb21-121"><a href="#cb21-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-122"><a href="#cb21-122" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Parse instantiations from the row data</span></span>
<span id="cb21-123"><a href="#cb21-123" aria-hidden="true" tabindex="-1"></a>      instantiations <span class="op">=</span> parse_instantiations_safely(node_data[<span class="st">'instantiations'</span>])</span>
<span id="cb21-124"><a href="#cb21-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-125"><a href="#cb21-125" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Build the node string</span></span>
<span id="cb21-126"><a href="#cb21-126" aria-hidden="true" tabindex="-1"></a>      node_output <span class="op">=</span> <span class="st">""</span></span>
<span id="cb21-127"><a href="#cb21-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-128"><a href="#cb21-128" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Add comments with questions if requested</span></span>
<span id="cb21-129"><a href="#cb21-129" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> include_questions_as_comments:</span>
<span id="cb21-130"><a href="#cb21-130" aria-hidden="true" tabindex="-1"></a>          <span class="co"># Add positive questions as comments</span></span>
<span id="cb21-131"><a href="#cb21-131" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> <span class="st">'Generate_Positive_Instantiation_Questions'</span> <span class="kw">in</span> node_data:</span>
<span id="cb21-132"><a href="#cb21-132" aria-hidden="true" tabindex="-1"></a>              positive_questions <span class="op">=</span> safe_parse_json(node_data[<span class="st">'Generate_Positive_Instantiation_Questions'</span>])</span>
<span id="cb21-133"><a href="#cb21-133" aria-hidden="true" tabindex="-1"></a>              <span class="cf">for</span> question <span class="kw">in</span> positive_questions.keys():</span>
<span id="cb21-134"><a href="#cb21-134" aria-hidden="true" tabindex="-1"></a>                  node_output <span class="op">+=</span> <span class="ss">f"</span><span class="sc">{</span>indent<span class="sc">}</span><span class="ss">/* </span><span class="sc">{</span>question<span class="sc">}</span><span class="ss"> */</span><span class="ch">\n</span><span class="ss">"</span></span>
<span id="cb21-135"><a href="#cb21-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-136"><a href="#cb21-136" aria-hidden="true" tabindex="-1"></a>          <span class="co"># Add negative questions as comments</span></span>
<span id="cb21-137"><a href="#cb21-137" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> <span class="st">'Generate_Negative_Instantiation_Questions'</span> <span class="kw">in</span> node_data:</span>
<span id="cb21-138"><a href="#cb21-138" aria-hidden="true" tabindex="-1"></a>              negative_questions <span class="op">=</span> safe_parse_json(node_data[<span class="st">'Generate_Negative_Instantiation_Questions'</span>])</span>
<span id="cb21-139"><a href="#cb21-139" aria-hidden="true" tabindex="-1"></a>              <span class="cf">for</span> question <span class="kw">in</span> negative_questions.keys():</span>
<span id="cb21-140"><a href="#cb21-140" aria-hidden="true" tabindex="-1"></a>                  node_output <span class="op">+=</span> <span class="ss">f"</span><span class="sc">{</span>indent<span class="sc">}</span><span class="ss">/* </span><span class="sc">{</span>question<span class="sc">}</span><span class="ss"> */</span><span class="ch">\n</span><span class="ss">"</span></span>
<span id="cb21-141"><a href="#cb21-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-142"><a href="#cb21-142" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Check if this node was already fully defined elsewhere</span></span>
<span id="cb21-143"><a href="#cb21-143" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> node <span class="kw">in</span> processed_nodes:</span>
<span id="cb21-144"><a href="#cb21-144" aria-hidden="true" tabindex="-1"></a>          <span class="co"># Just add a reference to the node</span></span>
<span id="cb21-145"><a href="#cb21-145" aria-hidden="true" tabindex="-1"></a>          node_output <span class="op">+=</span> <span class="ss">f"</span><span class="sc">{</span>prefix<span class="sc">}</span><span class="ss">[</span><span class="sc">{</span>title<span class="sc">}</span><span class="ss">]</span><span class="ch">\n</span><span class="ss">"</span></span>
<span id="cb21-146"><a href="#cb21-146" aria-hidden="true" tabindex="-1"></a>          <span class="cf">return</span> node_output</span>
<span id="cb21-147"><a href="#cb21-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-148"><a href="#cb21-148" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Mark this node as processed</span></span>
<span id="cb21-149"><a href="#cb21-149" aria-hidden="true" tabindex="-1"></a>      processed_nodes.add(node)</span>
<span id="cb21-150"><a href="#cb21-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-151"><a href="#cb21-151" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Prepare the metadata JSON</span></span>
<span id="cb21-152"><a href="#cb21-152" aria-hidden="true" tabindex="-1"></a>      metadata <span class="op">=</span> {</span>
<span id="cb21-153"><a href="#cb21-153" aria-hidden="true" tabindex="-1"></a>          <span class="st">"instantiations"</span>: instantiations</span>
<span id="cb21-154"><a href="#cb21-154" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb21-155"><a href="#cb21-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-156"><a href="#cb21-156" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Add priors with full questions as keys</span></span>
<span id="cb21-157"><a href="#cb21-157" aria-hidden="true" tabindex="-1"></a>      priors <span class="op">=</span> {}</span>
<span id="cb21-158"><a href="#cb21-158" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> <span class="st">'Generate_Positive_Instantiation_Questions'</span> <span class="kw">in</span> node_data:</span>
<span id="cb21-159"><a href="#cb21-159" aria-hidden="true" tabindex="-1"></a>          positive_questions <span class="op">=</span> safe_parse_json(node_data[<span class="st">'Generate_Positive_Instantiation_Questions'</span>])</span>
<span id="cb21-160"><a href="#cb21-160" aria-hidden="true" tabindex="-1"></a>          <span class="cf">for</span> question, estimate_key <span class="kw">in</span> positive_questions.items():</span>
<span id="cb21-161"><a href="#cb21-161" aria-hidden="true" tabindex="-1"></a>              <span class="cf">if</span> estimate_key <span class="op">==</span> <span class="st">'prior'</span>:</span>
<span id="cb21-162"><a href="#cb21-162" aria-hidden="true" tabindex="-1"></a>                  priors[question] <span class="op">=</span> <span class="st">"%?"</span>  <span class="co"># Default placeholder</span></span>
<span id="cb21-163"><a href="#cb21-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-164"><a href="#cb21-164" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> <span class="st">'Generate_Negative_Instantiation_Questions'</span> <span class="kw">in</span> node_data:</span>
<span id="cb21-165"><a href="#cb21-165" aria-hidden="true" tabindex="-1"></a>          negative_questions <span class="op">=</span> safe_parse_json(node_data[<span class="st">'Generate_Negative_Instantiation_Questions'</span>])</span>
<span id="cb21-166"><a href="#cb21-166" aria-hidden="true" tabindex="-1"></a>          <span class="cf">for</span> question, estimate_key <span class="kw">in</span> negative_questions.items():</span>
<span id="cb21-167"><a href="#cb21-167" aria-hidden="true" tabindex="-1"></a>              <span class="cf">if</span> estimate_key <span class="op">==</span> <span class="st">'prior'</span>:</span>
<span id="cb21-168"><a href="#cb21-168" aria-hidden="true" tabindex="-1"></a>                  priors[question] <span class="op">=</span> <span class="st">"%?"</span>  <span class="co"># Default placeholder</span></span>
<span id="cb21-169"><a href="#cb21-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-170"><a href="#cb21-170" aria-hidden="true" tabindex="-1"></a>      metadata[<span class="st">"priors"</span>] <span class="op">=</span> priors</span>
<span id="cb21-171"><a href="#cb21-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-172"><a href="#cb21-172" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Add posteriors with full questions as keys</span></span>
<span id="cb21-173"><a href="#cb21-173" aria-hidden="true" tabindex="-1"></a>      parents <span class="op">=</span> <span class="bu">list</span>(G.predecessors(node))</span>
<span id="cb21-174"><a href="#cb21-174" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> parents:</span>
<span id="cb21-175"><a href="#cb21-175" aria-hidden="true" tabindex="-1"></a>          posteriors <span class="op">=</span> {}</span>
<span id="cb21-176"><a href="#cb21-176" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> <span class="st">'Generate_Positive_Instantiation_Questions'</span> <span class="kw">in</span> node_data:</span>
<span id="cb21-177"><a href="#cb21-177" aria-hidden="true" tabindex="-1"></a>              positive_questions <span class="op">=</span> safe_parse_json(node_data[<span class="st">'Generate_Positive_Instantiation_Questions'</span>])</span>
<span id="cb21-178"><a href="#cb21-178" aria-hidden="true" tabindex="-1"></a>              <span class="cf">for</span> question, estimate_key <span class="kw">in</span> positive_questions.items():</span>
<span id="cb21-179"><a href="#cb21-179" aria-hidden="true" tabindex="-1"></a>                  <span class="cf">if</span> estimate_key.startswith(<span class="st">'estimate_'</span>):</span>
<span id="cb21-180"><a href="#cb21-180" aria-hidden="true" tabindex="-1"></a>                      posteriors[question] <span class="op">=</span> <span class="st">"?%"</span>  <span class="co"># Default placeholder</span></span>
<span id="cb21-181"><a href="#cb21-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-182"><a href="#cb21-182" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> <span class="st">'Generate_Negative_Instantiation_Questions'</span> <span class="kw">in</span> node_data:</span>
<span id="cb21-183"><a href="#cb21-183" aria-hidden="true" tabindex="-1"></a>              negative_questions <span class="op">=</span> safe_parse_json(node_data[<span class="st">'Generate_Negative_Instantiation_Questions'</span>])</span>
<span id="cb21-184"><a href="#cb21-184" aria-hidden="true" tabindex="-1"></a>              <span class="cf">for</span> question, estimate_key <span class="kw">in</span> negative_questions.items():</span>
<span id="cb21-185"><a href="#cb21-185" aria-hidden="true" tabindex="-1"></a>                  <span class="cf">if</span> estimate_key.startswith(<span class="st">'estimate_'</span>):</span>
<span id="cb21-186"><a href="#cb21-186" aria-hidden="true" tabindex="-1"></a>                      posteriors[question] <span class="op">=</span> <span class="st">"?%"</span>  <span class="co"># Default placeholder</span></span>
<span id="cb21-187"><a href="#cb21-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-188"><a href="#cb21-188" aria-hidden="true" tabindex="-1"></a>          metadata[<span class="st">"posteriors"</span>] <span class="op">=</span> posteriors</span>
<span id="cb21-189"><a href="#cb21-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-190"><a href="#cb21-190" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Format the node with metadata</span></span>
<span id="cb21-191"><a href="#cb21-191" aria-hidden="true" tabindex="-1"></a>      node_output <span class="op">+=</span> <span class="ss">f"</span><span class="sc">{</span>prefix<span class="sc">}</span><span class="ss">[</span><span class="sc">{</span>title<span class="sc">}</span><span class="ss">]: </span><span class="sc">{</span>description<span class="sc">}</span><span class="ss"> </span><span class="sc">{</span>json<span class="sc">.</span>dumps(metadata)<span class="sc">}</span><span class="ch">\n</span><span class="ss">"</span></span>
<span id="cb21-192"><a href="#cb21-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-193"><a href="#cb21-193" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Process parent nodes</span></span>
<span id="cb21-194"><a href="#cb21-194" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> parent <span class="kw">in</span> parents:</span>
<span id="cb21-195"><a href="#cb21-195" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> parent <span class="op">!=</span> node:  <span class="co"># Avoid self-references</span></span>
<span id="cb21-196"><a href="#cb21-196" aria-hidden="true" tabindex="-1"></a>              parent_output <span class="op">=</span> process_node(parent, indent_level <span class="op">+</span> <span class="dv">1</span>, processed_nodes)</span>
<span id="cb21-197"><a href="#cb21-197" aria-hidden="true" tabindex="-1"></a>              node_output <span class="op">+=</span> parent_output</span>
<span id="cb21-198"><a href="#cb21-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-199"><a href="#cb21-199" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> node_output</span>
<span id="cb21-200"><a href="#cb21-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-201"><a href="#cb21-201" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Helper function to parse instantiations safely</span></span>
<span id="cb21-202"><a href="#cb21-202" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> parse_instantiations_safely(instantiations_data):</span>
<span id="cb21-203"><a href="#cb21-203" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> <span class="bu">isinstance</span>(instantiations_data, <span class="bu">list</span>):</span>
<span id="cb21-204"><a href="#cb21-204" aria-hidden="true" tabindex="-1"></a>          <span class="cf">return</span> instantiations_data <span class="cf">if</span> instantiations_data <span class="cf">else</span> [<span class="ss">f"TRUE"</span>, <span class="ss">f"FALSE"</span>]</span>
<span id="cb21-205"><a href="#cb21-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-206"><a href="#cb21-206" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> <span class="bu">isinstance</span>(instantiations_data, <span class="bu">str</span>):</span>
<span id="cb21-207"><a href="#cb21-207" aria-hidden="true" tabindex="-1"></a>          <span class="cf">try</span>:</span>
<span id="cb21-208"><a href="#cb21-208" aria-hidden="true" tabindex="-1"></a>              parsed <span class="op">=</span> json.loads(instantiations_data)</span>
<span id="cb21-209"><a href="#cb21-209" aria-hidden="true" tabindex="-1"></a>              <span class="cf">if</span> <span class="bu">isinstance</span>(parsed, <span class="bu">list</span>):</span>
<span id="cb21-210"><a href="#cb21-210" aria-hidden="true" tabindex="-1"></a>                  <span class="cf">return</span> parsed <span class="cf">if</span> parsed <span class="cf">else</span> [<span class="ss">f"TRUE"</span>, <span class="ss">f"FALSE"</span>]</span>
<span id="cb21-211"><a href="#cb21-211" aria-hidden="true" tabindex="-1"></a>          <span class="cf">except</span>:</span>
<span id="cb21-212"><a href="#cb21-212" aria-hidden="true" tabindex="-1"></a>              <span class="cf">if</span> instantiations_data.startswith(<span class="st">'['</span>) <span class="kw">and</span> instantiations_data.endswith(<span class="st">']'</span>):</span>
<span id="cb21-213"><a href="#cb21-213" aria-hidden="true" tabindex="-1"></a>                  items <span class="op">=</span> instantiations_data.strip(<span class="st">'[]'</span>).split(<span class="st">','</span>)</span>
<span id="cb21-214"><a href="#cb21-214" aria-hidden="true" tabindex="-1"></a>                  result <span class="op">=</span> [item.strip(<span class="st">' "</span><span class="ch">\'</span><span class="st">'</span>) <span class="cf">for</span> item <span class="kw">in</span> items <span class="cf">if</span> item.strip()]</span>
<span id="cb21-215"><a href="#cb21-215" aria-hidden="true" tabindex="-1"></a>                  <span class="cf">return</span> result <span class="cf">if</span> result <span class="cf">else</span> [<span class="ss">f"TRUE"</span>, <span class="ss">f"FALSE"</span>]</span>
<span id="cb21-216"><a href="#cb21-216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-217"><a href="#cb21-217" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> [<span class="ss">f"TRUE"</span>, <span class="ss">f"FALSE"</span>]  <span class="co"># Default</span></span>
<span id="cb21-218"><a href="#cb21-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-219"><a href="#cb21-219" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Process each leaf node and its ancestors</span></span>
<span id="cb21-220"><a href="#cb21-220" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> leaf <span class="kw">in</span> leaf_nodes:</span>
<span id="cb21-221"><a href="#cb21-221" aria-hidden="true" tabindex="-1"></a>      bayesdown_content <span class="op">+=</span> process_node(leaf)</span>
<span id="cb21-222"><a href="#cb21-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-223"><a href="#cb21-223" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Save the BayesDown content</span></span>
<span id="cb21-224"><a href="#cb21-224" aria-hidden="true" tabindex="-1"></a>  <span class="cf">with</span> <span class="bu">open</span>(output_md_path, <span class="st">'w'</span>) <span class="im">as</span> f:</span>
<span id="cb21-225"><a href="#cb21-225" aria-hidden="true" tabindex="-1"></a>      f.write(bayesdown_content)</span>
<span id="cb21-226"><a href="#cb21-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-227"><a href="#cb21-227" aria-hidden="true" tabindex="-1"></a>  <span class="bu">print</span>(<span class="ss">f"BayesDown Questions saved to </span><span class="sc">{</span>output_md_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb21-228"><a href="#cb21-228" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> bayesdown_content</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Explicitly set the value of include_questions_as_comments</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>include_questions_as_comments<span class="op">=</span><span class="va">False</span>  <span class="co"># or False, depending on your needs</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the markdown content</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>bayesdown_questions <span class="op">=</span> extract_bayesdown_questions_fixed(</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ArgDown_WithQuestions.csv"</span>,</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">"BayesDownQuestions.md"</span>, include_questions_as_comments<span class="op">=</span>include_questions_as_comments</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Determine the output file path based on include_questions_as_comments</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> include_questions_as_comments: <span class="co"># Assuming include_questions_as_comments is defined somewhere in previous cells</span></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>    output_file_path <span class="op">=</span> <span class="st">"FULL_BayesDownQuestions.md"</span></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>    output_file_path <span class="op">=</span> <span class="st">"BayesDownQuestions.md"</span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the markdown content to the appropriate file</span></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(output_file_path, <span class="st">'w'</span>) <span class="im">as</span> f:</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>    f.write(md_content)</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Markdown content saved to </span><span class="sc">{</span>output_file_path<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate BayesDown format</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>bayesdown_questions <span class="op">=</span> extract_bayesdown_questions_fixed(</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ArgDown_WithQuestions.csv"</span>,</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"FULL_BayesDownQuestions.md"</span>,</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    include_questions_as_comments<span class="op">=</span><span class="va">True</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Display a preview of the format</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">BayesDown Format Preview:"</span>)</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(bayesdown_questions[:<span class="dv">50000</span>] <span class="op">+</span> <span class="st">"...</span><span class="ch">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load and print the content of the 'FULL_BayesDownQuestions.md' file</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">"FULL_BayesDownQuestions.md"</span>, <span class="st">"r"</span>) <span class="im">as</span> f:</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>    file_content <span class="op">=</span> f.read()</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(file_content)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate BayesDown format</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>bayesdown_questions <span class="op">=</span> extract_bayesdown_questions_fixed(</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ArgDown_WithQuestions.csv"</span>,</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"BayesDownQuestions.md"</span>,</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>    include_questions_as_comments<span class="op">=</span><span class="va">False</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Display a preview of the format</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(bayesdown_questions[:<span class="dv">50000</span>] <span class="op">+</span> <span class="st">"...</span><span class="ch">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="generate-bayesdown-probability-extraction-prompt" class="level2">
<h2 class="anchored" data-anchor-id="generate-bayesdown-probability-extraction-prompt">2.3 Generate BayesDown Probability Extraction Prompt</h2>
<p>Generate 2nd Extraction Prompt for Probabilities based on the questions generated from the ‘ArgDown.csv’ extraction</p>
</section>
<section id="bayesdown-format-specification" class="level2">
<h2 class="anchored" data-anchor-id="bayesdown-format-specification">2.3.1 BayesDown Format Specification</h2>
<p>BayesDown extends ArgDown with probability data in a structured JSON format to represent Bayesian networks. This intermediate representation bridges the gap between natural language arguments and formal probabilistic models, preserving both narrative structure and quantitative relationships.</p>
<section id="core-structure" class="level3">
<h3 class="anchored" data-anchor-id="core-structure">Core Structure</h3>
<p>A BayesDown representation consists of:</p>
<ol type="1">
<li><strong>Nodes</strong>: Variables or statements in brackets <code>[Node_Name]</code> with descriptive text</li>
<li><strong>Relationships</strong>: Hierarchical structure with indentation and <code>+</code> symbols</li>
<li><strong>Metadata</strong>: JSON objects containing probability information:</li>
</ol>
<div class="sourceCode" id="cb26"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"instantiations"</span><span class="fu">:</span> <span class="ot">[</span><span class="st">"state_TRUE"</span><span class="ot">,</span> <span class="st">"state_FALSE"</span><span class="ot">]</span><span class="fu">,</span>  <span class="er">//</span> <span class="er">Possible</span> <span class="er">states</span> <span class="er">of</span> <span class="er">variable</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"priors"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"p(state_TRUE)"</span><span class="fu">:</span> <span class="st">"0.7"</span><span class="fu">,</span>   <span class="er">//</span> <span class="er">Unconditional</span> <span class="er">probability</span> <span class="er">of</span> <span class="er">state_TRUE</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"p(state_FALSE)"</span><span class="fu">:</span> <span class="st">"0.3"</span>   <span class="er">//</span> <span class="er">Unconditional</span> <span class="er">probability</span> <span class="er">of</span> <span class="er">state_FALSE</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">},</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"posteriors"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"p(state_TRUE|condition1_TRUE,condition2_FALSE)"</span><span class="fu">:</span> <span class="st">"0.9"</span><span class="fu">,</span>  <span class="er">//</span> <span class="er">Conditional</span> <span class="er">on</span> <span class="er">parent</span> <span class="er">states</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"p(state_TRUE|condition1_FALSE,condition2_TRUE)"</span><span class="fu">:</span> <span class="st">"0.4"</span>   <span class="er">//</span> <span class="er">Different</span> <span class="er">parent</span> <span class="er">configuration</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">}</span></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a><span class="er">#####</span> <span class="er">Rain-Sprinkler-Lawn</span> <span class="er">Example</span></span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a><span class="ot">[</span><span class="er">Grass_Wet</span><span class="ot">]</span><span class="er">:</span> <span class="er">Concentrated</span> <span class="er">moisture</span> <span class="er">on</span> <span class="er">grass.</span> <span class="fu">{</span><span class="dt">"instantiations"</span><span class="fu">:</span> <span class="ot">[</span><span class="st">"grass_wet_TRUE"</span><span class="ot">,</span> <span class="st">"grass_wet_FALSE"</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a><span class="dt">"priors"</span><span class="fu">:</span> <span class="fu">{</span><span class="dt">"p(grass_wet_TRUE)"</span><span class="fu">:</span> <span class="st">"0.322"</span><span class="fu">,</span> <span class="dt">"p(grass_wet_FALSE)"</span><span class="fu">:</span> <span class="st">"0.678"</span><span class="fu">},</span></span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a><span class="dt">"posteriors"</span><span class="fu">:</span> <span class="fu">{</span><span class="dt">"p(grass_wet_TRUE|sprinkler_TRUE,rain_TRUE)"</span><span class="fu">:</span> <span class="st">"0.99"</span><span class="fu">,</span></span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a><span class="dt">"p(grass_wet_TRUE|sprinkler_TRUE,rain_FALSE)"</span><span class="fu">:</span> <span class="st">"0.9"</span><span class="fu">,</span></span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a><span class="dt">"p(grass_wet_TRUE|sprinkler_FALSE,rain_TRUE)"</span><span class="fu">:</span> <span class="st">"0.8"</span><span class="fu">,</span></span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a><span class="dt">"p(grass_wet_TRUE|sprinkler_FALSE,rain_FALSE)"</span><span class="fu">:</span> <span class="st">"0.0"</span><span class="fu">}}</span></span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a> <span class="er">+</span> <span class="ot">[</span><span class="er">Rain</span><span class="ot">]</span><span class="er">:</span> <span class="er">Water</span> <span class="er">falling</span> <span class="er">from</span> <span class="er">the</span> <span class="er">sky.</span> <span class="fu">{</span><span class="dt">"instantiations"</span><span class="fu">:</span> <span class="ot">[</span><span class="st">"rain_TRUE"</span><span class="ot">,</span> <span class="st">"rain_FALSE"</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a> <span class="dt">"priors"</span><span class="fu">:</span> <span class="fu">{</span><span class="dt">"p(rain_TRUE)"</span><span class="fu">:</span> <span class="st">"0.2"</span><span class="fu">,</span> <span class="dt">"p(rain_FALSE)"</span><span class="fu">:</span> <span class="st">"0.8"</span><span class="fu">}}</span></span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a> <span class="er">+</span> <span class="ot">[</span><span class="er">Sprinkler</span><span class="ot">]</span><span class="er">:</span> <span class="er">Artificial</span> <span class="er">watering</span> <span class="er">system.</span> <span class="fu">{</span><span class="dt">"instantiations"</span><span class="fu">:</span> <span class="ot">[</span><span class="st">"sprinkler_TRUE"</span><span class="ot">,</span> <span class="st">"sprinkler_FALSE"</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a> <span class="dt">"priors"</span><span class="fu">:</span> <span class="fu">{</span><span class="dt">"p(sprinkler_TRUE)"</span><span class="fu">:</span> <span class="st">"0.44838"</span><span class="fu">,</span> <span class="dt">"p(sprinkler_FALSE)"</span><span class="fu">:</span> <span class="st">"0.55162"</span><span class="fu">},</span></span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a> <span class="dt">"posteriors"</span><span class="fu">:</span> <span class="fu">{</span><span class="dt">"p(sprinkler_TRUE|rain_TRUE)"</span><span class="fu">:</span> <span class="st">"0.01"</span><span class="fu">,</span> <span class="dt">"p(sprinkler_TRUE|rain_FALSE)"</span><span class="fu">:</span> <span class="st">"0.4"</span><span class="fu">}}</span></span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a>   <span class="er">+</span> <span class="ot">[</span><span class="er">Rain</span><span class="ot">]</span></span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-28"><a href="#cb26-28" aria-hidden="true" tabindex="-1"></a><span class="er">In</span> <span class="er">this</span> <span class="er">example:</span></span>
<span id="cb26-29"><a href="#cb26-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-30"><a href="#cb26-30" aria-hidden="true" tabindex="-1"></a><span class="er">+</span> <span class="er">Grass_Wet</span> <span class="er">is</span> <span class="er">the</span> <span class="er">effect/outcome</span> <span class="er">node</span></span>
<span id="cb26-31"><a href="#cb26-31" aria-hidden="true" tabindex="-1"></a><span class="er">+</span> <span class="er">Rain</span> <span class="er">and</span> <span class="er">Sprinkler</span> <span class="er">are</span> <span class="er">parent</span> <span class="er">nodes</span> <span class="er">(causes)</span></span>
<span id="cb26-32"><a href="#cb26-32" aria-hidden="true" tabindex="-1"></a><span class="er">+</span> <span class="er">Rain</span> <span class="er">also</span> <span class="er">influences</span> <span class="er">Sprinkler</span> <span class="er">(people</span> <span class="er">tend</span> <span class="er">not</span> <span class="er">to</span> <span class="er">use</span> <span class="er">sprinklers</span> <span class="er">when</span> <span class="er">it's</span> <span class="er">raining)</span></span>
<span id="cb26-33"><a href="#cb26-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-34"><a href="#cb26-34" aria-hidden="true" tabindex="-1"></a><span class="er">Role</span> <span class="er">in</span> <span class="er">AMTAIR</span></span>
<span id="cb26-35"><a href="#cb26-35" aria-hidden="true" tabindex="-1"></a><span class="er">BayesDown</span> <span class="er">serves</span> <span class="er">as</span> <span class="er">the</span> <span class="er">critical</span> <span class="er">intermediate</span> <span class="er">representation</span> <span class="er">in</span> <span class="er">the</span> <span class="er">AMTAIR</span> <span class="er">extraction</span> <span class="er">pipeline,</span> <span class="er">bridging</span> <span class="er">between</span> <span class="er">qualitative</span> <span class="er">arguments</span> <span class="er">in</span> <span class="er">AI</span> <span class="er">safety</span> <span class="er">literature</span> <span class="er">and</span> <span class="er">formal</span> <span class="er">Bayesian</span> <span class="er">networks</span> <span class="er">that</span> <span class="er">can</span> <span class="er">be</span> <span class="er">used</span> <span class="er">for</span> <span class="er">probabilistic</span> <span class="er">reasoning</span> <span class="er">and</span> <span class="er">policy</span> <span class="er">evaluation.</span> <span class="er">By</span> <span class="er">preserving</span> <span class="er">both</span> <span class="er">narrative</span> <span class="er">explanation</span> <span class="er">and</span> <span class="er">probabilistic</span> <span class="er">information,</span> <span class="er">it</span> <span class="er">enables</span> <span class="er">the</span> <span class="er">automated</span> <span class="er">extraction</span> <span class="er">of</span> <span class="er">world</span> <span class="er">models</span> <span class="er">while</span> <span class="er">maintaining</span> <span class="er">traceability</span> <span class="er">to</span> <span class="er">the</span> <span class="er">original</span> <span class="er">arguments.</span></span>
<span id="cb26-36"><a href="#cb26-36" aria-hidden="true" tabindex="-1"></a><span class="er">For</span> <span class="er">full</span> <span class="er">syntax</span> <span class="er">details,</span> <span class="er">see</span> <span class="er">the</span> <span class="er">BayesDownSyntax.md</span> <span class="er">file</span> <span class="er">in</span> <span class="er">the</span> <span class="er">repository.</span></span>
<span id="cb26-37"><a href="#cb26-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-38"><a href="#cb26-38" aria-hidden="true" tabindex="-1"></a><span class="er">2.3.2</span> <span class="er">Probability</span> <span class="er">Extraction</span> <span class="er">Process</span></span>
<span id="cb26-39"><a href="#cb26-39" aria-hidden="true" tabindex="-1"></a><span class="er">The</span> <span class="er">probability</span> <span class="er">extraction</span> <span class="er">pipeline</span> <span class="er">follows</span> <span class="er">these</span> <span class="er">steps:</span></span>
<span id="cb26-40"><a href="#cb26-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-41"><a href="#cb26-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-42"><a href="#cb26-42" aria-hidden="true" tabindex="-1"></a><span class="er">Identify</span> <span class="er">variables</span> <span class="er">and</span> <span class="er">their</span> <span class="er">possible</span> <span class="er">states</span></span>
<span id="cb26-43"><a href="#cb26-43" aria-hidden="true" tabindex="-1"></a><span class="er">Extract</span> <span class="er">prior</span> <span class="er">probability</span> <span class="er">statements</span></span>
<span id="cb26-44"><a href="#cb26-44" aria-hidden="true" tabindex="-1"></a><span class="er">Identify</span> <span class="er">conditional</span> <span class="er">relationships</span></span>
<span id="cb26-45"><a href="#cb26-45" aria-hidden="true" tabindex="-1"></a><span class="er">Extract</span> <span class="er">conditional</span> <span class="er">probability</span> <span class="er">statements</span></span>
<span id="cb26-46"><a href="#cb26-46" aria-hidden="true" tabindex="-1"></a><span class="er">Format</span> <span class="er">the</span> <span class="er">data</span> <span class="er">in</span> <span class="er">BayesDown</span> <span class="er">syntax</span></span>
<span id="cb26-47"><a href="#cb26-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-48"><a href="#cb26-48" aria-hidden="true" tabindex="-1"></a><span class="er">2.3.3</span> <span class="er">Implementation</span> <span class="er">Steps</span></span>
<span id="cb26-49"><a href="#cb26-49" aria-hidden="true" tabindex="-1"></a><span class="er">To</span> <span class="er">extract</span> <span class="er">probabilities</span> <span class="er">and</span> <span class="er">create</span> <span class="er">BayesDown</span> <span class="er">format:</span></span>
<span id="cb26-50"><a href="#cb26-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-51"><a href="#cb26-51" aria-hidden="true" tabindex="-1"></a><span class="er">Run</span> <span class="er">the</span> <span class="er">extract_probabilities</span> <span class="er">function</span> <span class="er">on</span> <span class="er">ArgDown</span> <span class="er">text</span></span>
<span id="cb26-52"><a href="#cb26-52" aria-hidden="true" tabindex="-1"></a><span class="er">Process</span> <span class="er">the</span> <span class="er">results</span> <span class="er">into</span> <span class="er">a</span> <span class="er">structured</span> <span class="er">format</span></span>
<span id="cb26-53"><a href="#cb26-53" aria-hidden="true" tabindex="-1"></a><span class="er">Validate</span> <span class="er">the</span> <span class="er">probability</span> <span class="er">distributions</span> <span class="er">(ensure</span> <span class="er">they</span> <span class="er">sum</span> <span class="er">to</span> <span class="er">1)</span></span>
<span id="cb26-54"><a href="#cb26-54" aria-hidden="true" tabindex="-1"></a><span class="er">Generate</span> <span class="er">the</span> <span class="er">enhanced</span> <span class="er">BayesDown</span> <span class="er">representation</span></span>
<span id="cb26-55"><a href="#cb26-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-56"><a href="#cb26-56" aria-hidden="true" tabindex="-1"></a><span class="er">2.3.4</span> <span class="er">Validation</span> <span class="er">and</span> <span class="er">Quality</span> <span class="er">Control</span></span>
<span id="cb26-57"><a href="#cb26-57" aria-hidden="true" tabindex="-1"></a><span class="er">The</span> <span class="er">probability</span> <span class="er">extraction</span> <span class="er">process</span> <span class="er">includes</span> <span class="er">validation</span> <span class="er">steps:</span></span>
<span id="cb26-58"><a href="#cb26-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-59"><a href="#cb26-59" aria-hidden="true" tabindex="-1"></a><span class="er">Ensuring</span> <span class="er">coherent</span> <span class="er">probability</span> <span class="er">distributions</span></span>
<span id="cb26-60"><a href="#cb26-60" aria-hidden="true" tabindex="-1"></a><span class="er">Checking</span> <span class="er">for</span> <span class="er">logical</span> <span class="er">consistency</span> <span class="er">in</span> <span class="er">conditional</span> <span class="er">relationships</span></span>
<span id="cb26-61"><a href="#cb26-61" aria-hidden="true" tabindex="-1"></a><span class="er">Verifying</span> <span class="er">that</span> <span class="er">all</span> <span class="er">required</span> <span class="er">probability</span> <span class="er">statements</span> <span class="er">are</span> <span class="er">present</span></span>
<span id="cb26-62"><a href="#cb26-62" aria-hidden="true" tabindex="-1"></a><span class="er">Handling</span> <span class="er">missing</span> <span class="er">data</span> <span class="er">with</span> <span class="er">appropriate</span> <span class="er">default</span> <span class="er">values</span></span>
<span id="cb26-63"><a href="#cb26-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-64"><a href="#cb26-64" aria-hidden="true" tabindex="-1"></a><span class="er">##</span> <span class="er">2.4</span> <span class="er">Prepare</span> <span class="er">2nd</span> <span class="er">API</span> <span class="er">call</span></span>
<span id="cb26-65"><a href="#cb26-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-66"><a href="#cb26-66" aria-hidden="true" tabindex="-1"></a><span class="er">##</span> <span class="er">2.5</span> <span class="er">Make</span> <span class="er">BayesDown</span> <span class="er">Probability</span> <span class="er">Extraction</span> <span class="er">API</span> <span class="er">Call</span></span>
<span id="cb26-67"><a href="#cb26-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-68"><a href="#cb26-68" aria-hidden="true" tabindex="-1"></a><span class="er">##</span> <span class="er">2.6</span> <span class="er">Save</span> <span class="er">BayesDown</span> <span class="er">with</span> <span class="er">Probability</span> <span class="er">Estimates</span> <span class="er">(.csv)</span></span>
<span id="cb26-69"><a href="#cb26-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-70"><a href="#cb26-70" aria-hidden="true" tabindex="-1"></a><span class="er">##</span> <span class="er">2.7</span> <span class="er">Review</span> <span class="er">&amp;</span> <span class="er">Verify</span> <span class="er">BayesDown</span> <span class="er">Probability</span> <span class="er">Estimates</span></span>
<span id="cb26-71"><a href="#cb26-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-72"><a href="#cb26-72" aria-hidden="true" tabindex="-1"></a><span class="er">##</span> <span class="er">2.7.2</span> <span class="er">Check</span> <span class="er">the</span> <span class="er">Graph</span> <span class="er">Structure</span> <span class="er">with</span> <span class="er">the</span> <span class="er">ArgDown</span> <span class="er">Sandbox</span> <span class="er">Online</span></span>
<span id="cb26-73"><a href="#cb26-73" aria-hidden="true" tabindex="-1"></a><span class="er">Copy</span> <span class="er">and</span> <span class="er">paste</span> <span class="er">the</span> <span class="er">BayesDown</span> <span class="er">formatted</span> <span class="er">...</span> <span class="er">in</span> <span class="er">the</span> <span class="er">ArgDown</span> <span class="er">Sandbox</span> <span class="er">below</span> <span class="er">to</span> <span class="er">quickly</span> <span class="er">verify</span> <span class="er">that</span> <span class="er">the</span> <span class="er">network</span> <span class="er">renders</span> <span class="er">correctly.</span></span>
<span id="cb26-74"><a href="#cb26-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-75"><a href="#cb26-75" aria-hidden="true" tabindex="-1"></a><span class="er">##</span> <span class="er">2.8</span> <span class="er">Extract</span> <span class="er">BayesDown</span> <span class="er">with</span> <span class="er">Probability</span> <span class="er">Estimates</span> <span class="er">as</span> <span class="er">Dataframe</span></span>
<span id="cb26-76"><a href="#cb26-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-77"><a href="#cb26-77" aria-hidden="true" tabindex="-1"></a><span class="er">#</span> <span class="er">3.0</span> <span class="er">Data</span> <span class="er">Extraction:</span> <span class="er">BayesDown</span> <span class="er">(.md)</span> <span class="er">to</span> <span class="er">Database</span> <span class="er">(.csv)</span></span>
<span id="cb26-78"><a href="#cb26-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-79"><a href="#cb26-79" aria-hidden="true" tabindex="-1"></a><span class="er">#</span> <span class="er">3.</span> <span class="er">BayesDown</span> <span class="er">to</span> <span class="er">Structured</span> <span class="er">Data:</span> <span class="er">Network</span> <span class="er">Construction</span></span>
<span id="cb26-80"><a href="#cb26-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-81"><a href="#cb26-81" aria-hidden="true" tabindex="-1"></a><span class="er">##</span> <span class="er">Extraction</span> <span class="er">Pipeline</span> <span class="er">Overview</span></span>
<span id="cb26-82"><a href="#cb26-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-83"><a href="#cb26-83" aria-hidden="true" tabindex="-1"></a><span class="er">This</span> <span class="er">section</span> <span class="er">implements</span> <span class="er">the</span> <span class="er">core</span> <span class="er">extraction</span> <span class="er">pipeline</span> <span class="er">described</span> <span class="er">in</span> <span class="er">the</span> <span class="er">AMTAIR</span> <span class="er">project</span> <span class="er">documentation</span> <span class="er">(see</span> <span class="er">`PY_TechnicalImplementation.md`),</span> <span class="er">which</span> <span class="er">transforms</span> <span class="er">structured</span> <span class="er">argument</span> <span class="er">representations</span> <span class="er">into</span> <span class="er">formal</span> <span class="er">Bayesian</span> <span class="er">networks</span> <span class="er">through</span> <span class="er">a</span> <span class="er">series</span> <span class="er">of</span> <span class="er">processing</span> <span class="er">steps:</span></span>
<span id="cb26-84"><a href="#cb26-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-85"><a href="#cb26-85" aria-hidden="true" tabindex="-1"></a><span class="er">1.</span> <span class="er">**Input**:</span> <span class="er">Text</span> <span class="er">in</span> <span class="er">BayesDown</span> <span class="er">format</span> <span class="er">(see</span> <span class="er">Section</span> <span class="er">2.3.1)</span></span>
<span id="cb26-86"><a href="#cb26-86" aria-hidden="true" tabindex="-1"></a><span class="er">2.</span> <span class="er">**Parsing**:</span> <span class="er">Extract</span> <span class="er">nodes,</span> <span class="er">relationships,</span> <span class="er">and</span> <span class="er">probability</span> <span class="er">information</span></span>
<span id="cb26-87"><a href="#cb26-87" aria-hidden="true" tabindex="-1"></a><span class="er">3.</span> <span class="er">**Structuring**:</span> <span class="er">Organize</span> <span class="er">into</span> <span class="er">a</span> <span class="er">DataFrame</span> <span class="er">with</span> <span class="er">formal</span> <span class="er">relationships</span></span>
<span id="cb26-88"><a href="#cb26-88" aria-hidden="true" tabindex="-1"></a><span class="er">4.</span> <span class="er">**Enhancement**:</span> <span class="er">Add</span> <span class="er">derived</span> <span class="er">properties</span> <span class="er">and</span> <span class="er">network</span> <span class="er">metrics</span></span>
<span id="cb26-89"><a href="#cb26-89" aria-hidden="true" tabindex="-1"></a><span class="er">5.</span> <span class="er">**Output**:</span> <span class="er">Structured</span> <span class="er">data</span> <span class="er">ready</span> <span class="er">for</span> <span class="er">Bayesian</span> <span class="er">network</span> <span class="er">construction</span></span>
<span id="cb26-90"><a href="#cb26-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-91"><a href="#cb26-91" aria-hidden="true" tabindex="-1"></a><span class="er">###</span> <span class="er">Theoretical</span> <span class="er">Foundation</span></span>
<span id="cb26-92"><a href="#cb26-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-93"><a href="#cb26-93" aria-hidden="true" tabindex="-1"></a><span class="er">This</span> <span class="er">implementation</span> <span class="er">follows</span> <span class="er">the</span> <span class="er">extraction</span> <span class="er">algorithm</span> <span class="er">outlined</span> <span class="er">in</span> <span class="er">the</span> <span class="er">AMTAIR</span> <span class="er">project</span> <span class="er">description:</span></span>
<span id="cb26-94"><a href="#cb26-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-95"><a href="#cb26-95" aria-hidden="true" tabindex="-1"></a><span class="er">1.</span> <span class="er">Get</span> <span class="er">nodes:</span> <span class="er">All</span> <span class="er">premises</span> <span class="er">and</span> <span class="er">conclusions</span> <span class="er">from</span> <span class="er">the</span> <span class="er">argument</span> <span class="er">structure</span></span>
<span id="cb26-96"><a href="#cb26-96" aria-hidden="true" tabindex="-1"></a><span class="er">2.</span> <span class="er">Get</span> <span class="er">edges:</span> <span class="er">Parent-child</span> <span class="er">relationships</span> <span class="er">between</span> <span class="er">nodes</span></span>
<span id="cb26-97"><a href="#cb26-97" aria-hidden="true" tabindex="-1"></a><span class="er">3.</span> <span class="er">Extract</span> <span class="er">probability</span> <span class="er">distributions:</span> <span class="er">Prior</span> <span class="er">and</span> <span class="er">conditional</span> <span class="er">probabilities</span></span>
<span id="cb26-98"><a href="#cb26-98" aria-hidden="true" tabindex="-1"></a><span class="er">4.</span> <span class="er">Calculate</span> <span class="er">derived</span> <span class="er">metrics:</span> <span class="er">Network</span> <span class="er">statistics</span> <span class="er">and</span> <span class="er">node</span> <span class="er">classifications</span></span>
<span id="cb26-99"><a href="#cb26-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-100"><a href="#cb26-100" aria-hidden="true" tabindex="-1"></a><span class="er">The</span> <span class="er">resulting</span> <span class="er">structured</span> <span class="er">data</span> <span class="er">maintains</span> <span class="er">the</span> <span class="er">complete</span> <span class="er">information</span> <span class="er">needed</span> <span class="er">to</span> <span class="er">reconstruct</span> <span class="er">the</span> <span class="er">Bayesian</span> <span class="er">network</span> <span class="er">while</span> <span class="er">enabling</span> <span class="er">additional</span> <span class="er">analysis</span> <span class="er">and</span> <span class="er">visualization.</span></span>
<span id="cb26-101"><a href="#cb26-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-102"><a href="#cb26-102" aria-hidden="true" tabindex="-1"></a><span class="er">###</span> <span class="er">Role</span> <span class="er">in</span> <span class="er">Thesis</span> <span class="er">Research</span></span>
<span id="cb26-103"><a href="#cb26-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-104"><a href="#cb26-104" aria-hidden="true" tabindex="-1"></a><span class="er">This</span> <span class="er">extraction</span> <span class="er">pipeline</span> <span class="er">represents</span> <span class="er">a</span> <span class="er">key</span> <span class="er">contribution</span> <span class="er">of</span> <span class="er">the</span> <span class="er">Master's</span> <span class="er">thesis,</span> <span class="er">demonstrating</span> <span class="er">how</span> <span class="er">argument</span> <span class="er">structures</span> <span class="er">from</span> <span class="er">AI</span> <span class="er">safety</span> <span class="er">literature</span> <span class="er">can</span> <span class="er">be</span> <span class="er">automatically</span> <span class="er">transformed</span> <span class="er">into</span> <span class="er">formal</span> <span class="er">probabilistic</span> <span class="er">models.</span> <span class="er">While</span> <span class="er">the</span> <span class="er">current</span> <span class="er">implementation</span> <span class="er">focuses</span> <span class="er">on</span> <span class="er">pre-formatted</span> <span class="er">BayesDown,</span> <span class="er">the</span> <span class="er">architecture</span> <span class="er">is</span> <span class="er">designed</span> <span class="er">to</span> <span class="er">be</span> <span class="er">extended</span> <span class="er">with</span> <span class="er">LLM-powered</span> <span class="er">extraction</span> <span class="er">directly</span> <span class="er">from</span> <span class="er">natural</span> <span class="er">language</span> <span class="er">in</span> <span class="er">future</span> <span class="er">work.</span></span>
<span id="cb26-105"><a href="#cb26-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-106"><a href="#cb26-106" aria-hidden="true" tabindex="-1"></a><span class="er">The</span> <span class="er">rain-sprinkler-lawn</span> <span class="er">example</span> <span class="er">serves</span> <span class="er">as</span> <span class="er">a</span> <span class="er">simple</span> <span class="er">but</span> <span class="er">complete</span> <span class="er">test</span> <span class="er">case,</span> <span class="er">demonstrating</span> <span class="er">every</span> <span class="er">step</span> <span class="er">in</span> <span class="er">the</span> <span class="er">pipeline</span> <span class="er">from</span> <span class="er">structured</span> <span class="er">text</span> <span class="er">to</span> <span class="er">interactive</span> <span class="er">Bayesian</span> <span class="er">network</span> <span class="er">visualization.</span></span>
<span id="cb26-107"><a href="#cb26-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-108"><a href="#cb26-108" aria-hidden="true" tabindex="-1"></a><span class="er">###</span> <span class="er">3.1</span> <span class="er">ExtractBayesDown-Data_v1</span></span>
<span id="cb26-109"><a href="#cb26-109" aria-hidden="true" tabindex="-1"></a><span class="er">Build</span> <span class="er">data</span> <span class="er">frame</span> <span class="er">with</span> <span class="er">extractable</span> <span class="er">information</span> <span class="er">from</span> <span class="er">BayesDown</span></span>
<span id="cb26-110"><a href="#cb26-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-111"><a href="#cb26-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-112"><a href="#cb26-112" aria-hidden="true" tabindex="-1"></a><span class="er">```python</span></span>
<span id="cb26-113"><a href="#cb26-113" aria-hidden="true" tabindex="-1"></a><span class="er">#</span> <span class="er">read</span> <span class="er">sprinkler</span> <span class="er">example</span> <span class="er">--</span> <span class="er">Occam</span> <span class="er">Colab</span> <span class="er">Online</span></span>
<span id="cb26-114"><a href="#cb26-114" aria-hidden="true" tabindex="-1"></a><span class="er">file_path_ex_rain</span> <span class="er">=</span> <span class="er">"https://raw.githubusercontent.com/SingularitySmith/AMTAIR_Prototype/main/data/example_carlsmith/BayesDown.md"</span></span>
<span id="cb26-115"><a href="#cb26-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-116"><a href="#cb26-116" aria-hidden="true" tabindex="-1"></a><span class="er">#</span> <span class="er">Use</span> <span class="er">requests.get</span> <span class="er">to</span> <span class="er">fetch</span> <span class="er">content</span> <span class="er">from</span> <span class="er">URL</span></span>
<span id="cb26-117"><a href="#cb26-117" aria-hidden="true" tabindex="-1"></a><span class="er">response</span> <span class="er">=</span> <span class="er">requests.get(file_path_ex_rain)</span></span>
<span id="cb26-118"><a href="#cb26-118" aria-hidden="true" tabindex="-1"></a><span class="er">response.raise_for_status()</span>  <span class="er">#</span> <span class="er">Raise</span> <span class="er">HTTPError</span> <span class="er">for</span> <span class="er">bad</span> <span class="er">responses</span> <span class="er">(4xx</span> <span class="er">or</span> <span class="er">5xx)</span></span>
<span id="cb26-119"><a href="#cb26-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-120"><a href="#cb26-120" aria-hidden="true" tabindex="-1"></a><span class="er">#</span> <span class="er">Read</span> <span class="er">content</span> <span class="er">from</span> <span class="er">the</span> <span class="er">response</span></span>
<span id="cb26-121"><a href="#cb26-121" aria-hidden="true" tabindex="-1"></a><span class="er">md_content_ex_rain</span> <span class="er">=</span> <span class="er">response.text</span></span>
<span id="cb26-122"><a href="#cb26-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-123"><a href="#cb26-123" aria-hidden="true" tabindex="-1"></a><span class="er">md_content_ex_rain</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="test-bayesdown-extraction" class="level2">
<h2 class="anchored" data-anchor-id="test-bayesdown-extraction">3.1.2 Test BayesDown Extraction</h2>
<div class="sourceCode" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>display(Markdown(md_content_ex_rain)) <span class="co"># view BayesDown file formatted as MarkDown</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="check-the-graph-structure-with-the-argdown-sandbox-online-1" class="level2">
<h2 class="anchored" data-anchor-id="check-the-graph-structure-with-the-argdown-sandbox-online-1">3.1.2.2 Check the Graph Structure with the ArgDown Sandbox Online</h2>
<p>Copy and paste the BayesDown formatted … in the ArgDown Sandbox below to quickly verify that the network renders correctly.</p>
</section>
<section id="extraction" class="level2">
<h2 class="anchored" data-anchor-id="extraction">3.3 Extraction</h2>
<p>BayesDown Extraction Code already part of ArgDown extraction code, therefore just use same function “parse_markdown_hierarchy(markdown_data)” and ignore the extra argument (“ArgDown”) because it is automatically set to false amd will by default extract BayesDown.</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>result_df <span class="op">=</span> parse_markdown_hierarchy_fixed(md_content_ex_rain)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>result_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<section id="data-post-processing" class="level3">
<h3 class="anchored" data-anchor-id="data-post-processing">3.3 Data-Post-Processing</h3>
<p>Add rows to data frame that can be calculated from the extracted rows</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># @title 3.3.1 Data Post-Processing Functions ---</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="co">BLOCK PURPOSE: Enhances the extracted BayesDown data with calculated metrics and network properties.</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a><span class="co">This block provides functions to enrich the basic extracted data with additional</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a><span class="co">calculated columns that are useful for analysis and visualization:</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a><span class="co">1. Joint probabilities - Calculating P(A,B) from conditional and prior probabilities</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a><span class="co">2. Network metrics - Centrality measures that indicate importance of nodes in the network</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a><span class="co">3. Markov blanket - Identifying the minimal set of nodes that shield a node from the rest</span></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a><span class="co">These enhancements provide valuable context for understanding the network structure</span></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a><span class="co">and the relationships between variables, enabling more advanced analysis and</span></span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a><span class="co">improving visualization.</span></span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a><span class="co">DEPENDENCIES: networkx for graph calculations</span></span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a><span class="co">INPUTS: DataFrame with basic extracted BayesDown data</span></span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a><span class="co">OUTPUTS: Enhanced DataFrame with additional calculated columns</span></span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> enhance_extracted_data(df):</span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a><span class="co">    Enhance the extracted data with calculated columns</span></span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a><span class="co">        df: DataFrame with extracted BayesDown data</span></span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb29-30"><a href="#cb29-30" aria-hidden="true" tabindex="-1"></a><span class="co">        Enhanced DataFrame with additional columns</span></span>
<span id="cb29-31"><a href="#cb29-31" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb29-32"><a href="#cb29-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create a copy to avoid modifying the original</span></span>
<span id="cb29-33"><a href="#cb29-33" aria-hidden="true" tabindex="-1"></a>    enhanced_df <span class="op">=</span> df.copy()</span>
<span id="cb29-34"><a href="#cb29-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-35"><a href="#cb29-35" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 1. Calculate joint probabilities - P(A,B) = P(A|B) * P(B)</span></span>
<span id="cb29-36"><a href="#cb29-36" aria-hidden="true" tabindex="-1"></a>    enhanced_df[<span class="st">'joint_probabilities'</span>] <span class="op">=</span> <span class="va">None</span></span>
<span id="cb29-37"><a href="#cb29-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-38"><a href="#cb29-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> idx, row <span class="kw">in</span> enhanced_df.iterrows():</span>
<span id="cb29-39"><a href="#cb29-39" aria-hidden="true" tabindex="-1"></a>        title <span class="op">=</span> row[<span class="st">'Title'</span>]</span>
<span id="cb29-40"><a href="#cb29-40" aria-hidden="true" tabindex="-1"></a>        priors <span class="op">=</span> row[<span class="st">'priors'</span>] <span class="cf">if</span> <span class="bu">isinstance</span>(row[<span class="st">'priors'</span>], <span class="bu">dict</span>) <span class="cf">else</span> {}</span>
<span id="cb29-41"><a href="#cb29-41" aria-hidden="true" tabindex="-1"></a>        posteriors <span class="op">=</span> row[<span class="st">'posteriors'</span>] <span class="cf">if</span> <span class="bu">isinstance</span>(row[<span class="st">'posteriors'</span>], <span class="bu">dict</span>) <span class="cf">else</span> {}</span>
<span id="cb29-42"><a href="#cb29-42" aria-hidden="true" tabindex="-1"></a>        parents <span class="op">=</span> row[<span class="st">'Parents'</span>] <span class="cf">if</span> <span class="bu">isinstance</span>(row[<span class="st">'Parents'</span>], <span class="bu">list</span>) <span class="cf">else</span> []</span>
<span id="cb29-43"><a href="#cb29-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-44"><a href="#cb29-44" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Skip if no parents or no priors</span></span>
<span id="cb29-45"><a href="#cb29-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> parents <span class="kw">or</span> <span class="kw">not</span> priors:</span>
<span id="cb29-46"><a href="#cb29-46" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb29-47"><a href="#cb29-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-48"><a href="#cb29-48" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Initialize joint probabilities dictionary</span></span>
<span id="cb29-49"><a href="#cb29-49" aria-hidden="true" tabindex="-1"></a>        joint_probs <span class="op">=</span> {}</span>
<span id="cb29-50"><a href="#cb29-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-51"><a href="#cb29-51" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get instantiations</span></span>
<span id="cb29-52"><a href="#cb29-52" aria-hidden="true" tabindex="-1"></a>        instantiations <span class="op">=</span> row[<span class="st">'instantiations'</span>]</span>
<span id="cb29-53"><a href="#cb29-53" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> <span class="bu">isinstance</span>(instantiations, <span class="bu">list</span>) <span class="kw">or</span> <span class="kw">not</span> instantiations:</span>
<span id="cb29-54"><a href="#cb29-54" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb29-55"><a href="#cb29-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-56"><a href="#cb29-56" aria-hidden="true" tabindex="-1"></a>        <span class="co"># For each parent and child instantiation combination, calculate joint probability</span></span>
<span id="cb29-57"><a href="#cb29-57" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> inst <span class="kw">in</span> instantiations:</span>
<span id="cb29-58"><a href="#cb29-58" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Get this instantiation's prior probability</span></span>
<span id="cb29-59"><a href="#cb29-59" aria-hidden="true" tabindex="-1"></a>            inst_prior_key <span class="op">=</span> <span class="ss">f"p(</span><span class="sc">{</span>inst<span class="sc">}</span><span class="ss">)"</span></span>
<span id="cb29-60"><a href="#cb29-60" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> inst_prior_key <span class="kw">not</span> <span class="kw">in</span> priors:</span>
<span id="cb29-61"><a href="#cb29-61" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span></span>
<span id="cb29-62"><a href="#cb29-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-63"><a href="#cb29-63" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb29-64"><a href="#cb29-64" aria-hidden="true" tabindex="-1"></a>                inst_prior <span class="op">=</span> <span class="bu">float</span>(priors[inst_prior_key])</span>
<span id="cb29-65"><a href="#cb29-65" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span> (<span class="pp">ValueError</span>, <span class="pp">TypeError</span>):</span>
<span id="cb29-66"><a href="#cb29-66" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span></span>
<span id="cb29-67"><a href="#cb29-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-68"><a href="#cb29-68" aria-hidden="true" tabindex="-1"></a>            <span class="co"># For each parent</span></span>
<span id="cb29-69"><a href="#cb29-69" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> parent <span class="kw">in</span> parents:</span>
<span id="cb29-70"><a href="#cb29-70" aria-hidden="true" tabindex="-1"></a>                parent_row <span class="op">=</span> enhanced_df[enhanced_df[<span class="st">'Title'</span>] <span class="op">==</span> parent]</span>
<span id="cb29-71"><a href="#cb29-71" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> parent_row.empty:</span>
<span id="cb29-72"><a href="#cb29-72" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">continue</span></span>
<span id="cb29-73"><a href="#cb29-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-74"><a href="#cb29-74" aria-hidden="true" tabindex="-1"></a>                parent_insts <span class="op">=</span> parent_row.iloc[<span class="dv">0</span>][<span class="st">'instantiations'</span>]</span>
<span id="cb29-75"><a href="#cb29-75" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="kw">not</span> <span class="bu">isinstance</span>(parent_insts, <span class="bu">list</span>) <span class="kw">or</span> <span class="kw">not</span> parent_insts:</span>
<span id="cb29-76"><a href="#cb29-76" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">continue</span></span>
<span id="cb29-77"><a href="#cb29-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-78"><a href="#cb29-78" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> parent_inst <span class="kw">in</span> parent_insts:</span>
<span id="cb29-79"><a href="#cb29-79" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Get conditional probability</span></span>
<span id="cb29-80"><a href="#cb29-80" aria-hidden="true" tabindex="-1"></a>                    cond_key <span class="op">=</span> <span class="ss">f"p(</span><span class="sc">{</span>inst<span class="sc">}</span><span class="ss">|</span><span class="sc">{</span>parent<span class="sc">}</span><span class="ss">=</span><span class="sc">{</span>parent_inst<span class="sc">}</span><span class="ss">)"</span></span>
<span id="cb29-81"><a href="#cb29-81" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> cond_key <span class="kw">in</span> posteriors:</span>
<span id="cb29-82"><a href="#cb29-82" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">try</span>:</span>
<span id="cb29-83"><a href="#cb29-83" aria-hidden="true" tabindex="-1"></a>                            cond_prob <span class="op">=</span> <span class="bu">float</span>(posteriors[cond_key])</span>
<span id="cb29-84"><a href="#cb29-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-85"><a href="#cb29-85" aria-hidden="true" tabindex="-1"></a>                            <span class="co"># Get parent's prior</span></span>
<span id="cb29-86"><a href="#cb29-86" aria-hidden="true" tabindex="-1"></a>                            parent_priors <span class="op">=</span> parent_row.iloc[<span class="dv">0</span>][<span class="st">'priors'</span>]</span>
<span id="cb29-87"><a href="#cb29-87" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">if</span> <span class="kw">not</span> <span class="bu">isinstance</span>(parent_priors, <span class="bu">dict</span>):</span>
<span id="cb29-88"><a href="#cb29-88" aria-hidden="true" tabindex="-1"></a>                                <span class="cf">continue</span></span>
<span id="cb29-89"><a href="#cb29-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-90"><a href="#cb29-90" aria-hidden="true" tabindex="-1"></a>                            parent_prior_key <span class="op">=</span> <span class="ss">f"p(</span><span class="sc">{</span>parent_inst<span class="sc">}</span><span class="ss">)"</span></span>
<span id="cb29-91"><a href="#cb29-91" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">if</span> parent_prior_key <span class="kw">not</span> <span class="kw">in</span> parent_priors:</span>
<span id="cb29-92"><a href="#cb29-92" aria-hidden="true" tabindex="-1"></a>                                <span class="cf">continue</span></span>
<span id="cb29-93"><a href="#cb29-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-94"><a href="#cb29-94" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">try</span>:</span>
<span id="cb29-95"><a href="#cb29-95" aria-hidden="true" tabindex="-1"></a>                                parent_prior <span class="op">=</span> <span class="bu">float</span>(parent_priors[parent_prior_key])</span>
<span id="cb29-96"><a href="#cb29-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-97"><a href="#cb29-97" aria-hidden="true" tabindex="-1"></a>                                <span class="co"># Calculate joint probability: P(A,B) = P(A|B) * P(B)</span></span>
<span id="cb29-98"><a href="#cb29-98" aria-hidden="true" tabindex="-1"></a>                                joint_prob <span class="op">=</span> cond_prob <span class="op">*</span> parent_prior</span>
<span id="cb29-99"><a href="#cb29-99" aria-hidden="true" tabindex="-1"></a>                                joint_key <span class="op">=</span> <span class="ss">f"p(</span><span class="sc">{</span>inst<span class="sc">}</span><span class="ss">,</span><span class="sc">{</span>parent<span class="sc">}</span><span class="ss">=</span><span class="sc">{</span>parent_inst<span class="sc">}</span><span class="ss">)"</span></span>
<span id="cb29-100"><a href="#cb29-100" aria-hidden="true" tabindex="-1"></a>                                joint_probs[joint_key] <span class="op">=</span> <span class="bu">str</span>(<span class="bu">round</span>(joint_prob, <span class="dv">4</span>))</span>
<span id="cb29-101"><a href="#cb29-101" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">except</span> (<span class="pp">ValueError</span>, <span class="pp">TypeError</span>):</span>
<span id="cb29-102"><a href="#cb29-102" aria-hidden="true" tabindex="-1"></a>                                joint_prob <span class="op">=</span> cond_prob <span class="op">*</span> parent_prior</span>
<span id="cb29-103"><a href="#cb29-103" aria-hidden="true" tabindex="-1"></a>                                joint_key <span class="op">=</span> <span class="ss">f"p(</span><span class="sc">{</span>inst<span class="sc">}</span><span class="ss">,</span><span class="sc">{</span>parent<span class="sc">}</span><span class="ss">=</span><span class="sc">{</span>parent_inst<span class="sc">}</span><span class="ss">)"</span></span>
<span id="cb29-104"><a href="#cb29-104" aria-hidden="true" tabindex="-1"></a>                                joint_probs[joint_key] <span class="op">=</span> <span class="bu">str</span>(<span class="bu">round</span>(joint_prob, <span class="dv">4</span>))</span>
<span id="cb29-105"><a href="#cb29-105" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">except</span> (<span class="pp">ValueError</span>, <span class="pp">TypeError</span>):</span>
<span id="cb29-106"><a href="#cb29-106" aria-hidden="true" tabindex="-1"></a>                                <span class="cf">continue</span></span>
<span id="cb29-107"><a href="#cb29-107" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">except</span> (<span class="pp">ValueError</span>, <span class="pp">TypeError</span>):</span>
<span id="cb29-108"><a href="#cb29-108" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">continue</span></span>
<span id="cb29-109"><a href="#cb29-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-110"><a href="#cb29-110" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Store joint probabilities in dataframe</span></span>
<span id="cb29-111"><a href="#cb29-111" aria-hidden="true" tabindex="-1"></a>        enhanced_df.at[idx, <span class="st">'joint_probabilities'</span>] <span class="op">=</span> joint_probs</span>
<span id="cb29-112"><a href="#cb29-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-113"><a href="#cb29-113" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2. Calculate network metrics</span></span>
<span id="cb29-114"><a href="#cb29-114" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create a directed graph</span></span>
<span id="cb29-115"><a href="#cb29-115" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> networkx <span class="im">as</span> nx</span>
<span id="cb29-116"><a href="#cb29-116" aria-hidden="true" tabindex="-1"></a>    G <span class="op">=</span> nx.DiGraph()</span>
<span id="cb29-117"><a href="#cb29-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-118"><a href="#cb29-118" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add nodes</span></span>
<span id="cb29-119"><a href="#cb29-119" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> idx, row <span class="kw">in</span> enhanced_df.iterrows():</span>
<span id="cb29-120"><a href="#cb29-120" aria-hidden="true" tabindex="-1"></a>        G.add_node(row[<span class="st">'Title'</span>])</span>
<span id="cb29-121"><a href="#cb29-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-122"><a href="#cb29-122" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add edges</span></span>
<span id="cb29-123"><a href="#cb29-123" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> idx, row <span class="kw">in</span> enhanced_df.iterrows():</span>
<span id="cb29-124"><a href="#cb29-124" aria-hidden="true" tabindex="-1"></a>        child <span class="op">=</span> row[<span class="st">'Title'</span>]</span>
<span id="cb29-125"><a href="#cb29-125" aria-hidden="true" tabindex="-1"></a>        parents <span class="op">=</span> row[<span class="st">'Parents'</span>] <span class="cf">if</span> <span class="bu">isinstance</span>(row[<span class="st">'Parents'</span>], <span class="bu">list</span>) <span class="cf">else</span> []</span>
<span id="cb29-126"><a href="#cb29-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-127"><a href="#cb29-127" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> parent <span class="kw">in</span> parents:</span>
<span id="cb29-128"><a href="#cb29-128" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> parent <span class="kw">in</span> G.nodes():</span>
<span id="cb29-129"><a href="#cb29-129" aria-hidden="true" tabindex="-1"></a>                G.add_edge(parent, child)</span>
<span id="cb29-130"><a href="#cb29-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-131"><a href="#cb29-131" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate centrality measures</span></span>
<span id="cb29-132"><a href="#cb29-132" aria-hidden="true" tabindex="-1"></a>    degree_centrality <span class="op">=</span> nx.degree_centrality(G)  <span class="co"># Overall connectedness</span></span>
<span id="cb29-133"><a href="#cb29-133" aria-hidden="true" tabindex="-1"></a>    in_degree_centrality <span class="op">=</span> nx.in_degree_centrality(G)  <span class="co"># How many nodes affect this one</span></span>
<span id="cb29-134"><a href="#cb29-134" aria-hidden="true" tabindex="-1"></a>    out_degree_centrality <span class="op">=</span> nx.out_degree_centrality(G)  <span class="co"># How many nodes this one affects</span></span>
<span id="cb29-135"><a href="#cb29-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-136"><a href="#cb29-136" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb29-137"><a href="#cb29-137" aria-hidden="true" tabindex="-1"></a>        betweenness_centrality <span class="op">=</span> nx.betweenness_centrality(G)  <span class="co"># Node's role as a connector</span></span>
<span id="cb29-138"><a href="#cb29-138" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span>:</span>
<span id="cb29-139"><a href="#cb29-139" aria-hidden="true" tabindex="-1"></a>        betweenness_centrality <span class="op">=</span> {node: <span class="dv">0</span> <span class="cf">for</span> node <span class="kw">in</span> G.nodes()}</span>
<span id="cb29-140"><a href="#cb29-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-141"><a href="#cb29-141" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add metrics to dataframe</span></span>
<span id="cb29-142"><a href="#cb29-142" aria-hidden="true" tabindex="-1"></a>    enhanced_df[<span class="st">'degree_centrality'</span>] <span class="op">=</span> <span class="va">None</span></span>
<span id="cb29-143"><a href="#cb29-143" aria-hidden="true" tabindex="-1"></a>    enhanced_df[<span class="st">'in_degree_centrality'</span>] <span class="op">=</span> <span class="va">None</span></span>
<span id="cb29-144"><a href="#cb29-144" aria-hidden="true" tabindex="-1"></a>    enhanced_df[<span class="st">'out_degree_centrality'</span>] <span class="op">=</span> <span class="va">None</span></span>
<span id="cb29-145"><a href="#cb29-145" aria-hidden="true" tabindex="-1"></a>    enhanced_df[<span class="st">'betweenness_centrality'</span>] <span class="op">=</span> <span class="va">None</span></span>
<span id="cb29-146"><a href="#cb29-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-147"><a href="#cb29-147" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> idx, row <span class="kw">in</span> enhanced_df.iterrows():</span>
<span id="cb29-148"><a href="#cb29-148" aria-hidden="true" tabindex="-1"></a>        title <span class="op">=</span> row[<span class="st">'Title'</span>]</span>
<span id="cb29-149"><a href="#cb29-149" aria-hidden="true" tabindex="-1"></a>        enhanced_df.at[idx, <span class="st">'degree_centrality'</span>] <span class="op">=</span> degree_centrality.get(title, <span class="dv">0</span>)</span>
<span id="cb29-150"><a href="#cb29-150" aria-hidden="true" tabindex="-1"></a>        enhanced_df.at[idx, <span class="st">'in_degree_centrality'</span>] <span class="op">=</span> in_degree_centrality.get(title, <span class="dv">0</span>)</span>
<span id="cb29-151"><a href="#cb29-151" aria-hidden="true" tabindex="-1"></a>        enhanced_df.at[idx, <span class="st">'out_degree_centrality'</span>] <span class="op">=</span> out_degree_centrality.get(title, <span class="dv">0</span>)</span>
<span id="cb29-152"><a href="#cb29-152" aria-hidden="true" tabindex="-1"></a>        enhanced_df.at[idx, <span class="st">'betweenness_centrality'</span>] <span class="op">=</span> betweenness_centrality.get(title, <span class="dv">0</span>)</span>
<span id="cb29-153"><a href="#cb29-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-154"><a href="#cb29-154" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 3. Add Markov blanket information (parents, children, and children's parents)</span></span>
<span id="cb29-155"><a href="#cb29-155" aria-hidden="true" tabindex="-1"></a>    enhanced_df[<span class="st">'markov_blanket'</span>] <span class="op">=</span> <span class="va">None</span></span>
<span id="cb29-156"><a href="#cb29-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-157"><a href="#cb29-157" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> idx, row <span class="kw">in</span> enhanced_df.iterrows():</span>
<span id="cb29-158"><a href="#cb29-158" aria-hidden="true" tabindex="-1"></a>        title <span class="op">=</span> row[<span class="st">'Title'</span>]</span>
<span id="cb29-159"><a href="#cb29-159" aria-hidden="true" tabindex="-1"></a>        parents <span class="op">=</span> row[<span class="st">'Parents'</span>] <span class="cf">if</span> <span class="bu">isinstance</span>(row[<span class="st">'Parents'</span>], <span class="bu">list</span>) <span class="cf">else</span> []</span>
<span id="cb29-160"><a href="#cb29-160" aria-hidden="true" tabindex="-1"></a>        children <span class="op">=</span> row[<span class="st">'Children'</span>] <span class="cf">if</span> <span class="bu">isinstance</span>(row[<span class="st">'Children'</span>], <span class="bu">list</span>) <span class="cf">else</span> []</span>
<span id="cb29-161"><a href="#cb29-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-162"><a href="#cb29-162" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get children's parents (excluding this node)</span></span>
<span id="cb29-163"><a href="#cb29-163" aria-hidden="true" tabindex="-1"></a>        childrens_parents <span class="op">=</span> []</span>
<span id="cb29-164"><a href="#cb29-164" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> child <span class="kw">in</span> children:</span>
<span id="cb29-165"><a href="#cb29-165" aria-hidden="true" tabindex="-1"></a>            child_row <span class="op">=</span> enhanced_df[enhanced_df[<span class="st">'Title'</span>] <span class="op">==</span> child]</span>
<span id="cb29-166"><a href="#cb29-166" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">not</span> child_row.empty:</span>
<span id="cb29-167"><a href="#cb29-167" aria-hidden="true" tabindex="-1"></a>                child_parents <span class="op">=</span> child_row.iloc[<span class="dv">0</span>][<span class="st">'Parents'</span>]</span>
<span id="cb29-168"><a href="#cb29-168" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="bu">isinstance</span>(child_parents, <span class="bu">list</span>):</span>
<span id="cb29-169"><a href="#cb29-169" aria-hidden="true" tabindex="-1"></a>                    childrens_parents.extend([p <span class="cf">for</span> p <span class="kw">in</span> child_parents <span class="cf">if</span> p <span class="op">!=</span> title])</span>
<span id="cb29-170"><a href="#cb29-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-171"><a href="#cb29-171" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Remove duplicates</span></span>
<span id="cb29-172"><a href="#cb29-172" aria-hidden="true" tabindex="-1"></a>        childrens_parents <span class="op">=</span> <span class="bu">list</span>(<span class="bu">set</span>(childrens_parents))</span>
<span id="cb29-173"><a href="#cb29-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-174"><a href="#cb29-174" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Combine to get Markov blanket</span></span>
<span id="cb29-175"><a href="#cb29-175" aria-hidden="true" tabindex="-1"></a>        markov_blanket <span class="op">=</span> <span class="bu">list</span>(<span class="bu">set</span>(parents <span class="op">+</span> children <span class="op">+</span> childrens_parents))</span>
<span id="cb29-176"><a href="#cb29-176" aria-hidden="true" tabindex="-1"></a>        enhanced_df.at[idx, <span class="st">'markov_blanket'</span>] <span class="op">=</span> markov_blanket</span>
<span id="cb29-177"><a href="#cb29-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-178"><a href="#cb29-178" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> enhanced_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># @title 3.3 --- Enhance Extracted Data with Network Metrics ---</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="co">BLOCK PURPOSE: Applies the post-processing functions to enhance the extracted data.</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a><span class="co">This block takes the basic extracted DataFrame from the BayesDown parsing step</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a><span class="co">and enriches it with calculated metrics that provide deeper insight into the</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a><span class="co">network structure and relationships. It:</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a><span class="co">1. Applies the enhancement functions defined previously</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a><span class="co">2. Displays summary information about key calculated metrics</span></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a><span class="co">3. Saves the enhanced data for further analysis and visualization</span></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a><span class="co">The enhanced DataFrame provides a richer representation of the Bayesian network,</span></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a><span class="co">including measures of node importance and conditional relationships that are</span></span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a><span class="co">essential for effective analysis and visualization.</span></span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a><span class="co">DEPENDENCIES: enhance_extracted_data function</span></span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a><span class="co">INPUTS: DataFrame with basic extracted BayesDown data</span></span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a><span class="co">OUTPUTS: Enhanced DataFrame with additional calculated columns, saved to CSV</span></span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Enhance the extracted dataframe with calculated columns</span></span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a>enhanced_df <span class="op">=</span> enhance_extracted_data(result_df)</span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the enhanced dataframe</span></span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Enhanced DataFrame with additional calculated columns:"</span>)</span>
<span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a>enhanced_df.head()</span>
<span id="cb30-29"><a href="#cb30-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-30"><a href="#cb30-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Check some calculated metrics</span></span>
<span id="cb30-31"><a href="#cb30-31" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Joint Probabilities Example:"</span>)</span>
<span id="cb30-32"><a href="#cb30-32" aria-hidden="true" tabindex="-1"></a>example_node <span class="op">=</span> enhanced_df.loc[<span class="dv">0</span>, <span class="st">'Title'</span>]</span>
<span id="cb30-33"><a href="#cb30-33" aria-hidden="true" tabindex="-1"></a>joint_probs <span class="op">=</span> enhanced_df.loc[<span class="dv">0</span>, <span class="st">'joint_probabilities'</span>]</span>
<span id="cb30-34"><a href="#cb30-34" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Joint probabilities for </span><span class="sc">{</span>example_node<span class="sc">}</span><span class="ss">:"</span>)</span>
<span id="cb30-35"><a href="#cb30-35" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(joint_probs)</span>
<span id="cb30-36"><a href="#cb30-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-37"><a href="#cb30-37" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Network Metrics:"</span>)</span>
<span id="cb30-38"><a href="#cb30-38" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> idx, row <span class="kw">in</span> enhanced_df.iterrows():</span>
<span id="cb30-39"><a href="#cb30-39" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>row[<span class="st">'Title'</span>]<span class="sc">}</span><span class="ss">:"</span>)</span>
<span id="cb30-40"><a href="#cb30-40" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Degree Centrality: </span><span class="sc">{</span>row[<span class="st">'degree_centrality'</span>]<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb30-41"><a href="#cb30-41" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Betweenness Centrality: </span><span class="sc">{</span>row[<span class="st">'betweenness_centrality'</span>]<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb30-42"><a href="#cb30-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-43"><a href="#cb30-43" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the enhanced dataframe</span></span>
<span id="cb30-44"><a href="#cb30-44" aria-hidden="true" tabindex="-1"></a>enhanced_df.to_csv(<span class="st">'enhanced_extracted_data.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb30-45"><a href="#cb30-45" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Enhanced data saved to 'enhanced_extracted_data.csv'"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="download-and-save-finished-data-frame-as-.csv-file" class="level3">
<h3 class="anchored" data-anchor-id="download-and-save-finished-data-frame-as-.csv-file">3.4 Download and save finished data frame as .csv file</h3>
<div class="sourceCode" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># @title 3.4 --- Save Extracted Data for Further Processing ---</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="co">BLOCK PURPOSE: Saves the extracted data to a CSV file for further processing.</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a><span class="co">This step is essential for:</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a><span class="co">1. Persisting the structured representation of the Bayesian network</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a><span class="co">2. Enabling further analysis in other tools or notebook sections</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a><span class="co">3. Creating a permanent record of the extraction results</span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a><span class="co">4. Making the data available for the visualization pipeline</span></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a><span class="co">The CSV format provides a standardized, tabular representation of the network</span></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a><span class="co">that can be easily loaded and processed in subsequent analysis steps.</span></span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a><span class="co">DEPENDENCIES: pandas DataFrame operations</span></span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a><span class="co">INPUTS: Extracted DataFrame from the parsing step</span></span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a><span class="co">OUTPUTS: CSV file containing the structured network data</span></span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the extracted data as a CSV file</span></span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a>result_df.to_csv(<span class="st">'extracted_data.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"✅ Extracted data saved successfully to 'extracted_data.csv'"</span>)</span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Note: If using updated data in future steps, the file must be pushed to the GitHub repository"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
</section>
<section id="analysis-inference-bayesian-network-visualization" class="level1">
<h1>4. Analysis &amp; Inference: Bayesian Network Visualization</h1>
<section id="bayesian-network-visualization-approach" class="level2">
<h2 class="anchored" data-anchor-id="bayesian-network-visualization-approach">Bayesian Network Visualization Approach</h2>
<p>This section implements the visualization component of the AMTAIR project, transforming the structured data extracted from BayesDown into an interactive network visualization that makes complex probabilistic relationships accessible to human understanding.</p>
<section id="visualization-philosophy" class="level3">
<h3 class="anchored" data-anchor-id="visualization-philosophy">Visualization Philosophy</h3>
<p>A key challenge in AI governance is making complex probabilistic relationships understandable to diverse stakeholders. This visualization system addresses this challenge through:</p>
<ol type="1">
<li><strong>Visual Encoding of Probability</strong>: Node colors reflect probability values (green for high probability, red for low)</li>
<li><strong>Structural Classification</strong>: Border colors indicate node types (blue for root causes, purple for intermediate nodes, magenta for leaf nodes)</li>
<li><strong>Progressive Disclosure</strong>: Basic information in tooltips, detailed probability tables in modal popups</li>
<li><strong>Interactive Exploration</strong>: Draggable nodes, configurable physics, click interactions</li>
</ol>
</section>
<section id="connection-to-amtair-goals" class="level3">
<h3 class="anchored" data-anchor-id="connection-to-amtair-goals">Connection to AMTAIR Goals</h3>
<p>This visualization approach directly supports the AMTAIR project’s goal of improving coordination in AI governance by:</p>
<ol type="1">
<li>Making implicit models explicit through visual representation</li>
<li>Providing a common language for discussing probabilistic relationships</li>
<li>Enabling non-technical stakeholders to engage with formal models</li>
<li>Creating shareable artifacts that facilitate collaboration</li>
</ol>
</section>
<section id="implementation-structure" class="level3">
<h3 class="anchored" data-anchor-id="implementation-structure">Implementation Structure</h3>
<p>The visualization system is implemented in four phases:</p>
<ol type="1">
<li><strong>Network Construction</strong>: Creating a directed graph representation using NetworkX</li>
<li><strong>Node Classification</strong>: Identifying node types based on network position</li>
<li><strong>Visual Enhancement</strong>: Adding color coding, tooltips, and interactive elements</li>
<li><strong>Interactive Features</strong>: Implementing click handling for detailed exploration</li>
</ol>
<p>The resulting visualization serves as both an analytical tool for experts and a communication tool for broader audiences, bridging the gap between technical and policy domains in AI governance discussions.</p>
</section>
</section>
<section id="phase-1-dependenciesfunctions" class="level2">
<h2 class="anchored" data-anchor-id="phase-1-dependenciesfunctions">Phase 1: Dependencies/Functions</h2>
<div class="sourceCode" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># @title 4.0 --- Bayesian Network Visualization Functions ---</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="co">BLOCK PURPOSE: Provides functions to create interactive Bayesian network visualizations</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="co">from DataFrame representations of ArgDown/BayesDown data.</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a><span class="co">This block implements the visualization pipeline described in the AMTAIR project, transforming</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a><span class="co">the structured DataFrame extracted from ArgDown/BayesDown into an interactive network graph</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a><span class="co">that displays nodes, relationships, and probability information. The visualization leverages</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a><span class="co">NetworkX for graph representation and PyVis for interactive display.</span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a><span class="co">Key visualization features:</span></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a><span class="co">1. Color-coding of nodes based on probability values</span></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a><span class="co">2. Border styling to indicate node types (root, intermediate, leaf)</span></span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a><span class="co">3. Interactive tooltips with probability information</span></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a><span class="co">4. Modal popups with detailed conditional probability tables</span></span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a><span class="co">5. Physics-based layout for intuitive exploration</span></span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a><span class="co">DEPENDENCIES: networkx, pyvis, HTML display from IPython</span></span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a><span class="co">INPUTS: DataFrame with node information, relationships, and probabilities</span></span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a><span class="co">OUTPUTS: Interactive HTML visualization of the Bayesian network</span></span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyvis.network <span class="im">import</span> Network</span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> networkx <span class="im">as</span> nx</span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> IPython.display <span class="im">import</span> HTML</span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb32-29"><a href="#cb32-29" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb32-30"><a href="#cb32-30" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> io</span>
<span id="cb32-31"><a href="#cb32-31" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> base64</span>
<span id="cb32-32"><a href="#cb32-32" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> colorsys</span>
<span id="cb32-33"><a href="#cb32-33" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb32-34"><a href="#cb32-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-35"><a href="#cb32-35" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_bayesian_network_with_probabilities(df):</span>
<span id="cb32-36"><a href="#cb32-36" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb32-37"><a href="#cb32-37" aria-hidden="true" tabindex="-1"></a><span class="co">    Create an interactive Bayesian network visualization with enhanced probability visualization</span></span>
<span id="cb32-38"><a href="#cb32-38" aria-hidden="true" tabindex="-1"></a><span class="co">    and node classification based on network structure.</span></span>
<span id="cb32-39"><a href="#cb32-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-40"><a href="#cb32-40" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb32-41"><a href="#cb32-41" aria-hidden="true" tabindex="-1"></a><span class="co">        df (pandas.DataFrame): DataFrame containing node information, relationships, and probabilities</span></span>
<span id="cb32-42"><a href="#cb32-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-43"><a href="#cb32-43" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb32-44"><a href="#cb32-44" aria-hidden="true" tabindex="-1"></a><span class="co">        IPython.display.HTML: Interactive HTML visualization of the Bayesian network</span></span>
<span id="cb32-45"><a href="#cb32-45" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb32-46"><a href="#cb32-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># PHASE 1: Create a directed graph representation</span></span>
<span id="cb32-47"><a href="#cb32-47" aria-hidden="true" tabindex="-1"></a>    G <span class="op">=</span> nx.DiGraph()</span>
<span id="cb32-48"><a href="#cb32-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-49"><a href="#cb32-49" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add nodes with proper attributes</span></span>
<span id="cb32-50"><a href="#cb32-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> idx, row <span class="kw">in</span> df.iterrows():</span>
<span id="cb32-51"><a href="#cb32-51" aria-hidden="true" tabindex="-1"></a>        title <span class="op">=</span> row[<span class="st">'Title'</span>]</span>
<span id="cb32-52"><a href="#cb32-52" aria-hidden="true" tabindex="-1"></a>        description <span class="op">=</span> row[<span class="st">'Description'</span>]</span>
<span id="cb32-53"><a href="#cb32-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-54"><a href="#cb32-54" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Process probability information</span></span>
<span id="cb32-55"><a href="#cb32-55" aria-hidden="true" tabindex="-1"></a>        priors <span class="op">=</span> get_priors(row)</span>
<span id="cb32-56"><a href="#cb32-56" aria-hidden="true" tabindex="-1"></a>        instantiations <span class="op">=</span> get_instantiations(row)</span>
<span id="cb32-57"><a href="#cb32-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-58"><a href="#cb32-58" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add node with base information</span></span>
<span id="cb32-59"><a href="#cb32-59" aria-hidden="true" tabindex="-1"></a>        G.add_node(</span>
<span id="cb32-60"><a href="#cb32-60" aria-hidden="true" tabindex="-1"></a>            title,</span>
<span id="cb32-61"><a href="#cb32-61" aria-hidden="true" tabindex="-1"></a>            description<span class="op">=</span>description,</span>
<span id="cb32-62"><a href="#cb32-62" aria-hidden="true" tabindex="-1"></a>            priors<span class="op">=</span>priors,</span>
<span id="cb32-63"><a href="#cb32-63" aria-hidden="true" tabindex="-1"></a>            instantiations<span class="op">=</span>instantiations,</span>
<span id="cb32-64"><a href="#cb32-64" aria-hidden="true" tabindex="-1"></a>            posteriors<span class="op">=</span>get_posteriors(row)</span>
<span id="cb32-65"><a href="#cb32-65" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb32-66"><a href="#cb32-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-67"><a href="#cb32-67" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add edges based on parent-child relationships</span></span>
<span id="cb32-68"><a href="#cb32-68" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> idx, row <span class="kw">in</span> df.iterrows():</span>
<span id="cb32-69"><a href="#cb32-69" aria-hidden="true" tabindex="-1"></a>        child <span class="op">=</span> row[<span class="st">'Title'</span>]</span>
<span id="cb32-70"><a href="#cb32-70" aria-hidden="true" tabindex="-1"></a>        parents <span class="op">=</span> get_parents(row)</span>
<span id="cb32-71"><a href="#cb32-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-72"><a href="#cb32-72" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add edges from each parent to this child</span></span>
<span id="cb32-73"><a href="#cb32-73" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> parent <span class="kw">in</span> parents:</span>
<span id="cb32-74"><a href="#cb32-74" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> parent <span class="kw">in</span> G.nodes():</span>
<span id="cb32-75"><a href="#cb32-75" aria-hidden="true" tabindex="-1"></a>                G.add_edge(parent, child)</span>
<span id="cb32-76"><a href="#cb32-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-77"><a href="#cb32-77" aria-hidden="true" tabindex="-1"></a>    <span class="co"># PHASE 2: Classify nodes based on network structure</span></span>
<span id="cb32-78"><a href="#cb32-78" aria-hidden="true" tabindex="-1"></a>    classify_nodes(G)</span>
<span id="cb32-79"><a href="#cb32-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-80"><a href="#cb32-80" aria-hidden="true" tabindex="-1"></a>    <span class="co"># PHASE 3: Create interactive network visualization</span></span>
<span id="cb32-81"><a href="#cb32-81" aria-hidden="true" tabindex="-1"></a>    net <span class="op">=</span> Network(notebook<span class="op">=</span><span class="va">True</span>, directed<span class="op">=</span><span class="va">True</span>, cdn_resources<span class="op">=</span><span class="st">"in_line"</span>, height<span class="op">=</span><span class="st">"600px"</span>, width<span class="op">=</span><span class="st">"100%"</span>)</span>
<span id="cb32-82"><a href="#cb32-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-83"><a href="#cb32-83" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Configure physics for better layout</span></span>
<span id="cb32-84"><a href="#cb32-84" aria-hidden="true" tabindex="-1"></a>    net.force_atlas_2based(gravity<span class="op">=-</span><span class="dv">50</span>, spring_length<span class="op">=</span><span class="dv">100</span>, spring_strength<span class="op">=</span><span class="fl">0.02</span>)</span>
<span id="cb32-85"><a href="#cb32-85" aria-hidden="true" tabindex="-1"></a>    net.show_buttons(filter_<span class="op">=</span>[<span class="st">'physics'</span>])  <span class="co"># Allow user to adjust physics settings</span></span>
<span id="cb32-86"><a href="#cb32-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-87"><a href="#cb32-87" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add the graph to the network</span></span>
<span id="cb32-88"><a href="#cb32-88" aria-hidden="true" tabindex="-1"></a>    net.from_nx(G)</span>
<span id="cb32-89"><a href="#cb32-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-90"><a href="#cb32-90" aria-hidden="true" tabindex="-1"></a>    <span class="co"># PHASE 4: Enhance node appearance with probability information</span></span>
<span id="cb32-91"><a href="#cb32-91" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> node <span class="kw">in</span> net.nodes:</span>
<span id="cb32-92"><a href="#cb32-92" aria-hidden="true" tabindex="-1"></a>        node_id <span class="op">=</span> node[<span class="st">'id'</span>]</span>
<span id="cb32-93"><a href="#cb32-93" aria-hidden="true" tabindex="-1"></a>        node_data <span class="op">=</span> G.nodes[node_id]</span>
<span id="cb32-94"><a href="#cb32-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-95"><a href="#cb32-95" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get node type and set border color</span></span>
<span id="cb32-96"><a href="#cb32-96" aria-hidden="true" tabindex="-1"></a>        node_type <span class="op">=</span> node_data.get(<span class="st">'node_type'</span>, <span class="st">'unknown'</span>)</span>
<span id="cb32-97"><a href="#cb32-97" aria-hidden="true" tabindex="-1"></a>        border_color <span class="op">=</span> get_border_color(node_type)</span>
<span id="cb32-98"><a href="#cb32-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-99"><a href="#cb32-99" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get probability information</span></span>
<span id="cb32-100"><a href="#cb32-100" aria-hidden="true" tabindex="-1"></a>        priors <span class="op">=</span> node_data.get(<span class="st">'priors'</span>, {})</span>
<span id="cb32-101"><a href="#cb32-101" aria-hidden="true" tabindex="-1"></a>        true_prob <span class="op">=</span> priors.get(<span class="st">'true_prob'</span>, <span class="fl">0.5</span>) <span class="cf">if</span> priors <span class="cf">else</span> <span class="fl">0.5</span></span>
<span id="cb32-102"><a href="#cb32-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-103"><a href="#cb32-103" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get proper state names</span></span>
<span id="cb32-104"><a href="#cb32-104" aria-hidden="true" tabindex="-1"></a>        instantiations <span class="op">=</span> node_data.get(<span class="st">'instantiations'</span>, [<span class="st">"TRUE"</span>, <span class="st">"FALSE"</span>])</span>
<span id="cb32-105"><a href="#cb32-105" aria-hidden="true" tabindex="-1"></a>        true_state <span class="op">=</span> instantiations[<span class="dv">0</span>] <span class="cf">if</span> <span class="bu">len</span>(instantiations) <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="st">"TRUE"</span></span>
<span id="cb32-106"><a href="#cb32-106" aria-hidden="true" tabindex="-1"></a>        false_state <span class="op">=</span> instantiations[<span class="dv">1</span>] <span class="cf">if</span> <span class="bu">len</span>(instantiations) <span class="op">&gt;</span> <span class="dv">1</span> <span class="cf">else</span> <span class="st">"FALSE"</span></span>
<span id="cb32-107"><a href="#cb32-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-108"><a href="#cb32-108" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create background color based on probability</span></span>
<span id="cb32-109"><a href="#cb32-109" aria-hidden="true" tabindex="-1"></a>        background_color <span class="op">=</span> get_probability_color(priors)</span>
<span id="cb32-110"><a href="#cb32-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-111"><a href="#cb32-111" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create tooltip with probability information</span></span>
<span id="cb32-112"><a href="#cb32-112" aria-hidden="true" tabindex="-1"></a>        tooltip <span class="op">=</span> create_tooltip(node_id, node_data)</span>
<span id="cb32-113"><a href="#cb32-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-114"><a href="#cb32-114" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create a simpler node label with probability</span></span>
<span id="cb32-115"><a href="#cb32-115" aria-hidden="true" tabindex="-1"></a>        simple_label <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>node_id<span class="sc">}</span><span class="ch">\n</span><span class="ss">p=</span><span class="sc">{</span>true_prob<span class="sc">:.2f}</span><span class="ss">"</span></span>
<span id="cb32-116"><a href="#cb32-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-117"><a href="#cb32-117" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Store expanded content as a node attribute for use in click handler</span></span>
<span id="cb32-118"><a href="#cb32-118" aria-hidden="true" tabindex="-1"></a>        node_data[<span class="st">'expanded_content'</span>] <span class="op">=</span> create_expanded_content(node_id, node_data)</span>
<span id="cb32-119"><a href="#cb32-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-120"><a href="#cb32-120" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Set node attributes</span></span>
<span id="cb32-121"><a href="#cb32-121" aria-hidden="true" tabindex="-1"></a>        node[<span class="st">'title'</span>] <span class="op">=</span> tooltip  <span class="co"># Tooltip HTML</span></span>
<span id="cb32-122"><a href="#cb32-122" aria-hidden="true" tabindex="-1"></a>        node[<span class="st">'label'</span>] <span class="op">=</span> simple_label  <span class="co"># Simple text label</span></span>
<span id="cb32-123"><a href="#cb32-123" aria-hidden="true" tabindex="-1"></a>        node[<span class="st">'shape'</span>] <span class="op">=</span> <span class="st">'box'</span></span>
<span id="cb32-124"><a href="#cb32-124" aria-hidden="true" tabindex="-1"></a>        node[<span class="st">'color'</span>] <span class="op">=</span> {</span>
<span id="cb32-125"><a href="#cb32-125" aria-hidden="true" tabindex="-1"></a>            <span class="st">'background'</span>: background_color,</span>
<span id="cb32-126"><a href="#cb32-126" aria-hidden="true" tabindex="-1"></a>            <span class="st">'border'</span>: border_color,</span>
<span id="cb32-127"><a href="#cb32-127" aria-hidden="true" tabindex="-1"></a>            <span class="st">'highlight'</span>: {</span>
<span id="cb32-128"><a href="#cb32-128" aria-hidden="true" tabindex="-1"></a>                <span class="st">'background'</span>: background_color,</span>
<span id="cb32-129"><a href="#cb32-129" aria-hidden="true" tabindex="-1"></a>                <span class="st">'border'</span>: border_color</span>
<span id="cb32-130"><a href="#cb32-130" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb32-131"><a href="#cb32-131" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb32-132"><a href="#cb32-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-133"><a href="#cb32-133" aria-hidden="true" tabindex="-1"></a>    <span class="co"># PHASE 5: Setup interactive click handling</span></span>
<span id="cb32-134"><a href="#cb32-134" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Prepare data for click handler</span></span>
<span id="cb32-135"><a href="#cb32-135" aria-hidden="true" tabindex="-1"></a>    setup_data <span class="op">=</span> {</span>
<span id="cb32-136"><a href="#cb32-136" aria-hidden="true" tabindex="-1"></a>        <span class="st">'nodes_data'</span>: {node_id: {</span>
<span id="cb32-137"><a href="#cb32-137" aria-hidden="true" tabindex="-1"></a>            <span class="st">'expanded_content'</span>: json.dumps(G.nodes[node_id].get(<span class="st">'expanded_content'</span>, <span class="st">''</span>)),</span>
<span id="cb32-138"><a href="#cb32-138" aria-hidden="true" tabindex="-1"></a>            <span class="st">'description'</span>: G.nodes[node_id].get(<span class="st">'description'</span>, <span class="st">''</span>),</span>
<span id="cb32-139"><a href="#cb32-139" aria-hidden="true" tabindex="-1"></a>            <span class="st">'priors'</span>: G.nodes[node_id].get(<span class="st">'priors'</span>, {}),</span>
<span id="cb32-140"><a href="#cb32-140" aria-hidden="true" tabindex="-1"></a>            <span class="st">'posteriors'</span>: G.nodes[node_id].get(<span class="st">'posteriors'</span>, {})</span>
<span id="cb32-141"><a href="#cb32-141" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">for</span> node_id <span class="kw">in</span> G.nodes()}</span>
<span id="cb32-142"><a href="#cb32-142" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb32-143"><a href="#cb32-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-144"><a href="#cb32-144" aria-hidden="true" tabindex="-1"></a>    <span class="co"># JavaScript code for handling node clicks</span></span>
<span id="cb32-145"><a href="#cb32-145" aria-hidden="true" tabindex="-1"></a>    click_js <span class="op">=</span> <span class="st">"""</span></span>
<span id="cb32-146"><a href="#cb32-146" aria-hidden="true" tabindex="-1"></a><span class="st">    // Store node data for click handling</span></span>
<span id="cb32-147"><a href="#cb32-147" aria-hidden="true" tabindex="-1"></a><span class="st">    var nodesData = </span><span class="sc">%s</span><span class="st">;</span></span>
<span id="cb32-148"><a href="#cb32-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-149"><a href="#cb32-149" aria-hidden="true" tabindex="-1"></a><span class="st">    // Add event listener for node clicks</span></span>
<span id="cb32-150"><a href="#cb32-150" aria-hidden="true" tabindex="-1"></a><span class="st">    network.on("click", function(params) {</span></span>
<span id="cb32-151"><a href="#cb32-151" aria-hidden="true" tabindex="-1"></a><span class="st">        if (params.nodes.length &gt; 0) {</span></span>
<span id="cb32-152"><a href="#cb32-152" aria-hidden="true" tabindex="-1"></a><span class="st">            var nodeId = params.nodes[0];</span></span>
<span id="cb32-153"><a href="#cb32-153" aria-hidden="true" tabindex="-1"></a><span class="st">            var nodeInfo = nodesData[nodeId];</span></span>
<span id="cb32-154"><a href="#cb32-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-155"><a href="#cb32-155" aria-hidden="true" tabindex="-1"></a><span class="st">            if (nodeInfo) {</span></span>
<span id="cb32-156"><a href="#cb32-156" aria-hidden="true" tabindex="-1"></a><span class="st">                // Create a modal popup for expanded content</span></span>
<span id="cb32-157"><a href="#cb32-157" aria-hidden="true" tabindex="-1"></a><span class="st">                var modal = document.createElement('div');</span></span>
<span id="cb32-158"><a href="#cb32-158" aria-hidden="true" tabindex="-1"></a><span class="st">                modal.style.position = 'fixed';</span></span>
<span id="cb32-159"><a href="#cb32-159" aria-hidden="true" tabindex="-1"></a><span class="st">                modal.style.left = '50</span><span class="sc">%%</span><span class="st">';</span></span>
<span id="cb32-160"><a href="#cb32-160" aria-hidden="true" tabindex="-1"></a><span class="st">                modal.style.top = '50</span><span class="sc">%%</span><span class="st">';</span></span>
<span id="cb32-161"><a href="#cb32-161" aria-hidden="true" tabindex="-1"></a><span class="st">                modal.style.transform = 'translate(-50</span><span class="sc">%%</span><span class="st">, -50</span><span class="sc">%%</span><span class="st">)';</span></span>
<span id="cb32-162"><a href="#cb32-162" aria-hidden="true" tabindex="-1"></a><span class="st">                modal.style.backgroundColor = 'white';</span></span>
<span id="cb32-163"><a href="#cb32-163" aria-hidden="true" tabindex="-1"></a><span class="st">                modal.style.padding = '20px';</span></span>
<span id="cb32-164"><a href="#cb32-164" aria-hidden="true" tabindex="-1"></a><span class="st">                modal.style.borderRadius = '5px';</span></span>
<span id="cb32-165"><a href="#cb32-165" aria-hidden="true" tabindex="-1"></a><span class="st">                modal.style.boxShadow = '0 0 10px rgba(0,0,0,0.5)';</span></span>
<span id="cb32-166"><a href="#cb32-166" aria-hidden="true" tabindex="-1"></a><span class="st">                modal.style.zIndex = '1000';</span></span>
<span id="cb32-167"><a href="#cb32-167" aria-hidden="true" tabindex="-1"></a><span class="st">                modal.style.maxWidth = '80</span><span class="sc">%%</span><span class="st">';</span></span>
<span id="cb32-168"><a href="#cb32-168" aria-hidden="true" tabindex="-1"></a><span class="st">                modal.style.maxHeight = '80</span><span class="sc">%%</span><span class="st">';</span></span>
<span id="cb32-169"><a href="#cb32-169" aria-hidden="true" tabindex="-1"></a><span class="st">                modal.style.overflow = 'auto';</span></span>
<span id="cb32-170"><a href="#cb32-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-171"><a href="#cb32-171" aria-hidden="true" tabindex="-1"></a><span class="st">                // Add expanded content</span></span>
<span id="cb32-172"><a href="#cb32-172" aria-hidden="true" tabindex="-1"></a><span class="st">                modal.innerHTML = nodeInfo.expanded_content || 'No detailed information available';</span></span>
<span id="cb32-173"><a href="#cb32-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-174"><a href="#cb32-174" aria-hidden="true" tabindex="-1"></a><span class="st">                // Add close button</span></span>
<span id="cb32-175"><a href="#cb32-175" aria-hidden="true" tabindex="-1"></a><span class="st">                var closeBtn = document.createElement('button');</span></span>
<span id="cb32-176"><a href="#cb32-176" aria-hidden="true" tabindex="-1"></a><span class="st">                closeBtn.innerHTML = 'Close';</span></span>
<span id="cb32-177"><a href="#cb32-177" aria-hidden="true" tabindex="-1"></a><span class="st">                closeBtn.style.marginTop = '10px';</span></span>
<span id="cb32-178"><a href="#cb32-178" aria-hidden="true" tabindex="-1"></a><span class="st">                closeBtn.style.padding = '5px 10px';</span></span>
<span id="cb32-179"><a href="#cb32-179" aria-hidden="true" tabindex="-1"></a><span class="st">                closeBtn.style.cursor = 'pointer';</span></span>
<span id="cb32-180"><a href="#cb32-180" aria-hidden="true" tabindex="-1"></a><span class="st">                closeBtn.onclick = function() {</span></span>
<span id="cb32-181"><a href="#cb32-181" aria-hidden="true" tabindex="-1"></a><span class="st">                    document.body.removeChild(modal);</span></span>
<span id="cb32-182"><a href="#cb32-182" aria-hidden="true" tabindex="-1"></a><span class="st">                };</span></span>
<span id="cb32-183"><a href="#cb32-183" aria-hidden="true" tabindex="-1"></a><span class="st">                modal.appendChild(closeBtn);</span></span>
<span id="cb32-184"><a href="#cb32-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-185"><a href="#cb32-185" aria-hidden="true" tabindex="-1"></a><span class="st">                // Add modal to body</span></span>
<span id="cb32-186"><a href="#cb32-186" aria-hidden="true" tabindex="-1"></a><span class="st">                document.body.appendChild(modal);</span></span>
<span id="cb32-187"><a href="#cb32-187" aria-hidden="true" tabindex="-1"></a><span class="st">            }</span></span>
<span id="cb32-188"><a href="#cb32-188" aria-hidden="true" tabindex="-1"></a><span class="st">        }</span></span>
<span id="cb32-189"><a href="#cb32-189" aria-hidden="true" tabindex="-1"></a><span class="st">    });</span></span>
<span id="cb32-190"><a href="#cb32-190" aria-hidden="true" tabindex="-1"></a><span class="st">    """</span> <span class="op">%</span> json.dumps(setup_data[<span class="st">'nodes_data'</span>])</span>
<span id="cb32-191"><a href="#cb32-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-192"><a href="#cb32-192" aria-hidden="true" tabindex="-1"></a>    <span class="co"># PHASE 6: Save the graph to HTML and inject custom click handling</span></span>
<span id="cb32-193"><a href="#cb32-193" aria-hidden="true" tabindex="-1"></a>    html_file <span class="op">=</span> <span class="st">"bayesian_network.html"</span></span>
<span id="cb32-194"><a href="#cb32-194" aria-hidden="true" tabindex="-1"></a>    net.save_graph(html_file)</span>
<span id="cb32-195"><a href="#cb32-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-196"><a href="#cb32-196" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Inject custom click handling into HTML</span></span>
<span id="cb32-197"><a href="#cb32-197" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb32-198"><a href="#cb32-198" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> <span class="bu">open</span>(html_file, <span class="st">"r"</span>) <span class="im">as</span> f:</span>
<span id="cb32-199"><a href="#cb32-199" aria-hidden="true" tabindex="-1"></a>            html_content <span class="op">=</span> f.read()</span>
<span id="cb32-200"><a href="#cb32-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-201"><a href="#cb32-201" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Insert click handling script before the closing body tag</span></span>
<span id="cb32-202"><a href="#cb32-202" aria-hidden="true" tabindex="-1"></a>        html_content <span class="op">=</span> html_content.replace(<span class="st">'&lt;/body&gt;'</span>, <span class="ss">f'&lt;script&gt;</span><span class="sc">{</span>click_js<span class="sc">}</span><span class="ss">&lt;/script&gt;&lt;/body&gt;'</span>)</span>
<span id="cb32-203"><a href="#cb32-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-204"><a href="#cb32-204" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Write back the modified HTML</span></span>
<span id="cb32-205"><a href="#cb32-205" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> <span class="bu">open</span>(html_file, <span class="st">"w"</span>) <span class="im">as</span> f:</span>
<span id="cb32-206"><a href="#cb32-206" aria-hidden="true" tabindex="-1"></a>            f.write(html_content)</span>
<span id="cb32-207"><a href="#cb32-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-208"><a href="#cb32-208" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> HTML(html_content)</span>
<span id="cb32-209"><a href="#cb32-209" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb32-210"><a href="#cb32-210" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> HTML(<span class="ss">f"&lt;p&gt;Error rendering HTML: </span><span class="sc">{</span><span class="bu">str</span>(e)<span class="sc">}</span><span class="ss">&lt;/p&gt;&lt;p&gt;The network visualization has been saved to '</span><span class="sc">{</span>html_file<span class="sc">}</span><span class="ss">'&lt;/p&gt;"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="phase-2-node-classification-and-styling-module" class="level2">
<h2 class="anchored" data-anchor-id="phase-2-node-classification-and-styling-module">Phase 2: Node Classification and Styling Module</h2>
<div class="sourceCode" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># @title 4.1 --- Node Classification and Styling Functions ---</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="co">BLOCK PURPOSE: Implements the visual classification and styling of nodes in the Bayesian network.</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a><span class="co">This module handles the identification of node types based on their position in the network</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a><span class="co">and provides appropriate visual styling for each type. The functions:</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a><span class="co">1. Classify nodes as parents (causes), children (intermediate effects), or leaves (final effects)</span></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a><span class="co">2. Assign appropriate border colors to visually distinguish node types</span></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a><span class="co">3. Calculate background colors based on probability values</span></span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a><span class="co">4. Extract relevant information from DataFrame rows in a robust manner</span></span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a><span class="co">The visual encoding helps users understand both the structure of the network</span></span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a><span class="co">and the probability distributions at a glance.</span></span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a><span class="co">DEPENDENCIES: colorsys for color manipulation</span></span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a><span class="co">INPUTS: Graph structure and node data</span></span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a><span class="co">OUTPUTS: Classification and styling information for visualization</span></span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> classify_nodes(G):</span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a><span class="co">    Classify nodes as parent, child, or leaf based on network structure</span></span>
<span id="cb33-25"><a href="#cb33-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-26"><a href="#cb33-26" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb33-27"><a href="#cb33-27" aria-hidden="true" tabindex="-1"></a><span class="co">        G (networkx.DiGraph): Directed graph representation of the Bayesian network</span></span>
<span id="cb33-28"><a href="#cb33-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-29"><a href="#cb33-29" aria-hidden="true" tabindex="-1"></a><span class="co">    Effects:</span></span>
<span id="cb33-30"><a href="#cb33-30" aria-hidden="true" tabindex="-1"></a><span class="co">        Adds 'node_type' attribute to each node in the graph:</span></span>
<span id="cb33-31"><a href="#cb33-31" aria-hidden="true" tabindex="-1"></a><span class="co">        - 'parent': Root node with no parents but has children (causal source)</span></span>
<span id="cb33-32"><a href="#cb33-32" aria-hidden="true" tabindex="-1"></a><span class="co">        - 'child': Node with both parents and children (intermediate)</span></span>
<span id="cb33-33"><a href="#cb33-33" aria-hidden="true" tabindex="-1"></a><span class="co">        - 'leaf': Node with parents but no children (final effect)</span></span>
<span id="cb33-34"><a href="#cb33-34" aria-hidden="true" tabindex="-1"></a><span class="co">        - 'isolated': Node with no connections (rare in Bayesian networks)</span></span>
<span id="cb33-35"><a href="#cb33-35" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb33-36"><a href="#cb33-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> node <span class="kw">in</span> G.nodes():</span>
<span id="cb33-37"><a href="#cb33-37" aria-hidden="true" tabindex="-1"></a>        predecessors <span class="op">=</span> <span class="bu">list</span>(G.predecessors(node))  <span class="co"># Nodes pointing to this one (causes)</span></span>
<span id="cb33-38"><a href="#cb33-38" aria-hidden="true" tabindex="-1"></a>        successors <span class="op">=</span> <span class="bu">list</span>(G.successors(node))      <span class="co"># Nodes this one points to (effects)</span></span>
<span id="cb33-39"><a href="#cb33-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-40"><a href="#cb33-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> predecessors:  <span class="co"># No parents</span></span>
<span id="cb33-41"><a href="#cb33-41" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> successors:  <span class="co"># Has children</span></span>
<span id="cb33-42"><a href="#cb33-42" aria-hidden="true" tabindex="-1"></a>                G.nodes[node][<span class="st">'node_type'</span>] <span class="op">=</span> <span class="st">'parent'</span>  <span class="co"># Root cause</span></span>
<span id="cb33-43"><a href="#cb33-43" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:  <span class="co"># No children either</span></span>
<span id="cb33-44"><a href="#cb33-44" aria-hidden="true" tabindex="-1"></a>                G.nodes[node][<span class="st">'node_type'</span>] <span class="op">=</span> <span class="st">'isolated'</span>  <span class="co"># Disconnected node</span></span>
<span id="cb33-45"><a href="#cb33-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:  <span class="co"># Has parents</span></span>
<span id="cb33-46"><a href="#cb33-46" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">not</span> successors:  <span class="co"># No children</span></span>
<span id="cb33-47"><a href="#cb33-47" aria-hidden="true" tabindex="-1"></a>                G.nodes[node][<span class="st">'node_type'</span>] <span class="op">=</span> <span class="st">'leaf'</span>  <span class="co"># Final effect</span></span>
<span id="cb33-48"><a href="#cb33-48" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:  <span class="co"># Has both parents and children</span></span>
<span id="cb33-49"><a href="#cb33-49" aria-hidden="true" tabindex="-1"></a>                G.nodes[node][<span class="st">'node_type'</span>] <span class="op">=</span> <span class="st">'child'</span>  <span class="co"># Intermediate node</span></span>
<span id="cb33-50"><a href="#cb33-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-51"><a href="#cb33-51" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_border_color(node_type):</span>
<span id="cb33-52"><a href="#cb33-52" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb33-53"><a href="#cb33-53" aria-hidden="true" tabindex="-1"></a><span class="co">    Return border color based on node type</span></span>
<span id="cb33-54"><a href="#cb33-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-55"><a href="#cb33-55" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb33-56"><a href="#cb33-56" aria-hidden="true" tabindex="-1"></a><span class="co">        node_type (str): Type of node ('parent', 'child', 'leaf', or 'isolated')</span></span>
<span id="cb33-57"><a href="#cb33-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-58"><a href="#cb33-58" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb33-59"><a href="#cb33-59" aria-hidden="true" tabindex="-1"></a><span class="co">        str: Hex color code for node border</span></span>
<span id="cb33-60"><a href="#cb33-60" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb33-61"><a href="#cb33-61" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> node_type <span class="op">==</span> <span class="st">'parent'</span>:</span>
<span id="cb33-62"><a href="#cb33-62" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">'#0000FF'</span>  <span class="co"># Blue for root causes</span></span>
<span id="cb33-63"><a href="#cb33-63" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> node_type <span class="op">==</span> <span class="st">'child'</span>:</span>
<span id="cb33-64"><a href="#cb33-64" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">'#800080'</span>  <span class="co"># Purple for intermediate nodes</span></span>
<span id="cb33-65"><a href="#cb33-65" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> node_type <span class="op">==</span> <span class="st">'leaf'</span>:</span>
<span id="cb33-66"><a href="#cb33-66" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">'#FF00FF'</span>  <span class="co"># Magenta for final effects</span></span>
<span id="cb33-67"><a href="#cb33-67" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb33-68"><a href="#cb33-68" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">'#000000'</span>  <span class="co"># Default black for any other type</span></span>
<span id="cb33-69"><a href="#cb33-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-70"><a href="#cb33-70" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_probability_color(priors):</span>
<span id="cb33-71"><a href="#cb33-71" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb33-72"><a href="#cb33-72" aria-hidden="true" tabindex="-1"></a><span class="co">    Create background color based on probability (red to green gradient)</span></span>
<span id="cb33-73"><a href="#cb33-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-74"><a href="#cb33-74" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb33-75"><a href="#cb33-75" aria-hidden="true" tabindex="-1"></a><span class="co">        priors (dict): Dictionary containing probability information</span></span>
<span id="cb33-76"><a href="#cb33-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-77"><a href="#cb33-77" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb33-78"><a href="#cb33-78" aria-hidden="true" tabindex="-1"></a><span class="co">        str: Hex color code for node background, ranging from red (low probability)</span></span>
<span id="cb33-79"><a href="#cb33-79" aria-hidden="true" tabindex="-1"></a><span class="co">             to green (high probability)</span></span>
<span id="cb33-80"><a href="#cb33-80" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb33-81"><a href="#cb33-81" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Default to neutral color if no probability</span></span>
<span id="cb33-82"><a href="#cb33-82" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> priors <span class="kw">or</span> <span class="st">'true_prob'</span> <span class="kw">not</span> <span class="kw">in</span> priors:</span>
<span id="cb33-83"><a href="#cb33-83" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">'#F8F8F8'</span>  <span class="co"># Light grey</span></span>
<span id="cb33-84"><a href="#cb33-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-85"><a href="#cb33-85" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get probability value</span></span>
<span id="cb33-86"><a href="#cb33-86" aria-hidden="true" tabindex="-1"></a>    prob <span class="op">=</span> priors[<span class="st">'true_prob'</span>]</span>
<span id="cb33-87"><a href="#cb33-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-88"><a href="#cb33-88" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create color gradient from red (0.0) to green (1.0)</span></span>
<span id="cb33-89"><a href="#cb33-89" aria-hidden="true" tabindex="-1"></a>    hue <span class="op">=</span> <span class="dv">120</span> <span class="op">*</span> prob  <span class="co"># 0 = red, 120 = green (in HSL color space)</span></span>
<span id="cb33-90"><a href="#cb33-90" aria-hidden="true" tabindex="-1"></a>    saturation <span class="op">=</span> <span class="fl">0.75</span></span>
<span id="cb33-91"><a href="#cb33-91" aria-hidden="true" tabindex="-1"></a>    lightness <span class="op">=</span> <span class="fl">0.8</span>  <span class="co"># Lighter color for better text visibility</span></span>
<span id="cb33-92"><a href="#cb33-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-93"><a href="#cb33-93" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert HSL to RGB</span></span>
<span id="cb33-94"><a href="#cb33-94" aria-hidden="true" tabindex="-1"></a>    r, g, b <span class="op">=</span> colorsys.hls_to_rgb(hue<span class="op">/</span><span class="dv">360</span>, lightness, saturation)</span>
<span id="cb33-95"><a href="#cb33-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-96"><a href="#cb33-96" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert to hex format</span></span>
<span id="cb33-97"><a href="#cb33-97" aria-hidden="true" tabindex="-1"></a>    hex_color <span class="op">=</span> <span class="st">"#</span><span class="sc">{:02x}{:02x}{:02x}</span><span class="st">"</span>.<span class="bu">format</span>(<span class="bu">int</span>(r<span class="op">*</span><span class="dv">255</span>), <span class="bu">int</span>(g<span class="op">*</span><span class="dv">255</span>), <span class="bu">int</span>(b<span class="op">*</span><span class="dv">255</span>))</span>
<span id="cb33-98"><a href="#cb33-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-99"><a href="#cb33-99" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> hex_color</span>
<span id="cb33-100"><a href="#cb33-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-101"><a href="#cb33-101" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_parents(row):</span>
<span id="cb33-102"><a href="#cb33-102" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb33-103"><a href="#cb33-103" aria-hidden="true" tabindex="-1"></a><span class="co">    Extract parent nodes from row data, with safe handling for different data types</span></span>
<span id="cb33-104"><a href="#cb33-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-105"><a href="#cb33-105" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb33-106"><a href="#cb33-106" aria-hidden="true" tabindex="-1"></a><span class="co">        row (pandas.Series): Row from DataFrame containing node information</span></span>
<span id="cb33-107"><a href="#cb33-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-108"><a href="#cb33-108" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb33-109"><a href="#cb33-109" aria-hidden="true" tabindex="-1"></a><span class="co">        list: List of parent node names</span></span>
<span id="cb33-110"><a href="#cb33-110" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb33-111"><a href="#cb33-111" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'Parents'</span> <span class="kw">not</span> <span class="kw">in</span> row:</span>
<span id="cb33-112"><a href="#cb33-112" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> []</span>
<span id="cb33-113"><a href="#cb33-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-114"><a href="#cb33-114" aria-hidden="true" tabindex="-1"></a>    parents_data <span class="op">=</span> row[<span class="st">'Parents'</span>]</span>
<span id="cb33-115"><a href="#cb33-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-116"><a href="#cb33-116" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Handle NaN, None, or empty list</span></span>
<span id="cb33-117"><a href="#cb33-117" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(parents_data, <span class="bu">float</span>) <span class="kw">and</span> pd.isna(parents_data):</span>
<span id="cb33-118"><a href="#cb33-118" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> []</span>
<span id="cb33-119"><a href="#cb33-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-120"><a href="#cb33-120" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> parents_data <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb33-121"><a href="#cb33-121" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> []</span>
<span id="cb33-122"><a href="#cb33-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-123"><a href="#cb33-123" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Handle different data types</span></span>
<span id="cb33-124"><a href="#cb33-124" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(parents_data, <span class="bu">list</span>):</span>
<span id="cb33-125"><a href="#cb33-125" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Return a list with NaN and empty strings removed</span></span>
<span id="cb33-126"><a href="#cb33-126" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> [p <span class="cf">for</span> p <span class="kw">in</span> parents_data <span class="cf">if</span> <span class="kw">not</span> (<span class="bu">isinstance</span>(p, <span class="bu">float</span>) <span class="kw">and</span> pd.isna(p)) <span class="kw">and</span> p <span class="op">!=</span> <span class="st">''</span>]</span>
<span id="cb33-127"><a href="#cb33-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-128"><a href="#cb33-128" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(parents_data, <span class="bu">str</span>):</span>
<span id="cb33-129"><a href="#cb33-129" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> parents_data.strip():</span>
<span id="cb33-130"><a href="#cb33-130" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> []</span>
<span id="cb33-131"><a href="#cb33-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-132"><a href="#cb33-132" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Remove brackets and split by comma, removing empty strings and NaN</span></span>
<span id="cb33-133"><a href="#cb33-133" aria-hidden="true" tabindex="-1"></a>        cleaned <span class="op">=</span> parents_data.strip(<span class="st">'[]"</span><span class="ch">\'</span><span class="st">'</span>)</span>
<span id="cb33-134"><a href="#cb33-134" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> cleaned:</span>
<span id="cb33-135"><a href="#cb33-135" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> []</span>
<span id="cb33-136"><a href="#cb33-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-137"><a href="#cb33-137" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> [p.strip(<span class="st">' "</span><span class="ch">\'</span><span class="st">'</span>) <span class="cf">for</span> p <span class="kw">in</span> cleaned.split(<span class="st">','</span>) <span class="cf">if</span> p.strip()]</span>
<span id="cb33-138"><a href="#cb33-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-139"><a href="#cb33-139" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Default: empty list</span></span>
<span id="cb33-140"><a href="#cb33-140" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> []</span>
<span id="cb33-141"><a href="#cb33-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-142"><a href="#cb33-142" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_instantiations(row):</span>
<span id="cb33-143"><a href="#cb33-143" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb33-144"><a href="#cb33-144" aria-hidden="true" tabindex="-1"></a><span class="co">    Extract instantiations with safe handling for different data types</span></span>
<span id="cb33-145"><a href="#cb33-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-146"><a href="#cb33-146" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb33-147"><a href="#cb33-147" aria-hidden="true" tabindex="-1"></a><span class="co">        row (pandas.Series): Row from DataFrame containing node information</span></span>
<span id="cb33-148"><a href="#cb33-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-149"><a href="#cb33-149" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb33-150"><a href="#cb33-150" aria-hidden="true" tabindex="-1"></a><span class="co">        list: List of possible instantiations (states) for the node</span></span>
<span id="cb33-151"><a href="#cb33-151" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb33-152"><a href="#cb33-152" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'instantiations'</span> <span class="kw">not</span> <span class="kw">in</span> row:</span>
<span id="cb33-153"><a href="#cb33-153" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> [<span class="st">"TRUE"</span>, <span class="st">"FALSE"</span>]</span>
<span id="cb33-154"><a href="#cb33-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-155"><a href="#cb33-155" aria-hidden="true" tabindex="-1"></a>    inst_data <span class="op">=</span> row[<span class="st">'instantiations'</span>]</span>
<span id="cb33-156"><a href="#cb33-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-157"><a href="#cb33-157" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Handle NaN or None</span></span>
<span id="cb33-158"><a href="#cb33-158" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(inst_data, <span class="bu">float</span>) <span class="kw">and</span> pd.isna(inst_data):</span>
<span id="cb33-159"><a href="#cb33-159" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> [<span class="st">"TRUE"</span>, <span class="st">"FALSE"</span>]</span>
<span id="cb33-160"><a href="#cb33-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-161"><a href="#cb33-161" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> inst_data <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb33-162"><a href="#cb33-162" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> [<span class="st">"TRUE"</span>, <span class="st">"FALSE"</span>]</span>
<span id="cb33-163"><a href="#cb33-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-164"><a href="#cb33-164" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Handle different data types</span></span>
<span id="cb33-165"><a href="#cb33-165" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(inst_data, <span class="bu">list</span>):</span>
<span id="cb33-166"><a href="#cb33-166" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> inst_data <span class="cf">if</span> inst_data <span class="cf">else</span> [<span class="st">"TRUE"</span>, <span class="st">"FALSE"</span>]</span>
<span id="cb33-167"><a href="#cb33-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-168"><a href="#cb33-168" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(inst_data, <span class="bu">str</span>):</span>
<span id="cb33-169"><a href="#cb33-169" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> inst_data.strip():</span>
<span id="cb33-170"><a href="#cb33-170" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> [<span class="st">"TRUE"</span>, <span class="st">"FALSE"</span>]</span>
<span id="cb33-171"><a href="#cb33-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-172"><a href="#cb33-172" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Remove brackets and split by comma</span></span>
<span id="cb33-173"><a href="#cb33-173" aria-hidden="true" tabindex="-1"></a>        cleaned <span class="op">=</span> inst_data.strip(<span class="st">'[]"</span><span class="ch">\'</span><span class="st">'</span>)</span>
<span id="cb33-174"><a href="#cb33-174" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> cleaned:</span>
<span id="cb33-175"><a href="#cb33-175" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> [<span class="st">"TRUE"</span>, <span class="st">"FALSE"</span>]</span>
<span id="cb33-176"><a href="#cb33-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-177"><a href="#cb33-177" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> [i.strip(<span class="st">' "</span><span class="ch">\'</span><span class="st">'</span>) <span class="cf">for</span> i <span class="kw">in</span> cleaned.split(<span class="st">','</span>) <span class="cf">if</span> i.strip()]</span>
<span id="cb33-178"><a href="#cb33-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-179"><a href="#cb33-179" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Default</span></span>
<span id="cb33-180"><a href="#cb33-180" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [<span class="st">"TRUE"</span>, <span class="st">"FALSE"</span>]</span>
<span id="cb33-181"><a href="#cb33-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-182"><a href="#cb33-182" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_priors(row):</span>
<span id="cb33-183"><a href="#cb33-183" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb33-184"><a href="#cb33-184" aria-hidden="true" tabindex="-1"></a><span class="co">    Extract prior probabilities with safe handling for different data types</span></span>
<span id="cb33-185"><a href="#cb33-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-186"><a href="#cb33-186" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb33-187"><a href="#cb33-187" aria-hidden="true" tabindex="-1"></a><span class="co">        row (pandas.Series): Row from DataFrame containing node information</span></span>
<span id="cb33-188"><a href="#cb33-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-189"><a href="#cb33-189" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb33-190"><a href="#cb33-190" aria-hidden="true" tabindex="-1"></a><span class="co">        dict: Dictionary of prior probabilities with 'true_prob' added for convenience</span></span>
<span id="cb33-191"><a href="#cb33-191" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb33-192"><a href="#cb33-192" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'priors'</span> <span class="kw">not</span> <span class="kw">in</span> row:</span>
<span id="cb33-193"><a href="#cb33-193" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {}</span>
<span id="cb33-194"><a href="#cb33-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-195"><a href="#cb33-195" aria-hidden="true" tabindex="-1"></a>    priors_data <span class="op">=</span> row[<span class="st">'priors'</span>]</span>
<span id="cb33-196"><a href="#cb33-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-197"><a href="#cb33-197" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Handle NaN or None</span></span>
<span id="cb33-198"><a href="#cb33-198" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(priors_data, <span class="bu">float</span>) <span class="kw">and</span> pd.isna(priors_data):</span>
<span id="cb33-199"><a href="#cb33-199" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {}</span>
<span id="cb33-200"><a href="#cb33-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-201"><a href="#cb33-201" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> priors_data <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb33-202"><a href="#cb33-202" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {}</span>
<span id="cb33-203"><a href="#cb33-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-204"><a href="#cb33-204" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> {}</span>
<span id="cb33-205"><a href="#cb33-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-206"><a href="#cb33-206" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Handle dictionary</span></span>
<span id="cb33-207"><a href="#cb33-207" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(priors_data, <span class="bu">dict</span>):</span>
<span id="cb33-208"><a href="#cb33-208" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> priors_data</span>
<span id="cb33-209"><a href="#cb33-209" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Handle string representation of dictionary</span></span>
<span id="cb33-210"><a href="#cb33-210" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="bu">isinstance</span>(priors_data, <span class="bu">str</span>):</span>
<span id="cb33-211"><a href="#cb33-211" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> priors_data.strip() <span class="kw">or</span> priors_data <span class="op">==</span> <span class="st">'</span><span class="sc">{}</span><span class="st">'</span>:</span>
<span id="cb33-212"><a href="#cb33-212" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> {}</span>
<span id="cb33-213"><a href="#cb33-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-214"><a href="#cb33-214" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb33-215"><a href="#cb33-215" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Try to evaluate as Python literal</span></span>
<span id="cb33-216"><a href="#cb33-216" aria-hidden="true" tabindex="-1"></a>            <span class="im">import</span> ast</span>
<span id="cb33-217"><a href="#cb33-217" aria-hidden="true" tabindex="-1"></a>            result <span class="op">=</span> ast.literal_eval(priors_data)</span>
<span id="cb33-218"><a href="#cb33-218" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span>:</span>
<span id="cb33-219"><a href="#cb33-219" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Simple parsing for items like {'p(TRUE)': '0.2', 'p(FALSE)': '0.8'}</span></span>
<span id="cb33-220"><a href="#cb33-220" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="st">'{'</span> <span class="kw">in</span> priors_data <span class="kw">and</span> <span class="st">'}'</span> <span class="kw">in</span> priors_data:</span>
<span id="cb33-221"><a href="#cb33-221" aria-hidden="true" tabindex="-1"></a>                content <span class="op">=</span> priors_data[priors_data.find(<span class="st">'{'</span>)<span class="op">+</span><span class="dv">1</span>:priors_data.rfind(<span class="st">'}'</span>)]</span>
<span id="cb33-222"><a href="#cb33-222" aria-hidden="true" tabindex="-1"></a>                items <span class="op">=</span> [item.strip() <span class="cf">for</span> item <span class="kw">in</span> content.split(<span class="st">','</span>)]</span>
<span id="cb33-223"><a href="#cb33-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-224"><a href="#cb33-224" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> item <span class="kw">in</span> items:</span>
<span id="cb33-225"><a href="#cb33-225" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> <span class="st">':'</span> <span class="kw">in</span> item:</span>
<span id="cb33-226"><a href="#cb33-226" aria-hidden="true" tabindex="-1"></a>                        key, value <span class="op">=</span> item.split(<span class="st">':'</span>, <span class="dv">1</span>)</span>
<span id="cb33-227"><a href="#cb33-227" aria-hidden="true" tabindex="-1"></a>                        key <span class="op">=</span> key.strip(<span class="st">' </span><span class="ch">\'\"</span><span class="st">'</span>)</span>
<span id="cb33-228"><a href="#cb33-228" aria-hidden="true" tabindex="-1"></a>                        value <span class="op">=</span> value.strip(<span class="st">' </span><span class="ch">\'\"</span><span class="st">'</span>)</span>
<span id="cb33-229"><a href="#cb33-229" aria-hidden="true" tabindex="-1"></a>                        result[key] <span class="op">=</span> value</span>
<span id="cb33-230"><a href="#cb33-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-231"><a href="#cb33-231" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract main probability for TRUE state</span></span>
<span id="cb33-232"><a href="#cb33-232" aria-hidden="true" tabindex="-1"></a>    instantiations <span class="op">=</span> get_instantiations(row)</span>
<span id="cb33-233"><a href="#cb33-233" aria-hidden="true" tabindex="-1"></a>    true_state <span class="op">=</span> instantiations[<span class="dv">0</span>] <span class="cf">if</span> instantiations <span class="cf">else</span> <span class="st">"TRUE"</span></span>
<span id="cb33-234"><a href="#cb33-234" aria-hidden="true" tabindex="-1"></a>    true_key <span class="op">=</span> <span class="ss">f"p(</span><span class="sc">{</span>true_state<span class="sc">}</span><span class="ss">)"</span></span>
<span id="cb33-235"><a href="#cb33-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-236"><a href="#cb33-236" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> true_key <span class="kw">in</span> result:</span>
<span id="cb33-237"><a href="#cb33-237" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb33-238"><a href="#cb33-238" aria-hidden="true" tabindex="-1"></a>            result[<span class="st">'true_prob'</span>] <span class="op">=</span> <span class="bu">float</span>(result[true_key])</span>
<span id="cb33-239"><a href="#cb33-239" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span>:</span>
<span id="cb33-240"><a href="#cb33-240" aria-hidden="true" tabindex="-1"></a>            <span class="cf">pass</span></span>
<span id="cb33-241"><a href="#cb33-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-242"><a href="#cb33-242" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result</span>
<span id="cb33-243"><a href="#cb33-243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-244"><a href="#cb33-244" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_posteriors(row):</span>
<span id="cb33-245"><a href="#cb33-245" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb33-246"><a href="#cb33-246" aria-hidden="true" tabindex="-1"></a><span class="co">    Extract posterior probabilities with safe handling for different data types</span></span>
<span id="cb33-247"><a href="#cb33-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-248"><a href="#cb33-248" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb33-249"><a href="#cb33-249" aria-hidden="true" tabindex="-1"></a><span class="co">        row (pandas.Series): Row from DataFrame containing node information</span></span>
<span id="cb33-250"><a href="#cb33-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-251"><a href="#cb33-251" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb33-252"><a href="#cb33-252" aria-hidden="true" tabindex="-1"></a><span class="co">        dict: Dictionary of conditional probabilities</span></span>
<span id="cb33-253"><a href="#cb33-253" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb33-254"><a href="#cb33-254" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'posteriors'</span> <span class="kw">not</span> <span class="kw">in</span> row:</span>
<span id="cb33-255"><a href="#cb33-255" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {}</span>
<span id="cb33-256"><a href="#cb33-256" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-257"><a href="#cb33-257" aria-hidden="true" tabindex="-1"></a>    posteriors_data <span class="op">=</span> row[<span class="st">'posteriors'</span>]</span>
<span id="cb33-258"><a href="#cb33-258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-259"><a href="#cb33-259" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Handle NaN or None</span></span>
<span id="cb33-260"><a href="#cb33-260" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(posteriors_data, <span class="bu">float</span>) <span class="kw">and</span> pd.isna(posteriors_data):</span>
<span id="cb33-261"><a href="#cb33-261" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {}</span>
<span id="cb33-262"><a href="#cb33-262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-263"><a href="#cb33-263" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> posteriors_data <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb33-264"><a href="#cb33-264" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {}</span>
<span id="cb33-265"><a href="#cb33-265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-266"><a href="#cb33-266" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> {}</span>
<span id="cb33-267"><a href="#cb33-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-268"><a href="#cb33-268" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Handle dictionary</span></span>
<span id="cb33-269"><a href="#cb33-269" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(posteriors_data, <span class="bu">dict</span>):</span>
<span id="cb33-270"><a href="#cb33-270" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> posteriors_data</span>
<span id="cb33-271"><a href="#cb33-271" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Handle string representation of dictionary</span></span>
<span id="cb33-272"><a href="#cb33-272" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="bu">isinstance</span>(posteriors_data, <span class="bu">str</span>):</span>
<span id="cb33-273"><a href="#cb33-273" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> posteriors_data.strip() <span class="kw">or</span> posteriors_data <span class="op">==</span> <span class="st">'</span><span class="sc">{}</span><span class="st">'</span>:</span>
<span id="cb33-274"><a href="#cb33-274" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> {}</span>
<span id="cb33-275"><a href="#cb33-275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-276"><a href="#cb33-276" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb33-277"><a href="#cb33-277" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Try to evaluate as Python literal</span></span>
<span id="cb33-278"><a href="#cb33-278" aria-hidden="true" tabindex="-1"></a>            <span class="im">import</span> ast</span>
<span id="cb33-279"><a href="#cb33-279" aria-hidden="true" tabindex="-1"></a>            result <span class="op">=</span> ast.literal_eval(posteriors_data)</span>
<span id="cb33-280"><a href="#cb33-280" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span>:</span>
<span id="cb33-281"><a href="#cb33-281" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Simple parsing</span></span>
<span id="cb33-282"><a href="#cb33-282" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="st">'{'</span> <span class="kw">in</span> posteriors_data <span class="kw">and</span> <span class="st">'}'</span> <span class="kw">in</span> posteriors_data:</span>
<span id="cb33-283"><a href="#cb33-283" aria-hidden="true" tabindex="-1"></a>                content <span class="op">=</span> posteriors_data[posteriors_data.find(<span class="st">'{'</span>)<span class="op">+</span><span class="dv">1</span>:posteriors_data.rfind(<span class="st">'}'</span>)]</span>
<span id="cb33-284"><a href="#cb33-284" aria-hidden="true" tabindex="-1"></a>                items <span class="op">=</span> [item.strip() <span class="cf">for</span> item <span class="kw">in</span> content.split(<span class="st">','</span>)]</span>
<span id="cb33-285"><a href="#cb33-285" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-286"><a href="#cb33-286" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> item <span class="kw">in</span> items:</span>
<span id="cb33-287"><a href="#cb33-287" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> <span class="st">':'</span> <span class="kw">in</span> item:</span>
<span id="cb33-288"><a href="#cb33-288" aria-hidden="true" tabindex="-1"></a>                        key, value <span class="op">=</span> item.split(<span class="st">':'</span>, <span class="dv">1</span>)</span>
<span id="cb33-289"><a href="#cb33-289" aria-hidden="true" tabindex="-1"></a>                        key <span class="op">=</span> key.strip(<span class="st">' </span><span class="ch">\'\"</span><span class="st">'</span>)</span>
<span id="cb33-290"><a href="#cb33-290" aria-hidden="true" tabindex="-1"></a>                        value <span class="op">=</span> value.strip(<span class="st">' </span><span class="ch">\'\"</span><span class="st">'</span>)</span>
<span id="cb33-291"><a href="#cb33-291" aria-hidden="true" tabindex="-1"></a>                        result[key] <span class="op">=</span> value</span>
<span id="cb33-292"><a href="#cb33-292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-293"><a href="#cb33-293" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="phase-3-html-content-generation-module" class="level2">
<h2 class="anchored" data-anchor-id="phase-3-html-content-generation-module">Phase 3: HTML Content Generation Module</h2>
<div class="sourceCode" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co"># @title 4.2 --- HTML Content Generation Functions ---</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="co">BLOCK PURPOSE: Creates rich HTML content for the interactive Bayesian network visualization.</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a><span class="co">This module generates the HTML components that enhance the Bayesian network visualization:</span></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a><span class="co">1. Probability bars - Visual representation of probability distributions</span></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a><span class="co">2. Node tooltips - Rich information displayed on hover</span></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a><span class="co">3. Expanded content - Detailed probability information shown when clicking nodes</span></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a><span class="co">These HTML components make the mathematical concepts of Bayesian networks more</span></span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a><span class="co">intuitive and accessible to users without requiring deep statistical knowledge.</span></span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a><span class="co">The visual encoding of probabilities (colors, bars) and the progressive disclosure</span></span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a><span class="co">of information (hover, click) help users build understanding at their own pace.</span></span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a><span class="co">DEPENDENCIES: HTML generation capabilities</span></span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a><span class="co">INPUTS: Node data from the Bayesian network</span></span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a><span class="co">OUTPUTS: HTML content for visualization components</span></span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_probability_bar(true_prob, false_prob, height<span class="op">=</span><span class="st">"15px"</span>, show_values<span class="op">=</span><span class="va">True</span>, value_prefix<span class="op">=</span><span class="st">""</span>):</span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a><span class="co">    Creates a reusable HTML component to visualize probability distribution</span></span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-25"><a href="#cb34-25" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb34-26"><a href="#cb34-26" aria-hidden="true" tabindex="-1"></a><span class="co">        true_prob (float): Probability of the true state (0.0-1.0)</span></span>
<span id="cb34-27"><a href="#cb34-27" aria-hidden="true" tabindex="-1"></a><span class="co">        false_prob (float): Probability of the false state (0.0-1.0)</span></span>
<span id="cb34-28"><a href="#cb34-28" aria-hidden="true" tabindex="-1"></a><span class="co">        height (str): CSS height of the bar</span></span>
<span id="cb34-29"><a href="#cb34-29" aria-hidden="true" tabindex="-1"></a><span class="co">        show_values (bool): Whether to display numerical values</span></span>
<span id="cb34-30"><a href="#cb34-30" aria-hidden="true" tabindex="-1"></a><span class="co">        value_prefix (str): Prefix to add before values (e.g., "p=")</span></span>
<span id="cb34-31"><a href="#cb34-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-32"><a href="#cb34-32" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb34-33"><a href="#cb34-33" aria-hidden="true" tabindex="-1"></a><span class="co">        str: HTML for a horizontal bar showing probabilities</span></span>
<span id="cb34-34"><a href="#cb34-34" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb34-35"><a href="#cb34-35" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Prepare display labels if showing values</span></span>
<span id="cb34-36"><a href="#cb34-36" aria-hidden="true" tabindex="-1"></a>    true_label <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>value_prefix<span class="sc">}{</span>true_prob<span class="sc">:.3f}</span><span class="ss">"</span> <span class="cf">if</span> show_values <span class="cf">else</span> <span class="st">""</span></span>
<span id="cb34-37"><a href="#cb34-37" aria-hidden="true" tabindex="-1"></a>    false_label <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>value_prefix<span class="sc">}{</span>false_prob<span class="sc">:.3f}</span><span class="ss">"</span> <span class="cf">if</span> show_values <span class="cf">else</span> <span class="st">""</span></span>
<span id="cb34-38"><a href="#cb34-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-39"><a href="#cb34-39" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create the HTML for a horizontal stacked bar</span></span>
<span id="cb34-40"><a href="#cb34-40" aria-hidden="true" tabindex="-1"></a>    html <span class="op">=</span> <span class="ss">f"""</span></span>
<span id="cb34-41"><a href="#cb34-41" aria-hidden="true" tabindex="-1"></a><span class="ss">    &lt;div style="width:100%; height:</span><span class="sc">{</span>height<span class="sc">}</span><span class="ss">; display:flex; border:1px solid #ccc; overflow:hidden; border-radius:3px; margin-top:3px; margin-bottom:3px;"&gt;</span></span>
<span id="cb34-42"><a href="#cb34-42" aria-hidden="true" tabindex="-1"></a><span class="ss">        &lt;div style="flex-basis:</span><span class="sc">{</span>true_prob<span class="op">*</span><span class="dv">100</span><span class="sc">}</span><span class="ss">%; background:linear-gradient(to bottom, rgba(0,180,0,0.9), rgba(0,140,0,0.7)); border-right:2px solid #008800; display:flex; align-items:center; justify-content:center; overflow:hidden; min-width:</span><span class="sc">{</span><span class="dv">2</span> <span class="cf">if</span> true_prob <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span><span class="sc">}</span><span class="ss">px;"&gt;</span></span>
<span id="cb34-43"><a href="#cb34-43" aria-hidden="true" tabindex="-1"></a><span class="ss">            &lt;span style="font-size:10px; color:white; text-shadow:0px 0px 2px #000;"&gt;</span><span class="sc">{</span>true_label<span class="sc">}</span><span class="ss">&lt;/span&gt;</span></span>
<span id="cb34-44"><a href="#cb34-44" aria-hidden="true" tabindex="-1"></a><span class="ss">        &lt;/div&gt;</span></span>
<span id="cb34-45"><a href="#cb34-45" aria-hidden="true" tabindex="-1"></a><span class="ss">        &lt;div style="flex-basis:</span><span class="sc">{</span>false_prob<span class="op">*</span><span class="dv">100</span><span class="sc">}</span><span class="ss">%; background:linear-gradient(to bottom, rgba(220,0,0,0.9), rgba(180,0,0,0.7)); border-left:2px solid #880000; display:flex; align-items:center; justify-content:center; overflow:hidden; min-width:</span><span class="sc">{</span><span class="dv">2</span> <span class="cf">if</span> false_prob <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span><span class="sc">}</span><span class="ss">px;"&gt;</span></span>
<span id="cb34-46"><a href="#cb34-46" aria-hidden="true" tabindex="-1"></a><span class="ss">            &lt;span style="font-size:10px; color:white; text-shadow:0px 0px 2px #000;"&gt;</span><span class="sc">{</span>false_label<span class="sc">}</span><span class="ss">&lt;/span&gt;</span></span>
<span id="cb34-47"><a href="#cb34-47" aria-hidden="true" tabindex="-1"></a><span class="ss">        &lt;/div&gt;</span></span>
<span id="cb34-48"><a href="#cb34-48" aria-hidden="true" tabindex="-1"></a><span class="ss">    &lt;/div&gt;</span></span>
<span id="cb34-49"><a href="#cb34-49" aria-hidden="true" tabindex="-1"></a><span class="ss">    """</span></span>
<span id="cb34-50"><a href="#cb34-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> html</span>
<span id="cb34-51"><a href="#cb34-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-52"><a href="#cb34-52" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_tooltip(node_id, node_data):</span>
<span id="cb34-53"><a href="#cb34-53" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb34-54"><a href="#cb34-54" aria-hidden="true" tabindex="-1"></a><span class="co">    Create rich HTML tooltip with probability information</span></span>
<span id="cb34-55"><a href="#cb34-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-56"><a href="#cb34-56" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb34-57"><a href="#cb34-57" aria-hidden="true" tabindex="-1"></a><span class="co">        node_id (str): Identifier of the node</span></span>
<span id="cb34-58"><a href="#cb34-58" aria-hidden="true" tabindex="-1"></a><span class="co">        node_data (dict): Node attributes including probabilities</span></span>
<span id="cb34-59"><a href="#cb34-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-60"><a href="#cb34-60" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb34-61"><a href="#cb34-61" aria-hidden="true" tabindex="-1"></a><span class="co">        str: HTML content for tooltip displayed on hover</span></span>
<span id="cb34-62"><a href="#cb34-62" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb34-63"><a href="#cb34-63" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract node information</span></span>
<span id="cb34-64"><a href="#cb34-64" aria-hidden="true" tabindex="-1"></a>    description <span class="op">=</span> node_data.get(<span class="st">'description'</span>, <span class="st">''</span>)</span>
<span id="cb34-65"><a href="#cb34-65" aria-hidden="true" tabindex="-1"></a>    priors <span class="op">=</span> node_data.get(<span class="st">'priors'</span>, {})</span>
<span id="cb34-66"><a href="#cb34-66" aria-hidden="true" tabindex="-1"></a>    instantiations <span class="op">=</span> node_data.get(<span class="st">'instantiations'</span>, [<span class="st">"TRUE"</span>, <span class="st">"FALSE"</span>])</span>
<span id="cb34-67"><a href="#cb34-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-68"><a href="#cb34-68" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Start building the HTML tooltip</span></span>
<span id="cb34-69"><a href="#cb34-69" aria-hidden="true" tabindex="-1"></a>    html <span class="op">=</span> <span class="ss">f"""</span></span>
<span id="cb34-70"><a href="#cb34-70" aria-hidden="true" tabindex="-1"></a><span class="ss">    &lt;div style="max-width:350px; padding:10px; background-color:#f8f9fa; border-radius:5px; font-family:Arial, sans-serif;"&gt;</span></span>
<span id="cb34-71"><a href="#cb34-71" aria-hidden="true" tabindex="-1"></a><span class="ss">        &lt;h3 style="margin-top:0; color:#202124;"&gt;</span><span class="sc">{</span>node_id<span class="sc">}</span><span class="ss">&lt;/h3&gt;</span></span>
<span id="cb34-72"><a href="#cb34-72" aria-hidden="true" tabindex="-1"></a><span class="ss">        &lt;p style="font-style:italic;"&gt;</span><span class="sc">{</span>description<span class="sc">}</span><span class="ss">&lt;/p&gt;</span></span>
<span id="cb34-73"><a href="#cb34-73" aria-hidden="true" tabindex="-1"></a><span class="ss">    """</span></span>
<span id="cb34-74"><a href="#cb34-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-75"><a href="#cb34-75" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add prior probabilities section</span></span>
<span id="cb34-76"><a href="#cb34-76" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> priors <span class="kw">and</span> <span class="st">'true_prob'</span> <span class="kw">in</span> priors:</span>
<span id="cb34-77"><a href="#cb34-77" aria-hidden="true" tabindex="-1"></a>        true_prob <span class="op">=</span> priors[<span class="st">'true_prob'</span>]</span>
<span id="cb34-78"><a href="#cb34-78" aria-hidden="true" tabindex="-1"></a>        false_prob <span class="op">=</span> <span class="fl">1.0</span> <span class="op">-</span> true_prob</span>
<span id="cb34-79"><a href="#cb34-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-80"><a href="#cb34-80" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get proper state names</span></span>
<span id="cb34-81"><a href="#cb34-81" aria-hidden="true" tabindex="-1"></a>        true_state <span class="op">=</span> instantiations[<span class="dv">0</span>] <span class="cf">if</span> <span class="bu">len</span>(instantiations) <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="st">"TRUE"</span></span>
<span id="cb34-82"><a href="#cb34-82" aria-hidden="true" tabindex="-1"></a>        false_state <span class="op">=</span> instantiations[<span class="dv">1</span>] <span class="cf">if</span> <span class="bu">len</span>(instantiations) <span class="op">&gt;</span> <span class="dv">1</span> <span class="cf">else</span> <span class="st">"FALSE"</span></span>
<span id="cb34-83"><a href="#cb34-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-84"><a href="#cb34-84" aria-hidden="true" tabindex="-1"></a>        html <span class="op">+=</span> <span class="ss">f"""</span></span>
<span id="cb34-85"><a href="#cb34-85" aria-hidden="true" tabindex="-1"></a><span class="ss">        &lt;div style="margin-top:10px; background-color:#fff; padding:8px; border-radius:4px; border:1px solid #ddd;"&gt;</span></span>
<span id="cb34-86"><a href="#cb34-86" aria-hidden="true" tabindex="-1"></a><span class="ss">            &lt;h4 style="margin-top:0; font-size:14px;"&gt;Prior Probabilities:&lt;/h4&gt;</span></span>
<span id="cb34-87"><a href="#cb34-87" aria-hidden="true" tabindex="-1"></a><span class="ss">            &lt;div style="display:flex; justify-content:space-between; margin-bottom:4px;"&gt;</span></span>
<span id="cb34-88"><a href="#cb34-88" aria-hidden="true" tabindex="-1"></a><span class="ss">                &lt;div style="font-size:12px;"&gt;</span><span class="sc">{</span>true_state<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>true_prob<span class="sc">:.3f}</span><span class="ss">&lt;/div&gt;</span></span>
<span id="cb34-89"><a href="#cb34-89" aria-hidden="true" tabindex="-1"></a><span class="ss">                &lt;div style="font-size:12px;"&gt;</span><span class="sc">{</span>false_state<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>false_prob<span class="sc">:.3f}</span><span class="ss">&lt;/div&gt;</span></span>
<span id="cb34-90"><a href="#cb34-90" aria-hidden="true" tabindex="-1"></a><span class="ss">            &lt;/div&gt;</span></span>
<span id="cb34-91"><a href="#cb34-91" aria-hidden="true" tabindex="-1"></a><span class="ss">            </span><span class="sc">{</span>create_probability_bar(true_prob, false_prob, <span class="st">"20px"</span>, <span class="va">True</span>)<span class="sc">}</span></span>
<span id="cb34-92"><a href="#cb34-92" aria-hidden="true" tabindex="-1"></a><span class="ss">        &lt;/div&gt;</span></span>
<span id="cb34-93"><a href="#cb34-93" aria-hidden="true" tabindex="-1"></a><span class="ss">        """</span></span>
<span id="cb34-94"><a href="#cb34-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-95"><a href="#cb34-95" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add click instruction</span></span>
<span id="cb34-96"><a href="#cb34-96" aria-hidden="true" tabindex="-1"></a>    html <span class="op">+=</span> <span class="st">"""</span></span>
<span id="cb34-97"><a href="#cb34-97" aria-hidden="true" tabindex="-1"></a><span class="st">    &lt;div style="margin-top:8px; font-size:12px; color:#666; text-align:center;"&gt;</span></span>
<span id="cb34-98"><a href="#cb34-98" aria-hidden="true" tabindex="-1"></a><span class="st">        Click node to see full probability details</span></span>
<span id="cb34-99"><a href="#cb34-99" aria-hidden="true" tabindex="-1"></a><span class="st">    &lt;/div&gt;</span></span>
<span id="cb34-100"><a href="#cb34-100" aria-hidden="true" tabindex="-1"></a><span class="st">    &lt;/div&gt;</span></span>
<span id="cb34-101"><a href="#cb34-101" aria-hidden="true" tabindex="-1"></a><span class="st">    """</span></span>
<span id="cb34-102"><a href="#cb34-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-103"><a href="#cb34-103" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> html</span>
<span id="cb34-104"><a href="#cb34-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-105"><a href="#cb34-105" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_expanded_content(node_id, node_data):</span>
<span id="cb34-106"><a href="#cb34-106" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb34-107"><a href="#cb34-107" aria-hidden="true" tabindex="-1"></a><span class="co">    Create expanded content shown when a node is clicked</span></span>
<span id="cb34-108"><a href="#cb34-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-109"><a href="#cb34-109" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb34-110"><a href="#cb34-110" aria-hidden="true" tabindex="-1"></a><span class="co">        node_id (str): Identifier of the node</span></span>
<span id="cb34-111"><a href="#cb34-111" aria-hidden="true" tabindex="-1"></a><span class="co">        node_data (dict): Node attributes including probabilities</span></span>
<span id="cb34-112"><a href="#cb34-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-113"><a href="#cb34-113" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb34-114"><a href="#cb34-114" aria-hidden="true" tabindex="-1"></a><span class="co">        str: HTML content for detailed view displayed on click</span></span>
<span id="cb34-115"><a href="#cb34-115" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb34-116"><a href="#cb34-116" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract node information</span></span>
<span id="cb34-117"><a href="#cb34-117" aria-hidden="true" tabindex="-1"></a>    description <span class="op">=</span> node_data.get(<span class="st">'description'</span>, <span class="st">''</span>)</span>
<span id="cb34-118"><a href="#cb34-118" aria-hidden="true" tabindex="-1"></a>    priors <span class="op">=</span> node_data.get(<span class="st">'priors'</span>, {})</span>
<span id="cb34-119"><a href="#cb34-119" aria-hidden="true" tabindex="-1"></a>    posteriors <span class="op">=</span> node_data.get(<span class="st">'posteriors'</span>, {})</span>
<span id="cb34-120"><a href="#cb34-120" aria-hidden="true" tabindex="-1"></a>    instantiations <span class="op">=</span> node_data.get(<span class="st">'instantiations'</span>, [<span class="st">"TRUE"</span>, <span class="st">"FALSE"</span>])</span>
<span id="cb34-121"><a href="#cb34-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-122"><a href="#cb34-122" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get proper state names</span></span>
<span id="cb34-123"><a href="#cb34-123" aria-hidden="true" tabindex="-1"></a>    true_state <span class="op">=</span> instantiations[<span class="dv">0</span>] <span class="cf">if</span> <span class="bu">len</span>(instantiations) <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="st">"TRUE"</span></span>
<span id="cb34-124"><a href="#cb34-124" aria-hidden="true" tabindex="-1"></a>    false_state <span class="op">=</span> instantiations[<span class="dv">1</span>] <span class="cf">if</span> <span class="bu">len</span>(instantiations) <span class="op">&gt;</span> <span class="dv">1</span> <span class="cf">else</span> <span class="st">"FALSE"</span></span>
<span id="cb34-125"><a href="#cb34-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-126"><a href="#cb34-126" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract probabilities</span></span>
<span id="cb34-127"><a href="#cb34-127" aria-hidden="true" tabindex="-1"></a>    true_prob <span class="op">=</span> priors.get(<span class="st">'true_prob'</span>, <span class="fl">0.5</span>)</span>
<span id="cb34-128"><a href="#cb34-128" aria-hidden="true" tabindex="-1"></a>    false_prob <span class="op">=</span> <span class="fl">1.0</span> <span class="op">-</span> true_prob</span>
<span id="cb34-129"><a href="#cb34-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-130"><a href="#cb34-130" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Start building the expanded content</span></span>
<span id="cb34-131"><a href="#cb34-131" aria-hidden="true" tabindex="-1"></a>    html <span class="op">=</span> <span class="ss">f"""</span></span>
<span id="cb34-132"><a href="#cb34-132" aria-hidden="true" tabindex="-1"></a><span class="ss">    &lt;div style="max-width:500px; padding:15px; font-family:Arial, sans-serif;"&gt;</span></span>
<span id="cb34-133"><a href="#cb34-133" aria-hidden="true" tabindex="-1"></a><span class="ss">        &lt;h2 style="margin-top:0; color:#333;"&gt;</span><span class="sc">{</span>node_id<span class="sc">}</span><span class="ss">&lt;/h2&gt;</span></span>
<span id="cb34-134"><a href="#cb34-134" aria-hidden="true" tabindex="-1"></a><span class="ss">        &lt;p style="font-style:italic; margin-bottom:15px;"&gt;</span><span class="sc">{</span>description<span class="sc">}</span><span class="ss">&lt;/p&gt;</span></span>
<span id="cb34-135"><a href="#cb34-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-136"><a href="#cb34-136" aria-hidden="true" tabindex="-1"></a><span class="ss">        &lt;div style="margin-bottom:20px; padding:12px; border:1px solid #ddd; background-color:#f9f9f9; border-radius:5px;"&gt;</span></span>
<span id="cb34-137"><a href="#cb34-137" aria-hidden="true" tabindex="-1"></a><span class="ss">            &lt;h3 style="margin-top:0; color:#333;"&gt;Prior Probabilities&lt;/h3&gt;</span></span>
<span id="cb34-138"><a href="#cb34-138" aria-hidden="true" tabindex="-1"></a><span class="ss">            &lt;div style="display:flex; justify-content:space-between; margin-bottom:5px;"&gt;</span></span>
<span id="cb34-139"><a href="#cb34-139" aria-hidden="true" tabindex="-1"></a><span class="ss">                &lt;div&gt;&lt;strong&gt;</span><span class="sc">{</span>true_state<span class="sc">}</span><span class="ss">:&lt;/strong&gt; </span><span class="sc">{</span>true_prob<span class="sc">:.3f}</span><span class="ss">&lt;/div&gt;</span></span>
<span id="cb34-140"><a href="#cb34-140" aria-hidden="true" tabindex="-1"></a><span class="ss">                &lt;div&gt;&lt;strong&gt;</span><span class="sc">{</span>false_state<span class="sc">}</span><span class="ss">:&lt;/strong&gt; </span><span class="sc">{</span>false_prob<span class="sc">:.3f}</span><span class="ss">&lt;/div&gt;</span></span>
<span id="cb34-141"><a href="#cb34-141" aria-hidden="true" tabindex="-1"></a><span class="ss">            &lt;/div&gt;</span></span>
<span id="cb34-142"><a href="#cb34-142" aria-hidden="true" tabindex="-1"></a><span class="ss">            </span><span class="sc">{</span>create_probability_bar(true_prob, false_prob, <span class="st">"25px"</span>, <span class="va">True</span>)<span class="sc">}</span></span>
<span id="cb34-143"><a href="#cb34-143" aria-hidden="true" tabindex="-1"></a><span class="ss">        &lt;/div&gt;</span></span>
<span id="cb34-144"><a href="#cb34-144" aria-hidden="true" tabindex="-1"></a><span class="ss">    """</span></span>
<span id="cb34-145"><a href="#cb34-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-146"><a href="#cb34-146" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add conditional probability table if available</span></span>
<span id="cb34-147"><a href="#cb34-147" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> posteriors:</span>
<span id="cb34-148"><a href="#cb34-148" aria-hidden="true" tabindex="-1"></a>        html <span class="op">+=</span> <span class="st">"""</span></span>
<span id="cb34-149"><a href="#cb34-149" aria-hidden="true" tabindex="-1"></a><span class="st">        &lt;div style="padding:12px; border:1px solid #ddd; background-color:#f9f9f9; border-radius:5px;"&gt;</span></span>
<span id="cb34-150"><a href="#cb34-150" aria-hidden="true" tabindex="-1"></a><span class="st">            &lt;h3 style="margin-top:0; color:#333;"&gt;Conditional Probabilities&lt;/h3&gt;</span></span>
<span id="cb34-151"><a href="#cb34-151" aria-hidden="true" tabindex="-1"></a><span class="st">            &lt;table style="width:100%; border-collapse:collapse; font-size:13px;"&gt;</span></span>
<span id="cb34-152"><a href="#cb34-152" aria-hidden="true" tabindex="-1"></a><span class="st">                &lt;tr style="background-color:#eee;"&gt;</span></span>
<span id="cb34-153"><a href="#cb34-153" aria-hidden="true" tabindex="-1"></a><span class="st">                    &lt;th style="padding:8px; text-align:left; border:1px solid #ddd;"&gt;Condition&lt;/th&gt;</span></span>
<span id="cb34-154"><a href="#cb34-154" aria-hidden="true" tabindex="-1"></a><span class="st">                    &lt;th style="padding:8px; text-align:center; border:1px solid #ddd; width:80px;"&gt;Value&lt;/th&gt;</span></span>
<span id="cb34-155"><a href="#cb34-155" aria-hidden="true" tabindex="-1"></a><span class="st">                    &lt;th style="padding:8px; text-align:center; border:1px solid #ddd;"&gt;Visualization&lt;/th&gt;</span></span>
<span id="cb34-156"><a href="#cb34-156" aria-hidden="true" tabindex="-1"></a><span class="st">                &lt;/tr&gt;</span></span>
<span id="cb34-157"><a href="#cb34-157" aria-hidden="true" tabindex="-1"></a><span class="st">        """</span></span>
<span id="cb34-158"><a href="#cb34-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-159"><a href="#cb34-159" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Sort posteriors to group by similar conditions</span></span>
<span id="cb34-160"><a href="#cb34-160" aria-hidden="true" tabindex="-1"></a>        posterior_items <span class="op">=</span> <span class="bu">list</span>(posteriors.items())</span>
<span id="cb34-161"><a href="#cb34-161" aria-hidden="true" tabindex="-1"></a>        posterior_items.sort(key<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="dv">0</span>])</span>
<span id="cb34-162"><a href="#cb34-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-163"><a href="#cb34-163" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add rows for conditional probabilities</span></span>
<span id="cb34-164"><a href="#cb34-164" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> key, value <span class="kw">in</span> posterior_items:</span>
<span id="cb34-165"><a href="#cb34-165" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb34-166"><a href="#cb34-166" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Try to parse probability value</span></span>
<span id="cb34-167"><a href="#cb34-167" aria-hidden="true" tabindex="-1"></a>                prob_value <span class="op">=</span> <span class="bu">float</span>(value)</span>
<span id="cb34-168"><a href="#cb34-168" aria-hidden="true" tabindex="-1"></a>                inv_prob <span class="op">=</span> <span class="fl">1.0</span> <span class="op">-</span> prob_value</span>
<span id="cb34-169"><a href="#cb34-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-170"><a href="#cb34-170" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Add row with probability visualization</span></span>
<span id="cb34-171"><a href="#cb34-171" aria-hidden="true" tabindex="-1"></a>                html <span class="op">+=</span> <span class="ss">f"""</span></span>
<span id="cb34-172"><a href="#cb34-172" aria-hidden="true" tabindex="-1"></a><span class="ss">                &lt;tr&gt;</span></span>
<span id="cb34-173"><a href="#cb34-173" aria-hidden="true" tabindex="-1"></a><span class="ss">                    &lt;td style="padding:8px; border:1px solid #ddd;"&gt;</span><span class="sc">{</span>key<span class="sc">}</span><span class="ss">&lt;/td&gt;</span></span>
<span id="cb34-174"><a href="#cb34-174" aria-hidden="true" tabindex="-1"></a><span class="ss">                    &lt;td style="padding:8px; text-align:center; border:1px solid #ddd;"&gt;</span><span class="sc">{</span>prob_value<span class="sc">:.3f}</span><span class="ss">&lt;/td&gt;</span></span>
<span id="cb34-175"><a href="#cb34-175" aria-hidden="true" tabindex="-1"></a><span class="ss">                    &lt;td style="padding:8px; border:1px solid #ddd;"&gt;</span></span>
<span id="cb34-176"><a href="#cb34-176" aria-hidden="true" tabindex="-1"></a><span class="ss">                        </span><span class="sc">{</span>create_probability_bar(prob_value, inv_prob, <span class="st">"20px"</span>, <span class="va">False</span>)<span class="sc">}</span></span>
<span id="cb34-177"><a href="#cb34-177" aria-hidden="true" tabindex="-1"></a><span class="ss">                    &lt;/td&gt;</span></span>
<span id="cb34-178"><a href="#cb34-178" aria-hidden="true" tabindex="-1"></a><span class="ss">                &lt;/tr&gt;</span></span>
<span id="cb34-179"><a href="#cb34-179" aria-hidden="true" tabindex="-1"></a><span class="ss">                """</span></span>
<span id="cb34-180"><a href="#cb34-180" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span>:</span>
<span id="cb34-181"><a href="#cb34-181" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Fallback for non-numeric values</span></span>
<span id="cb34-182"><a href="#cb34-182" aria-hidden="true" tabindex="-1"></a>                html <span class="op">+=</span> <span class="ss">f"""</span></span>
<span id="cb34-183"><a href="#cb34-183" aria-hidden="true" tabindex="-1"></a><span class="ss">                &lt;tr&gt;</span></span>
<span id="cb34-184"><a href="#cb34-184" aria-hidden="true" tabindex="-1"></a><span class="ss">                    &lt;td style="padding:8px; border:1px solid #ddd;"&gt;</span><span class="sc">{</span>key<span class="sc">}</span><span class="ss">&lt;/td&gt;</span></span>
<span id="cb34-185"><a href="#cb34-185" aria-hidden="true" tabindex="-1"></a><span class="ss">                    &lt;td style="padding:8px; text-align:center; border:1px solid #ddd;" colspan="2"&gt;</span><span class="sc">{</span>value<span class="sc">}</span><span class="ss">&lt;/td&gt;</span></span>
<span id="cb34-186"><a href="#cb34-186" aria-hidden="true" tabindex="-1"></a><span class="ss">                &lt;/tr&gt;</span></span>
<span id="cb34-187"><a href="#cb34-187" aria-hidden="true" tabindex="-1"></a><span class="ss">                """</span></span>
<span id="cb34-188"><a href="#cb34-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-189"><a href="#cb34-189" aria-hidden="true" tabindex="-1"></a>        html <span class="op">+=</span> <span class="st">"""</span></span>
<span id="cb34-190"><a href="#cb34-190" aria-hidden="true" tabindex="-1"></a><span class="st">            &lt;/table&gt;</span></span>
<span id="cb34-191"><a href="#cb34-191" aria-hidden="true" tabindex="-1"></a><span class="st">        &lt;/div&gt;</span></span>
<span id="cb34-192"><a href="#cb34-192" aria-hidden="true" tabindex="-1"></a><span class="st">        """</span></span>
<span id="cb34-193"><a href="#cb34-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-194"><a href="#cb34-194" aria-hidden="true" tabindex="-1"></a>    html <span class="op">+=</span> <span class="st">"&lt;/div&gt;"</span></span>
<span id="cb34-195"><a href="#cb34-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-196"><a href="#cb34-196" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> html</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="phase-4-main-visualization-function" class="level2">
<h2 class="anchored" data-anchor-id="phase-4-main-visualization-function">Phase 4: Main Visualization Function</h2>
<div class="sourceCode" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_bayesian_network_with_probabilities(df):</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Create an interactive Bayesian network visualization with enhanced probability visualization</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a><span class="co">    and node classification based on network structure.</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create a directed graph</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>    G <span class="op">=</span> nx.DiGraph()</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add nodes with proper attributes</span></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> idx, row <span class="kw">in</span> df.iterrows():</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>        title <span class="op">=</span> row[<span class="st">'Title'</span>]</span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>        description <span class="op">=</span> row[<span class="st">'Description'</span>]</span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Process probability information</span></span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>        priors <span class="op">=</span> get_priors(row)</span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>        instantiations <span class="op">=</span> get_instantiations(row)</span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add node with base information</span></span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a>        G.add_node(</span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a>            title,</span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a>            description<span class="op">=</span>description,</span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a>            priors<span class="op">=</span>priors,</span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a>            instantiations<span class="op">=</span>instantiations,</span>
<span id="cb35-24"><a href="#cb35-24" aria-hidden="true" tabindex="-1"></a>            posteriors<span class="op">=</span>get_posteriors(row)</span>
<span id="cb35-25"><a href="#cb35-25" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb35-26"><a href="#cb35-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-27"><a href="#cb35-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add edges</span></span>
<span id="cb35-28"><a href="#cb35-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> idx, row <span class="kw">in</span> df.iterrows():</span>
<span id="cb35-29"><a href="#cb35-29" aria-hidden="true" tabindex="-1"></a>        child <span class="op">=</span> row[<span class="st">'Title'</span>]</span>
<span id="cb35-30"><a href="#cb35-30" aria-hidden="true" tabindex="-1"></a>        parents <span class="op">=</span> get_parents(row)</span>
<span id="cb35-31"><a href="#cb35-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-32"><a href="#cb35-32" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add edges from each parent to this child</span></span>
<span id="cb35-33"><a href="#cb35-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> parent <span class="kw">in</span> parents:</span>
<span id="cb35-34"><a href="#cb35-34" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> parent <span class="kw">in</span> G.nodes():</span>
<span id="cb35-35"><a href="#cb35-35" aria-hidden="true" tabindex="-1"></a>                G.add_edge(parent, child)</span>
<span id="cb35-36"><a href="#cb35-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-37"><a href="#cb35-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Classify nodes based on network structure</span></span>
<span id="cb35-38"><a href="#cb35-38" aria-hidden="true" tabindex="-1"></a>    classify_nodes(G)</span>
<span id="cb35-39"><a href="#cb35-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-40"><a href="#cb35-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create network visualization</span></span>
<span id="cb35-41"><a href="#cb35-41" aria-hidden="true" tabindex="-1"></a>    net <span class="op">=</span> Network(notebook<span class="op">=</span><span class="va">True</span>, directed<span class="op">=</span><span class="va">True</span>, cdn_resources<span class="op">=</span><span class="st">"in_line"</span>, height<span class="op">=</span><span class="st">"600px"</span>, width<span class="op">=</span><span class="st">"100%"</span>)</span>
<span id="cb35-42"><a href="#cb35-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-43"><a href="#cb35-43" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Configure physics for better layout</span></span>
<span id="cb35-44"><a href="#cb35-44" aria-hidden="true" tabindex="-1"></a>    net.force_atlas_2based(gravity<span class="op">=-</span><span class="dv">50</span>, spring_length<span class="op">=</span><span class="dv">100</span>, spring_strength<span class="op">=</span><span class="fl">0.02</span>)</span>
<span id="cb35-45"><a href="#cb35-45" aria-hidden="true" tabindex="-1"></a>    net.show_buttons(filter_<span class="op">=</span>[<span class="st">'physics'</span>])</span>
<span id="cb35-46"><a href="#cb35-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-47"><a href="#cb35-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add the graph to the network</span></span>
<span id="cb35-48"><a href="#cb35-48" aria-hidden="true" tabindex="-1"></a>    net.from_nx(G)</span>
<span id="cb35-49"><a href="#cb35-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-50"><a href="#cb35-50" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Enhance node appearance with probability information and classification</span></span>
<span id="cb35-51"><a href="#cb35-51" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> node <span class="kw">in</span> net.nodes:</span>
<span id="cb35-52"><a href="#cb35-52" aria-hidden="true" tabindex="-1"></a>        node_id <span class="op">=</span> node[<span class="st">'id'</span>]</span>
<span id="cb35-53"><a href="#cb35-53" aria-hidden="true" tabindex="-1"></a>        node_data <span class="op">=</span> G.nodes[node_id]</span>
<span id="cb35-54"><a href="#cb35-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-55"><a href="#cb35-55" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get node type and set border color</span></span>
<span id="cb35-56"><a href="#cb35-56" aria-hidden="true" tabindex="-1"></a>        node_type <span class="op">=</span> node_data.get(<span class="st">'node_type'</span>, <span class="st">'unknown'</span>)</span>
<span id="cb35-57"><a href="#cb35-57" aria-hidden="true" tabindex="-1"></a>        border_color <span class="op">=</span> get_border_color(node_type)</span>
<span id="cb35-58"><a href="#cb35-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-59"><a href="#cb35-59" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get probability information</span></span>
<span id="cb35-60"><a href="#cb35-60" aria-hidden="true" tabindex="-1"></a>        priors <span class="op">=</span> node_data.get(<span class="st">'priors'</span>, {})</span>
<span id="cb35-61"><a href="#cb35-61" aria-hidden="true" tabindex="-1"></a>        true_prob <span class="op">=</span> priors.get(<span class="st">'true_prob'</span>, <span class="fl">0.5</span>) <span class="cf">if</span> priors <span class="cf">else</span> <span class="fl">0.5</span></span>
<span id="cb35-62"><a href="#cb35-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-63"><a href="#cb35-63" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get proper state names</span></span>
<span id="cb35-64"><a href="#cb35-64" aria-hidden="true" tabindex="-1"></a>        instantiations <span class="op">=</span> node_data.get(<span class="st">'instantiations'</span>, [<span class="st">"TRUE"</span>, <span class="st">"FALSE"</span>])</span>
<span id="cb35-65"><a href="#cb35-65" aria-hidden="true" tabindex="-1"></a>        true_state <span class="op">=</span> instantiations[<span class="dv">0</span>] <span class="cf">if</span> <span class="bu">len</span>(instantiations) <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="st">"TRUE"</span></span>
<span id="cb35-66"><a href="#cb35-66" aria-hidden="true" tabindex="-1"></a>        false_state <span class="op">=</span> instantiations[<span class="dv">1</span>] <span class="cf">if</span> <span class="bu">len</span>(instantiations) <span class="op">&gt;</span> <span class="dv">1</span> <span class="cf">else</span> <span class="st">"FALSE"</span></span>
<span id="cb35-67"><a href="#cb35-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-68"><a href="#cb35-68" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create background color based on probability</span></span>
<span id="cb35-69"><a href="#cb35-69" aria-hidden="true" tabindex="-1"></a>        background_color <span class="op">=</span> get_probability_color(priors)</span>
<span id="cb35-70"><a href="#cb35-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-71"><a href="#cb35-71" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create tooltip with probability information</span></span>
<span id="cb35-72"><a href="#cb35-72" aria-hidden="true" tabindex="-1"></a>        tooltip <span class="op">=</span> create_tooltip(node_id, node_data)</span>
<span id="cb35-73"><a href="#cb35-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-74"><a href="#cb35-74" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create a simpler node label with probability</span></span>
<span id="cb35-75"><a href="#cb35-75" aria-hidden="true" tabindex="-1"></a>        simple_label <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>node_id<span class="sc">}</span><span class="ch">\n</span><span class="ss">p=</span><span class="sc">{</span>true_prob<span class="sc">:.2f}</span><span class="ss">"</span></span>
<span id="cb35-76"><a href="#cb35-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-77"><a href="#cb35-77" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Store expanded content as a node attribute for use in click handler</span></span>
<span id="cb35-78"><a href="#cb35-78" aria-hidden="true" tabindex="-1"></a>        node_data[<span class="st">'expanded_content'</span>] <span class="op">=</span> create_expanded_content(node_id, node_data)</span>
<span id="cb35-79"><a href="#cb35-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-80"><a href="#cb35-80" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Set node attributes</span></span>
<span id="cb35-81"><a href="#cb35-81" aria-hidden="true" tabindex="-1"></a>        node[<span class="st">'title'</span>] <span class="op">=</span> tooltip  <span class="co"># Tooltip HTML</span></span>
<span id="cb35-82"><a href="#cb35-82" aria-hidden="true" tabindex="-1"></a>        node[<span class="st">'label'</span>] <span class="op">=</span> simple_label  <span class="co"># Simple text label</span></span>
<span id="cb35-83"><a href="#cb35-83" aria-hidden="true" tabindex="-1"></a>        node[<span class="st">'shape'</span>] <span class="op">=</span> <span class="st">'box'</span></span>
<span id="cb35-84"><a href="#cb35-84" aria-hidden="true" tabindex="-1"></a>        node[<span class="st">'color'</span>] <span class="op">=</span> {</span>
<span id="cb35-85"><a href="#cb35-85" aria-hidden="true" tabindex="-1"></a>            <span class="st">'background'</span>: background_color,</span>
<span id="cb35-86"><a href="#cb35-86" aria-hidden="true" tabindex="-1"></a>            <span class="st">'border'</span>: border_color,</span>
<span id="cb35-87"><a href="#cb35-87" aria-hidden="true" tabindex="-1"></a>            <span class="st">'highlight'</span>: {</span>
<span id="cb35-88"><a href="#cb35-88" aria-hidden="true" tabindex="-1"></a>                <span class="st">'background'</span>: background_color,</span>
<span id="cb35-89"><a href="#cb35-89" aria-hidden="true" tabindex="-1"></a>                <span class="st">'border'</span>: border_color</span>
<span id="cb35-90"><a href="#cb35-90" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb35-91"><a href="#cb35-91" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb35-92"><a href="#cb35-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-93"><a href="#cb35-93" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Set up the click handler with proper data</span></span>
<span id="cb35-94"><a href="#cb35-94" aria-hidden="true" tabindex="-1"></a>    setup_data <span class="op">=</span> {</span>
<span id="cb35-95"><a href="#cb35-95" aria-hidden="true" tabindex="-1"></a>        <span class="st">'nodes_data'</span>: {node_id: {</span>
<span id="cb35-96"><a href="#cb35-96" aria-hidden="true" tabindex="-1"></a>            <span class="st">'expanded_content'</span>: json.dumps(G.nodes[node_id].get(<span class="st">'expanded_content'</span>, <span class="st">''</span>)),</span>
<span id="cb35-97"><a href="#cb35-97" aria-hidden="true" tabindex="-1"></a>            <span class="st">'description'</span>: G.nodes[node_id].get(<span class="st">'description'</span>, <span class="st">''</span>),</span>
<span id="cb35-98"><a href="#cb35-98" aria-hidden="true" tabindex="-1"></a>            <span class="st">'priors'</span>: G.nodes[node_id].get(<span class="st">'priors'</span>, {}),</span>
<span id="cb35-99"><a href="#cb35-99" aria-hidden="true" tabindex="-1"></a>            <span class="st">'posteriors'</span>: G.nodes[node_id].get(<span class="st">'posteriors'</span>, {})</span>
<span id="cb35-100"><a href="#cb35-100" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">for</span> node_id <span class="kw">in</span> G.nodes()}</span>
<span id="cb35-101"><a href="#cb35-101" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb35-102"><a href="#cb35-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-103"><a href="#cb35-103" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add custom click handling JavaScript</span></span>
<span id="cb35-104"><a href="#cb35-104" aria-hidden="true" tabindex="-1"></a>    click_js <span class="op">=</span> <span class="st">"""</span></span>
<span id="cb35-105"><a href="#cb35-105" aria-hidden="true" tabindex="-1"></a><span class="st">    // Store node data for click handling</span></span>
<span id="cb35-106"><a href="#cb35-106" aria-hidden="true" tabindex="-1"></a><span class="st">    var nodesData = </span><span class="sc">%s</span><span class="st">;</span></span>
<span id="cb35-107"><a href="#cb35-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-108"><a href="#cb35-108" aria-hidden="true" tabindex="-1"></a><span class="st">    // Add event listener for node clicks</span></span>
<span id="cb35-109"><a href="#cb35-109" aria-hidden="true" tabindex="-1"></a><span class="st">    network.on("click", function(params) {</span></span>
<span id="cb35-110"><a href="#cb35-110" aria-hidden="true" tabindex="-1"></a><span class="st">        if (params.nodes.length &gt; 0) {</span></span>
<span id="cb35-111"><a href="#cb35-111" aria-hidden="true" tabindex="-1"></a><span class="st">            var nodeId = params.nodes[0];</span></span>
<span id="cb35-112"><a href="#cb35-112" aria-hidden="true" tabindex="-1"></a><span class="st">            var nodeInfo = nodesData[nodeId];</span></span>
<span id="cb35-113"><a href="#cb35-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-114"><a href="#cb35-114" aria-hidden="true" tabindex="-1"></a><span class="st">            if (nodeInfo) {</span></span>
<span id="cb35-115"><a href="#cb35-115" aria-hidden="true" tabindex="-1"></a><span class="st">                // Create a modal popup for expanded content</span></span>
<span id="cb35-116"><a href="#cb35-116" aria-hidden="true" tabindex="-1"></a><span class="st">                var modal = document.createElement('div');</span></span>
<span id="cb35-117"><a href="#cb35-117" aria-hidden="true" tabindex="-1"></a><span class="st">                modal.style.position = 'fixed';</span></span>
<span id="cb35-118"><a href="#cb35-118" aria-hidden="true" tabindex="-1"></a><span class="st">                modal.style.left = '50</span><span class="sc">%%</span><span class="st">';</span></span>
<span id="cb35-119"><a href="#cb35-119" aria-hidden="true" tabindex="-1"></a><span class="st">                modal.style.top = '50</span><span class="sc">%%</span><span class="st">';</span></span>
<span id="cb35-120"><a href="#cb35-120" aria-hidden="true" tabindex="-1"></a><span class="st">                modal.style.transform = 'translate(-50</span><span class="sc">%%</span><span class="st">, -50</span><span class="sc">%%</span><span class="st">)';</span></span>
<span id="cb35-121"><a href="#cb35-121" aria-hidden="true" tabindex="-1"></a><span class="st">                modal.style.backgroundColor = 'white';</span></span>
<span id="cb35-122"><a href="#cb35-122" aria-hidden="true" tabindex="-1"></a><span class="st">                modal.style.padding = '20px';</span></span>
<span id="cb35-123"><a href="#cb35-123" aria-hidden="true" tabindex="-1"></a><span class="st">                modal.style.borderRadius = '5px';</span></span>
<span id="cb35-124"><a href="#cb35-124" aria-hidden="true" tabindex="-1"></a><span class="st">                modal.style.boxShadow = '0 0 10px rgba(0,0,0,0.5)';</span></span>
<span id="cb35-125"><a href="#cb35-125" aria-hidden="true" tabindex="-1"></a><span class="st">                modal.style.zIndex = '1000';</span></span>
<span id="cb35-126"><a href="#cb35-126" aria-hidden="true" tabindex="-1"></a><span class="st">                modal.style.maxWidth = '80</span><span class="sc">%%</span><span class="st">';</span></span>
<span id="cb35-127"><a href="#cb35-127" aria-hidden="true" tabindex="-1"></a><span class="st">                modal.style.maxHeight = '80</span><span class="sc">%%</span><span class="st">';</span></span>
<span id="cb35-128"><a href="#cb35-128" aria-hidden="true" tabindex="-1"></a><span class="st">                modal.style.overflow = 'auto';</span></span>
<span id="cb35-129"><a href="#cb35-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-130"><a href="#cb35-130" aria-hidden="true" tabindex="-1"></a><span class="st">                // Parse the JSON string back to HTML content</span></span>
<span id="cb35-131"><a href="#cb35-131" aria-hidden="true" tabindex="-1"></a><span class="st">                try {</span></span>
<span id="cb35-132"><a href="#cb35-132" aria-hidden="true" tabindex="-1"></a><span class="st">                    var expandedContent = JSON.parse(nodeInfo.expanded_content);</span></span>
<span id="cb35-133"><a href="#cb35-133" aria-hidden="true" tabindex="-1"></a><span class="st">                    modal.innerHTML = expandedContent;</span></span>
<span id="cb35-134"><a href="#cb35-134" aria-hidden="true" tabindex="-1"></a><span class="st">                } catch (e) {</span></span>
<span id="cb35-135"><a href="#cb35-135" aria-hidden="true" tabindex="-1"></a><span class="st">                    modal.innerHTML = 'Error displaying content: ' + e.message;</span></span>
<span id="cb35-136"><a href="#cb35-136" aria-hidden="true" tabindex="-1"></a><span class="st">                }</span></span>
<span id="cb35-137"><a href="#cb35-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-138"><a href="#cb35-138" aria-hidden="true" tabindex="-1"></a><span class="st">                // Add close button</span></span>
<span id="cb35-139"><a href="#cb35-139" aria-hidden="true" tabindex="-1"></a><span class="st">                var closeBtn = document.createElement('button');</span></span>
<span id="cb35-140"><a href="#cb35-140" aria-hidden="true" tabindex="-1"></a><span class="st">                closeBtn.innerHTML = 'Close';</span></span>
<span id="cb35-141"><a href="#cb35-141" aria-hidden="true" tabindex="-1"></a><span class="st">                closeBtn.style.marginTop = '10px';</span></span>
<span id="cb35-142"><a href="#cb35-142" aria-hidden="true" tabindex="-1"></a><span class="st">                closeBtn.style.padding = '5px 10px';</span></span>
<span id="cb35-143"><a href="#cb35-143" aria-hidden="true" tabindex="-1"></a><span class="st">                closeBtn.style.cursor = 'pointer';</span></span>
<span id="cb35-144"><a href="#cb35-144" aria-hidden="true" tabindex="-1"></a><span class="st">                closeBtn.onclick = function() {</span></span>
<span id="cb35-145"><a href="#cb35-145" aria-hidden="true" tabindex="-1"></a><span class="st">                    document.body.removeChild(modal);</span></span>
<span id="cb35-146"><a href="#cb35-146" aria-hidden="true" tabindex="-1"></a><span class="st">                };</span></span>
<span id="cb35-147"><a href="#cb35-147" aria-hidden="true" tabindex="-1"></a><span class="st">                modal.appendChild(closeBtn);</span></span>
<span id="cb35-148"><a href="#cb35-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-149"><a href="#cb35-149" aria-hidden="true" tabindex="-1"></a><span class="st">                // Add modal to body</span></span>
<span id="cb35-150"><a href="#cb35-150" aria-hidden="true" tabindex="-1"></a><span class="st">                document.body.appendChild(modal);</span></span>
<span id="cb35-151"><a href="#cb35-151" aria-hidden="true" tabindex="-1"></a><span class="st">            }</span></span>
<span id="cb35-152"><a href="#cb35-152" aria-hidden="true" tabindex="-1"></a><span class="st">        }</span></span>
<span id="cb35-153"><a href="#cb35-153" aria-hidden="true" tabindex="-1"></a><span class="st">    });</span></span>
<span id="cb35-154"><a href="#cb35-154" aria-hidden="true" tabindex="-1"></a><span class="st">    """</span> <span class="op">%</span> json.dumps(setup_data[<span class="st">'nodes_data'</span>])</span>
<span id="cb35-155"><a href="#cb35-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-156"><a href="#cb35-156" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Save the graph to HTML</span></span>
<span id="cb35-157"><a href="#cb35-157" aria-hidden="true" tabindex="-1"></a>    html_file <span class="op">=</span> <span class="st">"bayesian_network.html"</span></span>
<span id="cb35-158"><a href="#cb35-158" aria-hidden="true" tabindex="-1"></a>    net.save_graph(html_file)</span>
<span id="cb35-159"><a href="#cb35-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-160"><a href="#cb35-160" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Inject custom click handling into HTML</span></span>
<span id="cb35-161"><a href="#cb35-161" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb35-162"><a href="#cb35-162" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> <span class="bu">open</span>(html_file, <span class="st">"r"</span>) <span class="im">as</span> f:</span>
<span id="cb35-163"><a href="#cb35-163" aria-hidden="true" tabindex="-1"></a>            html_content <span class="op">=</span> f.read()</span>
<span id="cb35-164"><a href="#cb35-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-165"><a href="#cb35-165" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Insert click handling script before the closing body tag</span></span>
<span id="cb35-166"><a href="#cb35-166" aria-hidden="true" tabindex="-1"></a>        html_content <span class="op">=</span> html_content.replace(<span class="st">'&lt;/body&gt;'</span>, <span class="ss">f'&lt;script&gt;</span><span class="sc">{</span>click_js<span class="sc">}</span><span class="ss">&lt;/script&gt;&lt;/body&gt;'</span>)</span>
<span id="cb35-167"><a href="#cb35-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-168"><a href="#cb35-168" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Write back the modified HTML</span></span>
<span id="cb35-169"><a href="#cb35-169" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> <span class="bu">open</span>(html_file, <span class="st">"w"</span>) <span class="im">as</span> f:</span>
<span id="cb35-170"><a href="#cb35-170" aria-hidden="true" tabindex="-1"></a>            f.write(html_content)</span>
<span id="cb35-171"><a href="#cb35-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-172"><a href="#cb35-172" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> HTML(html_content)</span>
<span id="cb35-173"><a href="#cb35-173" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb35-174"><a href="#cb35-174" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> HTML(<span class="ss">f"&lt;p&gt;Error rendering HTML: </span><span class="sc">{</span><span class="bu">str</span>(e)<span class="sc">}</span><span class="ss">&lt;/p&gt;&lt;p&gt;The network visualization has been saved to '</span><span class="sc">{</span>html_file<span class="sc">}</span><span class="ss">'&lt;/p&gt;"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="quickly-check-html-outputs" class="level1">
<h1>Quickly check HTML Outputs</h1>
<div class="sourceCode" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>create_bayesian_network_with_probabilities(result_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Use the function to create and display the visualization</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(result_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="conclusion-from-prototype-to-production" class="level1">
<h1>Conclusion: From Prototype to Production</h1>
<section id="summary-of-achievements" class="level2">
<h2 class="anchored" data-anchor-id="summary-of-achievements">Summary of Achievements</h2>
<p>This notebook has successfully demonstrated the core AMTAIR extraction pipeline, transforming structured argument representations into interactive Bayesian network visualizations through the following steps:</p>
<ol type="1">
<li><strong>Environment Setup</strong>: Established a reproducible environment with necessary libraries and data access</li>
<li><strong>Argument Extraction</strong>: Processed structured ArgDown representations preserving the hierarchical relationships</li>
<li><strong>Probability Integration</strong>: Enhanced arguments with probability information to create BayesDown</li>
<li><strong>Data Transformation</strong>: Converted BayesDown into structured DataFrame representation</li>
<li><strong>Visualization &amp; Analysis</strong>: Created interactive Bayesian network visualizations with probability encoding</li>
</ol>
<p>The rain-sprinkler-lawn example, though simple, demonstrates all the key components of the extraction pipeline that can be applied to more complex AI safety arguments.</p>
</section>
<section id="limitations-and-future-work" class="level2">
<h2 class="anchored" data-anchor-id="limitations-and-future-work">Limitations and Future Work</h2>
<p>While this prototype successfully demonstrates the core pipeline, several limitations and opportunities for future work remain:</p>
<ol type="1">
<li><p><strong>LLM Extraction</strong>: The current implementation focuses on processing pre-formatted ArgDown rather than performing extraction directly from unstructured text. Future work will integrate LLM-powered extraction.</p></li>
<li><p><strong>Scalability</strong>: The system has been tested on small examples; scaling to larger, more complex arguments will require additional optimization and handling of computational complexity.</p></li>
<li><p><strong>Policy Evaluation</strong>: The current implementation focuses on representation and visualization; future work will add policy evaluation capabilities by implementing intervention modeling.</p></li>
<li><p><strong>Prediction Market Integration</strong>: Future versions will integrate with forecasting platforms to incorporate live data into the models.</p></li>
</ol>
</section>
<section id="connection-to-amtair-project" class="level2">
<h2 class="anchored" data-anchor-id="connection-to-amtair-project">Connection to AMTAIR Project</h2>
<p>This prototype represents just one component of the broader AMTAIR project described in the project documentation (see PY_AMTAIRDescription and PY_AMTAIR_SoftwareToolsNMilestones). The full project includes:</p>
<ol type="1">
<li><strong>AI Risk Pathway Analyzer (ARPA)</strong>: The core extraction and visualization system demonstrated in this notebook</li>
<li><strong>Worldview Comparator</strong>: Tools for comparing different perspectives on AI risk</li>
<li><strong>Policy Impact Evaluator</strong>: Systems for evaluating intervention effects across scenarios</li>
<li><strong>Strategic Intervention Generator</strong>: Tools for identifying robust governance strategies</li>
</ol>
<p>Together, these components aim to address the coordination crisis in AI governance by providing computational tools that make implicit models explicit, identify cruxes of disagreement, and evaluate policy impacts across diverse worldviews.</p>
<p>By transforming unstructured text into formal, analyzable representations, the AMTAIR project helps bridge the gaps between technical researchers, policy specialists, and other stakeholders, enabling more effective coordination in addressing existential risks from advanced AI.</p>
</section>
</section>
<section id="save-outputs" class="level1">
<h1>6.0 Save Outputs</h1>
</section>
<section id="saving-and-exporting-results" class="level1">
<h1>6. Saving and Exporting Results</h1>
<p>This section provides tools for saving the notebook results and visualizations in various formats:</p>
<ol type="1">
<li><strong>HTML Export</strong>: Creates a self-contained HTML version of the notebook with all visualizations</li>
<li><strong>Markdown Export</strong>: Generates documentation-friendly Markdown version of the notebook</li>
<li><strong>PDF Export</strong>: Creates a PDF document for formal sharing (requires LaTeX installation)</li>
</ol>
<p>These exports are essential for: - Sharing analysis results with colleagues and stakeholders - Including visualizations in presentations and reports - Creating documentation for the AMTAIR project - Preserving results for future reference</p>
<p>The different formats serve different purposes, from interactive exploration (HTML) to documentation (Markdown) to formal presentation (PDF).</p>
<p>Instruction:</p>
<p>Download the ipynb, which you want to convert, on your local computer. Run the code below to upload the ipynb.</p>
<p>The html version will be downloaded automatically on your local machine. Enjoy it!</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># @title 6.0 --- Save Visualization and Notebook Outputs as .HTML---</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="co">BLOCK PURPOSE: Provides tools for saving the notebook results in various formats.</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a><span class="co">This block offers functions to:</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a><span class="co">1. Convert the notebook to HTML for easy sharing and viewing</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a><span class="co">2. Convert the notebook to Markdown for documentation purposes</span></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a><span class="co">3. Save the visualization outputs for external use</span></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a><span class="co">These tools are essential for preserving the analysis results and making them</span></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a><span class="co">accessible outside the notebook environment, supporting knowledge transfer</span></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a><span class="co">and integration with other AMTAIR project components.</span></span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a><span class="co">DEPENDENCIES: nbformat, nbconvert modules</span></span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a><span class="co">INPUTS: Current notebook state</span></span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a><span class="co">OUTPUTS: HTML, Markdown, or other format versions of the notebook</span></span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> nbformat</span>
<span id="cb38-21"><a href="#cb38-21" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> nbconvert <span class="im">import</span> HTMLExporter</span>
<span id="cb38-22"><a href="#cb38-22" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb38-23"><a href="#cb38-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-24"><a href="#cb38-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Repository URL variable for file access</span></span>
<span id="cb38-25"><a href="#cb38-25" aria-hidden="true" tabindex="-1"></a>repo_url <span class="op">=</span> <span class="st">"https://raw.githubusercontent.com/SingularitySmith/AMTAIR_Prototype/main/data/example_carlsmith/"</span></span>
<span id="cb38-26"><a href="#cb38-26" aria-hidden="true" tabindex="-1"></a>notebook_name <span class="op">=</span> <span class="st">"AMTAIR_Prototype_example_carlsmith"</span>  <span class="co"># Change when working with different examples</span></span>
<span id="cb38-27"><a href="#cb38-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-28"><a href="#cb38-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Download the notebook file</span></span>
<span id="cb38-29"><a href="#cb38-29" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>wget {repo_url}{notebook_name}.ipynb <span class="op">-</span>O {notebook_name}.ipynb</span>
<span id="cb38-30"><a href="#cb38-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-31"><a href="#cb38-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the notebook</span></span>
<span id="cb38-32"><a href="#cb38-32" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb38-33"><a href="#cb38-33" aria-hidden="true" tabindex="-1"></a>  <span class="cf">with</span> <span class="bu">open</span>(<span class="ss">f"</span><span class="sc">{</span>notebook_name<span class="sc">}</span><span class="ss">.ipynb"</span>) <span class="im">as</span> f:</span>
<span id="cb38-34"><a href="#cb38-34" aria-hidden="true" tabindex="-1"></a>    nb <span class="op">=</span> nbformat.read(f, as_version<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb38-35"><a href="#cb38-35" aria-hidden="true" tabindex="-1"></a>  <span class="bu">print</span>(<span class="ss">f"✅ Successfully loaded notebook: </span><span class="sc">{</span>notebook_name<span class="sc">}</span><span class="ss">.ipynb"</span>)</span>
<span id="cb38-36"><a href="#cb38-36" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">FileNotFoundError</span>:</span>
<span id="cb38-37"><a href="#cb38-37" aria-hidden="true" tabindex="-1"></a>  <span class="bu">print</span>(<span class="ss">f"❌ Error: File '</span><span class="sc">{</span>notebook_name<span class="sc">}</span><span class="ss">.ipynb' not found. Please check if it was downloaded correctly."</span>)</span>
<span id="cb38-38"><a href="#cb38-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-39"><a href="#cb38-39" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize the HTML exporter</span></span>
<span id="cb38-40"><a href="#cb38-40" aria-hidden="true" tabindex="-1"></a>exporter <span class="op">=</span> HTMLExporter()</span>
<span id="cb38-41"><a href="#cb38-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-42"><a href="#cb38-42" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert the notebook to HTML</span></span>
<span id="cb38-43"><a href="#cb38-43" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb38-44"><a href="#cb38-44" aria-hidden="true" tabindex="-1"></a>    (body, resources) <span class="op">=</span> exporter.from_notebook_node(nb)</span>
<span id="cb38-45"><a href="#cb38-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-46"><a href="#cb38-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Save the HTML to a file</span></span>
<span id="cb38-47"><a href="#cb38-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(<span class="ss">f"</span><span class="sc">{</span>notebook_name<span class="sc">}</span><span class="ss">IPYNB.html"</span>, <span class="st">"w"</span>) <span class="im">as</span> f:</span>
<span id="cb38-48"><a href="#cb38-48" aria-hidden="true" tabindex="-1"></a>        f.write(body)</span>
<span id="cb38-49"><a href="#cb38-49" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"✅ Successfully saved HTML version to: </span><span class="sc">{</span>notebook_name<span class="sc">}</span><span class="ss">IPYNB.html"</span>)</span>
<span id="cb38-50"><a href="#cb38-50" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb38-51"><a href="#cb38-51" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"❌ Error converting notebook to HTML: </span><span class="sc">{</span><span class="bu">str</span>(e)<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<section id="convert-.ipynb-notebook-to-markdown" class="level2">
<h2 class="anchored" data-anchor-id="convert-.ipynb-notebook-to-markdown">Convert .ipynb Notebook to MarkDown</h2>
<div class="sourceCode" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># @title --- Convert .ipynb Notebook to MarkDown ---</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> nbformat</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> nbconvert <span class="im">import</span> MarkdownExporter</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a><span class="co"># repo_url = "https://raw.githubusercontent.com/SingularitySmith/AMTAIR_Prototype/main/data/example_1/"</span></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>notebook_name <span class="op">=</span> <span class="st">"AMTAIR_Prototype_example_carlsmith"</span>  <span class="co">#Change Notebook name and path when working on different examples</span></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Download the notebook file</span></span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>wget {repo_url}{notebook_name}.ipynb <span class="op">-</span>O {notebook_name}.ipynb  <span class="co"># Corrected line</span></span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the notebook</span></span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a><span class="co"># add error handling for file not found</span></span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a>  <span class="cf">with</span> <span class="bu">open</span>(<span class="ss">f"</span><span class="sc">{</span>notebook_name<span class="sc">}</span><span class="ss">.ipynb"</span>) <span class="im">as</span> f:</span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a>    nb <span class="op">=</span> nbformat.read(f, as_version<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">FileNotFoundError</span>:</span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a>  <span class="bu">print</span>(<span class="ss">f"Error: File '</span><span class="sc">{</span>notebook_name<span class="sc">}</span><span class="ss">.ipynb' not found. Please check if it was downloaded correctly."</span>)</span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-22"><a href="#cb39-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize the Markdown exporter</span></span>
<span id="cb39-23"><a href="#cb39-23" aria-hidden="true" tabindex="-1"></a>exporter <span class="op">=</span> MarkdownExporter(exclude_output<span class="op">=</span><span class="va">True</span>)  <span class="co"># Correct initialization</span></span>
<span id="cb39-24"><a href="#cb39-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-25"><a href="#cb39-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert the notebook to Markdown</span></span>
<span id="cb39-26"><a href="#cb39-26" aria-hidden="true" tabindex="-1"></a>(body, resources) <span class="op">=</span> exporter.from_notebook_node(nb)</span>
<span id="cb39-27"><a href="#cb39-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-28"><a href="#cb39-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the Markdown to a file</span></span>
<span id="cb39-29"><a href="#cb39-29" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="ss">f"</span><span class="sc">{</span>notebook_name<span class="sc">}</span><span class="ss">IPYNB.md"</span>, <span class="st">"w"</span>) <span class="im">as</span> f:</span>
<span id="cb39-30"><a href="#cb39-30" aria-hidden="true" tabindex="-1"></a>    f.write(body)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># @title 6.1 --- Convert Notebook to Markdown Documentation ---</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="co">BLOCK PURPOSE: Converts the notebook to Markdown format for documentation purposes.</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a><span class="co">Markdown is a lightweight markup language that is widely used for documentation</span></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a><span class="co">and is easily readable in both plain text and rendered formats. This conversion:</span></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a><span class="co">1. Preserves the structure and content of the notebook</span></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a><span class="co">2. Creates a format suitable for inclusion in documentation systems</span></span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a><span class="co">3. Excludes code outputs to focus on the process and methodology</span></span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a><span class="co">4. Supports version control and collaboration on GitHub</span></span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a><span class="co">The resulting Markdown file can be used in project documentation, GitHub wikis,</span></span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a><span class="co">or as a standalone reference guide to the AMTAIR extraction pipeline.</span></span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a><span class="co">DEPENDENCIES: nbformat, nbconvert.MarkdownExporter modules</span></span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a><span class="co">INPUTS: Current notebook state</span></span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a><span class="co">OUTPUTS: Markdown version of the notebook</span></span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-22"><a href="#cb40-22" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> nbformat</span>
<span id="cb40-23"><a href="#cb40-23" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> nbconvert <span class="im">import</span> MarkdownExporter</span>
<span id="cb40-24"><a href="#cb40-24" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb40-25"><a href="#cb40-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-26"><a href="#cb40-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Repository URL variable for file access</span></span>
<span id="cb40-27"><a href="#cb40-27" aria-hidden="true" tabindex="-1"></a><span class="co"># repo_url = "https://raw.githubusercontent.com/SingularitySmith/AMTAIR_Prototype/main/data/example_carlsmith/"</span></span>
<span id="cb40-28"><a href="#cb40-28" aria-hidden="true" tabindex="-1"></a>notebook_name <span class="op">=</span> <span class="st">"AMTAIR_Prototype_example_carlsmith"</span>  <span class="co"># Change when working with different examples</span></span>
<span id="cb40-29"><a href="#cb40-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-30"><a href="#cb40-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Download the notebook file</span></span>
<span id="cb40-31"><a href="#cb40-31" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>wget {repo_url}{notebook_name}.ipynb <span class="op">-</span>O {notebook_name}.ipynb</span>
<span id="cb40-32"><a href="#cb40-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-33"><a href="#cb40-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the notebook</span></span>
<span id="cb40-34"><a href="#cb40-34" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb40-35"><a href="#cb40-35" aria-hidden="true" tabindex="-1"></a>  <span class="cf">with</span> <span class="bu">open</span>(<span class="ss">f"</span><span class="sc">{</span>notebook_name<span class="sc">}</span><span class="ss">.ipynb"</span>) <span class="im">as</span> f:</span>
<span id="cb40-36"><a href="#cb40-36" aria-hidden="true" tabindex="-1"></a>    nb <span class="op">=</span> nbformat.read(f, as_version<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb40-37"><a href="#cb40-37" aria-hidden="true" tabindex="-1"></a>  <span class="bu">print</span>(<span class="ss">f"✅ Successfully loaded notebook: </span><span class="sc">{</span>notebook_name<span class="sc">}</span><span class="ss">.ipynb"</span>)</span>
<span id="cb40-38"><a href="#cb40-38" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">FileNotFoundError</span>:</span>
<span id="cb40-39"><a href="#cb40-39" aria-hidden="true" tabindex="-1"></a>  <span class="bu">print</span>(<span class="ss">f"❌ Error: File '</span><span class="sc">{</span>notebook_name<span class="sc">}</span><span class="ss">.ipynb' not found. Please check if it was downloaded correctly."</span>)</span>
<span id="cb40-40"><a href="#cb40-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-41"><a href="#cb40-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-42"><a href="#cb40-42" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize the Markdown exporter</span></span>
<span id="cb40-43"><a href="#cb40-43" aria-hidden="true" tabindex="-1"></a>exporter <span class="op">=</span> MarkdownExporter(exclude_output<span class="op">=</span><span class="va">True</span>)  <span class="co"># Exclude outputs for cleaner documentation</span></span>
<span id="cb40-44"><a href="#cb40-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-45"><a href="#cb40-45" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert the notebook to Markdown</span></span>
<span id="cb40-46"><a href="#cb40-46" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb40-47"><a href="#cb40-47" aria-hidden="true" tabindex="-1"></a>    (body, resources) <span class="op">=</span> exporter.from_notebook_node(nb)</span>
<span id="cb40-48"><a href="#cb40-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-49"><a href="#cb40-49" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Save the Markdown to a file</span></span>
<span id="cb40-50"><a href="#cb40-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(<span class="ss">f"</span><span class="sc">{</span>notebook_name<span class="sc">}</span><span class="ss">IPYNB.md"</span>, <span class="st">"w"</span>) <span class="im">as</span> f:</span>
<span id="cb40-51"><a href="#cb40-51" aria-hidden="true" tabindex="-1"></a>        f.write(body)</span>
<span id="cb40-52"><a href="#cb40-52" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"✅ Successfully saved Markdown version to: </span><span class="sc">{</span>notebook_name<span class="sc">}</span><span class="ss">IPYNB.md"</span>)</span>
<span id="cb40-53"><a href="#cb40-53" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb40-54"><a href="#cb40-54" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"❌ Error converting notebook to Markdown: </span><span class="sc">{</span><span class="bu">str</span>(e)<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> nbformat</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> nbconvert <span class="im">import</span> PDFExporter</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> subprocess</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> escape_latex_special_chars(text):</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>  <span class="co">"""Escapes special LaTeX characters in a string."""</span></span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>  latex_special_chars <span class="op">=</span> [<span class="st">'&amp;'</span>, <span class="st">'%'</span>, <span class="st">'#'</span>, <span class="st">'_'</span>, <span class="st">'{'</span>, <span class="st">'}'</span>, <span class="st">'~'</span>, <span class="st">'^'</span>, <span class="st">'</span><span class="ch">\\</span><span class="st">'</span>]</span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>  replacement_patterns <span class="op">=</span> [</span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>      (char, <span class="st">'</span><span class="ch">\\</span><span class="st">'</span> <span class="op">+</span> char) <span class="cf">for</span> char <span class="kw">in</span> latex_special_chars</span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>  ]</span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Escape reserved characters</span></span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> original, replacement <span class="kw">in</span> replacement_patterns:</span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a>    text <span class="op">=</span> text.replace(original, replacement) <span class="co"># This is the fix</span></span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> text</span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to check if a command is available</span></span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> is_command_available(command):</span>
<span id="cb41-21"><a href="#cb41-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb41-22"><a href="#cb41-22" aria-hidden="true" tabindex="-1"></a>        subprocess.run([command], capture_output<span class="op">=</span><span class="va">True</span>, check<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb41-23"><a href="#cb41-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb41-24"><a href="#cb41-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> (subprocess.CalledProcessError, <span class="pp">FileNotFoundError</span>):</span>
<span id="cb41-25"><a href="#cb41-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb41-26"><a href="#cb41-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-27"><a href="#cb41-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Check if xelatex is installed, and install if necessary</span></span>
<span id="cb41-28"><a href="#cb41-28" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> is_command_available(<span class="st">"xelatex"</span>):</span>
<span id="cb41-29"><a href="#cb41-29" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Installing necessary TeX packages..."</span>)</span>
<span id="cb41-30"><a href="#cb41-30" aria-hidden="true" tabindex="-1"></a>    <span class="op">!</span>apt<span class="op">-</span>get install <span class="op">-</span>y texlive<span class="op">-</span>xetex texlive<span class="op">-</span>fonts<span class="op">-</span>recommended texlive<span class="op">-</span>plain<span class="op">-</span>generic</span>
<span id="cb41-31"><a href="#cb41-31" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"TeX packages installed successfully."</span>)</span>
<span id="cb41-32"><a href="#cb41-32" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb41-33"><a href="#cb41-33" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"xelatex is already installed. Skipping installation."</span>)</span>
<span id="cb41-34"><a href="#cb41-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-35"><a href="#cb41-35" aria-hidden="true" tabindex="-1"></a><span class="co"># repo_url = "https://raw.githubusercontent.com/SingularitySmith/AMTAIR_Prototype/main/data/example_1/"</span></span>
<span id="cb41-36"><a href="#cb41-36" aria-hidden="true" tabindex="-1"></a>notebook_name <span class="op">=</span> <span class="st">"AMTAIR_Prototype_example_carlsmith"</span>  <span class="co">#Change Notebook name and path when working on different examples</span></span>
<span id="cb41-37"><a href="#cb41-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-38"><a href="#cb41-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Download the notebook file</span></span>
<span id="cb41-39"><a href="#cb41-39" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>wget {repo_url}{notebook_name}.ipynb <span class="op">-</span>O {notebook_name}.ipynb  <span class="co"># Corrected line</span></span>
<span id="cb41-40"><a href="#cb41-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-41"><a href="#cb41-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the notebook</span></span>
<span id="cb41-42"><a href="#cb41-42" aria-hidden="true" tabindex="-1"></a><span class="co"># add error handling for file not found</span></span>
<span id="cb41-43"><a href="#cb41-43" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb41-44"><a href="#cb41-44" aria-hidden="true" tabindex="-1"></a>  <span class="cf">with</span> <span class="bu">open</span>(<span class="ss">f"</span><span class="sc">{</span>notebook_name<span class="sc">}</span><span class="ss">.ipynb"</span>) <span class="im">as</span> f:</span>
<span id="cb41-45"><a href="#cb41-45" aria-hidden="true" tabindex="-1"></a>    nb <span class="op">=</span> nbformat.read(f, as_version<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb41-46"><a href="#cb41-46" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">FileNotFoundError</span>:</span>
<span id="cb41-47"><a href="#cb41-47" aria-hidden="true" tabindex="-1"></a>  <span class="bu">print</span>(<span class="ss">f"Error: File '</span><span class="sc">{</span>notebook_name<span class="sc">}</span><span class="ss">.ipynb' not found. Please check if it was downloaded correctly."</span>)</span>
<span id="cb41-48"><a href="#cb41-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-49"><a href="#cb41-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-50"><a href="#cb41-50" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize the PDF exporter</span></span>
<span id="cb41-51"><a href="#cb41-51" aria-hidden="true" tabindex="-1"></a>exporter <span class="op">=</span> PDFExporter(exclude_output<span class="op">=</span><span class="va">True</span>)  <span class="co"># Changed to PDFExporter</span></span>
<span id="cb41-52"><a href="#cb41-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-53"><a href="#cb41-53" aria-hidden="true" tabindex="-1"></a><span class="co"># Sanitize notebook cell titles to escape special LaTeX characters like '&amp;'</span></span>
<span id="cb41-54"><a href="#cb41-54" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> cell <span class="kw">in</span> nb.cells:</span>
<span id="cb41-55"><a href="#cb41-55" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'cell_type'</span> <span class="kw">in</span> cell <span class="kw">and</span> cell[<span class="st">'cell_type'</span>] <span class="op">==</span> <span class="st">'markdown'</span>:</span>
<span id="cb41-56"><a href="#cb41-56" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">'source'</span> <span class="kw">in</span> cell <span class="kw">and</span> <span class="bu">isinstance</span>(cell[<span class="st">'source'</span>], <span class="bu">str</span>):</span>
<span id="cb41-57"><a href="#cb41-57" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Replace '&amp;' with '\protect&amp;' in markdown cell titles AND CONTENT</span></span>
<span id="cb41-58"><a href="#cb41-58" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Updated to use escape_latex_special_chars function</span></span>
<span id="cb41-59"><a href="#cb41-59" aria-hidden="true" tabindex="-1"></a>            cell[<span class="st">'source'</span>] <span class="op">=</span> escape_latex_special_chars(cell[<span class="st">'source'</span>])</span>
<span id="cb41-60"><a href="#cb41-60" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Additionally, escape special characters in headings</span></span>
<span id="cb41-61"><a href="#cb41-61" aria-hidden="true" tabindex="-1"></a>            cell[<span class="st">'source'</span>] <span class="op">=</span> re.sub(<span class="vs">r'</span><span class="kw">(</span><span class="vs">#</span><span class="op">+</span><span class="kw">)</span><span class="dv">\s</span><span class="op">*</span><span class="kw">(</span><span class="dv">.</span><span class="op">*</span><span class="kw">)</span><span class="vs">'</span>, <span class="kw">lambda</span> m: m.group(<span class="dv">1</span>) <span class="op">+</span> <span class="st">' '</span> <span class="op">+</span> escape_latex_special_chars(m.group(<span class="dv">2</span>)), cell[<span class="st">'source'</span>])</span>
<span id="cb41-62"><a href="#cb41-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-63"><a href="#cb41-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-64"><a href="#cb41-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-65"><a href="#cb41-65" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert the notebook to PDF</span></span>
<span id="cb41-66"><a href="#cb41-66" aria-hidden="true" tabindex="-1"></a>(body, resources) <span class="op">=</span> exporter.from_notebook_node(nb)</span>
<span id="cb41-67"><a href="#cb41-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-68"><a href="#cb41-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-69"><a href="#cb41-69" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the PDF to a file</span></span>
<span id="cb41-70"><a href="#cb41-70" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="ss">f"</span><span class="sc">{</span>notebook_name<span class="sc">}</span><span class="ss">IPYNB.pdf"</span>, <span class="st">"wb"</span>) <span class="im">as</span> f:  <span class="co"># Changed to 'wb' for binary writing</span></span>
<span id="cb41-71"><a href="#cb41-71" aria-hidden="true" tabindex="-1"></a>    f.write(body)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
     </main>
<!-- /main column -->  <script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>  </div> <!-- /content --> 
  
</body></html>